<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YG3SBRRZFZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YG3SBRRZFZ');
    </script>

    <title>Composite Wall Heat Loss - Engineering Tools</title>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <style>
        :root {
            --primary-color: #1f2937;
            --primary-light: #f1f5f9;
            --secondary-color: #334155;
            --text-color: #111827;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --bg-color: #f8fafc;
            --bg-card: #ffffff;
            --shadow: 0 14px 30px -25px rgba(15, 23, 42, 0.65);
            --border-radius: 14px;
            --accent-color: #2563eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }

        body {
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 6px 12px -12px rgba(30, 41, 59, 0.7);
            padding: 0 5%;
        }
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .nav-brand {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 0.01em;
        }
        .nav-brand:hover { text-decoration: none; }

        main.container {
            flex-grow: 1;
            width: 92%;
            max-width: 1220px;
            margin: 0 auto;
            padding: 32px 0 56px;
        }

        h1, h2, h3, h4 {
            color: var(--primary-color);
            margin-bottom: 0.75em;
            line-height: 1.2;
            font-weight: 650;
        }
        h1 { font-size: clamp(2rem, 3.2vw, 2.75rem); margin-bottom: 0.35rem; }
        h2 { font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 1.1rem; }
        h3 { font-size: 1.2rem; color: var(--secondary-color); }
        h4 { font-size: 1.05rem; color: var(--secondary-color); }

        p { margin-bottom: 0.9rem; color: var(--text-light); }
        a { color: var(--accent-color); text-decoration: none; font-weight: 600; }
        a:hover { text-decoration: underline; }

        .tool-description { font-size: 1.08rem; max-width: 80ch; margin-bottom: 1.1rem; color: var(--text-color); }

        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .purpose-section {
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-card);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .purpose-section summary {
            padding: 18px 24px;
            font-size: 1.05rem;
            font-weight: 650;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--secondary-color);
        }
        .purpose-section summary::after {
            content: '[Expand]';
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-light);
        }
        .purpose-section[open] > summary::after { content: '[Collapse]'; }
        .purpose-content { padding: 0 24px 24px; border-top: 1px solid rgba(148, 163, 184, 0.25); }
        .purpose-content ul { padding-left: 20px; margin-bottom: 1em; }

        .tool-layout {
            display: grid;
            grid-template-columns: minmax(320px, 0.9fr) minmax(420px, 1.1fr);
            gap: 26px;
            align-items: start;
        }
        .output-column {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid rgba(203, 213, 225, 0.7);
            box-shadow: var(--shadow);
            padding: 24px;
        }

        .sticky-card {
            position: sticky;
            top: 20px;
        }

        fieldset {
            border: 1px solid rgba(203, 213, 225, 0.7);
            border-radius: 12px;
            padding: 18px 18px 12px;
            margin-bottom: 18px;
            background: rgba(248, 250, 252, 0.65);
        }
        fieldset legend {
            font-weight: 650;
            font-size: 0.95rem;
            color: var(--secondary-color);
            padding: 0 8px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 14px 18px;
        }

        .input-group { display: flex; flex-direction: column; gap: 4px; position: relative; }
        .input-group label {
            font-size: 0.85rem;
            font-weight: 650;
            color: var(--secondary-color);
        }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: #fff;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-group input:focus,
        .input-group select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
            outline: none;
        }

        .layer-group {
            border: 1px dashed var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            background: rgba(241, 245, 249, 0.75);
        }

        .tooltip-trigger {
            position: absolute;
            right: -20px;
            top: 32px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(148, 163, 184, 0.4);
            color: var(--secondary-color);
            font-size: 11px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 135%;
            left: 50%;
            transform: translateX(-50%);
            white-space: normal;
            width: 220px;
            background: var(--primary-color);
            color: #fff;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 0.78rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
            box-shadow: 0 8px 18px -12px rgba(15, 23, 42, 0.8);
            z-index: 9;
        }
        .tooltip-trigger:hover::after,
        .tooltip-trigger:focus::after {
            opacity: 1;
            visibility: visible;
        }

        .btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            font-weight: 650;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-primary {
            width: 100%;
            background: var(--accent-color);
            color: #fff;
            box-shadow: 0 10px 18px -15px rgba(37, 99, 235, 0.7);
            margin-top: 8px;
        }
        .btn-primary:hover { background: #1d4ed8; }

        .tabs {
            display: flex;
            gap: 6px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .tab-link {
            padding: 9px 14px;
            background: rgba(226, 232, 240, 0.45);
            border: none;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-link.active {
            background: var(--bg-card);
            color: var(--primary-color);
            border-bottom: 2px solid var(--accent-color);
        }
        .tab-content { display: none; animation: fadeIn 0.35s ease; }
        @keyframes fadeIn { from { opacity: 0; translate: 0 6px; } to { opacity: 1; translate: 0; } }

        #results-display { display: flex; flex-direction: column; gap: 18px; }

        .results-block { display: flex; flex-direction: column; gap: 12px; }
        .results-block h4 { margin-bottom: 0; }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
        }
        .metric {
            border: 1px solid rgba(203, 213, 225, 0.8);
            border-radius: 10px;
            padding: 12px;
            background: rgba(248, 250, 252, 0.9);
        }
        .metric span { color: var(--text-light); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.08em; }
        .metric strong { display: block; font-size: 1.05rem; margin-top: 2px; color: var(--primary-color); }
        .metric small { display: block; font-size: 0.82rem; color: var(--text-light); }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }
        table thead { background: rgba(226, 232, 240, 0.5); }
        table th, table td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(203, 213, 225, 0.6);
            font-size: 0.92rem;
        }
        table tr:last-child td { border-bottom: none; }
        table tbody tr:hover { background: rgba(37, 99, 235, 0.08); }

        .equation-wrapper {
            max-width: 100%;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        .equation-expression {
            display: block;
            margin-bottom: 0.4rem;
            font-size: 1rem;
        }
        .variable-list {
            list-style: none;
            padding-left: 0;
            margin: 0 0 0.75rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 6px 18px;
        }
        .variable-list li {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .math-inline {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .summary-card h3 { margin-top: 0; }
        .summary-card p { margin-bottom: 0.4rem; }

        #plot-container {
            width: 100%;
            min-height: 340px;
            border: 1px dashed rgba(148, 163, 184, 0.7);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(248, 250, 252, 0.7);
            color: var(--text-light);
            font-weight: 600;
        }

        footer {
            text-align: center;
            padding: 24px 0 32px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .hidden { display: none !important; }

        @media (max-width: 980px) {
            .tool-layout { grid-template-columns: 1fr; }
            .output-column { order: -1; }
            .sticky-card { position: relative; top: 0; }
        }
        @media (max-width: 600px) {
            .tabs { flex-direction: column; }
            .tab-link { border-radius: 8px; }
            .metric-grid { grid-template-columns: 1fr 1fr; }
            fieldset { padding: 16px 14px 10px; }
            .tooltip-trigger { display: none; }
        }
    
    .support-link {
      color: inherit;
      font-weight: 600;
      text-decoration: none;
    }

    .support-link:hover {
      text-decoration: underline;
    }
    </style>
</head>

<body>
    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
        </nav>
    </header>

    <main class="container">
        <h1>Composite Wall Heat Loss</h1>
        <p class="tool-description" id="tool-description">
            Quantify steady one-dimensional conduction through a layered wall assembly, including optional interior and exterior film resistances.
        </p>

        <details class="purpose-section">
            <summary>Tool Scope &amp; Usage Notes</summary>
            <div class="purpose-content">
                <h3>What This Tool Delivers</h3>
                <ul>
                    <li>Breaks down the total R-value into film and material components for quick auditing.</li>
                    <li>Outputs both SI and inch–pound unit conversions (U-value, heat flux, heat flow).</li>
                    <li>Plots the temperature profile across the envelope to reveal critical interfaces.</li>
                </ul>
                <h3>Model Assumptions</h3>
                <ul>
                    <li>One-dimensional heat flow with uniform material properties.</li>
                    <li>No internal heat generation and constant area across layers.</li>
                    <li>Optional film coefficients represent well-mixed air conditions on both sides.</li>
                </ul>
                <h3>Workflow Tips</h3>
                <ul>
                    <li>Set layer count first, then enter thickness (m) and conductivity (W/m·K) for each layer.</li>
                    <li>Leave film coefficients blank to exclude them from the resistance network.</li>
                    <li>Use the summary card to compare the resulting U-value against design targets.</li>
                </ul>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <form id="calc-form">
                    <fieldset>
                        <legend>Geometry &amp; Boundary Conditions</legend>
                        <div class="input-grid">
                            <div class="input-group" data-param="area">
                                <label for="area">Wall Area (m²)</label>
                                <input type="number" id="area" name="area" placeholder="e.g., 20" step="any" min="0" value="10">
                                <span class="tooltip-trigger" data-tooltip="Plan area of the wall assembly exposed to the temperature difference.">?</span>
                            </div>
                            <div class="input-group" data-param="interior_temperature">
                                <label for="interior-temperature">Interior Ambient (°C)</label>
                                <input type="number" id="interior-temperature" name="interior-temperature" placeholder="e.g., 21" step="any" value="21">
                                <span class="tooltip-trigger" data-tooltip="Dry-bulb temperature on the conditioned side of the wall.">?</span>
                            </div>
                            <div class="input-group" data-param="exterior_temperature">
                                <label for="exterior-temperature">Exterior Ambient (°C)</label>
                                <input type="number" id="exterior-temperature" name="exterior-temperature" placeholder="e.g., -5" step="any" value="-5">
                                <span class="tooltip-trigger" data-tooltip="Outdoor or unconditioned-side temperature.">?</span>
                            </div>
                            <div class="input-group">
                                <label for="layer-count">Number of Layers</label>
                                <select id="layer-count" name="layer-count">
                                    <option value="1">1 Layer</option>
                                    <option value="2">2 Layers</option>
                                    <option value="3" selected>3 Layers</option>
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Film Coefficients (Optional)</legend>
                        <div class="input-grid">
                            <div class="input-group" data-param="interior_convection_coefficient">
                                <label for="interior-h">Interior h<sub>i</sub> (W/m²·K)</label>
                                <input type="number" id="interior-h" name="interior-h" placeholder="e.g., 8" step="any" min="0">
                                <span class="tooltip-trigger" data-tooltip="Interior film coefficient; typical values: 7–10 W/m²·K for natural convection.">?</span>
                            </div>
                            <div class="input-group" data-param="exterior_convection_coefficient">
                                <label for="exterior-h">Exterior h<sub>o</sub> (W/m²·K)</label>
                                <input type="number" id="exterior-h" name="exterior-h" placeholder="e.g., 25" step="any" min="0">
                                <span class="tooltip-trigger" data-tooltip="Exterior film coefficient; depends on wind speed (e.g., 20–35 W/m²·K).">?</span>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Layer Properties (Thickness in metres)</legend>
                        <div id="layer-wrapper">
                            <div class="layer-group" data-layer="1">
                                <h4>Layer 1</h4>
                                <div class="input-grid">
                                    <div class="input-group" data-param="layer_thicknesses">
                                        <label for="layer-1-thickness">Thickness (m)</label>
                                        <input type="number" id="layer-1-thickness" placeholder="e.g., 0.20" step="any" min="0" value="0.2">
                                    </div>
                                    <div class="input-group" data-param="layer_conductivities">
                                        <label for="layer-1-k">Thermal Conductivity (W/m·K)</label>
                                        <input type="number" id="layer-1-k" placeholder="e.g., 0.038" step="any" min="0" value="0.038">
                                    </div>
                                </div>
                            </div>

                            <div class="layer-group" data-layer="2">
                                <h4>Layer 2</h4>
                                <div class="input-grid">
                                    <div class="input-group" data-param="layer_thicknesses">
                                        <label for="layer-2-thickness">Thickness (m)</label>
                                        <input type="number" id="layer-2-thickness" placeholder="e.g., 0.02" step="any" min="0" value="0.02">
                                    </div>
                                    <div class="input-group" data-param="layer_conductivities">
                                        <label for="layer-2-k">Thermal Conductivity (W/m·K)</label>
                                        <input type="number" id="layer-2-k" placeholder="e.g., 0.21" step="any" min="0" value="0.21">
                                    </div>
                                </div>
                            </div>

                            <div class="layer-group" data-layer="3">
                                <h4>Layer 3</h4>
                                <div class="input-grid">
                                    <div class="input-group" data-param="layer_thicknesses">
                                        <label for="layer-3-thickness">Thickness (m)</label>
                                        <input type="number" id="layer-3-thickness" placeholder="e.g., 0.01" step="any" min="0" value="0.01">
                                    </div>
                                    <div class="input-group" data-param="layer_conductivities">
                                        <label for="layer-3-k">Thermal Conductivity (W/m·K)</label>
                                        <input type="number" id="layer-3-k" placeholder="e.g., 0.72" step="any" min="0" value="0.72">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <button type="submit" class="btn btn-primary" id="calculate-btn">
                        Calculate Heat Flow
                    </button>
                </form>
            </section>

            <div class="output-column">
                <section class="tool-outputs card">
                    <div class="tabs">
                        <button class="tab-link active" onclick="openTab(event, 'results')">Results</button>
                        <button class="tab-link" onclick="openTab(event, 'plot')">Visualization</button>
                        <button class="tab-link" onclick="openTab(event, 'background')">Background &amp; Equations</button>
                    </div>

                    <div id="results" class="tab-content" style="display: block;">
                        <h3>Detailed Results</h3>
                        <div id="results-display">
                            <p id="results-placeholder">Provide inputs and press “Calculate Heat Flow” to see the conduction breakdown.</p>
                        </div>
                    </div>

                    <div id="plot" class="tab-content">
                        <h3>Temperature Profile</h3>
                        <div id="plot-container">
                            Run a calculation to view the temperature distribution across the wall.
                        </div>
                    </div>

                    <div id="background" class="tab-content">
                        <h3>Underlying Principles</h3>
                        <p>Loading Python documentation...</p>
                    </div>
                </section>

                <aside class="card sticky-card summary-card" id="summary-card">
                    <h3>Summary</h3>
                    <p>Run a calculation to pin the key metrics (heat flux, U-value, total R-value) here.</p>
                </aside>
            </div>
        </div>
    </main>

    <footer>&copy; 2025 Engineering Tools. Built for quick heat loss checks and educational walkthroughs. <a class="support-link" href="https://ko-fi.com/transparent_tools" target="_blank" rel="noopener">Support on Ko-fi</a>
</footer>

    <script>
        let toolDocumentation = {};
        let pyToolModule;
        let latestResults = null;
        let latestInputs = { area: null };

        const TOOL_MODULE_NAME = 'heat_transfer';
        const TOOL_FUNCTION_NAME = 'composite_wall_analysis';

        function openTab(event, tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
            document.querySelectorAll(".tab-link").forEach(link => link.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            event.currentTarget.classList.add("active");
        }

        function typesetMath() {
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }

        function updateLayerVisibility() {
            const desiredLayers = Number(document.getElementById('layer-count').value);
            document.querySelectorAll('.layer-group').forEach(group => {
                const layerIndex = Number(group.dataset.layer);
                group.classList.toggle('hidden', layerIndex > desiredLayers);
            });
        }
        document.getElementById('layer-count').addEventListener('change', updateLayerVisibility);
        updateLayerVisibility();

        async function main() {
            document.getElementById("calculate-btn").textContent = "Loading Pyodide...";
            const pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");

            document.getElementById("calculate-btn").textContent = "Loading Python...";
            await pyodide.runPythonAsync(`
                import micropip
                from pyodide.http import pyfetch

                response_utils = await pyfetch('../../pycalcs/utils.py')
                with open('utils.py', 'w') as f:
                    f.write(await response_utils.string())

                response_tool = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
                with open('${TOOL_MODULE_NAME}.py', 'w') as f:
                    f.write(await response_tool.string())

                import utils
                import ${TOOL_MODULE_NAME}
            `);

            const pyUtils = pyodide.globals.get('utils');
            pyToolModule = pyodide.globals.get(TOOL_MODULE_NAME);

            const docMap = pyUtils.get_documentation(TOOL_MODULE_NAME, TOOL_FUNCTION_NAME).toJs();
            if (docMap.has('error')) {
                const message = docMap.get('error');
                document.getElementById("results-display").innerHTML = `
                    <p style="color: red; font-weight: bold;">Initialization Error:</p>
                    <p style="color: red;">${message}</p>
                `;
                const summary = document.getElementById('summary-card');
                summary.innerHTML = `<h3>Summary</h3><p style="color:red;">Initialization error: ${message}</p>`;
                resetVisualization('Visualization unavailable due to initialization error.');
                return;
            }

            toolDocumentation = Object.fromEntries(docMap);
            if (toolDocumentation.parameters) {
                toolDocumentation.parameters = Object.fromEntries(toolDocumentation.parameters);
            }
            if (toolDocumentation.returns) {
                toolDocumentation.returns = Object.fromEntries(toolDocumentation.returns);
            }

            populateUiFromDocs();
            document.getElementById("calculate-btn").textContent = "Calculate Heat Flow";
        }
        main();

        function populateUiFromDocs() {
            if (toolDocumentation.description) {
                document.getElementById("tool-description").textContent = toolDocumentation.description;
            }

            document.querySelectorAll('.input-group[data-param]').forEach(group => {
                const key = group.dataset.param;
                const tooltip = group.querySelector('.tooltip-trigger');
                if (tooltip && toolDocumentation.parameters?.[key]) {
                    tooltip.setAttribute('data-tooltip', toolDocumentation.parameters[key]);
                }
            });

            const latexBlock = toolDocumentation.latex
                ? toolDocumentation.latex.split('\n').filter(line => line.trim().length > 0)
                : [];
            const references = toolDocumentation.references
                ? toolDocumentation.references.replace(/\n/g, '<br>')
                : 'Incropera et al. (2007) and ASHRAE Handbook – Fundamentals (2017).';
            const equationInfo = [
                {
                    label: 'Film Resistance',
                    expression: 'R_{\\text{film}} = \\frac{1}{h \\; A}',
                    description: 'Thermal resistance across an interior or exterior convection film.',
                    variables: [
                        { symbol: 'R_{\\text{film}}', explanation: 'Film resistance (K/W)' },
                        { symbol: 'h', explanation: 'Convection heat-transfer coefficient (W/m²·K)' },
                        { symbol: 'A', explanation: 'Wall area normal to heat flow (m²)' }
                    ]
                },
                {
                    label: 'Layer Resistance',
                    expression: 'R_{j} = \\frac{L_{j}}{k_{j} \\; A}',
                    description: 'Conduction resistance of layer j within the wall.',
                    variables: [
                        { symbol: 'R_{j}', explanation: 'Resistance of layer j (K/W)' },
                        { symbol: 'L_{j}', explanation: 'Thickness of layer j (m)' },
                        { symbol: 'k_{j}', explanation: 'Thermal conductivity of layer j (W/m·K)' },
                        { symbol: 'A', explanation: 'Wall area normal to heat flow (m²)' }
                    ]
                },
                {
                    label: 'Total Resistance',
                    expression: 'R_{\\text{total}} = R_{\\text{film,i}} + \\sum_{j=1}^{N} R_j + R_{\\text{film,o}}',
                    description: 'Series combination of all film and conduction resistances.',
                    variables: [
                        { symbol: 'R_{\\text{total}}', explanation: 'Total wall resistance (K/W)' },
                        { symbol: 'R_{\\text{film,i}}', explanation: 'Interior film resistance (K/W)' },
                        { symbol: 'R_{\\text{film,o}}', explanation: 'Exterior film resistance (K/W)' },
                        { symbol: 'R_j', explanation: 'Resistance of layer j (K/W)' }
                    ]
                },
                {
                    label: 'Heat Transfer Rate',
                    expression: '\\dot{Q} = \\frac{T_{\\text{i}} - T_{\\text{o}}}{R_{\\text{total}}}',
                    description: 'Net steady-state heat flow through the wall.',
                    variables: [
                        { symbol: '\\dot{Q}', explanation: 'Heat transfer rate (W)' },
                        { symbol: 'T_{\\text{i}}', explanation: 'Interior ambient temperature (°C)' },
                        { symbol: 'T_{\\text{o}}', explanation: 'Exterior ambient temperature (°C)' },
                        { symbol: 'R_{\\text{total}}', explanation: 'Total wall resistance (K/W)' }
                    ]
                },
                {
                    label: 'Heat Flux',
                    expression: 'q\'\' = \\frac{\\dot{Q}}{A}',
                    description: 'Heat transfer rate per unit area of wall.',
                    variables: [
                        { symbol: 'q\'\'', explanation: 'Heat flux (W/m²)' },
                        { symbol: '\\dot{Q}', explanation: 'Heat transfer rate (W)' },
                        { symbol: 'A', explanation: 'Wall area (m²)' }
                    ]
                },
                {
                    label: 'Overall U-Value',
                    expression: 'U = \\frac{1}{A \\; R_{\\text{total}}}',
                    description: 'Overall heat-transfer coefficient for the assembly.',
                    variables: [
                        { symbol: 'U', explanation: 'Overall U-value (W/m²·K)' },
                        { symbol: 'A', explanation: 'Wall area (m²)' },
                        { symbol: 'R_{\\text{total}}', explanation: 'Total wall resistance (K/W)' }
                    ]
                },
                {
                    label: 'Imperial Conversions',
                    expression: 'R_{\\text{IP}} = R_{\\text{SI}} \\times 5.678263,\\qquad U_{\\text{IP}} = U_{\\text{SI}} \\times 0.176110',
                    description: 'Unit conversions between SI and inch–pound systems.',
                    variables: [
                        { symbol: 'R_{\\text{IP}}', explanation: 'Total resistance in hr·ft²·°F/BTU' },
                        { symbol: 'R_{\\text{SI}}', explanation: 'Total resistance in K/W' },
                        { symbol: 'U_{\\text{IP}}', explanation: 'U-value in BTU/(hr·ft²·°F)' },
                        { symbol: 'U_{\\text{SI}}', explanation: 'U-value in W/(m²·K)' }
                    ]
                }
            ];

            document.getElementById('background').innerHTML = `
                <h3>Thermal Resistance Network</h3>
                <p>${(toolDocumentation.description || '').replace(/\n/g, '<br>')}</p>
                <h4>Governing Equations</h4>
                <div class="equation-list">
                    ${equationInfo.map((item, index) => `
                        <div class="equation-wrapper">
                            <strong>Equation (${index + 1}): ${item.label}</strong>
                            <span class="equation-expression">\\[ ${item.expression} \\]</span>
                            <p style="font-size:0.88rem;color:var(--text-light);">${item.description}</p>
                            <ul class="variable-list">
                                ${item.variables.map(variable => `
                                    <li><span class="math-inline">\\(${variable.symbol}\\)</span>: ${variable.explanation}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `).join('')}
                </div>
                <h4>References</h4>
                <p>${references}</p>
            `;
            typesetMath();
        }

        function coerceNumber(value) {
            if (value === '' || value === null || value === undefined) {
                return null;
            }
            const parsed = Number(value);
            return Number.isFinite(parsed) ? parsed : NaN;
        }

        document.getElementById('calc-form').addEventListener('submit', (event) => {
            event.preventDefault();

            const area = coerceNumber(document.getElementById('area').value);
            const tInterior = coerceNumber(document.getElementById('interior-temperature').value);
            const tExterior = coerceNumber(document.getElementById('exterior-temperature').value);
            const hInterior = coerceNumber(document.getElementById('interior-h').value);
            const hExterior = coerceNumber(document.getElementById('exterior-h').value);
            const layerCount = Number(document.getElementById('layer-count').value);

            const thicknesses = [];
            const conductivities = [];

            for (let i = 1; i <= layerCount; i += 1) {
                const thickness = coerceNumber(document.getElementById(`layer-${i}-thickness`).value);
                const conductivity = coerceNumber(document.getElementById(`layer-${i}-k`).value);
                thicknesses.push(thickness);
                conductivities.push(conductivity);
            }

            try {
                if (!Number.isFinite(area) || area === null || area <= 0) {
                    throw new Error('Area must be a positive number.');
                }
                if (!Number.isFinite(tInterior) || !Number.isFinite(tExterior)) {
                    throw new Error('Interior and exterior temperatures must be numeric.');
                }

                thicknesses.forEach((value, index) => {
                    if (!Number.isFinite(value) || value === null || value <= 0) {
                        throw new Error(`Layer ${index + 1} thickness must be greater than zero.`);
                    }
                });
                conductivities.forEach((value, index) => {
                    if (!Number.isFinite(value) || value === null || value <= 0) {
                        throw new Error(`Layer ${index + 1} conductivity must be greater than zero.`);
                    }
                });

                const hiArg = Number.isFinite(hInterior) && hInterior > 0 ? hInterior : null;
                const hoArg = Number.isFinite(hExterior) && hExterior > 0 ? hExterior : null;
                latestInputs = { area, tInterior, tExterior, hInterior: hiArg, hExterior: hoArg };

                const resultMap = pyToolModule[TOOL_FUNCTION_NAME](
                    area,
                    tInterior,
                    tExterior,
                    thicknesses,
                    conductivities,
                    hiArg,
                    hoArg
                ).toJs();

                const results = Object.fromEntries(resultMap);
                if (results.error) {
                    throw new Error(results.error);
                }

                latestResults = results;
                renderSummary(results, latestInputs);
                renderMainResults(results, latestInputs);
                renderVisualization(results);
            } catch (error) {
                latestResults = null;
                document.getElementById('results-display').innerHTML = `
                    <p style="color: red; font-weight: bold;">Calculation Error:</p>
                    <p style="color: red;">${error.message}</p>
                `;
                const summary = document.getElementById('summary-card');
                summary.innerHTML = `<h3>Summary</h3><p style="color:red;">${error.message}</p>`;
                resetVisualization('Visualization unavailable due to calculation error.');
            }
        });

        function renderSummary(results, inputs) {
            const summary = document.getElementById('summary-card');
            if (!summary) return;

            const heatFlux = formatNumber(results.heat_flux);
            const heatFluxIp = formatNumber(results.heat_flux_ip);
            const uValue = formatNumber(results.overall_u_value);
            const uValueIp = formatNumber(results.overall_u_value_ip);
            const totalR = formatNumber(results.total_thermal_resistance);
            const totalRip = formatNumber(results.total_r_value_ip);
            const q = formatNumber(results.heat_transfer_rate);
            const qIp = formatNumber(results.heat_transfer_rate_ip);

            const areaLine = Number.isFinite(inputs.area)
                ? `<span style="color:var(--text-light); font-size:0.82rem;">(Computed as ${formatNumber(results.heat_transfer_rate)} W ÷ ${formatNumber(inputs.area)} m²)</span>`
                : '';

            summary.innerHTML = `
                <h3>Summary</h3>
                <p><strong>Heat flux:</strong> ${heatFlux} W/m² <span style="color:var(--text-light);">(${heatFluxIp} BTU/hr·ft²)</span><br>${areaLine}</p>
                <p><strong>Overall U-value:</strong> ${uValue} W/m²·K <span style="color:var(--text-light);">(${uValueIp} BTU/hr·ft²·°F)</span></p>
                <p><strong>Total R-value:</strong> ${totalR} K/W <span style="color:var(--text-light);">(${totalRip} hr·ft²·°F/BTU)</span></p>
                <p><strong>Heat transfer rate:</strong> ${q} W <span style="color:var(--text-light);">(${qIp} BTU/hr)</span></p>
            `;
        }

        function renderMainResults(results, inputs) {
            const resultsDiv = document.getElementById('results-display');
            if (!resultsDiv) return;
            document.getElementById("results-placeholder")?.remove();
            resultsDiv.innerHTML = '';

            const metricsBlock = document.createElement('section');
            metricsBlock.className = 'results-block';
            metricsBlock.innerHTML = `
                <h4>Primary Metrics</h4>
                <div class="metric-grid">
                    <div class="metric">
                        <span>Heat flux</span>
                        <strong>${formatNumber(results.heat_flux)} W/m²</strong>
                        <small>${formatNumber(results.heat_flux_ip)} BTU/hr·ft²</small>
                        ${Number.isFinite(inputs.area)
                            ? `<small style="display:block;color:var(--text-light);margin-top:4px;">q'' = ${formatNumber(results.heat_transfer_rate)} W ÷ ${formatNumber(inputs.area)} m²</small>`
                            : ''}
                    </div>
                    <div class="metric">
                        <span>Overall U-value</span>
                        <strong>${formatNumber(results.overall_u_value)} W/m²·K</strong>
                        <small>${formatNumber(results.overall_u_value_ip)} BTU/hr·ft²·°F</small>
                    </div>
                    <div class="metric">
                        <span>Total R-value</span>
                        <strong>${formatNumber(results.total_thermal_resistance)} K/W</strong>
                        <small>${formatNumber(results.total_r_value_ip)} hr·ft²·°F/BTU</small>
                    </div>
                    <div class="metric">
                        <span>Heat transfer rate</span>
                        <strong>${formatNumber(results.heat_transfer_rate)} W</strong>
                        <small>${formatNumber(results.heat_transfer_rate_ip)} BTU/hr</small>
                    </div>
                </div>
            `;
            resultsDiv.appendChild(metricsBlock);

            const resistanceBlock = document.createElement('section');
            resistanceBlock.className = 'results-block';
            resistanceBlock.innerHTML = `
                <h4>Thermal Resistance Breakdown</h4>
                ${buildResistanceTable(results)}
            `;
            resultsDiv.appendChild(resistanceBlock);

            const profileBlock = document.createElement('section');
            profileBlock.className = 'results-block';
            profileBlock.innerHTML = `
                <h4>Interface Temperature Profile</h4>
                ${buildTemperatureTable(results)}
            `;
            resultsDiv.appendChild(profileBlock);

            const derivationBlock = document.createElement('section');
            derivationBlock.className = 'results-block';
            derivationBlock.innerHTML = `
                <h4>Key Derivations</h4>
                ${buildDerivationDetails(results)}
            `;
            resultsDiv.appendChild(derivationBlock);

            typesetMath();
        }

        function buildResistanceTable(results) {
            const conduction = results.layer_resistances || [];
            const conductionSub = results.subst_layer_resistances || [];
            const films = results.film_resistances || {};
            const filmSub = results.subst_film_resistances || {};

            let rows = '';
            conduction.forEach((value, index) => {
                const layerName = index + 1 === conduction.length
                    ? `Layer ${index + 1} (outermost)`
                    : `Layer ${index + 1}`;
                rows += `
                    <tr>
                        <td>${layerName}</td>
                        <td>${formatNumber(value)} K/W</td>
                        <td>${conductionSub[index] ? `$$${conductionSub[index]}$$` : ''}</td>
                    </tr>
                `;
            });

            if (films.interior !== undefined) {
                rows = `
                    <tr>
                        <td>Interior film (h<sub>i</sub>)</td>
                        <td>${formatNumber(films.interior)} K/W</td>
                        <td>${filmSub.interior ? `$$${filmSub.interior}$$` : ''}</td>
                    </tr>
                ` + rows;
            }
            if (films.exterior !== undefined) {
                rows += `
                    <tr>
                        <td>Exterior film (h<sub>o</sub>)</td>
                        <td>${formatNumber(films.exterior)} K/W</td>
                        <td>${filmSub.exterior ? `$$${filmSub.exterior}$$` : ''}</td>
                    </tr>
                `;
            }

            return `
                <table>
                    <thead>
                        <tr>
                            <th>Element</th>
                            <th>Resistance (K/W)</th>
                            <th>Derivation</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function buildTemperatureTable(results) {
            const profile = normalizeTemperatureProfile(results.temperature_profile);
            if (!profile.length) {
                return '<p>No temperature profile available.</p>';
            }
            const rows = profile.map((node, index) => `
                <tr>
                    <td>${index}</td>
                    <td>${node.name}</td>
                    <td>${formatNumber(node.temperature_c)} °C</td>
                    <td>${node.resistance_k_per_w ? formatNumber(node.resistance_k_per_w) : '—'}</td>
                    <td>${node.type}</td>
                </tr>
            `).join('');

            return `
                <table>
                    <thead>
                        <tr>
                            <th>Node</th>
                            <th>Description</th>
                            <th>Temperature</th>
                            <th>Resistance Applied</th>
                            <th>Type</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function buildDerivationDetails(results) {
            const items = [
                results.subst_heat_transfer_rate,
                results.subst_heat_transfer_rate_ip,
                results.subst_heat_flux,
                results.subst_heat_flux_ip,
                results.subst_overall_u_value,
                results.subst_overall_u_value_ip,
                results.subst_total_thermal_resistance,
                results.subst_total_r_value_ip
            ].filter(Boolean);

            if (!items.length) {
                return '<p>No derivations available.</p>';
            }

            const list = items.map(entry => `<li>$$${entry}$$</li>`).join('');
            return `<ul>${list}</ul>`;
        }

        function renderVisualization(results) {
            const container = document.getElementById('plot-container');
            if (!window.Plotly) {
                resetVisualization('Plotly failed to load. Refresh to retry the visualization.');
                return;
            }

            const profile = normalizeTemperatureProfile(results.temperature_profile);
            if (profile.length < 2) {
                resetVisualization('Run a calculation to view the temperature distribution across the wall.');
                return;
            }

            const xPositions = buildResistanceAxis(profile);
            const labels = profile.map(node => node.name);
            const temperatures = profile.map(node => Number(node.temperature_c) || 0);
            const hoverText = profile.map((node, index) => {
                const resistance = Number(node.resistance_k_per_w);
                return `<b>${node.name}</b><br>Node ${index}<br>Type: ${node.type}` +
                    `<br>R element: ${resistance ? formatNumber(resistance) + ' K/W' : '—'}` +
                    `<br>Temperature: ${formatNumber(node.temperature_c)} °C`;
            });

            const trace = {
                type: 'scatter',
                mode: 'lines+markers',
                x: xPositions,
                y: temperatures,
                line: {color: '#1d4ed8', width: 3, shape: 'linear'},
                marker: {
                    size: 11,
                    color: profile.map(node => node.type === 'conduction' ? '#1d4ed8' : '#16a34a'),
                    symbol: profile.map(node => node.type === 'conduction' ? 'circle' : 'diamond'),
                    line: {color: '#fff', width: 1.5}
                },
                text: hoverText,
                hovertemplate: '%{text}<extra></extra>',
                name: 'Temperature profile'
            };

            const layout = {
                margin: {l: 70, r: 30, t: 40, b: 120},
                xaxis: {
                    title: 'Cumulative thermal resistance (K/W)',
                    tickvals: xPositions,
                    ticktext: labels,
                    tickangle: -35,
                    showgrid: true,
                    gridcolor: '#e2e8f0',
                    zeroline: false,
                    automargin: true
                },
                yaxis: {
                    title: 'Temperature (°C)',
                    showgrid: true,
                    gridcolor: '#e2e8f0',
                    zeroline: false,
                    automargin: true
                },
                hovermode: 'closest',
                showlegend: false,
                paper_bgcolor: 'rgba(255,255,255,0)',
                plot_bgcolor: '#ffffff'
            };

            const config = {
                responsive: true,
                displaylogo: false,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                toImageButtonOptions: {filename: 'composite-wall-temperature-profile'}
            };

            container.innerHTML = '';
            window.Plotly.newPlot(container, [trace], layout, config);
        }

        function resetVisualization(message = 'Run a calculation to view the temperature distribution across the wall.') {
            const container = document.getElementById('plot-container');
            container.innerHTML = `<p>${message}</p>`;
        }

        function formatNumber(value) {
            if (!Number.isFinite(value)) {
                return '—';
            }
            const absVal = Math.abs(value);
            if (absVal !== 0 && (absVal >= 9_999 || absVal < 0.005)) {
                return value.toExponential(3);
            }
            return value.toLocaleString(undefined, { maximumFractionDigits: 4 });
        }

        function normalizeTemperatureProfile(rawProfile) {
            if (!rawProfile) {
                return [];
            }
            return Array.from(rawProfile, (node, index) => {
                if (node && typeof node === 'object') {
                    if (typeof node.get === 'function') {
                        return {
                            name: node.get('name'),
                            type: node.get('type'),
                            temperature_c: node.get('temperature_c'),
                            resistance_k_per_w: node.get('resistance_k_per_w')
                        };
                    }
                    return {
                        name: node.name ?? `Interface ${index}`,
                        type: node.type ?? 'conduction',
                        temperature_c: Number(node.temperature_c ?? node.temperature ?? 0),
                        resistance_k_per_w: Number(node.resistance_k_per_w ?? node.resistance ?? 0)
                    };
                }
                return {
                    name: `Interface ${index}`,
                    type: 'conduction',
                    temperature_c: Number(node) || 0,
                    resistance_k_per_w: 0
                };
            });
        }

        function buildResistanceAxis(profile) {
            const positions = [];
            let cumulative = 0;
            profile.forEach(node => {
                positions.push(cumulative);
                const increment = Number(node.resistance_k_per_w) || 0;
                cumulative += increment || (node.type === 'convection' ? 0.001 : 0);
            });
            return positions;
        }
    </script>
</body>
</html>

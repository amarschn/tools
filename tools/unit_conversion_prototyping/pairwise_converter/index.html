<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pairwise Converter Prototype - Engineering Tools</title>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <style>
        :root {
            --primary-color: #212529;
            --primary-light: #f8f9fa;
            --secondary-color: #495057;
            --text-color: #212529;
            --text-light: #6c757d;
            --border-color: #dee2e6;
            --bg-color: #f8f9fa;
            --bg-card: #ffffff;
            --shadow: 0 8px 18px rgba(15, 23, 42, 0.05);
            --border-radius: 10px;
            --accent-color: #3b82f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }
        .container { width: 94%; max-width: 1200px; margin: 0 auto; padding: 24px 0 40px; }
        h1, h2, h3 { color: var(--primary-color); line-height: 1.2; font-weight: 600; }
        h1 { font-size: 2.35rem; margin-bottom: 0.5rem; }
        h2 { font-size: 1.7rem; border-bottom: 2px solid var(--border-color); padding-bottom: 12px; margin-bottom: 1.25rem; }
        h3 { font-size: 1.2rem; margin-bottom: 0.75rem; color: var(--secondary-color); }
        p { margin-bottom: 1rem; color: var(--text-light); }

        .navbar { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(15, 23, 42, 0.05); padding: 0 5%; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; height: 64px; max-width: 1200px; margin: 0 auto; }
        .nav-brand { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); text-decoration: none; }

        main.container { flex-grow: 1; }
        .tool-description { font-size: 1.05rem; max-width: 80ch; margin-bottom: 1.5rem; color: var(--secondary-color); }
        .tool-layout { display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1.45fr); gap: 28px; }
        .card { background-color: var(--bg-card); border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); padding: 24px 28px; }

        details > summary { list-style: none; cursor: pointer; font-weight: 600; color: var(--secondary-color); }
        details > summary::-webkit-details-marker { display: none; }
        .purpose-section { margin-bottom: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--bg-card); overflow: hidden; }
        .purpose-section summary { padding: 18px 24px; font-size: 1.05rem; display: flex; justify-content: space-between; align-items: center; }
        .purpose-section summary::after { content: 'Expand'; font-weight: 500; font-size: 0.85rem; color: var(--text-light); }
        .purpose-section[open] > summary::after { content: 'Hide'; }
        .purpose-content { padding: 0 24px 24px; border-top: 1px solid var(--border-color); }
        .purpose-content code { background-color: var(--bg-color); padding: 2px 4px; border-radius: 4px; }
        .purpose-content ul { padding-left: 20px; margin-top: 0.75rem; }

        .input-group { margin-bottom: 1.4rem; }
        .input-group label { display: inline-flex; align-items: center; gap: 8px; font-weight: 600; font-size: 0.95rem; color: var(--secondary-color); margin-bottom: 6px; }
        .input-group select, .input-group input[type="number"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #fff;
        }
        .input-group select:focus, .input-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
        }
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: var(--border-color);
            color: var(--text-light);
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            cursor: help;
            position: relative;
            transform: translateY(-1px);
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.3;
            width: max-content;
            max-width: 220px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        .tooltip-trigger:hover::after { opacity: 1; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: transform 0.15s ease, box-shadow 0.2s ease;
        }
        .btn-primary {
            background-color: var(--accent-color);
            color: #ffffff;
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.25);
        }
        .btn-primary:hover { transform: translateY(-1px); }
        .btn-ghost {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px dashed var(--accent-color);
        }

        .tab-strip { display: flex; gap: 10px; margin-bottom: 1.2rem; }
        .tab-link {
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 0.95rem;
            color: var(--secondary-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-link.active {
            background-color: var(--accent-color);
            border-color: transparent;
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        }

        #results-display { display: grid; gap: 14px; }
        .result-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 18px;
            background-color: rgba(248, 250, 252, 0.6);
        }
        .result-header { display: flex; justify-content: space-between; gap: 16px; align-items: center; }
        .result-header strong { color: var(--primary-color); }
        .result-value { font-size: 1.05rem; font-weight: 600; color: var(--secondary-color); }
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 10px;
            font-size: 0.75rem;
            border-radius: 999px;
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--accent-color);
        }
        details.inline-details summary {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            display: grid;
            place-items: center;
            cursor: pointer;
            color: var(--text-light);
            font-size: 0.85rem;
        }
        details.inline-details[open] summary { background-color: var(--accent-color); color: #fff; border-color: transparent; }
        .equation-details { margin-top: 10px; padding-left: 6px; color: var(--text-light); }

        .equation-container { display: grid; gap: 12px; margin-top: 1rem; }
        .equation-card {
            background: rgba(248, 250, 252, 0.75);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 14px 16px;
        }

        footer.footer { background-color: var(--bg-card); border-top: 1px solid var(--border-color); padding: 18px 0; text-align: center; font-size: 0.85rem; color: var(--text-light); }

        @media (max-width: 980px) {
            .tool-layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
        </nav>
    </header>

    <main class="container">
        <h1>Pairwise Converter Prototype</h1>
        <p class="tool-description" id="tool-description">
            Loading documentation…
        </p>

        <details class="purpose-section">
            <summary>Tool Purpose & README</summary>
            <div class="purpose-content" id="readme-content">
                <p>Loading README…</p>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <form id="calc-form">
                    <div class="input-group">
                        <label for="quantity">Quantity
                            <span class="tooltip-trigger" id="tooltip-quantity" data-tooltip="Loading…">?</span>
                        </label>
                        <select id="quantity" name="quantity"></select>
                    </div>
                    <div class="input-group">
                        <label for="from_unit">From unit
                            <span class="tooltip-trigger" id="tooltip-from_unit" data-tooltip="Loading…">?</span>
                        </label>
                        <select id="from_unit" name="from_unit"></select>
                    </div>
                    <div class="input-group">
                        <label for="to_unit">To unit
                            <span class="tooltip-trigger" id="tooltip-to_unit" data-tooltip="Loading…">?</span>
                        </label>
                        <select id="to_unit" name="to_unit"></select>
                    </div>
                    <div class="input-group">
                        <label for="value">Value
                            <span class="tooltip-trigger" id="tooltip-value" data-tooltip="Loading…">?</span>
                        </label>
                        <input type="number" step="any" id="value" name="value" placeholder="e.g., 5.5">
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary" id="calculate-btn">Calculate</button>
                        <button type="button" class="btn btn-ghost" id="swap-units-btn">Swap units</button>
                    </div>
                </form>
            </section>

            <section class="tool-outputs card">
                <div class="tab-strip">
                    <button class="tab-link active" data-target="results">Results</button>
                    <button class="tab-link" data-target="background">Background</button>
                </div>

                <div id="results" class="tab-content" style="display: block;">
                    <h3>Conversion Summary</h3>
                    <div id="results-display">
                        <p id="results-placeholder">Enter a value and press <em>Calculate</em> to see the conversion.</p>
                    </div>
                </div>

                <div id="background" class="tab-content" style="display:none;">
                    <h3>Underlying Principles</h3>
                    <div id="background-description">
                        <p>Documentation and equations will appear here after the tool loads.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Engineering Tools. All tools are for educational purposes.</p>
    </footer>

    <script>
        const TOOL_MODULE_NAME = 'unit_prototypes';
        const TOOL_FUNCTION_NAME = 'convert_unit_pair';
        const PARAM_IDS = ['quantity', 'from_unit', 'to_unit', 'value'];

        let pyodideInstance;
        let pyUtils;
        let pyUnits;
        let pyToolModule;
        let toolDocumentation = {};
        let unitCatalog = {};

        function mapToObject(maybeMap) {
            if (maybeMap instanceof Map) {
                return Object.fromEntries(
                    Array.from(maybeMap, ([key, value]) => [key, mapToObject(value)])
                );
            }
            return maybeMap;
        }

        function openTab(targetId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = tab.id === targetId ? 'block' : 'none';
            });
            document.querySelectorAll('.tab-link').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === targetId);
            });
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }

        document.querySelectorAll('.tab-link').forEach(btn => {
            btn.addEventListener('click', (event) => {
                event.preventDefault();
                openTab(btn.dataset.target);
            });
        });

        async function loadReadme() {
            try {
                const response = await fetch('./README.md');
                const text = await response.text();
                const formatted = text
                    .replace(/^# (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h4>$1</h4>')
                    .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                    .replace(/^- (.*$)/gim, '<li>$1</li>')
                    .replace(/\n{2,}/g, '</p><p>')
                    .replace(/<li>(.*?)<\/li>/gim, '<ul><li>$1</li></ul>');
                document.getElementById('readme-content').innerHTML = `<p>${formatted}</p>`;
            } catch (error) {
                document.getElementById('readme-content').innerHTML = '<p>Unable to load README.</p>';
            }
        }

        function populateTooltips() {
            if (!toolDocumentation.parameters) {
                return;
            }
            Object.entries(toolDocumentation.parameters).forEach(([key, description]) => {
                const tooltip = document.getElementById(`tooltip-${key}`);
                if (tooltip) {
                    tooltip.setAttribute('data-tooltip', description);
                }
            });
        }

        function populateBackground() {
            const container = document.getElementById('background-description');
            const latexLines = toolDocumentation.latex
                ? toolDocumentation.latex.split('\\n').filter(line => line.trim().length > 0)
                : [];
            const descriptionHtml = toolDocumentation.description
                ? toolDocumentation.description.replace(/\\n/g, '<br>')
                : 'No description provided.';
            const equationCards = latexLines.map((expression, index) => `
                <div class="equation-card">
                    <strong>Equation (${index + 1})</strong>
                    <div class="equation-expression">\\[ ${expression} \\]</div>
                </div>
            `).join('');
            container.innerHTML = `
                <p>${descriptionHtml}</p>
                <h4 style="margin-top:1rem;">Equations</h4>
                <div class="equation-container">
                    ${equationCards || '<p>No equations provided.</p>'}
                </div>
            `;
            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }

        function populateQuantities(quantities) {
            const select = document.getElementById('quantity');
            select.innerHTML = '';
            quantities.forEach((quantity) => {
                const option = document.createElement('option');
                option.value = quantity;
                option.textContent = quantity.charAt(0).toUpperCase() + quantity.slice(1).replace(/_/g, ' ');
                select.appendChild(option);
            });
            select.addEventListener('change', () => {
                updateUnitDropdowns(select.value);
            });
            if (quantities.length) {
                updateUnitDropdowns(quantities[0]);
            }
        }

        function updateUnitDropdowns(quantity) {
            const unitMap = unitCatalog[quantity] || {};
            const fromSelect = document.getElementById('from_unit');
            const toSelect = document.getElementById('to_unit');
            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';

            Object.entries(unitMap).forEach(([symbol, info]) => {
                const optionA = document.createElement('option');
                optionA.value = symbol;
                optionA.textContent = `${symbol} — ${info.name}`;

                const optionB = optionA.cloneNode(true);

                fromSelect.appendChild(optionA);
                toSelect.appendChild(optionB);
            });

            if (fromSelect.options.length > 1) {
                toSelect.selectedIndex = 1;
            }
        }

        function swapUnits() {
            const fromSelect = document.getElementById('from_unit');
            const toSelect = document.getElementById('to_unit');
            const oldFrom = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = oldFrom;
        }

        function formatResultValue(value) {
            if (typeof value === 'boolean') {
                return value ? 'Yes' : 'No';
            }
            if (typeof value === 'number') {
                if (!Number.isFinite(value)) {
                    return value.toString();
                }
                if (Math.abs(value) >= 1e4 || Math.abs(value) <= 1e-3) {
                    return value.toExponential(4);
                }
                return value.toLocaleString(undefined, { maximumFractionDigits: 6 });
            }
            return value;
        }

        function renderResults(results) {
            const resultsDiv = document.getElementById('results-display');
            resultsDiv.innerHTML = '';

            const returns = toolDocumentation.returns || {};
            const equations = (toolDocumentation.latex || '').split('\\n');
            let equationIndex = 0;

            Object.entries(returns).forEach(([key, description]) => {
                const value = results[key];
                const subst = results[`subst_${key}`];
                const equation = equations[equationIndex] || '';
                equationIndex += 1;

                const displayName = key
                    .split('_')
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                    .join(' ');

                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <div class="result-header">
                        <div>
                            <strong>${displayName}</strong>
                            <span class="badge" title="${description}">Definition</span>
                        </div>
                        <div class="result-value">${formatResultValue(value)}</div>
                    </div>
                    <details class="inline-details">
                        <summary>?</summary>
                        <div class="equation-details">
                            ${equation ? `<p><strong>Equation:</strong> $$${equation}$$</p>` : ''}
                            ${subst ? `<p><strong>Substitution:</strong> $$${subst}$$</p>` : ''}
                        </div>
                    </details>
                `;
                resultsDiv.appendChild(item);
            });

            if (window.MathJax) {
                window.MathJax.typesetPromise();
            }
        }

        async function initializePyodide() {
            document.getElementById('calculate-btn').textContent = 'Loading Pyodide…';
            pyodideInstance = await loadPyodide();
            await pyodideInstance.loadPackage('micropip');

            document.getElementById('calculate-btn').textContent = 'Loading Python…';
            const bootstrapScript = `
import micropip
from pyodide.http import pyfetch

response_utils = await pyfetch('../../pycalcs/utils.py')
with open('utils.py', 'w') as f:
    f.write(await response_utils.string())

response_units = await pyfetch('../../pycalcs/units.py')
with open('units.py', 'w') as f:
    f.write(await response_units.string())

response_tool = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
with open('${TOOL_MODULE_NAME}.py', 'w') as f:
    f.write(await response_tool.string())

import utils
import units
import ${TOOL_MODULE_NAME}
`;

            await pyodideInstance.runPythonAsync(bootstrapScript);

            pyUtils = pyodideInstance.globals.get('utils');
            pyUnits = pyodideInstance.globals.get('units');
            pyToolModule = pyodideInstance.globals.get(TOOL_MODULE_NAME);

            const docMap = pyUtils.get_documentation(TOOL_MODULE_NAME, TOOL_FUNCTION_NAME).toJs();
            if (docMap.has('error')) {
                throw new Error(docMap.get('error'));
            }

            toolDocumentation = Object.fromEntries(docMap);
            if (toolDocumentation.parameters) {
                toolDocumentation.parameters = Object.fromEntries(toolDocumentation.parameters);
            }
            if (toolDocumentation.returns) {
                toolDocumentation.returns = Object.fromEntries(toolDocumentation.returns);
            }
            document.getElementById('tool-description').textContent = toolDocumentation.description || '';
            populateTooltips();
            populateBackground();

            const quantityList = Array.from(pyUnits.list_supported_quantities().toJs());
            unitCatalog = mapToObject(pyUnits.get_unit_catalog().toJs());
            populateQuantities(quantityList);
            document.getElementById('calculate-btn').textContent = 'Calculate';
        }

        document.getElementById('swap-units-btn').addEventListener('click', (event) => {
            event.preventDefault();
            swapUnits();
        });

        document.getElementById('calc-form').addEventListener('submit', (event) => {
            event.preventDefault();
            try {
                const args = PARAM_IDS.map((id) => document.getElementById(id).value || '');
                const resultMap = pyToolModule[TOOL_FUNCTION_NAME](...args).toJs();
                const results = Object.fromEntries(resultMap);
                if (results.error) {
                    throw new Error(results.error);
                }
                renderResults(results);
            } catch (error) {
                document.getElementById('results-display').innerHTML = `
                    <div class="result-item" style="border-color:#f87171;background:rgba(248, 113, 113, 0.08);">
                        <strong style="color:#b91c1c;">Calculation Error</strong>
                        <p style="margin-top:0.5rem;color:#b91c1c;">${error.message}</p>
                    </div>
                `;
            }
        });

        loadReadme();
        initializePyodide().catch((error) => {
            document.getElementById('results-display').innerHTML = `
                <div class="result-item" style="border-color:#f87171;background:rgba(248, 113, 113, 0.08);">
                    <strong style="color:#b91c1c;">Initialization Error</strong>
                    <p style="margin-top:0.5rem;color:#b91c1c;">${error.message}</p>
                </div>
            `;
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beam Bending Calculator - Engineering Tools</title>
    <meta name="description" content="Calculate deflection, stress, shear and bending moment for beams with various support conditions and loading. Includes safety checks and interactive diagrams.">

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        /* =============================================================================
           1. CSS VARIABLES & RESET (Polestar-Inspired)
           ============================================================================= */
        :root {
            --primary-color: #0b0d12;
            --primary-light: #f4f5f7;
            --secondary-color: #4b5563;
            --accent-color: #111827;
            --success-color: #0f766e;
            --warning-color: #b45309;
            --danger-color: #b91c1c;
            --text-color: #111827;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --bg-color: #f8f9fb;
            --bg-card: #ffffff;
            --shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 6px 18px rgba(15, 23, 42, 0.08);
            --border-radius: 8px;
            --font-sans: 'Helvetica Neue', 'Avenir Next', system-ui, sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-sans);
            line-height: 1.6;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* =============================================================================
           2. LOADING OVERLAY
           ============================================================================= */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-weight: 600; color: var(--text-color); }

        /* =============================================================================
           3. LAYOUT
           ============================================================================= */
        .container { width: 92%; max-width: 1400px; margin: 0 auto; padding: 24px 0; }
        .navbar {
            background: var(--primary-color);
            border-bottom: none;
            box-shadow: var(--shadow);
            padding: 0 5%;
        }
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .nav-brand { font-size: 1.25rem; font-weight: 600; color: #fff; text-decoration: none; }
        .nav-brand:hover { text-decoration: none; opacity: 0.85; }

        main.container { flex-grow: 1; }

        h1, h2, h3, h4 { color: var(--primary-color); margin-bottom: 0.75em; line-height: 1.2; font-weight: 600; }
        h1 { font-size: 2.25rem; letter-spacing: -0.02em; }
        h2 { font-size: 1.375rem; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
        h3 { font-size: 1.1rem; color: var(--secondary-color); }
        p { margin-bottom: 1em; color: var(--text-light); }

        .tool-header { text-align: center; margin-bottom: 2rem; }
        .tool-header h1 { margin-bottom: 0.5rem; }
        .tool-description { font-size: 1.1rem; max-width: 70ch; margin: 0 auto 1.5rem; color: var(--text-light); }

        .tool-layout {
            display: grid;
            grid-template-columns: minmax(360px, 0.9fr) minmax(480px, 1.1fr);
            gap: 28px;
            align-items: start;
        }

        .card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 24px;
        }

        /* =============================================================================
           4. PURPOSE/README SECTION
           ============================================================================= */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .purpose-section {
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-card);
        }
        .purpose-section summary {
            padding: 16px 24px;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .purpose-section summary::after {
            content: 'Expand';
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent-color);
            background: var(--primary-light);
            padding: 4px 12px;
            border-radius: 20px;
        }
        .purpose-section[open] > summary::after { content: 'Collapse'; }
        .purpose-content { padding: 0 24px 24px 24px; border-top: 1px solid var(--border-color); }
        .purpose-content h3 { margin-top: 1rem; }
        .purpose-content ul { padding-left: 20px; margin-bottom: 1rem; }

        /* =============================================================================
           5. MODE TOGGLE
           ============================================================================= */
        .mode-toggle-wrap { display: flex; align-items: center; gap: 16px; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .mode-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        .mode-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-light);
            transition: all 0.2s;
        }
        .mode-btn.active { background: var(--accent-color); color: white; }
        .mode-btn:hover:not(.active) { background: var(--primary-light); color: var(--text-color); }
        .mode-desc { font-size: 0.875rem; color: var(--text-light); flex: 1; min-width: 300px; }

        /* =============================================================================
           6. INPUT SECTION
           ============================================================================= */
        .tool-inputs h2 { margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; }
        .tool-inputs h2::before { content: ''; width: 4px; height: 24px; background: var(--accent-color); border-radius: 2px; }

        .input-tabs { display: flex; gap: 6px; margin-bottom: 1.25rem; flex-wrap: wrap; }
        .input-tab {
            flex: 1 1 auto;
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-card);
            color: var(--secondary-color);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: background-color 0.15s ease, border-color 0.15s ease;
            text-align: center;
        }
        .input-tab:hover { border-color: var(--text-color); color: var(--text-color); }
        .input-tab.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }
        .input-section { display: none; animation: fadeIn 0.3s ease; }
        .input-section.active { display: block; }

        .input-group { margin-bottom: 1.1rem; position: relative; }
        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.875rem;
            color: var(--text-color);
        }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-family: var(--font-sans);
            transition: border-color 0.15s ease;
            background: var(--bg-card);
            color: var(--text-color);
        }
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--text-color);
        }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .input-helper { font-size: 0.8rem; color: var(--text-light); margin-top: 4px; }

        /* Tooltip */
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px; height: 18px;
            background-color: var(--border-color);
            color: var(--text-light);
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            position: absolute;
            right: 8px;
            top: 42px;
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.5;
            white-space: normal;
            width: 220px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        .tooltip-trigger:hover::after { opacity: 1; visibility: visible; }

        /* Advanced section */
        .advanced-section { display: none; margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border-color); }
        .advanced-section.visible { display: block; }
        .advanced-toggle {
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding: 8px 0;
        }
        .advanced-toggle:hover { text-decoration: underline; }

        /* =============================================================================
           7. BUTTONS
           ============================================================================= */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            transition: background-color 0.15s ease, opacity 0.15s ease;
        }
        .btn-primary {
            background: var(--accent-color);
            color: white;
            width: 100%;
            font-size: 1rem;
            padding: 14px;
            margin-top: 8px;
            box-shadow: var(--shadow);
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary {
            background-color: var(--bg-card);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background-color: var(--primary-light); }

        /* =============================================================================
           8. OUTPUT SECTION
           ============================================================================= */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; gap: 4px; }
        .tab-link {
            padding: 12px 18px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: color 0.15s ease, border-color 0.15s ease;
        }
        .tab-link:hover { color: var(--text-color); }
        .tab-link.active { color: var(--text-color); font-weight: 600; border-bottom-color: var(--text-color); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Results grid */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            transition: all 0.2s;
        }
        .result-card:hover { border-color: var(--accent-color); }
        .result-card.highlight { background: var(--primary-light); border-left: 3px solid var(--accent-color); }
        .result-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .result-card-main { flex: 1; }
        .result-card .label { font-size: 0.8rem; color: var(--text-light); margin-bottom: 6px; font-weight: 500; }
        .result-card .value { font-size: 1.4rem; font-weight: 600; color: var(--primary-color); font-family: var(--font-mono); }
        .result-card .unit { font-size: 0.8rem; color: var(--text-light); margin-left: 4px; }
        .result-card-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .result-card-toggle:hover { background: var(--primary-light); color: var(--text-color); }
        .result-card-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--text-light);
            line-height: 1.6;
        }
        .result-card-details.open { display: block; }
        .result-card-details .detail-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .result-card-details .detail-label { color: var(--text-light); }
        .result-card-details .detail-value { font-family: var(--font-mono); color: var(--text-color); }
        .result-card-details .detail-equation { background: var(--primary-light); padding: 10px; border-radius: 6px; margin-top: 8px; overflow-x: auto; }
        .result-card-details p { margin: 8px 0 0 0; }

        /* Safety gauges */
        .safety-section { margin-top: 24px; }
        .safety-section h4 { margin-bottom: 16px; color: var(--secondary-color); }
        .safety-check-block {
            margin-bottom: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .safety-gauge {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 16px;
        }
        .gauge-label { min-width: 120px; font-weight: 600; font-size: 0.9rem; }
        .gauge-bar-container { flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; position: relative; overflow: visible; }
        .gauge-bar { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
        .gauge-bar.success { background: var(--success-color); }
        .gauge-bar.warning { background: var(--warning-color); }
        .gauge-bar.danger { background: var(--danger-color); }
        .gauge-value { min-width: 60px; text-align: right; font-family: var(--font-mono); font-weight: 600; font-size: 0.9rem; }
        .gauge-value.success { color: var(--success-color); }
        .gauge-value.warning { color: var(--warning-color); }
        .gauge-value.danger { color: var(--danger-color); }
        .gauge-threshold { position: absolute; width: 2px; height: 16px; background: var(--text-color); top: -4px; }
        .gauge-toggle {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            margin-left: 8px;
        }
        .gauge-toggle:hover { background: var(--primary-light); color: var(--text-color); }
        .gauge-toggle[aria-expanded="true"] { transform: rotate(180deg); }
        .gauge-equations {
            display: none;
            padding: 16px;
            background: var(--primary-light);
            border-top: 1px solid var(--border-color);
        }
        .gauge-equations.open { display: block; animation: fadeIn 0.3s ease; }
        .gauge-equations-content .equation-step { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .gauge-equations-content .equation-step:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        /* Status banner */
        .status-banner {
            padding: 18px 24px;
            border-radius: var(--border-radius);
            margin-top: 24px;
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }
        .status-banner .icon { font-size: 1.25rem; }
        .status-banner .content h4 { margin-bottom: 4px; }
        .status-banner .content p { margin-bottom: 0; font-size: 0.9rem; }
        .status-banner.acceptable { background: #ecfdf5; border: 1px solid var(--success-color); }
        .status-banner.acceptable h4 { color: var(--success-color); }
        .status-banner.marginal { background: #fffbeb; border: 1px solid var(--warning-color); }
        .status-banner.marginal h4 { color: var(--warning-color); }
        .status-banner.unacceptable { background: #fef2f2; border: 1px solid var(--danger-color); }
        .status-banner.unacceptable h4 { color: var(--danger-color); }
        .recommendations { margin-top: 8px; padding-left: 20px; }
        .recommendations li { font-size: 0.85rem; margin-bottom: 4px; }

        /* =============================================================================
           9. BEAM DIAGRAM SVG
           ============================================================================= */
        .beam-diagram-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 20px;
        }
        .beam-diagram-container h4 { margin-bottom: 12px; font-size: 0.95rem; }
        #beam-diagram { width: 100%; height: 200px; }

        /* =============================================================================
           10. CHARTS
           ============================================================================= */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 18px;
            margin-bottom: 20px;
        }
        .chart-container h4 { margin-bottom: 12px; font-size: 0.95rem; font-weight: 600; }
        .chart-plot { width: 100%; min-height: 300px; }
        .chart-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .chart-tab {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--bg-card);
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .chart-tab.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .chart-tab:hover:not(.active) { border-color: var(--text-color); }

        /* =============================================================================
           11. DERIVATION PANELS
           ============================================================================= */
        .derivation-panel {
            display: none;
            background: var(--primary-light);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }
        .derivation-panel.visible { display: block; animation: fadeIn 0.3s ease; }
        .derivation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .derivation-title { font-weight: 600; font-size: 1rem; }
        .derivation-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: var(--text-light); }
        .derivation-close:hover { color: var(--text-color); }
        .derivation-step { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .derivation-step:last-child { border-bottom: none; }
        .derivation-step .step-title { font-weight: 500; margin-bottom: 8px; }
        .derivation-step .equation { background: white; padding: 12px; border-radius: 6px; font-size: 0.95rem; overflow-x: auto; }
        .derivation-step .result-box { background: var(--accent-color); color: white; padding: 12px 16px; border-radius: 6px; margin-top: 12px; font-family: var(--font-mono); font-size: 1rem; }

        /* =============================================================================
           12. EQUATION CARDS
           ============================================================================= */
        .equation-container { display: flex; flex-direction: column; gap: 16px; margin-top: 1rem; }
        .equation-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px 20px;
        }
        .equation-card strong { display: block; margin-bottom: 8px; color: var(--secondary-color); font-size: 0.9rem; }
        .equation-card .equation-expression { display: block; margin-bottom: 10px; font-size: 1.05rem; }
        .equation-card .eq-description { font-size: 0.85rem; color: var(--text-light); margin: 0; line-height: 1.5; }

        /* =============================================================================
           13. SECTION PROPERTIES TABLE
           ============================================================================= */
        .properties-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 16px;
        }
        .properties-table th, .properties-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .properties-table th { font-weight: 600; color: var(--secondary-color); }
        .properties-table td:last-child { font-family: var(--font-mono); text-align: right; }

        /* Section Properties Equations (Progressive Disclosure) */
        .section-props-equations {
            margin-top: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .section-props-equations summary {
            padding: 12px 16px;
            background: var(--primary-light);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            list-style: none;
        }
        .section-props-equations summary::-webkit-details-marker { display: none; }
        .section-props-equations summary::after {
            content: 'Show';
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--accent-color);
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: 20px;
        }
        .section-props-equations[open] > summary::after { content: 'Hide'; }
        .section-props-equations-content {
            padding: 16px;
            background: var(--bg-card);
        }
        .equation-step {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .equation-step:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .equation-step-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }
        .equation-formula {
            background: var(--primary-light);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow-x: auto;
        }
        .equation-calculation {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--text-color);
            background: var(--bg-color);
            padding: 10px 12px;
            border-radius: 6px;
            overflow-x: auto;
        }
        .equation-result {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            margin-top: 8px;
        }

        /* =============================================================================
           14. SETTINGS PANEL (Slide-out)
           ============================================================================= */
        .nav-actions { display: flex; align-items: center; gap: 12px; }
        .settings-button {
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #fff;
            font-weight: 600;
            font-size: 0.85rem;
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .settings-button:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.4); }

        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 1000;
        }
        .settings-overlay.open { opacity: 1; visibility: visible; }

        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 340px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            transform: translateX(100%);
            transition: transform 0.2s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        .settings-panel.open { transform: translateX(0); }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-header h3 { margin: 0; font-size: 1.05rem; }
        .settings-close {
            background: none;
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
        }
        .settings-close:hover { color: var(--text-color); }

        .settings-content { padding: 16px 20px; overflow-y: auto; flex: 1; }
        .settings-section { margin-bottom: 24px; }
        .settings-section h4 { margin-bottom: 12px; font-size: 0.9rem; color: var(--secondary-color); }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }
        .setting-label { font-weight: 600; font-size: 0.9rem; color: var(--text-color); }
        .setting-help { font-size: 0.8rem; color: var(--text-light); margin-top: 2px; }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-toggle {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--border-color);
            transition: 0.2s;
            border-radius: 999px;
        }
        .slider-toggle::before {
            position: absolute;
            content: '';
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: var(--bg-card);
            transition: 0.2s;
            border-radius: 50%;
            box-shadow: var(--shadow);
        }
        .switch input:checked + .slider-toggle { background-color: var(--accent-color); }
        .switch input:checked + .slider-toggle::before { transform: translateX(20px); }

        .segmented {
            display: inline-flex;
            gap: 4px;
            background: var(--primary-light);
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 4px;
        }
        .segmented button {
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: 0.8rem;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .segmented button:hover { color: var(--text-color); }
        .segmented button.active {
            background: var(--accent-color);
            color: var(--bg-card);
        }

        .settings-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); }

        @media (max-width: 720px) {
            .settings-panel { width: 100%; }
        }

        /* =============================================================================
           15. FOOTER
           ============================================================================= */
        .footer {
            text-align: center;
            padding: 24px 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: auto;
        }

        /* =============================================================================
           17. DARK THEME
           ============================================================================= */
        body[data-theme="dark"] {
            --primary-color: #f9fafb;
            --primary-light: #111827;
            --secondary-color: #9ca3af;
            --accent-color: #f9fafb;
            --text-color: #f9fafb;
            --text-light: #9ca3af;
            --border-color: #1f2937;
            --bg-color: #0b0d12;
            --bg-card: #111827;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
            --shadow-lg: 0 16px 32px rgba(0, 0, 0, 0.55);
        }
        body[data-theme="dark"] .navbar { background: #0b0d12; }
        body[data-theme="dark"] .loading-overlay { background: rgba(11, 13, 18, 0.95); }

        /* Dark mode: Fix elements with white text on accent backgrounds */
        body[data-theme="dark"] .mode-btn.active,
        body[data-theme="dark"] .input-tab.active,
        body[data-theme="dark"] .chart-tab.active {
            color: #0b0d12;
        }
        body[data-theme="dark"] .btn-primary {
            color: #0b0d12;
        }
        body[data-theme="dark"] .derivation-step .result-box,
        body[data-theme="dark"] .equation-result {
            color: #0b0d12;
        }
        body[data-theme="dark"] .tooltip-trigger::after {
            background-color: #f9fafb;
            color: #0b0d12;
        }
        body[data-theme="dark"] .segmented button.active {
            color: #0b0d12;
        }
        /* Dark mode: Status banners */
        body[data-theme="dark"] .status-banner.acceptable { background: #064e3b; }
        body[data-theme="dark"] .status-banner.acceptable h4 { color: #6ee7b7; }
        body[data-theme="dark"] .status-banner.marginal { background: #78350f; }
        body[data-theme="dark"] .status-banner.marginal h4 { color: #fcd34d; }
        body[data-theme="dark"] .status-banner.unacceptable { background: #7f1d1d; }
        body[data-theme="dark"] .status-banner.unacceptable h4 { color: #fca5a5; }

        @media (prefers-color-scheme: dark) {
            body[data-theme="system"] {
                --primary-color: #f9fafb;
                --primary-light: #111827;
                --secondary-color: #9ca3af;
                --accent-color: #f9fafb;
                --text-color: #f9fafb;
                --text-light: #9ca3af;
                --border-color: #1f2937;
                --bg-color: #0b0d12;
                --bg-card: #111827;
                --shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
                --shadow-lg: 0 16px 32px rgba(0, 0, 0, 0.55);
            }
            body[data-theme="system"] .navbar { background: #0b0d12; }
            body[data-theme="system"] .loading-overlay { background: rgba(11, 13, 18, 0.95); }

            /* System dark mode: Fix elements with white text on accent backgrounds */
            body[data-theme="system"] .mode-btn.active,
            body[data-theme="system"] .input-tab.active,
            body[data-theme="system"] .chart-tab.active {
                color: #0b0d12;
            }
            body[data-theme="system"] .btn-primary {
                color: #0b0d12;
            }
            body[data-theme="system"] .derivation-step .result-box,
            body[data-theme="system"] .equation-result {
                color: #0b0d12;
            }
            body[data-theme="system"] .tooltip-trigger::after {
                background-color: #f9fafb;
                color: #0b0d12;
            }
            body[data-theme="system"] .segmented button.active {
                color: #0b0d12;
            }
            /* System dark mode: Status banners */
            body[data-theme="system"] .status-banner.acceptable { background: #064e3b; }
            body[data-theme="system"] .status-banner.acceptable h4 { color: #6ee7b7; }
            body[data-theme="system"] .status-banner.marginal { background: #78350f; }
            body[data-theme="system"] .status-banner.marginal h4 { color: #fcd34d; }
            body[data-theme="system"] .status-banner.unacceptable { background: #7f1d1d; }
            body[data-theme="system"] .status-banner.unacceptable h4 { color: #fca5a5; }
        }

        /* =============================================================================
           18. COMPACT DENSITY
           ============================================================================= */
        body[data-density="compact"] .card { padding: 18px; }
        body[data-density="compact"] .input-group label { font-size: 0.82rem; margin-bottom: 4px; }
        body[data-density="compact"] .input-group input,
        body[data-density="compact"] .input-group select { padding: 9px 12px; font-size: 0.9rem; }
        body[data-density="compact"] .results-grid { gap: 12px; }
        body[data-density="compact"] .result-card { padding: 12px; }
        body[data-density="compact"] .safety-gauge { padding: 10px 12px; }

        /* =============================================================================
           16. RESPONSIVE
           ============================================================================= */
        @media (max-width: 1000px) {
            .tool-layout { grid-template-columns: 1fr; }
            .input-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            .input-tabs { flex-direction: column; }
            .results-grid { grid-template-columns: 1fr; }
            .mode-toggle-wrap { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>

<body data-theme="system" data-density="comfortable">
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Loading Python environment...</div>
    </div>

    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
            <div class="nav-actions">
                <button class="settings-button" id="settings-button" type="button">Tool Settings</button>
            </div>
        </nav>
    </header>

    <div class="settings-overlay" id="settings-overlay" aria-hidden="true"></div>
    <aside class="settings-panel" id="settings-panel" aria-hidden="true">
        <div class="settings-header">
            <h3>Tool Settings</h3>
            <button class="settings-close" id="settings-close" type="button">Close</button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h4>Behavior</h4>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Auto-calculate</div>
                        <div class="setting-help">Update results as inputs change</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="setting-auto-calc">
                        <span class="slider-toggle"></span>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <h4>Appearance</h4>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Theme</div>
                        <div class="setting-help">Light, dark, or system default</div>
                    </div>
                    <div class="segmented" role="group" aria-label="Theme">
                        <button type="button" data-theme="light">Light</button>
                        <button type="button" data-theme="dark">Dark</button>
                        <button type="button" data-theme="system" class="active">System</button>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Density</div>
                        <div class="setting-help">Adjust spacing and sizing</div>
                    </div>
                    <div class="segmented" role="group" aria-label="Density">
                        <button type="button" data-density="comfortable" class="active">Comfort</button>
                        <button type="button" data-density="compact">Compact</button>
                    </div>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Precision</div>
                        <div class="setting-help">Decimal places in results</div>
                    </div>
                    <div class="segmented" role="group" aria-label="Precision">
                        <button type="button" data-precision="2">2 dp</button>
                        <button type="button" data-precision="3" class="active">3 dp</button>
                        <button type="button" data-precision="4">4 dp</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings-footer">
            <button class="btn btn-secondary" id="settings-reset" type="button" style="width: 100%;">Reset to defaults</button>
        </div>
    </aside>

    <main class="container">
        <div class="tool-header">
            <h1>Beam Bending Calculator</h1>
            <p class="tool-description">
                Calculate deflection, stress, shear force, and bending moment for beams with various support conditions.
                Includes safety checks against deflection limits and allowable stress.
            </p>
        </div>

        <details class="purpose-section">
            <summary>About This Tool</summary>
            <div class="purpose-content">
                <h3>Purpose</h3>
                <p>This calculator analyzes elastic beam behavior using Euler-Bernoulli beam theory.
                   It supports multiple load cases, cross-section types, and materials with full equation transparency.</p>

                <h3>Features</h3>
                <ul>
                    <li>10 common load/support configurations</li>
                    <li>8 cross-section types including standard steel shapes</li>
                    <li>Material library with common engineering materials</li>
                    <li>Interactive diagrams showing deflected shape</li>
                    <li>Safety checks for deflection limits and stress utilization</li>
                    <li>Full derivation display with governing equations</li>
                </ul>

                <h3>Limitations</h3>
                <ul>
                    <li>Linear elastic analysis only (small deflections)</li>
                    <li>Prismatic beams (constant cross-section)</li>
                    <li>Does not account for shear deformation (slender beams only)</li>
                    <li>Single-span beams only</li>
                </ul>

                <h3>References</h3>
                <ul>
                    <li>Roark's Formulas for Stress and Strain, 8th Edition</li>
                    <li>AISC Steel Construction Manual, 15th Edition</li>
                    <li>Gere & Timoshenko, Mechanics of Materials</li>
                </ul>
            </div>
        </details>

        <div class="mode-toggle-wrap">
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="simple">Simple</button>
                <button class="mode-btn" data-mode="advanced">Advanced</button>
            </div>
            <p class="mode-desc" id="mode-description">
                Quick analysis with common defaults. Switch to Advanced for full control over materials, safety factors, and deflection limits.
            </p>
        </div>

        <div class="tool-layout">
            <!-- INPUT SECTION -->
            <section class="tool-inputs card">
                <h2>Inputs</h2>

                <div class="input-tabs">
                    <button class="input-tab active" data-section="geometry">Geometry</button>
                    <button class="input-tab" data-section="loading">Loading</button>
                    <button class="input-tab" data-section="material">Material</button>
                </div>

                <!-- GEOMETRY TAB -->
                <div id="geometry-section" class="input-section active">
                    <div class="input-group">
                        <label for="load-case">Support & Loading</label>
                        <select id="load-case">
                            <optgroup label="Simply Supported">
                                <option value="simply_supported_point_center">Point Load at Center</option>
                                <option value="simply_supported_point_any">Point Load at Any Position</option>
                                <option value="simply_supported_udl" selected>Uniform Distributed Load</option>
                                <option value="simply_supported_triangular">Triangular Load</option>
                            </optgroup>
                            <optgroup label="Cantilever">
                                <option value="cantilever_point_end">Point Load at Free End</option>
                                <option value="cantilever_point_any">Point Load at Any Position</option>
                                <option value="cantilever_udl">Uniform Distributed Load</option>
                            </optgroup>
                            <optgroup label="Fixed-Fixed">
                                <option value="fixed_fixed_point_center">Point Load at Center</option>
                                <option value="fixed_fixed_udl">Uniform Distributed Load</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="propped_cantilever_udl">Propped Cantilever - UDL</option>
                            </optgroup>
                        </select>
                        <span class="tooltip-trigger" data-tooltip="Select the beam support conditions (simply supported, cantilever, fixed-fixed) and the type of loading (point load, distributed, triangular).">?</span>
                    </div>

                    <div class="input-group">
                        <label for="span">Span Length (m)</label>
                        <input type="number" id="span" value="5" min="0.01" step="0.1">
                        <span class="tooltip-trigger" data-tooltip="Clear span between supports for simply-supported or fixed beams, or the length of a cantilever from the fixed end to the free end.">?</span>
                    </div>

                    <div class="input-group">
                        <label for="section-type">Cross-Section Type</label>
                        <select id="section-type">
                            <option value="rectangular" selected>Rectangular Solid</option>
                            <option value="circular_solid">Circular Solid</option>
                            <option value="circular_hollow">Circular Hollow (Tube)</option>
                            <option value="i_beam">I-Beam (Custom)</option>
                            <option value="box">Box / RHS</option>
                            <option value="c_channel">C-Channel</option>
                            <option value="t_section">T-Section</option>
                            <option value="standard_steel">Standard Steel (AISC W-Shape)</option>
                            <option value="custom">Custom Properties</option>
                        </select>
                        <span class="tooltip-trigger" data-tooltip="The beam's cross-sectional shape. This determines the moment of inertia (I) and section modulus (S) used in calculations. Standard steel shapes use AISC tabulated values.">?</span>
                    </div>

                    <div id="section-dimensions"></div>
                </div>

                <!-- LOADING TAB -->
                <div id="loading-section" class="input-section">
                    <div class="input-group" id="load-value-group">
                        <label for="load-value" id="load-value-label">Distributed Load, w (N/m)</label>
                        <input type="number" id="load-value" value="10000" min="0" step="100">
                        <span class="tooltip-trigger" data-tooltip="For distributed loads: force per unit length. For point loads: total force in Newtons. Positive values act downward.">?</span>
                        <p class="input-helper" id="load-helper">Total load on beam: <span id="total-load">50,000 N</span></p>
                    </div>

                    <div class="input-group" id="load-position-group" style="display: none;">
                        <label for="load-position">Load Position from Left Support (m)</label>
                        <input type="number" id="load-position" value="2" min="0.01" step="0.1">
                        <span class="tooltip-trigger" data-tooltip="Distance from the left support to where the point load is applied. For cantilevers, measured from the fixed end.">?</span>
                        <p class="input-helper">Distance from left support (or fixed end for cantilevers)</p>
                    </div>
                </div>

                <!-- MATERIAL TAB -->
                <div id="material-section" class="input-section">
                    <div class="input-group">
                        <label for="material">Material</label>
                        <select id="material">
                            <option value="steel_structural" selected>Structural Steel (A36)</option>
                            <option value="steel_stainless_304">Stainless Steel 304</option>
                            <option value="aluminum_6061_t6">Aluminum 6061-T6</option>
                            <option value="aluminum_7075_t6">Aluminum 7075-T6</option>
                            <option value="wood_douglas_fir">Douglas Fir</option>
                            <option value="wood_oak">Red Oak</option>
                            <option value="titanium_6al4v">Titanium 6Al-4V</option>
                            <option value="custom">Custom Material</option>
                        </select>
                        <span class="tooltip-trigger" data-tooltip="Select from common engineering materials with pre-defined elastic modulus (E) and yield strength (Fy). Choose 'Custom' to enter your own values.">?</span>
                    </div>

                    <div id="material-props" class="input-helper" style="margin-bottom: 16px;">
                        E = 200 GPa, Fy = 250 MPa
                    </div>

                    <div class="advanced-section" id="material-advanced">
                        <div class="input-group">
                            <label for="elastic-modulus">Elastic Modulus, E (GPa)</label>
                            <input type="number" id="elastic-modulus" value="200" step="1">
                            <span class="tooltip-trigger" data-tooltip="Young's modulus - measures material stiffness. Steel  200 GPa, Aluminum  70 GPa, Wood  10-15 GPa. Higher E means less deflection.">?</span>
                        </div>

                        <div class="input-group">
                            <label for="yield-strength">Yield Strength, Fy (MPa)</label>
                            <input type="number" id="yield-strength" value="250" step="1">
                            <span class="tooltip-trigger" data-tooltip="Stress at which material begins to deform permanently. A36 steel = 250 MPa (36 ksi). Used with safety factor to determine allowable stress.">?</span>
                        </div>

                        <div class="input-group">
                            <label for="safety-factor">Safety Factor</label>
                            <input type="number" id="safety-factor" value="1.5" min="1" step="0.1">
                            <span class="tooltip-trigger" data-tooltip="Factor of safety applied to yield strength. Allowable stress = Fy / SF. Typical values: 1.5-2.0 for buildings, 2.5-4.0 for critical applications.">?</span>
                            <p class="input-helper">Allowable stress = Fy / SF</p>
                        </div>

                        <div class="input-group">
                            <label for="deflection-limit">Deflection Limit</label>
                            <select id="deflection-limit">
                                <option value="L/180">L/180 - Roofs</option>
                                <option value="L/240">L/240 - General floors</option>
                                <option value="L/360" selected>L/360 - Brittle finishes</option>
                                <option value="L/480">L/480 - Precision</option>
                                <option value="L/600">L/600 - High precision</option>
                                <option value="custom">Custom</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Maximum allowable deflection as fraction of span. L/360 is common for floors with brittle finishes (drywall). More restrictive limits prevent cracking and visible sag.">?</span>
                        </div>
                    </div>

                    <button class="advanced-toggle" id="toggle-material-advanced">
                        <span></span> Show Advanced Options
                    </button>
                </div>

                <button class="btn btn-primary" id="calculate-btn" disabled>Calculate</button>
            </section>

            <!-- OUTPUT SECTION -->
            <section class="tool-outputs card">
                <div class="tabs">
                    <button class="tab-link active" data-target="results">Results</button>
                    <button class="tab-link" data-target="diagram">Diagram</button>
                    <button class="tab-link" data-target="charts">Charts</button>
                    <button class="tab-link" data-target="equations">Equations</button>
                </div>

                <!-- RESULTS TAB -->
                <div id="results" class="tab-content" style="display: block;">
                    <div id="results-placeholder">
                        <p style="text-align: center; color: var(--text-light); padding: 40px 0;">
                            Configure beam parameters and click Calculate to see results.
                        </p>
                    </div>

                    <div id="results-display" style="display: none;">
                        <div class="results-grid" id="results-grid"></div>

                        <div class="safety-section">
                            <h4>Safety Checks</h4>
                            <div class="safety-check-block" id="deflection-block">
                                <div class="safety-gauge" id="deflection-gauge">
                                    <span class="gauge-label">Deflection</span>
                                    <div class="gauge-bar-container">
                                        <div class="gauge-bar" id="deflection-bar"></div>
                                        <div class="gauge-threshold" style="left: 100%;"></div>
                                    </div>
                                    <span class="gauge-value" id="deflection-value"></span>
                                    <button class="gauge-toggle" data-target="deflection-equations" aria-expanded="false"></button>
                                </div>
                                <div class="gauge-equations" id="deflection-equations">
                                    <div class="gauge-equations-content" id="deflection-equations-content"></div>
                                </div>
                            </div>

                            <div class="safety-check-block" id="stress-block">
                                <div class="safety-gauge" id="stress-gauge">
                                    <span class="gauge-label">Stress</span>
                                    <div class="gauge-bar-container">
                                        <div class="gauge-bar" id="stress-bar"></div>
                                        <div class="gauge-threshold" style="left: 100%;"></div>
                                    </div>
                                    <span class="gauge-value" id="stress-value"></span>
                                    <button class="gauge-toggle" data-target="stress-equations" aria-expanded="false"></button>
                                </div>
                                <div class="gauge-equations" id="stress-equations">
                                    <div class="gauge-equations-content" id="stress-equations-content"></div>
                                </div>
                            </div>
                        </div>

                        <div class="status-banner" id="status-banner" style="display: none;">
                            <div class="icon" id="status-icon"></div>
                            <div class="content">
                                <h4 id="status-title">Design Acceptable</h4>
                                <p id="status-message">All safety checks passed.</p>
                                <ul class="recommendations" id="recommendations-list"></ul>
                            </div>
                        </div>

                        <div class="derivation-panel" id="derivation-panel">
                            <div class="derivation-header">
                                <span class="derivation-title" id="derivation-title">Derivation</span>
                                <button class="derivation-close" id="close-derivation"></button>
                            </div>
                            <div id="derivation-content"></div>
                        </div>

                        <h4 style="margin-top: 24px;">Section Properties</h4>
                        <table class="properties-table" id="section-properties-table">
                            <tbody></tbody>
                        </table>

                        <details class="section-props-equations" id="section-props-equations">
                            <summary>Equations & Calculations</summary>
                            <div class="section-props-equations-content" id="section-props-equations-content">
                                <!-- Populated by JavaScript -->
                            </div>
                        </details>
                    </div>
                </div>

                <!-- DIAGRAM TAB -->
                <div id="diagram" class="tab-content">
                    <div class="beam-diagram-container">
                        <h4>Beam Configuration</h4>
                        <svg id="beam-diagram" viewBox="0 0 600 200"></svg>
                    </div>
                    <div class="beam-diagram-container">
                        <h4>Deflected Shape (Exaggerated)</h4>
                        <svg id="deflection-diagram" viewBox="0 0 600 150"></svg>
                    </div>
                </div>

                <!-- CHARTS TAB -->
                <div id="charts" class="tab-content">
                    <div class="chart-tabs">
                        <button class="chart-tab active" data-chart="deflection">Deflection</button>
                        <button class="chart-tab" data-chart="moment">Bending Moment</button>
                        <button class="chart-tab" data-chart="shear">Shear Force</button>
                        <button class="chart-tab" data-chart="combined">Combined</button>
                    </div>
                    <div class="chart-container">
                        <div id="response-chart" class="chart-plot"></div>
                    </div>
                </div>

                <!-- EQUATIONS TAB -->
                <div id="equations" class="tab-content">
                    <h3>Euler-Bernoulli Beam Theory</h3>
                    <p>This calculator uses classical beam theory, which assumes small deflections, linear elastic material behavior, and plane sections remaining plane after bending.</p>

                    <div class="equation-container">
                        <div class="equation-card">
                            <strong>Fundamental Beam Equation</strong>
                            <div class="equation-expression">\[ EI \frac{d^4 y}{dx^4} = w(x) \]</div>
                            <p class="eq-description">The governing differential equation relates the distributed load \(w(x)\) to the beam deflection \(y(x)\) through the flexural rigidity \(EI\).</p>
                        </div>

                        <div class="equation-card">
                            <strong>Moment-Curvature Relationship</strong>
                            <div class="equation-expression">\[ M(x) = EI \frac{d^2 y}{dx^2} \]</div>
                            <p class="eq-description">Bending moment is proportional to curvature. This is the basis for determining deflections by double integration of the moment diagram.</p>
                        </div>

                        <div class="equation-card">
                            <strong>Shear-Moment Relationship</strong>
                            <div class="equation-expression">\[ V(x) = \frac{dM}{dx} \quad \text{and} \quad w(x) = \frac{dV}{dx} \]</div>
                            <p class="eq-description">Shear force is the derivative of moment; distributed load is the derivative of shear. These relationships are used to construct shear and moment diagrams.</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 28px;">Load Case Formulas</h3>
                    <p>Specific equations for the selected load case:</p>

                    <div class="equation-container" id="equation-container">
                        <div class="equation-card">
                            <strong>Maximum Deflection</strong>
                            <div class="equation-expression" id="eq-deflection">Select a load case to see equations</div>
                            <p class="eq-description">Maximum vertical displacement of the beam. For simply supported beams with symmetric loading, this occurs at midspan. For cantilevers, at the free end.</p>
                        </div>
                        <div class="equation-card">
                            <strong>Maximum Bending Moment</strong>
                            <div class="equation-expression" id="eq-moment"></div>
                            <p class="eq-description">Peak internal moment that causes bending stress. Location depends on load type and support conditions.</p>
                        </div>
                        <div class="equation-card">
                            <strong>Maximum Shear Force</strong>
                            <div class="equation-expression" id="eq-shear"></div>
                            <p class="eq-description">Peak internal shear force. Typically maximum at supports or at concentrated load locations.</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 28px;">Stress Analysis</h3>
                    <p>Determining stresses from internal forces:</p>

                    <div class="equation-container">
                        <div class="equation-card">
                            <strong>Bending Stress (Flexure Formula)</strong>
                            <div class="equation-expression">\[ \sigma = \frac{M \cdot y}{I} = \frac{M}{S} \]</div>
                            <p class="eq-description">Normal stress varies linearly through the cross-section depth. Maximum stress occurs at the extreme fibers (top and bottom). \(S = I/c\) is the section modulus.</p>
                        </div>

                        <div class="equation-card">
                            <strong>Maximum Bending Stress</strong>
                            <div class="equation-expression">\[ \sigma_{max} = \frac{M_{max} \cdot c}{I} \]</div>
                            <p class="eq-description">Where \(c\) is the distance from the neutral axis to the extreme fiber. For symmetric sections, \(c = h/2\).</p>
                        </div>

                        <div class="equation-card">
                            <strong>Shear Stress (Approximate)</strong>
                            <div class="equation-expression">\[ \tau_{avg} = \frac{V}{A_{web}} \quad \text{or} \quad \tau_{max} = \frac{VQ}{Ib} \]</div>
                            <p class="eq-description">Shear stress distribution is parabolic through the depth. The exact formula uses the first moment of area \(Q\). For rectangular sections, \(\tau_{max} = 1.5 V/A\).</p>
                        </div>

                        <div class="equation-card">
                            <strong>Allowable Stress Design</strong>
                            <div class="equation-expression">\[ \sigma_{allow} = \frac{F_y}{SF} \quad \text{where } SF \geq 1.5 \]</div>
                            <p class="eq-description">The allowable stress is the yield strength divided by a safety factor. Common factors: 1.5-2.0 for buildings, 2.5-4.0 for critical applications.</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 28px;">Section Properties</h3>
                    <p>Key geometric properties of cross-sections:</p>

                    <div class="equation-container">
                        <div class="equation-card">
                            <strong>Moment of Inertia (Second Moment of Area)</strong>
                            <div class="equation-expression">\[ I = \int y^2 \, dA \]</div>
                            <p class="eq-description">Measures resistance to bending. Larger \(I\) means less deflection and lower stress for the same moment.</p>
                            <div style="margin-top: 12px; font-size: 0.85rem; color: var(--text-light);">
                                <strong>Common shapes:</strong><br>
                                Rectangle: \( I = \frac{bh^3}{12} \)<br>
                                Circle: \( I = \frac{\pi d^4}{64} \)<br>
                                Hollow circle: \( I = \frac{\pi (d_o^4 - d_i^4)}{64} \)
                            </div>
                        </div>

                        <div class="equation-card">
                            <strong>Section Modulus</strong>
                            <div class="equation-expression">\[ S = \frac{I}{c} \]</div>
                            <p class="eq-description">Convenient property for stress calculations: \(\sigma = M/S\). For symmetric sections, \(S_{top} = S_{bottom}\).</p>
                        </div>

                        <div class="equation-card">
                            <strong>Radius of Gyration</strong>
                            <div class="equation-expression">\[ r = \sqrt{\frac{I}{A}} \]</div>
                            <p class="eq-description">Used in buckling calculations. Represents the distance at which the entire area could be concentrated to produce the same moment of inertia.</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 28px;">Deflection Limits</h3>
                    <p>Serviceability requirements for acceptable deflection:</p>

                    <div class="equation-container">
                        <div class="equation-card">
                            <strong>Common Deflection Limits</strong>
                            <div style="font-size: 0.9rem; line-height: 1.8;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 6px 0;"><strong>L/180</strong></td>
                                        <td>Roof members not supporting ceiling</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 6px 0;"><strong>L/240</strong></td>
                                        <td>Floor members, general use</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 6px 0;"><strong>L/360</strong></td>
                                        <td>Floor members supporting brittle finishes (plaster, tile)</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <td style="padding: 6px 0;"><strong>L/480</strong></td>
                                        <td>Precision equipment, sensitive machinery</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 6px 0;"><strong>L/600</strong></td>
                                        <td>High-precision applications, optical equipment</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>Engineering Tools  For educational and preliminary design purposes only.</p>
    </footer>

    <script>
        // =============================================================================
        // GLOBAL STATE
        // =============================================================================
        let pyodideInstance = null;
        let beamModule = null;
        let currentResult = null;
        let currentMode = 'simple';

        // Settings
        const SETTINGS_KEY = 'beam-bending-settings';
        const defaultSettings = {
            autoCalc: false,
            theme: 'system',
            density: 'comfortable',
            precision: 3
        };
        let settings = { ...defaultSettings };

        // Unit conversion factors to SI (meters, Newtons, Pascals)
        const LENGTH_TO_M = { m: 1, mm: 0.001, ft: 0.3048, in: 0.0254 };
        const FORCE_TO_N = { N: 1, kN: 1000, lb: 4.44822, kip: 4448.22 };
        const DISTRIBUTED_TO_NM = { 'N/m': 1, 'kN/m': 1000, 'lb/ft': 14.5939 };
        const PRESSURE_TO_PA = { Pa: 1, MPa: 1e6, GPa: 1e9, psi: 6894.76, ksi: 6894760 };

        // Section dimension configs
        const SECTION_CONFIGS = {
            rectangular: [
                { id: 'width', label: 'Width (b)', default: 0.2, unit: 'm' },
                { id: 'depth', label: 'Depth (h)', default: 0.4, unit: 'm' },
            ],
            circular_solid: [
                { id: 'diameter', label: 'Diameter (d)', default: 0.2, unit: 'm' },
            ],
            circular_hollow: [
                { id: 'outer_diameter', label: 'Outer Diameter', default: 0.2, unit: 'm' },
                { id: 'inner_diameter', label: 'Inner Diameter', default: 0.15, unit: 'm' },
            ],
            i_beam: [
                { id: 'overall_depth', label: 'Overall Depth (d)', default: 0.4, unit: 'm' },
                { id: 'flange_width', label: 'Flange Width (bf)', default: 0.2, unit: 'm' },
                { id: 'flange_thickness', label: 'Flange Thickness (tf)', default: 0.02, unit: 'm' },
                { id: 'web_thickness', label: 'Web Thickness (tw)', default: 0.012, unit: 'm' },
            ],
            box: [
                { id: 'width', label: 'Width', default: 0.2, unit: 'm' },
                { id: 'depth', label: 'Depth', default: 0.3, unit: 'm' },
                { id: 'wall_thickness', label: 'Wall Thickness', default: 0.01, unit: 'm' },
            ],
            c_channel: [
                { id: 'depth', label: 'Depth', default: 0.25, unit: 'm' },
                { id: 'flange_width', label: 'Flange Width', default: 0.1, unit: 'm' },
                { id: 'flange_thickness', label: 'Flange Thickness', default: 0.015, unit: 'm' },
                { id: 'web_thickness', label: 'Web Thickness', default: 0.01, unit: 'm' },
            ],
            t_section: [
                { id: 'flange_width', label: 'Flange Width', default: 0.2, unit: 'm' },
                { id: 'flange_thickness', label: 'Flange Thickness', default: 0.02, unit: 'm' },
                { id: 'stem_depth', label: 'Stem Depth', default: 0.2, unit: 'm' },
                { id: 'stem_thickness', label: 'Stem Thickness', default: 0.015, unit: 'm' },
            ],
            standard_steel: [
                { id: 'designation', label: 'AISC Designation', type: 'select',
                  options: ['W8x31', 'W10x49', 'W12x26', 'W14x30', 'W16x40', 'W18x50', 'W21x62', 'W24x76'] },
            ],
            custom: [
                { id: 'moment_of_inertia', label: 'Moment of Inertia (I)', default: 1e-4, unit: 'm' },
                { id: 'c_top', label: 'Distance to Top Fiber (c_top)', default: 0.2, unit: 'm' },
                { id: 'c_bottom', label: 'Distance to Bottom Fiber (c_bot)', default: 0.2, unit: 'm' },
                { id: 'area', label: 'Area (optional)', default: 0.01, unit: 'm' },
            ],
        };

        const MATERIAL_PROPS = {
            steel_structural: { E: 200, Fy: 250, name: 'Structural Steel (A36)' },
            steel_stainless_304: { E: 193, Fy: 215, name: 'Stainless Steel 304' },
            aluminum_6061_t6: { E: 68.9, Fy: 276, name: 'Aluminum 6061-T6' },
            aluminum_7075_t6: { E: 71.7, Fy: 503, name: 'Aluminum 7075-T6' },
            wood_douglas_fir: { E: 12.4, Fy: 7.6, name: 'Douglas Fir' },
            wood_oak: { E: 12.5, Fy: 10.3, name: 'Red Oak' },
            titanium_6al4v: { E: 113.8, Fy: 880, name: 'Titanium 6Al-4V' },
            custom: { E: 200, Fy: 250, name: 'Custom' },
        };

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        async function initPyodide() {
            const loadingText = document.getElementById('loading-text');

            try {
                loadingText.textContent = 'Loading Python runtime...';
                pyodideInstance = await loadPyodide();

                loadingText.textContent = 'Loading beam analysis module...';
                await pyodideInstance.runPythonAsync(`
                    from pyodide.http import pyfetch

                    response = await pyfetch('../../pycalcs/beam_analysis.py')
                    with open('beam_analysis.py', 'w') as f:
                        f.write(await response.string())

                    import beam_analysis
                `);

                beamModule = pyodideInstance.globals.get('beam_analysis');

                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('calculate-btn').disabled = false;

                renderSectionFields();
                updateLoadLabel();
                updateMaterialDisplay();

            } catch (error) {
                loadingText.textContent = `Error: ${error.message}`;
                console.error('Pyodide init error:', error);
            }
        }

        // =============================================================================
        // UI HELPERS
        // =============================================================================
        function openTab(target) {
            document.querySelectorAll('.tab-link').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.target === target);
            });
            document.querySelectorAll('.tab-content').forEach(panel => {
                panel.style.display = panel.id === target ? 'block' : 'none';
            });
        }

        function openInputSection(section) {
            document.querySelectorAll('.input-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === section);
            });
            document.querySelectorAll('.input-section').forEach(panel => {
                panel.classList.toggle('active', panel.id === `${section}-section`);
            });
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            const desc = document.getElementById('mode-description');
            if (mode === 'simple') {
                desc.textContent = 'Quick analysis with common defaults. Switch to Advanced for full control over materials, safety factors, and deflection limits.';
                document.getElementById('material-advanced').classList.remove('visible');
            } else {
                desc.textContent = 'Full control over material properties, safety factors, and deflection criteria.';
                document.getElementById('material-advanced').classList.add('visible');
            }
        }

        function formatNumber(value, decimals = null) {
            if (!Number.isFinite(value)) return '';
            const dp = decimals ?? settings.precision;
            if (Math.abs(value) >= 1e6 || (Math.abs(value) < 0.001 && value !== 0)) {
                return value.toExponential(dp);
            }
            return value.toLocaleString(undefined, { maximumFractionDigits: dp });
        }

        function formatEngineering(value, unit) {
            if (!Number.isFinite(value)) return '';

            const prefixes = [
                { threshold: 1e9, prefix: 'G', divisor: 1e9 },
                { threshold: 1e6, prefix: 'M', divisor: 1e6 },
                { threshold: 1e3, prefix: 'k', divisor: 1e3 },
                { threshold: 1, prefix: '', divisor: 1 },
                { threshold: 1e-3, prefix: 'm', divisor: 1e-3 },
                { threshold: 1e-6, prefix: '', divisor: 1e-6 },
            ];

            const absVal = Math.abs(value);
            for (const p of prefixes) {
                if (absVal >= p.threshold || p.threshold === 1e-6) {
                    return `${(value / p.divisor).toFixed(settings.precision)} ${p.prefix}${unit}`;
                }
            }
            return `${value.toExponential(settings.precision)} ${unit}`;
        }

        // =============================================================================
        // SETTINGS
        // =============================================================================
        function loadSettings() {
            const stored = localStorage.getItem(SETTINGS_KEY);
            if (stored) {
                try {
                    settings = { ...defaultSettings, ...JSON.parse(stored) };
                } catch (e) {
                    settings = { ...defaultSettings };
                }
            }
        }

        function saveSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        }

        function applySettings() {
            document.body.dataset.theme = settings.theme;
            document.body.dataset.density = settings.density;
            document.getElementById('setting-auto-calc').checked = settings.autoCalc;

            // Update segmented buttons
            document.querySelectorAll('.settings-panel [data-theme]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === settings.theme);
            });
            document.querySelectorAll('.settings-panel [data-density]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.density === settings.density);
            });
            document.querySelectorAll('.settings-panel [data-precision]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.precision === String(settings.precision));
            });

            // Re-render results if we have them
            if (currentResult) {
                displayResults(currentResult);
            }
        }

        function toggleSettingsPanel(open) {
            const panel = document.getElementById('settings-panel');
            const overlay = document.getElementById('settings-overlay');
            const isOpen = open ?? !panel.classList.contains('open');
            panel.classList.toggle('open', isOpen);
            overlay.classList.toggle('open', isOpen);
            panel.setAttribute('aria-hidden', !isOpen);
            overlay.setAttribute('aria-hidden', !isOpen);
        }

        function handleSettingChange(key, value) {
            settings[key] = value;
            saveSettings();
            applySettings();
            if (key === 'autoCalc' && value && beamModule) {
                calculate();
            }
        }

        let calcDebounce = null;
        function scheduleCalculation() {
            if (!settings.autoCalc || !beamModule) return;
            if (calcDebounce) clearTimeout(calcDebounce);
            calcDebounce = setTimeout(calculate, 300);
        }

        function initSettings() {
            loadSettings();
            applySettings();

            // Settings button
            document.getElementById('settings-button').addEventListener('click', () => toggleSettingsPanel(true));
            document.getElementById('settings-close').addEventListener('click', () => toggleSettingsPanel(false));
            document.getElementById('settings-overlay').addEventListener('click', () => toggleSettingsPanel(false));

            // Auto-calc toggle
            document.getElementById('setting-auto-calc').addEventListener('change', (e) => {
                handleSettingChange('autoCalc', e.target.checked);
            });

            // Theme buttons
            document.querySelectorAll('.settings-panel [data-theme]').forEach(btn => {
                btn.addEventListener('click', () => handleSettingChange('theme', btn.dataset.theme));
            });

            // Density buttons
            document.querySelectorAll('.settings-panel [data-density]').forEach(btn => {
                btn.addEventListener('click', () => handleSettingChange('density', btn.dataset.density));
            });

            // Precision buttons
            document.querySelectorAll('.settings-panel [data-precision]').forEach(btn => {
                btn.addEventListener('click', () => handleSettingChange('precision', Number(btn.dataset.precision)));
            });

            // Reset button
            document.getElementById('settings-reset').addEventListener('click', () => {
                settings = { ...defaultSettings };
                saveSettings();
                applySettings();
            });

            // Escape key closes settings
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') toggleSettingsPanel(false);
            });
        }

        // =============================================================================
        // SECTION FIELDS
        // =============================================================================
        function renderSectionFields() {
            const sectionType = document.getElementById('section-type').value;
            const container = document.getElementById('section-dimensions');
            const config = SECTION_CONFIGS[sectionType] || [];

            container.innerHTML = '';

            config.forEach(field => {
                const group = document.createElement('div');
                group.className = 'input-group';

                if (field.type === 'select') {
                    group.innerHTML = `
                        <label for="dim-${field.id}">${field.label}</label>
                        <select id="dim-${field.id}">
                            ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>
                    `;
                } else {
                    group.innerHTML = `
                        <label for="dim-${field.id}">${field.label}</label>
                        <div class="input-row">
                            <input type="number" id="dim-${field.id}" value="${field.default}" step="0.001" min="0">
                            <span style="padding: 11px; background: var(--primary-light); border-radius: 0 6px 6px 0; font-size: 0.9rem;">${field.unit}</span>
                        </div>
                    `;
                }

                container.appendChild(group);

                // Add auto-calc listener
                const input = group.querySelector('input, select');
                if (input) {
                    input.addEventListener('input', scheduleCalculation);
                    input.addEventListener('change', scheduleCalculation);
                }
            });
        }

        function getSectionDimensions() {
            const sectionType = document.getElementById('section-type').value;
            const config = SECTION_CONFIGS[sectionType] || [];
            const dims = {};

            config.forEach(field => {
                const el = document.getElementById(`dim-${field.id}`);
                if (el) {
                    dims[field.id] = field.type === 'select' ? el.value : parseFloat(el.value);
                }
            });

            return dims;
        }

        // =============================================================================
        // LOAD CASE HANDLING
        // =============================================================================
        function updateLoadLabel() {
            const loadCase = document.getElementById('load-case').value;
            const label = document.getElementById('load-value-label');
            const posGroup = document.getElementById('load-position-group');

            const isDistributed = loadCase.includes('udl') || loadCase.includes('triangular');
            const needsPosition = loadCase.includes('_any');

            if (isDistributed) {
                label.textContent = 'Distributed Load, w (N/m)';
            } else {
                label.textContent = 'Point Load, P (N)';
            }

            posGroup.style.display = needsPosition ? 'block' : 'none';
            updateTotalLoad();
        }

        function updateTotalLoad() {
            const loadCase = document.getElementById('load-case').value;
            const loadValue = parseFloat(document.getElementById('load-value').value) || 0;
            const span = parseFloat(document.getElementById('span').value) || 1;
            const helper = document.getElementById('load-helper');

            if (loadCase.includes('udl') || loadCase.includes('triangular')) {
                const total = loadCase.includes('triangular') ? loadValue * span / 2 : loadValue * span;
                helper.innerHTML = `Total load on beam: <strong>${formatNumber(total)} N</strong>`;
                helper.style.display = 'block';
            } else {
                helper.style.display = 'none';
            }
        }

        // =============================================================================
        // MATERIAL HANDLING
        // =============================================================================
        function updateMaterialDisplay() {
            const material = document.getElementById('material').value;
            const props = MATERIAL_PROPS[material];
            const display = document.getElementById('material-props');

            if (material === 'custom') {
                display.textContent = 'Enter custom values below';
            } else {
                display.textContent = `E = ${props.E} GPa, Fy = ${props.Fy} MPa`;
                document.getElementById('elastic-modulus').value = props.E;
                document.getElementById('yield-strength').value = props.Fy;
            }
        }

        // =============================================================================
        // CALCULATION
        // =============================================================================
        async function calculate() {
            if (!beamModule) return;

            const btn = document.getElementById('calculate-btn');
            btn.disabled = true;
            btn.textContent = 'Calculating...';

            try {
                // Gather inputs
                const loadCase = document.getElementById('load-case').value;
                const sectionType = document.getElementById('section-type').value;
                const span = parseFloat(document.getElementById('span').value);
                const loadValue = parseFloat(document.getElementById('load-value').value);
                const material = document.getElementById('material').value;
                const E = parseFloat(document.getElementById('elastic-modulus').value) * 1e9; // GPa to Pa
                const Fy = parseFloat(document.getElementById('yield-strength').value) * 1e6; // MPa to Pa
                const safetyFactor = parseFloat(document.getElementById('safety-factor').value) || 1.5;
                const deflectionLimit = document.getElementById('deflection-limit').value;

                const dims = getSectionDimensions();
                const loadPosition = loadCase.includes('_any') ?
                    parseFloat(document.getElementById('load-position').value) : null;

                // Load is already in SI (N or N/m)
                const loadSI = loadValue;

                // Call Python
                const pyDims = pyodideInstance.toPy(dims);
                const result = beamModule.beam_analysis(
                    loadCase,
                    sectionType,
                    pyDims,
                    span,
                    loadSI,
                    material,
                    E,
                    Fy,
                    loadPosition,
                    deflectionLimit,
                    null, // custom ratio
                    101,  // num_points
                    safetyFactor
                );

                currentResult = result.toJs({ dict_converter: Object.fromEntries });
                pyDims.destroy();
                result.destroy();

                if (currentResult.error) {
                    alert(`Error: ${currentResult.error}`);
                } else {
                    displayResults(currentResult);
                    updateDiagrams(currentResult);
                    updateCharts(currentResult);
                    updateEquations(currentResult);
                }

            } catch (error) {
                console.error('Calculation error:', error);
                alert(`Calculation error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Calculate';
            }
        }

        // =============================================================================
        // RESULTS DISPLAY
        // =============================================================================

        function generateSectionEquations(sectionType, dimensions, props) {
            const container = document.getElementById('section-props-equations-content');
            const sectionKey = sectionType.toLowerCase();
            let html = '';

            // Helper to format dimension values nicely
            const fmtDim = (val) => {
                if (val >= 1) return val.toFixed(3) + ' m';
                return (val * 1000).toFixed(1) + ' mm';
            };
            const fmtArea = (val) => formatEngineering(val, 'm');
            const fmtInertia = (val) => formatEngineering(val, 'm');

            if (sectionKey === 'rectangular') {
                const b = dimensions.width;
                const h = dimensions.depth;
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">Cross-Sectional Area</div>
                        <div class="equation-formula">\\[ A = b \\times h \\]</div>
                        <div class="equation-calculation">A = ${fmtDim(b)}  ${fmtDim(h)}</div>
                        <span class="equation-result">A = ${fmtArea(props.area)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Moment of Inertia (Strong Axis)</div>
                        <div class="equation-formula">\\[ I_x = \\frac{b \\cdot h^3}{12} \\]</div>
                        <div class="equation-calculation">I = (${fmtDim(b)}  ${fmtDim(h)}) / 12</div>
                        <span class="equation-result">I = ${fmtInertia(props.Ix)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Section Modulus</div>
                        <div class="equation-formula">\\[ S_x = \\frac{I_x}{c} = \\frac{b \\cdot h^2}{6} \\]</div>
                        <div class="equation-calculation">S = I / c = ${fmtInertia(props.Ix)} / ${fmtDim(props.c_top)}</div>
                        <span class="equation-result">S = ${formatEngineering(props.Sx_top, 'm')}</span>
                    </div>
                `;
            } else if (sectionKey === 'circular_solid') {
                const d = dimensions.diameter;
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">Cross-Sectional Area</div>
                        <div class="equation-formula">\\[ A = \\frac{\\pi d^2}{4} \\]</div>
                        <div class="equation-calculation">A =   ${fmtDim(d)} / 4</div>
                        <span class="equation-result">A = ${fmtArea(props.area)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Moment of Inertia</div>
                        <div class="equation-formula">\\[ I_x = \\frac{\\pi d^4}{64} \\]</div>
                        <div class="equation-calculation">I =   ${fmtDim(d)} / 64</div>
                        <span class="equation-result">I = ${fmtInertia(props.Ix)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Section Modulus</div>
                        <div class="equation-formula">\\[ S_x = \\frac{\\pi d^3}{32} \\]</div>
                        <div class="equation-calculation">S =   ${fmtDim(d)} / 32</div>
                        <span class="equation-result">S = ${formatEngineering(props.Sx_top, 'm')}</span>
                    </div>
                `;
            } else if (sectionKey === 'circular_hollow') {
                const do_ = dimensions.outer_diameter;
                const di = dimensions.inner_diameter;
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">Cross-Sectional Area</div>
                        <div class="equation-formula">\\[ A = \\frac{\\pi (d_o^2 - d_i^2)}{4} \\]</div>
                        <div class="equation-calculation">A =   (${fmtDim(do_)}  ${fmtDim(di)}) / 4</div>
                        <span class="equation-result">A = ${fmtArea(props.area)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Moment of Inertia</div>
                        <div class="equation-formula">\\[ I_x = \\frac{\\pi (d_o^4 - d_i^4)}{64} \\]</div>
                        <div class="equation-calculation">I =   (${fmtDim(do_)}  ${fmtDim(di)}) / 64</div>
                        <span class="equation-result">I = ${fmtInertia(props.Ix)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Section Modulus</div>
                        <div class="equation-formula">\\[ S_x = \\frac{I_x}{c} \\quad \\text{where } c = \\frac{d_o}{2} \\]</div>
                        <div class="equation-calculation">S = ${fmtInertia(props.Ix)} / ${fmtDim(props.c_top)}</div>
                        <span class="equation-result">S = ${formatEngineering(props.Sx_top, 'm')}</span>
                    </div>
                `;
            } else if (sectionKey === 'i_beam') {
                const d = dimensions.overall_depth;
                const bf = dimensions.flange_width;
                const tf = dimensions.flange_thickness;
                const tw = dimensions.web_thickness;
                const hw = d - 2 * tf;
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">Cross-Sectional Area</div>
                        <div class="equation-formula">\\[ A = 2 \\cdot b_f \\cdot t_f + h_w \\cdot t_w \\]</div>
                        <div class="equation-calculation">A = 2  ${fmtDim(bf)}  ${fmtDim(tf)} + ${fmtDim(hw)}  ${fmtDim(tw)}</div>
                        <span class="equation-result">A = ${fmtArea(props.area)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Moment of Inertia</div>
                        <div class="equation-formula">\\[ I_x = \\frac{b_f \\cdot d^3 - (b_f - t_w) \\cdot h_w^3}{12} \\]</div>
                        <div class="equation-calculation">I = (${fmtDim(bf)}  ${fmtDim(d)}  ${fmtDim(bf - tw)}  ${fmtDim(hw)}) / 12</div>
                        <span class="equation-result">I = ${fmtInertia(props.Ix)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Section Modulus</div>
                        <div class="equation-formula">\\[ S_x = \\frac{I_x}{c} \\quad \\text{where } c = \\frac{d}{2} \\]</div>
                        <div class="equation-calculation">S = ${fmtInertia(props.Ix)} / ${fmtDim(props.c_top)}</div>
                        <span class="equation-result">S = ${formatEngineering(props.Sx_top, 'm')}</span>
                    </div>
                `;
            } else if (sectionKey === 'box') {
                const b = dimensions.width;
                const h = dimensions.depth;
                const t = dimensions.wall_thickness;
                const bi = b - 2 * t;
                const hi = h - 2 * t;
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">Cross-Sectional Area</div>
                        <div class="equation-formula">\\[ A = b \\cdot h - b_i \\cdot h_i \\]</div>
                        <div class="equation-calculation">A = ${fmtDim(b)}  ${fmtDim(h)}  ${fmtDim(bi)}  ${fmtDim(hi)}</div>
                        <span class="equation-result">A = ${fmtArea(props.area)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Moment of Inertia</div>
                        <div class="equation-formula">\\[ I_x = \\frac{b \\cdot h^3 - b_i \\cdot h_i^3}{12} \\]</div>
                        <div class="equation-calculation">I = (${fmtDim(b)}  ${fmtDim(h)}  ${fmtDim(bi)}  ${fmtDim(hi)}) / 12</div>
                        <span class="equation-result">I = ${fmtInertia(props.Ix)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Section Modulus</div>
                        <div class="equation-formula">\\[ S_x = \\frac{I_x}{c} \\quad \\text{where } c = \\frac{h}{2} \\]</div>
                        <div class="equation-calculation">S = ${fmtInertia(props.Ix)} / ${fmtDim(props.c_top)}</div>
                        <span class="equation-result">S = ${formatEngineering(props.Sx_top, 'm')}</span>
                    </div>
                `;
            } else if (sectionKey === 'c_channel') {
                const d = dimensions.depth;
                const bf = dimensions.flange_width;
                const tf = dimensions.flange_thickness;
                const tw = dimensions.web_thickness;
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">Cross-Sectional Area</div>
                        <div class="equation-formula">\\[ A = 2 \\cdot b_f \\cdot t_f + (d - 2t_f) \\cdot t_w \\]</div>
                        <div class="equation-calculation">A = 2  ${fmtDim(bf)}  ${fmtDim(tf)} + ${fmtDim(d - 2*tf)}  ${fmtDim(tw)}</div>
                        <span class="equation-result">A = ${fmtArea(props.area)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Moment of Inertia</div>
                        <div class="equation-formula">\\[ I_x = \\frac{t_w \\cdot d^3}{12} + 2 \\left[ \\frac{b_f \\cdot t_f^3}{12} + b_f \\cdot t_f \\cdot \\left(\\frac{d - t_f}{2}\\right)^2 \\right] \\]</div>
                        <div class="equation-calculation">Using parallel axis theorem for flanges</div>
                        <span class="equation-result">I = ${fmtInertia(props.Ix)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Section Modulus</div>
                        <div class="equation-formula">\\[ S_x = \\frac{I_x}{c} \\quad \\text{where } c = \\frac{d}{2} \\]</div>
                        <div class="equation-calculation">S = ${fmtInertia(props.Ix)} / ${fmtDim(props.c_top)}</div>
                        <span class="equation-result">S = ${formatEngineering(props.Sx_top, 'm')}</span>
                    </div>
                `;
            } else if (sectionKey === 't_section') {
                const bf = dimensions.flange_width;
                const tf = dimensions.flange_thickness;
                const ds = dimensions.stem_depth;
                const ts = dimensions.stem_thickness;
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">Cross-Sectional Area</div>
                        <div class="equation-formula">\\[ A = b_f \\cdot t_f + d_s \\cdot t_s \\]</div>
                        <div class="equation-calculation">A = ${fmtDim(bf)}  ${fmtDim(tf)} + ${fmtDim(ds)}  ${fmtDim(ts)}</div>
                        <span class="equation-result">A = ${fmtArea(props.area)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Centroid Location</div>
                        <div class="equation-formula">\\[ \\bar{y} = \\frac{A_f \\cdot y_f + A_s \\cdot y_s}{A} \\]</div>
                        <div class="equation-calculation">Centroid from top: ${fmtDim(props.c_top)}</div>
                        <span class="equation-result">c_top = ${fmtDim(props.c_top)}, c_bot = ${fmtDim(props.c_bottom)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Moment of Inertia</div>
                        <div class="equation-formula">\\[ I_x = I_{flange} + I_{stem} \\quad \\text{(using parallel axis theorem)} \\]</div>
                        <div class="equation-calculation">I = (I + Ad) for each component</div>
                        <span class="equation-result">I = ${fmtInertia(props.Ix)}</span>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Section Moduli (Unsymmetric)</div>
                        <div class="equation-formula">\\[ S_{top} = \\frac{I_x}{c_{top}}, \\quad S_{bot} = \\frac{I_x}{c_{bot}} \\]</div>
                        <span class="equation-result">S_top = ${formatEngineering(props.Sx_top, 'm')}, S_bot = ${formatEngineering(props.Sx_bottom, 'm')}</span>
                    </div>
                `;
            } else if (sectionKey === 'standard_steel') {
                const designation = dimensions.designation;
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">AISC Standard Section: ${designation}</div>
                        <div class="equation-formula" style="background: var(--bg-color);">
                            Properties obtained from AISC Steel Construction Manual tabulated values.
                        </div>
                        <div class="equation-calculation">
                            A = ${fmtArea(props.area)}<br>
                            I = ${fmtInertia(props.Ix)}<br>
                            S = ${formatEngineering(props.Sx_top, 'm')}
                        </div>
                    </div>
                `;
            } else if (sectionKey === 'custom') {
                html = `
                    <div class="equation-step">
                        <div class="equation-step-title">Custom Section Properties</div>
                        <div class="equation-formula" style="background: var(--bg-color);">
                            User-specified values directly entered.
                        </div>
                        <div class="equation-calculation">
                            I = ${fmtInertia(props.Ix)}<br>
                            c_top = ${fmtDim(props.c_top)}<br>
                            c_bottom = ${fmtDim(props.c_bottom)}<br>
                            ${props.area > 0 ? 'A = ' + fmtArea(props.area) : 'Area not specified'}
                        </div>
                    </div>
                    <div class="equation-step">
                        <div class="equation-step-title">Section Modulus</div>
                        <div class="equation-formula">\\[ S_x = \\frac{I_x}{c} \\]</div>
                        <span class="equation-result">S_top = ${formatEngineering(props.Sx_top, 'm')}, S_bot = ${formatEngineering(props.Sx_bottom, 'm')}</span>
                    </div>
                `;
            }

            // Add radius of gyration for all section types
            if (props.rx > 0) {
                html += `
                    <div class="equation-step">
                        <div class="equation-step-title">Radius of Gyration</div>
                        <div class="equation-formula">\\[ r_x = \\sqrt{\\frac{I_x}{A}} \\]</div>
                        <div class="equation-calculation">r = (${fmtInertia(props.Ix)} / ${fmtArea(props.area)})</div>
                        <span class="equation-result">r = ${fmtDim(props.rx)}</span>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Typeset MathJax when details is opened
            const details = document.getElementById('section-props-equations');
            details.addEventListener('toggle', function() {
                if (this.open && window.MathJax) {
                    MathJax.typesetPromise([container]);
                }
            }, { once: true });
        }

        function generateDeflectionEquations(result) {
            const container = document.getElementById('deflection-equations-content');
            const info = result.load_case_info || {};
            const span = parseFloat(document.getElementById('span').value);
            const deflectionLimit = document.getElementById('deflection-limit').value;

            // Parse deflection limit ratio
            let limitRatio = 360;
            if (deflectionLimit.startsWith('L/')) {
                limitRatio = parseInt(deflectionLimit.substring(2));
            }

            const html = `
                <div class="equation-step">
                    <div class="equation-step-title">Maximum Deflection Formula</div>
                    <div class="equation-formula">\\[ ${info.max_deflection_formula || '\\delta_{max}'} \\]</div>
                    <div class="equation-calculation">
                        For ${info.load_case_name || 'this load case'}, maximum deflection occurs at ${info.max_deflection_location || 'the critical point'}
                    </div>
                    <span class="equation-result">_max = ${formatEngineering(result.max_deflection, 'm')}</span>
                </div>
                <div class="equation-step">
                    <div class="equation-step-title">Allowable Deflection</div>
                    <div class="equation-formula">\\[ \\delta_{allow} = \\frac{L}{${limitRatio}} \\]</div>
                    <div class="equation-calculation">_allow = ${formatNumber(span, 3)} m / ${limitRatio}</div>
                    <span class="equation-result">_allow = ${formatEngineering(result.allowable_deflection, 'm')}</span>
                </div>
                <div class="equation-step">
                    <div class="equation-step-title">Deflection Utilization</div>
                    <div class="equation-formula">\\[ \\text{Utilization} = \\frac{\\delta_{max}}{\\delta_{allow}} \\times 100\\% \\]</div>
                    <div class="equation-calculation">Utilization = ${formatEngineering(result.max_deflection, 'm')} / ${formatEngineering(result.allowable_deflection, 'm')}  100%</div>
                    <span class="equation-result ${result.deflection_utilization > 100 ? 'style=\"background: var(--danger-color);\"' : ''}">${formatNumber(result.deflection_utilization, 1)}%</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function generateStressEquations(result) {
            const container = document.getElementById('stress-equations-content');
            const props = result.section_properties;
            const safetyFactor = parseFloat(document.getElementById('safety-factor').value) || 1.5;
            const Fy = parseFloat(document.getElementById('yield-strength').value) * 1e6; // MPa to Pa

            const html = `
                <div class="equation-step">
                    <div class="equation-step-title">Maximum Bending Stress</div>
                    <div class="equation-formula">\\[ \\sigma_{max} = \\frac{M_{max} \\cdot c}{I_x} = \\frac{M_{max}}{S_x} \\]</div>
                    <div class="equation-calculation">
                         = ${formatEngineering(result.max_moment, 'Nm')} / ${formatEngineering(props.Sx_top, 'm')}
                    </div>
                    <span class="equation-result">_max = ${formatEngineering(result.max_stress, 'Pa')}</span>
                </div>
                <div class="equation-step">
                    <div class="equation-step-title">Allowable Stress (ASD Method)</div>
                    <div class="equation-formula">\\[ \\sigma_{allow} = \\frac{F_y}{SF} \\]</div>
                    <div class="equation-calculation">
                        _allow = ${formatEngineering(Fy, 'Pa')} / ${formatNumber(safetyFactor, 2)}
                    </div>
                    <span class="equation-result">_allow = ${formatEngineering(result.allowable_stress, 'Pa')}</span>
                </div>
                <div class="equation-step">
                    <div class="equation-step-title">Safety Factor</div>
                    <div class="equation-formula">\\[ SF = \\frac{F_y}{\\sigma_{allow}} \\]</div>
                    <div class="equation-calculation">
                        Applied safety factor: ${formatNumber(safetyFactor, 2)}<br>
                        F_y (Yield Strength) = ${formatEngineering(Fy, 'Pa')}
                    </div>
                    <p style="margin-top: 8px; font-size: 0.85rem; color: var(--text-light);">
                        Typical values: 1.52.0 for buildings, 2.54.0 for critical applications
                    </p>
                </div>
                <div class="equation-step">
                    <div class="equation-step-title">Stress Utilization</div>
                    <div class="equation-formula">\\[ \\text{Utilization} = \\frac{\\sigma_{max}}{\\sigma_{allow}} \\times 100\\% \\]</div>
                    <div class="equation-calculation">Utilization = ${formatEngineering(result.max_stress, 'Pa')} / ${formatEngineering(result.allowable_stress, 'Pa')}  100%</div>
                    <span class="equation-result ${result.stress_utilization > 100 ? 'style=\"background: var(--danger-color);\"' : ''}">${formatNumber(result.stress_utilization, 1)}%</span>
                </div>
            `;

            container.innerHTML = html;
        }

        function initGaugeToggles() {
            document.querySelectorAll('.gauge-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.dataset.target;
                    const equationsDiv = document.getElementById(targetId);
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';

                    // Toggle state
                    this.setAttribute('aria-expanded', !isExpanded);
                    equationsDiv.classList.toggle('open', !isExpanded);

                    // Typeset MathJax when opening
                    if (!isExpanded && window.MathJax) {
                        MathJax.typesetPromise([equationsDiv]);
                    }
                });
            });
        }

        function displayResults(result) {
            document.getElementById('results-placeholder').style.display = 'none';
            document.getElementById('results-display').style.display = 'block';

            // Results grid
            const grid = document.getElementById('results-grid');
            grid.innerHTML = '';

            const info = result.load_case_info || {};
            const cards = [
                {
                    label: 'Max Deflection',
                    value: result.max_deflection,
                    unit: 'm',
                    key: 'deflection',
                    details: {
                        location: `At x = ${formatNumber(result.max_deflection_position)} m`,
                        allowable: `Allowable: ${formatEngineering(result.allowable_deflection, 'm')} (${result.deflection_limit_code})`,
                        utilization: `Utilization: ${formatNumber(result.deflection_utilization, 1)}%`,
                        equation: info.max_deflection_formula || '',
                        explanation: 'Maximum vertical displacement of the beam under load. Must be less than the allowable limit to prevent damage to finishes and ensure occupant comfort.'
                    }
                },
                {
                    label: 'Max Bending Moment',
                    value: result.max_moment,
                    unit: 'Nm',
                    key: 'moment',
                    details: {
                        location: info.max_moment_location || 'At critical section',
                        equation: info.max_moment_formula || '',
                        explanation: 'Peak internal bending moment that creates tensile stress on one face and compressive stress on the other. This is the primary driver of bending stress.'
                    }
                },
                {
                    label: 'Max Shear Force',
                    value: result.max_shear,
                    unit: 'N',
                    key: 'shear',
                    details: {
                        location: info.max_shear_location || 'At support',
                        equation: info.max_shear_formula || '',
                        explanation: 'Peak internal shear force, typically maximum at supports. Creates shear stress that is distributed parabolically through the cross-section depth.'
                    }
                },
                {
                    label: 'Max Bending Stress',
                    value: result.max_stress,
                    unit: 'Pa',
                    key: 'stress',
                    details: {
                        allowable: `Allowable: ${formatEngineering(result.allowable_stress, 'Pa')} (Fy/SF)`,
                        utilization: `Utilization: ${formatNumber(result.stress_utilization, 1)}%`,
                        equation: '\\sigma_{max} = \\frac{M_{max} \\cdot c}{I}',
                        explanation: 'Maximum normal stress at the extreme fiber of the cross-section. Must remain below allowable stress to prevent yielding.'
                    }
                },
                {
                    label: 'Beam Self-Weight',
                    value: result.beam_weight,
                    unit: 'N',
                    key: 'weight',
                    details: {
                        perMeter: `Per meter: ${formatEngineering(result.beam_weight / parseFloat(document.getElementById('span').value), 'N/m')}`,
                        explanation: 'Total weight of the beam based on cross-sectional area and material density. For steel, density  7850 kg/m. Self-weight should be considered as an additional distributed load in design.'
                    }
                },
            ];

            cards.forEach((card, index) => {
                const div = document.createElement('div');
                div.className = 'result-card';
                const detailsId = `result-details-${index}`;

                let detailsHTML = '';
                if (card.details) {
                    detailsHTML = '<div class="result-card-details" id="' + detailsId + '">';
                    if (card.details.location) {
                        detailsHTML += `<div class="detail-row"><span class="detail-label">Location</span><span class="detail-value">${card.details.location}</span></div>`;
                    }
                    if (card.details.allowable) {
                        detailsHTML += `<div class="detail-row"><span class="detail-label">${card.details.allowable}</span></div>`;
                    }
                    if (card.details.utilization) {
                        detailsHTML += `<div class="detail-row"><span class="detail-label">${card.details.utilization}</span></div>`;
                    }
                    if (card.details.perMeter) {
                        detailsHTML += `<div class="detail-row"><span class="detail-label">${card.details.perMeter}</span></div>`;
                    }
                    if (card.details.equation) {
                        detailsHTML += `<div class="detail-equation">\\[ ${card.details.equation} \\]</div>`;
                    }
                    if (card.details.explanation) {
                        detailsHTML += `<p>${card.details.explanation}</p>`;
                    }
                    detailsHTML += '</div>';
                }

                div.innerHTML = `
                    <div class="result-card-header">
                        <div class="result-card-main">
                            <div class="label">${card.label}</div>
                            <div class="value">${formatEngineering(card.value, card.unit)}</div>
                        </div>
                        <button class="result-card-toggle" data-target="${detailsId}">Details </button>
                    </div>
                    ${detailsHTML}
                `;

                // Add toggle functionality
                const toggleBtn = div.querySelector('.result-card-toggle');
                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const details = div.querySelector('.result-card-details');
                    const isOpen = details.classList.toggle('open');
                    toggleBtn.textContent = isOpen ? 'Hide ' : 'Details ';
                    if (isOpen && window.MathJax) {
                        MathJax.typesetPromise([details]);
                    }
                });

                grid.appendChild(div);
            });

            // Safety gauges
            updateGauge('deflection', result.deflection_utilization);
            updateGauge('stress', result.stress_utilization);

            // Generate safety check equations (progressive disclosure)
            generateDeflectionEquations(result);
            generateStressEquations(result);

            // Status banner
            const banner = document.getElementById('status-banner');
            const icon = document.getElementById('status-icon');
            const title = document.getElementById('status-title');
            const msg = document.getElementById('status-message');
            const recList = document.getElementById('recommendations-list');

            banner.style.display = 'flex';
            banner.className = `status-banner ${result.status}`;

            if (result.status === 'acceptable') {
                icon.textContent = '';
                title.textContent = 'Design Acceptable';
                msg.textContent = 'All safety checks passed with adequate margin.';
            } else if (result.status === 'marginal') {
                icon.textContent = '';
                title.textContent = 'Design Marginal';
                msg.textContent = 'Design passes but utilization is high.';
            } else {
                icon.textContent = '';
                title.textContent = 'Design Not Acceptable';
                msg.textContent = 'One or more safety checks failed.';
            }

            recList.innerHTML = '';
            (result.recommendations || []).forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recList.appendChild(li);
            });

            // Section properties table
            const tbody = document.querySelector('#section-properties-table tbody');
            tbody.innerHTML = '';
            const props = result.section_properties;
            const propRows = [
                ['Area (A)', formatEngineering(props.area, 'm')],
                ['Moment of Inertia (I)', formatEngineering(props.Ix, 'm')],
                ['Section Modulus - Top (Sx)', formatEngineering(props.Sx_top, 'm')],
                ['Section Modulus - Bottom (Sx)', formatEngineering(props.Sx_bottom, 'm')],
                ['Distance to Top Fiber (c)', formatNumber(props.c_top * 1000, 1) + ' mm'],
                ['Distance to Bottom Fiber (c)', formatNumber(props.c_bottom * 1000, 1) + ' mm'],
            ];

            propRows.forEach(([label, value]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${label}</td><td>${value}</td>`;
                tbody.appendChild(tr);
            });

            // Generate section property equations (progressive disclosure)
            const sectionType = document.getElementById('section-type').value;
            const dimensions = getSectionDimensions();
            generateSectionEquations(sectionType, dimensions, props);

            // Typeset math
            if (window.MathJax) MathJax.typesetPromise();
        }

        function updateGauge(type, utilization) {
            const bar = document.getElementById(`${type}-bar`);
            const value = document.getElementById(`${type}-value`);

            const pct = Math.min(utilization, 150);
            bar.style.width = `${Math.min(pct, 100)}%`;

            let colorClass = 'success';
            if (utilization > 100) colorClass = 'danger';
            else if (utilization > 85) colorClass = 'warning';

            bar.className = `gauge-bar ${colorClass}`;
            value.className = `gauge-value ${colorClass}`;
            value.textContent = `${utilization.toFixed(1)}%`;
        }

        function showDerivation(key, result) {
            const panel = document.getElementById('derivation-panel');
            const title = document.getElementById('derivation-title');
            const content = document.getElementById('derivation-content');

            panel.classList.add('visible');

            const info = result.load_case_info;

            if (key === 'deflection') {
                title.textContent = 'Maximum Deflection Derivation';
                content.innerHTML = `
                    <div class="derivation-step">
                        <div class="step-title">Formula</div>
                        <div class="equation">\\[ ${info.max_deflection_formula} \\]</div>
                    </div>
                    <div class="derivation-step">
                        <div class="step-title">Result</div>
                        <div class="result-box">${formatEngineering(result.max_deflection, 'm')} at x = ${formatNumber(result.max_deflection_position)} m</div>
                    </div>
                    <div class="derivation-step">
                        <div class="step-title">Allowable</div>
                        <p>${result.deflection_limit_code} = ${formatEngineering(result.allowable_deflection, 'm')}</p>
                    </div>
                `;
            } else if (key === 'moment') {
                title.textContent = 'Maximum Bending Moment Derivation';
                content.innerHTML = `
                    <div class="derivation-step">
                        <div class="step-title">Formula</div>
                        <div class="equation">\\[ ${info.max_moment_formula} \\]</div>
                    </div>
                    <div class="derivation-step">
                        <div class="step-title">Result</div>
                        <div class="result-box">${formatEngineering(result.max_moment, 'Nm')}</div>
                    </div>
                `;
            } else if (key === 'stress') {
                title.textContent = 'Maximum Stress Derivation';
                content.innerHTML = `
                    <div class="derivation-step">
                        <div class="step-title">Formula</div>
                        <div class="equation">\\[ \\sigma_{max} = \\frac{M_{max} \\cdot c}{I} \\]</div>
                    </div>
                    <div class="derivation-step">
                        <div class="step-title">Result</div>
                        <div class="result-box ${result.stress_utilization > 100 ? 'bad' : ''}">${formatEngineering(result.max_stress, 'Pa')}</div>
                    </div>
                    <div class="derivation-step">
                        <div class="step-title">Allowable</div>
                        <p>Fy / SF = ${formatEngineering(result.allowable_stress, 'Pa')}</p>
                    </div>
                `;
            }

            if (window.MathJax) MathJax.typesetPromise();
        }

        // =============================================================================
        // DIAGRAMS
        // =============================================================================
        function updateDiagrams(result) {
            drawBeamDiagram(result);
            drawDeflectionDiagram(result);
        }

        function drawBeamDiagram(result) {
            const svg = document.getElementById('beam-diagram');
            const loadCase = document.getElementById('load-case').value;
            const span = parseFloat(document.getElementById('span').value);

            const margin = 60;
            const width = 600 - 2 * margin;
            const beamY = 100;

            let html = '';

            // Beam line
            html += `<line x1="${margin}" y1="${beamY}" x2="${margin + width}" y2="${beamY}"
                     stroke="#111827" stroke-width="8" stroke-linecap="round"/>`;

            // Supports
            const supportType = result.load_case_info.support_type;

            if (supportType === 'simply_supported') {
                // Pin at left
                html += `<polygon points="${margin},${beamY+5} ${margin-15},${beamY+30} ${margin+15},${beamY+30}"
                         fill="none" stroke="#111827" stroke-width="2"/>`;
                // Roller at right
                html += `<polygon points="${margin+width},${beamY+5} ${margin+width-15},${beamY+30} ${margin+width+15},${beamY+30}"
                         fill="none" stroke="#111827" stroke-width="2"/>`;
                html += `<circle cx="${margin+width}" cy="${beamY+35}" r="5" fill="none" stroke="#111827" stroke-width="2"/>`;
            } else if (supportType === 'cantilever') {
                // Fixed at left
                html += `<rect x="${margin-15}" y="${beamY-30}" width="15" height="60" fill="#111827"/>`;
                html += `<line x1="${margin-15}" y1="${beamY-30}" x2="${margin-15}" y2="${beamY+30}" stroke="#111827" stroke-width="3"/>`;
            } else if (supportType === 'fixed_fixed') {
                // Fixed at both ends
                html += `<rect x="${margin-15}" y="${beamY-30}" width="15" height="60" fill="#111827"/>`;
                html += `<rect x="${margin+width}" y="${beamY-30}" width="15" height="60" fill="#111827"/>`;
            } else if (supportType === 'propped') {
                // Fixed at left, pin at right
                html += `<rect x="${margin-15}" y="${beamY-30}" width="15" height="60" fill="#111827"/>`;
                html += `<polygon points="${margin+width},${beamY+5} ${margin+width-15},${beamY+30} ${margin+width+15},${beamY+30}"
                         fill="none" stroke="#111827" stroke-width="2"/>`;
            }

            // Load arrows
            const loadType = result.load_case_info.load_type;

            if (loadType === 'point') {
                let loadX = margin + width / 2;
                if (loadCase.includes('_end')) loadX = margin + width;
                if (loadCase.includes('_any')) {
                    const pos = parseFloat(document.getElementById('load-position').value) || span/2;
                    loadX = margin + (pos / span) * width;
                }

                html += `<line x1="${loadX}" y1="${beamY-60}" x2="${loadX}" y2="${beamY-10}"
                         stroke="#b91c1c" stroke-width="3"/>`;
                html += `<polygon points="${loadX},${beamY-10} ${loadX-8},${beamY-25} ${loadX+8},${beamY-25}"
                         fill="#b91c1c"/>`;
                html += `<text x="${loadX}" y="${beamY-70}" text-anchor="middle" font-size="14" font-weight="600" fill="#b91c1c">P</text>`;
            } else if (loadType === 'distributed') {
                // UDL arrows
                const numArrows = 8;
                for (let i = 0; i <= numArrows; i++) {
                    const x = margin + (i / numArrows) * width;
                    html += `<line x1="${x}" y1="${beamY-50}" x2="${x}" y2="${beamY-10}"
                             stroke="#b91c1c" stroke-width="2"/>`;
                    html += `<polygon points="${x},${beamY-10} ${x-5},${beamY-20} ${x+5},${beamY-20}"
                             fill="#b91c1c"/>`;
                }
                html += `<line x1="${margin}" y1="${beamY-50}" x2="${margin+width}" y2="${beamY-50}"
                         stroke="#b91c1c" stroke-width="2"/>`;
                html += `<text x="${margin+width/2}" y="${beamY-60}" text-anchor="middle" font-size="14" font-weight="600" fill="#b91c1c">w</text>`;
            }

            // Dimension line
            html += `<line x1="${margin}" y1="${beamY+50}" x2="${margin+width}" y2="${beamY+50}"
                     stroke="#6b7280" stroke-width="1" marker-start="url(#arrow)" marker-end="url(#arrow)"/>`;
            html += `<text x="${margin+width/2}" y="${beamY+70}" text-anchor="middle" font-size="12" fill="#6b7280">L = ${span} m</text>`;

            // Arrow marker definition
            html = `<defs>
                <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                    <path d="M0,0 L10,5 L0,10 Z" fill="#6b7280"/>
                </marker>
            </defs>` + html;

            svg.innerHTML = html;
        }

        function drawDeflectionDiagram(result) {
            const svg = document.getElementById('deflection-diagram');
            const curve = result.curve;

            if (!curve || curve.length === 0) {
                svg.innerHTML = '<text x="300" y="75" text-anchor="middle" fill="#6b7280">No data</text>';
                return;
            }

            const margin = 60;
            const width = 600 - 2 * margin;
            const height = 100;
            const baseY = 40;

            // Find max deflection for scaling
            const maxDefl = Math.max(...curve.map(p => Math.abs(p.deflection)));
            const scale = maxDefl > 0 ? (height * 0.8) / maxDefl : 1;

            // Build path
            const points = curve.map((p, i) => {
                const x = margin + (i / (curve.length - 1)) * width;
                const y = baseY + p.deflection * scale;
                return `${x},${y}`;
            });

            let html = '';

            // Original beam line (dashed)
            html += `<line x1="${margin}" y1="${baseY}" x2="${margin + width}" y2="${baseY}"
                     stroke="#e5e7eb" stroke-width="2" stroke-dasharray="8,4"/>`;

            // Deflected shape
            html += `<polyline points="${points.join(' ')}"
                     fill="none" stroke="#3b82f6" stroke-width="3"/>`;

            // Max deflection annotation
            const maxIdx = curve.findIndex(p => Math.abs(p.deflection) === maxDefl);
            const maxX = margin + (maxIdx / (curve.length - 1)) * width;
            const maxY = baseY + curve[maxIdx].deflection * scale;

            html += `<circle cx="${maxX}" cy="${maxY}" r="5" fill="#3b82f6"/>`;
            html += `<text x="${maxX}" y="${maxY + 20}" text-anchor="middle" font-size="11" fill="#3b82f6">
                      = ${formatEngineering(maxDefl, 'm')}</text>`;

            svg.innerHTML = html;
        }

        // =============================================================================
        // CHARTS
        // =============================================================================
        let currentChartType = 'deflection';

        function updateCharts(result) {
            drawChart(currentChartType, result);
        }

        function drawChart(chartType, result) {
            const curve = result.curve;
            if (!curve) return;

            const x = curve.map(p => p.x);
            let y, title, yLabel;

            if (chartType === 'deflection') {
                y = curve.map(p => p.deflection * 1000); // mm
                title = 'Deflection Along Beam';
                yLabel = 'Deflection (mm)';
            } else if (chartType === 'moment') {
                y = curve.map(p => p.moment / 1000); // kNm
                title = 'Bending Moment Diagram';
                yLabel = 'Moment (kNm)';
            } else if (chartType === 'shear') {
                y = curve.map(p => p.shear / 1000); // kN
                title = 'Shear Force Diagram';
                yLabel = 'Shear (kN)';
            } else if (chartType === 'combined') {
                // Multiple traces
                const traces = [
                    {
                        x: x,
                        y: curve.map(p => p.deflection * 1000),
                        name: 'Deflection (mm)',
                        yaxis: 'y',
                    },
                    {
                        x: x,
                        y: curve.map(p => p.moment / 1000),
                        name: 'Moment (kNm)',
                        yaxis: 'y2',
                    },
                ];

                Plotly.newPlot('response-chart', traces, {
                    title: 'Combined Response',
                    xaxis: { title: 'Position (m)' },
                    yaxis: { title: 'Deflection (mm)', side: 'left' },
                    yaxis2: { title: 'Moment (kNm)', side: 'right', overlaying: 'y' },
                    legend: { x: 0.5, y: 1.1, orientation: 'h' },
                    margin: { t: 60, b: 50, l: 60, r: 60 },
                }, { responsive: true });
                return;
            }

            const trace = {
                x: x,
                y: y,
                type: 'scatter',
                mode: 'lines',
                fill: chartType === 'deflection' ? 'tozeroy' : 'none',
                line: { color: '#3b82f6', width: 2 },
                fillcolor: 'rgba(59, 130, 246, 0.1)',
            };

            Plotly.newPlot('response-chart', [trace], {
                title: title,
                xaxis: { title: 'Position along beam (m)' },
                yaxis: { title: yLabel },
                margin: { t: 50, b: 50, l: 60, r: 30 },
            }, { responsive: true });
        }

        // =============================================================================
        // EQUATIONS
        // =============================================================================
        function updateEquations(result) {
            const info = result.load_case_info;

            document.getElementById('eq-deflection').innerHTML = `\\[ ${info.max_deflection_formula} \\]`;
            document.getElementById('eq-moment').innerHTML = `\\[ ${info.max_moment_formula} \\]`;
            document.getElementById('eq-shear').innerHTML = `\\[ ${info.max_shear_formula} \\]`;

            if (window.MathJax) MathJax.typesetPromise();
        }

        // =============================================================================
        // EVENT LISTENERS
        // =============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            initSettings();
            initPyodide();
            initGaugeToggles();

            // Mode toggle
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => setMode(btn.dataset.mode));
            });

            // Output tabs
            document.querySelectorAll('.tab-link').forEach(btn => {
                btn.addEventListener('click', () => openTab(btn.dataset.target));
            });

            // Input tabs
            document.querySelectorAll('.input-tab').forEach(btn => {
                btn.addEventListener('click', () => openInputSection(btn.dataset.section));
            });

            // Chart tabs
            document.querySelectorAll('.chart-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.chart-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentChartType = btn.dataset.chart;
                    if (currentResult) drawChart(currentChartType, currentResult);
                });
            });

            // Section type change
            document.getElementById('section-type').addEventListener('change', () => {
                renderSectionFields();
                scheduleCalculation();
            });

            // Load case change
            document.getElementById('load-case').addEventListener('change', () => {
                updateLoadLabel();
                scheduleCalculation();
            });

            // Material change
            document.getElementById('material').addEventListener('change', () => {
                updateMaterialDisplay();
                scheduleCalculation();
            });

            // Load value change for total load display
            document.getElementById('load-value').addEventListener('input', () => {
                updateTotalLoad();
                scheduleCalculation();
            });
            document.getElementById('span').addEventListener('input', () => {
                updateTotalLoad();
                scheduleCalculation();
            });

            // Auto-calc for other inputs
            ['load-position', 'elastic-modulus', 'yield-strength', 'safety-factor', 'deflection-limit'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', scheduleCalculation);
                    el.addEventListener('change', scheduleCalculation);
                }
            });

            // Advanced toggle
            document.getElementById('toggle-material-advanced').addEventListener('click', () => {
                const section = document.getElementById('material-advanced');
                const btn = document.getElementById('toggle-material-advanced');
                section.classList.toggle('visible');
                btn.innerHTML = section.classList.contains('visible') ?
                    '<span></span> Hide Advanced Options' : '<span></span> Show Advanced Options';
            });

            // Derivation close
            document.getElementById('close-derivation').addEventListener('click', () => {
                document.getElementById('derivation-panel').classList.remove('visible');
            });

            // Calculate button
            document.getElementById('calculate-btn').addEventListener('click', calculate);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YG3SBRRZFZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YG3SBRRZFZ');
    </script>

    <title>Battery Runtime Estimator - Engineering Tools</title>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <style>
        /* --- 1. Global Styles & Variables --- */
        :root {
            --primary-color: #0b0d12;
            --primary-light: #f4f5f7;
            --secondary-color: #4b5563;
            --accent-color: #111827;
            --success-color: #0f766e;
            --warning-color: #b45309;
            --danger-color: #b91c1c;
            --text-color: #111827;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --bg-color: #f8f9fb;
            --bg-card: #ffffff;
            --shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 6px 18px rgba(15, 23, 42, 0.08);
            --border-radius: 8px;
            --font-sans: 'Helvetica Neue', 'Avenir Next', 'Univers', 'Helvetica', sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-sans);
            line-height: 1.6;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container { width: 92%; max-width: 1400px; margin: 0 auto; padding: 24px 0; }
        h1, h2, h3, h4 { color: var(--primary-color); margin-bottom: 0.75em; line-height: 1.2; font-weight: 700; }
        h1 { font-size: 2.25rem; letter-spacing: -0.01em; }
        h2 { font-size: 1.4rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        h3 { font-size: 1.05rem; color: var(--secondary-color); font-weight: 600; }
        h4 { font-size: 1rem; color: var(--secondary-color); font-weight: 600; }
        p { margin-bottom: 1em; color: var(--text-light); }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }

        /* --- 2. Navigation --- */
        .navbar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            box-shadow: none;
            padding: 0 5%;
        }
        .nav-container { display: flex; justify-content: space-between; align-items: center; height: 64px; max-width: 1400px; margin: 0 auto; }
        .nav-brand { font-size: 1.35rem; font-weight: 600; color: var(--text-color); letter-spacing: -0.01em; }
        .nav-brand:hover { text-decoration: none; color: var(--text-color); }

        /* --- 3. Main Tool Layout --- */
        main.container { flex-grow: 1; }
        .tool-header { text-align: center; margin-bottom: 2rem; }
        .tool-header h1 { margin-bottom: 0.5rem; }
        .tool-description { font-size: 1.15rem; max-width: 70ch; margin: 0 auto 1.5rem; color: var(--text-light); }
        .tool-layout { display: grid; grid-template-columns: minmax(360px, 0.9fr) minmax(480px, 1.1fr); gap: 28px; align-items: start; }
        .card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 28px;
        }

        /* --- 3b. Purpose/README Section --- */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .purpose-section { margin-bottom: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--bg-card); }
        .purpose-section summary { padding: 16px 24px; font-size: 1rem; font-weight: 600; color: var(--text-color); display: flex; justify-content: space-between; align-items: center; }
        .purpose-section summary::after {
            content: 'Expand';
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-light);
            border: 1px solid var(--border-color);
            padding: 2px 8px;
            border-radius: 999px;
        }
        .purpose-section[open] > summary::after { content: 'Collapse'; }
        .purpose-content { padding: 0 24px 24px 24px; border-top: 1px solid var(--border-color); }
        .purpose-content h3 { margin-top: 1rem; }
        .purpose-content ul { padding-left: 20px; margin-bottom: 1rem; }

        /* --- 4. Input Section --- */
        .tool-inputs h2 { margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center; }
        .tool-inputs h2::before { content: none; }
        .inputs-intro { font-size: 0.95rem; color: var(--text-light); margin-bottom: 1rem; }

        .input-tabs { display: flex; gap: 6px; margin-bottom: 1.25rem; flex-wrap: wrap; }
        .input-tab {
            flex: 1 1 auto;
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            letter-spacing: 0.02em;
            transition: all 0.2s ease;
            text-align: center;
        }
        .input-tab:hover { border-color: var(--text-color); color: var(--text-color); }
        .input-tab.active {
            background: #fff;
            color: var(--text-color);
            border-color: var(--text-color);
            box-shadow: none;
        }
        .input-section { display: none; animation: fadeIn 0.3s ease; }
        .input-section.active { display: block; }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
        .input-group { margin-bottom: 1.1rem; position: relative; }
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: 100%;
            padding: 12px 14px;
            padding-right: 38px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fff;
        }
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--text-color);
            box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.08);
        }
        .input-group select {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: none;
        }
        .input-group input[type="number"]::-webkit-inner-spin-button,
        .input-group input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-group input[type="number"] { -moz-appearance: textfield; }
        .input-hint { font-size: 0.85rem; color: var(--text-light); margin-top: 6px; }

        /* --- 5. Input Tooltip --- */
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: #f1f5f9;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            position: absolute;
            right: 8px;
            top: 42px;
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.5;
            white-space: normal;
            width: 220px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        .tooltip-trigger:hover::after { opacity: 1; visibility: visible; }

        /* --- 6. Button Styles --- */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background: var(--text-color);
            color: white;
            width: 100%;
            font-size: 1.1rem;
            padding: 14px;
            margin-top: 8px;
            box-shadow: none;
        }
        .btn-primary:hover {
            background: #050608;
        }
        .btn-secondary {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background-color: var(--primary-light); }

        /* --- 7. Output Section --- */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; gap: 4px; }
        .tab-link {
            padding: 12px 20px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s ease;
        }
        .tab-link:hover { color: var(--text-color); }
        .tab-link.active {
            color: var(--text-color);
            font-weight: 600;
            border-bottom-color: var(--text-color);
        }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 7a. Results Display --- */
        #results-display { min-height: 200px; }
        .results-section { margin-bottom: 24px; }
        .results-section h4 { margin-bottom: 12px; }
        .results-grid { display: flex; flex-direction: column; gap: 12px; }
        .result-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            grid-template-rows: auto auto;
            gap: 4px 16px;
            align-items: center;
        }
        .result-card.highlight {
            background: #f7f7f8;
            border-color: var(--text-color);
        }
        .result-card .label { font-size: 0.9rem; color: var(--text-light); font-weight: 500; grid-column: 1; grid-row: 1; }
        .result-card .value { font-size: 1.3rem; font-weight: 700; color: var(--text-color); font-family: var(--font-mono); grid-column: 2; grid-row: 1; text-align: right; }
        .result-card .unit { font-size: 0.9rem; color: var(--text-light); margin-left: 4px; }
        .result-card .range { font-size: 0.8rem; color: var(--text-light); grid-column: 1 / -1; grid-row: 2; }

        /* --- 7b. Inline Equation Details --- */
        .result-card details.inline-details {
            margin-top: 8px;
            grid-column: 1 / -1;
            grid-row: 3;
        }
        .result-card details.inline-details summary {
            list-style: none;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--accent-color);
            font-weight: 600;
        }
        .result-card details.inline-details summary::-webkit-details-marker { display: none; }
        .result-card .equation-details {
            margin-top: 10px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.9rem;
            color: var(--secondary-color);
            text-align: left;
        }
        .result-card .equation-details p { margin-bottom: 8px; }
        .result-card .equation-details p:last-child { margin-bottom: 0; }
        .result-card .equation-details .MathJax { font-size: 0.95em !important; }
        .result-card .equation-details mjx-container { display: block !important; margin: 4px 0; }

        /* --- 7c. Performance Gauges --- */
        .safety-section { margin-top: 24px; }
        .safety-section h4 { margin-bottom: 16px; color: var(--secondary-color); }
        .safety-gauge {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
            padding: 12px 16px;
            background: var(--bg-color);
            border-radius: 8px;
        }
        .gauge-label { min-width: 160px; font-weight: 600; font-size: 0.9rem; }
        .gauge-bar-container { flex: 1; height: 10px; background: #e5e7eb; border-radius: 5px; position: relative; overflow: visible; }
        .gauge-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease; }
        .gauge-bar.success { background: var(--success-color); }
        .gauge-bar.warning { background: var(--warning-color); }
        .gauge-bar.danger { background: var(--danger-color); }
        .gauge-value {
            min-width: 80px;
            text-align: right;
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.95rem;
        }
        .gauge-value.success { color: var(--success-color); }
        .gauge-value.warning { color: var(--warning-color); }
        .gauge-value.danger { color: var(--danger-color); }
        .gauge-threshold {
            position: absolute;
            width: 2px;
            height: 18px;
            background: var(--text-color);
            top: -4px;
        }

        /* --- 7d. Status Banner --- */
        .status-banner {
            padding: 18px 24px;
            border-radius: var(--border-radius);
            margin-top: 24px;
            display: flex;
            align-items: flex-start;
            gap: 14px;
            background: #f7f7f8;
            border: 1px solid var(--border-color);
        }
        .status-banner .icon { font-size: 1.5rem; }
        .status-banner .content h4 { margin-bottom: 4px; }
        .status-banner .content p { margin-bottom: 0; font-size: 0.9rem; }
        .status-banner.acceptable { border-left: 3px solid var(--success-color); }
        .status-banner.acceptable h4 { color: var(--success-color); }
        .status-banner.marginal { border-left: 3px solid var(--warning-color); }
        .status-banner.marginal h4 { color: var(--warning-color); }
        .status-banner.unacceptable { border-left: 3px solid var(--danger-color); }
        .status-banner.unacceptable h4 { color: var(--danger-color); }
        .recommendations { margin-top: 8px; padding-left: 20px; }
        .recommendations li { font-size: 0.85rem; margin-bottom: 4px; }

        /* --- 7e. Chart Containers --- */
        .chart-container {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 20px;
        }
        .chart-container h4 { margin-bottom: 12px; font-size: 1rem; }
        .chart-plot { width: 100%; min-height: 280px; display: flex; align-items: center; justify-content: center; text-align: center; color: var(--text-light); padding: 16px; background: var(--primary-light); border-radius: 8px; }

        /* --- 7f. Interactive Definitions (Tooltips) --- */
        .def { position: relative; cursor: help; border-bottom: 2px dotted var(--border-color); }
        .def::after {
            content: attr(data-def);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.4;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
        }
        .def:hover::after { opacity: 1; visibility: visible; }

        /* --- 7g. Equation Cards --- */
        .equation-container { display: flex; flex-direction: column; gap: 16px; margin-top: 1rem; }
        .equation-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px 20px;
        }
        .equation-card strong { display: block; margin-bottom: 8px; color: var(--secondary-color); font-size: 0.95rem; }
        .equation-card .equation-expression { display: block; margin-bottom: 10px; font-size: 1.1rem; overflow-x: auto; }
        .equation-card .equation-summary { font-size: 0.9rem; color: var(--text-light); margin-bottom: 8px; }
        .equation-card ul { list-style: none; padding-left: 0; display: grid; gap: 6px; font-size: 0.85rem; color: var(--text-light); }
        .equation-card .math-inline { font-weight: 600; color: var(--secondary-color); }

        /* --- 7h. Background Content Sections --- */
        .background-section { margin-bottom: 2rem; }
        .background-section h3 { margin-top: 0; margin-bottom: 1rem; font-size: 1.15rem; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .background-section h4 { margin-top: 1.25rem; margin-bottom: 0.75rem; font-size: 1rem; color: var(--secondary-color); }
        .background-section p { font-size: 0.95rem; line-height: 1.7; margin-bottom: 1rem; }
        .background-section ul, .background-section ol { padding-left: 1.5rem; margin-bottom: 1rem; }
        .background-section li { font-size: 0.95rem; line-height: 1.6; margin-bottom: 0.5rem; }
        .background-section a { color: var(--accent-color); text-decoration: underline; }
        .background-section a:hover { opacity: 0.8; }
        .background-tabs { display: flex; gap: 6px; margin-bottom: 1.5rem; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
        .background-tab {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        .background-tab:hover { border-color: var(--text-color); color: var(--text-color); }
        .background-tab.active { background: var(--text-color); color: #fff; border-color: var(--text-color); }
        .background-panel { display: none; animation: fadeIn 0.3s ease; }
        .background-panel.active { display: block; }

        /* --- 7i. Glossary Styles --- */
        .glossary-grid { display: grid; gap: 12px; }
        .glossary-item {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 14px 18px;
        }
        .glossary-item .term { font-weight: 600; font-size: 0.95rem; color: var(--text-color); margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .glossary-item .term code { font-family: var(--font-mono); font-size: 0.85rem; background: var(--bg-color); padding: 2px 6px; border-radius: 4px; }
        .glossary-item .definition { font-size: 0.9rem; color: var(--text-light); line-height: 1.6; }
        .glossary-item .units { font-size: 0.8rem; color: var(--secondary-color); margin-top: 4px; font-family: var(--font-mono); }
        .glossary-item .typical { font-size: 0.8rem; color: var(--text-light); margin-top: 4px; font-style: italic; }
        .glossary-category { margin-bottom: 1.5rem; }
        .glossary-category h4 { margin-bottom: 12px; font-size: 1rem; color: var(--secondary-color); }

        /* --- 7j. Reference Cards --- */
        .reference-list { display: flex; flex-direction: column; gap: 12px; }
        .reference-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 14px 18px;
        }
        .reference-card .ref-title { font-weight: 600; font-size: 0.95rem; color: var(--text-color); margin-bottom: 4px; }
        .reference-card .ref-authors { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
        .reference-card .ref-source { font-size: 0.85rem; color: var(--secondary-color); font-style: italic; }
        .reference-card .ref-link { font-size: 0.85rem; margin-top: 6px; }
        .reference-card .ref-link a { color: var(--accent-color); }

        /* --- 7k. Chemistry Comparison Table --- */
        .chemistry-table { width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9rem; }
        .chemistry-table th, .chemistry-table td { padding: 10px 12px; text-align: left; border: 1px solid var(--border-color); }
        .chemistry-table th { background: var(--bg-color); font-weight: 600; color: var(--text-color); }
        .chemistry-table td { background: #fff; color: var(--text-light); }
        .chemistry-table tr:hover td { background: var(--primary-light); }

        /* --- 7l. Discharge Curve Placeholder --- */
        .curve-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 1rem; }
        .curve-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
        }
        .curve-card h5 { font-size: 0.95rem; color: var(--text-color); margin-bottom: 8px; }
        .curve-card .curve-plot { height: 180px; background: var(--bg-color); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--text-light); font-size: 0.85rem; }
        .curve-card .curve-notes { font-size: 0.8rem; color: var(--text-light); margin-top: 8px; line-height: 1.5; }

        /* --- 8. Footer --- */
        .footer {
            text-align: center;
            padding: 24px 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: auto;
        }

        /* --- 9. Responsive Layout --- */
        @media (max-width: 1000px) {
            .tool-layout { grid-template-columns: 1fr; }
            .input-row { grid-template-columns: 1fr; }
            .chemistry-table { font-size: 0.8rem; }
            .chemistry-table th, .chemistry-table td { padding: 6px 8px; }
        }
        @media (max-width: 600px) {
            .input-tabs { flex-direction: column; }
            .background-tabs { flex-direction: column; }
            .chemistry-table { display: block; overflow-x: auto; }
            .curve-grid { grid-template-columns: 1fr; }
            .glossary-grid { gap: 8px; }
            .result-card { padding: 12px 14px; }
            .result-card .value { font-size: 1.15rem; }
        }

        /* --- 10. Loading State --- */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(248, 249, 251, 0.96);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--text-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-weight: 600; color: var(--text-color); }
    
    .support-link {
      color: inherit;
      font-weight: 600;
      text-decoration: none;
    }

    .support-link:hover {
      text-decoration: underline;
    }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Loading Pyodide...</div>
    </div>

    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
        </nav>
    </header>

    <main class="container">
        <div class="tool-header">
            <h1>Battery Runtime Estimator</h1>
            <p class="tool-description" id="tool-description">
                Estimate runtime based on load type, internal resistance, temperature, and capacity adjustments.
            </p>
        </div>

        <details class="purpose-section">
            <summary>Tool Purpose & README</summary>
            <div class="purpose-content" id="readme-content">
                <p>Loading README...</p>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <p class="inputs-intro">
                    Choose a chemistry preset, then set pack or cell specs. Use the load tab to define current,
                    power, or resistance, and refine runtime with environment and degradation factors.
                </p>
                <div class="input-tabs">
                    <button type="button" class="input-tab active" data-target="section-pack">Pack</button>
                    <button type="button" class="input-tab" data-target="section-cells">Cells</button>
                    <button type="button" class="input-tab" data-target="section-load">Load</button>
                    <button type="button" class="input-tab" data-target="section-environment">Environment</button>
                </div>
                <form id="calc-form">
                    <div id="section-pack" class="input-section active">
                        <div class="input-row">
                            <div class="input-group">
                                <label for="chemistry">Chemistry Preset</label>
                                <select id="chemistry" name="chemistry">
                                    <option value="li_ion_nmc" selected>Li-ion (NMC/NCA)</option>
                                    <option value="lipo">LiPo (high-rate)</option>
                                    <option value="lifepo4">LiFePO4</option>
                                    <option value="nimh">NiMH</option>
                                    <option value="lead_acid">Lead-acid</option>
                                </select>
                                <span class="tooltip-trigger" id="tooltip-chemistry" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="use_cell_specs">Use Cell Specs?</label>
                                <select id="use_cell_specs" name="use_cell_specs">
                                    <option value="1">Yes (derive pack)</option>
                                    <option value="0" selected>No (use pack inputs)</option>
                                </select>
                                <span class="tooltip-trigger" id="tooltip-use_cell_specs" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="pack_nominal_voltage_v">Pack Nominal Voltage (V)</label>
                                <input type="number" id="pack_nominal_voltage_v" name="pack_nominal_voltage_v" value="14.4" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-pack_nominal_voltage_v" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="pack_capacity_ah">Pack Capacity (Ah)</label>
                                <input type="number" id="pack_capacity_ah" name="pack_capacity_ah" value="5.2" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-pack_capacity_ah" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="pack_internal_resistance_ohm">Pack Internal Resistance (Ohm)</label>
                                <input type="number" id="pack_internal_resistance_ohm" name="pack_internal_resistance_ohm" value="0.06" step="0.001">
                                <span class="tooltip-trigger" id="tooltip-pack_internal_resistance_ohm" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="pack_cutoff_voltage_v">Pack Cutoff Voltage (V)</label>
                                <input type="number" id="pack_cutoff_voltage_v" name="pack_cutoff_voltage_v" value="12.0" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-pack_cutoff_voltage_v" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <p class="input-hint">When cell specs are enabled, pack-level values update automatically.</p>
                    </div>

                    <div id="section-cells" class="input-section">
                        <div class="input-row">
                            <div class="input-group">
                                <label for="series_cells">Cells in Series (Ns)</label>
                                <input type="number" id="series_cells" name="series_cells" value="4" step="1">
                                <span class="tooltip-trigger" id="tooltip-series_cells" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="parallel_cells">Cells in Parallel (Np)</label>
                                <input type="number" id="parallel_cells" name="parallel_cells" value="2" step="1">
                                <span class="tooltip-trigger" id="tooltip-parallel_cells" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="cell_nominal_voltage_v">Cell Nominal Voltage (V)</label>
                                <input type="number" id="cell_nominal_voltage_v" name="cell_nominal_voltage_v" value="3.6" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-cell_nominal_voltage_v" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="cell_capacity_ah">Cell Capacity (Ah)</label>
                                <input type="number" id="cell_capacity_ah" name="cell_capacity_ah" value="2.6" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-cell_capacity_ah" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="cell_internal_resistance_ohm">Cell Internal Resistance (Ohm)</label>
                                <input type="number" id="cell_internal_resistance_ohm" name="cell_internal_resistance_ohm" value="0.03" step="0.001">
                                <span class="tooltip-trigger" id="tooltip-cell_internal_resistance_ohm" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="cell_cutoff_voltage_v">Cell Cutoff Voltage (V)</label>
                                <input type="number" id="cell_cutoff_voltage_v" name="cell_cutoff_voltage_v" value="3.0" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-cell_cutoff_voltage_v" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                    </div>

                    <div id="section-load" class="input-section">
                        <div class="input-row">
                            <div class="input-group">
                                <label for="load_type">Load Type</label>
                                <select id="load_type" name="load_type">
                                    <option value="constant_power" selected>Constant power</option>
                                    <option value="constant_current">Constant current</option>
                                    <option value="constant_resistance">Constant resistance</option>
                                </select>
                                <span class="tooltip-trigger" id="tooltip-load_type" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="duty_cycle">Duty Cycle (0-1)</label>
                                <input type="number" id="duty_cycle" name="duty_cycle" value="1.0" step="0.01" min="0" max="1">
                                <span class="tooltip-trigger" id="tooltip-duty_cycle" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="load_current_a">Load Current (A)</label>
                                <input type="number" id="load_current_a" name="load_current_a" value="1.5" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-load_current_a" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="load_power_w">Load Power (W)</label>
                                <input type="number" id="load_power_w" name="load_power_w" value="20" step="0.1">
                                <span class="tooltip-trigger" id="tooltip-load_power_w" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="load_resistance_ohm">Load Resistance (Ohm)</label>
                                <input type="number" id="load_resistance_ohm" name="load_resistance_ohm" value="10" step="0.1">
                                <span class="tooltip-trigger" id="tooltip-load_resistance_ohm" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="converter_efficiency">Converter Efficiency (0-1)</label>
                                <input type="number" id="converter_efficiency" name="converter_efficiency" value="0.9" step="0.01" min="0" max="1">
                                <span class="tooltip-trigger" id="tooltip-converter_efficiency" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                    </div>

                    <div id="section-environment" class="input-section">
                        <div class="input-row">
                            <div class="input-group">
                                <label for="ambient_temperature_c">Ambient Temperature (deg C)</label>
                                <input type="number" id="ambient_temperature_c" name="ambient_temperature_c" value="25" step="0.1">
                                <span class="tooltip-trigger" id="tooltip-ambient_temperature_c" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="reference_temperature_c">Reference Temperature (deg C)</label>
                                <input type="number" id="reference_temperature_c" name="reference_temperature_c" value="25" step="0.1">
                                <span class="tooltip-trigger" id="tooltip-reference_temperature_c" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="capacity_temp_coeff_per_c">Capacity Temp Coeff (1/deg C)</label>
                                <input type="number" id="capacity_temp_coeff_per_c" name="capacity_temp_coeff_per_c" value="0.004" step="0.0001">
                                <span class="tooltip-trigger" id="tooltip-capacity_temp_coeff_per_c" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="peukert_exponent">Peukert Exponent (k)</label>
                                <input type="number" id="peukert_exponent" name="peukert_exponent" value="1.05" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-peukert_exponent" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="reference_current_a">Reference Current (A)</label>
                                <input type="number" id="reference_current_a" name="reference_current_a" value="1.0" step="0.01">
                                <span class="tooltip-trigger" id="tooltip-reference_current_a" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group">
                                <label for="depth_of_discharge">Depth of Discharge (0-1)</label>
                                <input type="number" id="depth_of_discharge" name="depth_of_discharge" value="0.8" step="0.01" min="0" max="1">
                                <span class="tooltip-trigger" id="tooltip-depth_of_discharge" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="state_of_health">State of Health (0-1)</label>
                                <input type="number" id="state_of_health" name="state_of_health" value="1.0" step="0.01" min="0" max="1">
                                <span class="tooltip-trigger" id="tooltip-state_of_health" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="calculate-btn">Calculate</button>
                </form>
            </section>

            <section class="tool-outputs card">
                <div class="tabs">
                    <button class="tab-link active" data-target="results">Results</button>
                    <button class="tab-link" data-target="plot">Visualization</button>
                    <button class="tab-link" data-target="background">Background & Principles</button>
                </div>

                <div id="results" class="tab-content" style="display: block;">
                    <div id="results-display">
                        <p style="text-align: center; color: var(--text-light); padding: 40px;">
                            Enter parameters and click <strong>Calculate</strong> to estimate runtime.
                        </p>
                    </div>
                    <button class="btn btn-secondary" id="export-btn" style="margin-top: 20px;">Export Results</button>
                </div>

                <div id="plot" class="tab-content">
                    <div class="chart-container">
                        <h4>Discharge Curve (Placeholder)</h4>
                        <div id="plot-container" class="chart-plot">
                            Provide a reference discharge profile to visualize voltage vs capacity.
                        </div>
                    </div>
                </div>

                <div id="background" class="tab-content">
                    <div class="background-tabs">
                        <button class="background-tab active" data-bg-target="bg-overview">Overview</button>
                        <button class="background-tab" data-bg-target="bg-glossary">Parameter Glossary</button>
                        <button class="background-tab" data-bg-target="bg-theory">Theory</button>
                        <button class="background-tab" data-bg-target="bg-equations">Equations</button>
                        <button class="background-tab" data-bg-target="bg-chemistries">Chemistries</button>
                        <button class="background-tab" data-bg-target="bg-references">References</button>
                    </div>

                    <!-- Overview Panel -->
                    <div id="bg-overview" class="background-panel active">
                        <div class="background-section">
                            <h3>Battery Runtime Estimation</h3>
                            <p id="background-description">
                                This tool estimates the runtime of a battery pack under specified load conditions,
                                accounting for internal resistance losses, temperature effects, capacity degradation,
                                and the nonlinear behavior captured by Peukert's law.
                            </p>
                            <p>
                                The model uses a <strong>constant nominal open-circuit voltage</strong> with a
                                <strong>lumped internal resistance</strong> to approximate the loaded terminal voltage.
                                While real battery discharge curves are nonlinear, this simplified approach provides
                                practical estimates for initial design and feasibility studies.
                            </p>

                            <h4>Key Capabilities</h4>
                            <ul>
                                <li><strong>Multiple load types:</strong> Constant current, constant power, and constant resistance loads</li>
                                <li><strong>Cell-to-pack aggregation:</strong> Derive pack parameters from individual cell specs</li>
                                <li><strong>Temperature correction:</strong> Adjust capacity based on ambient temperature deviation</li>
                                <li><strong>Peukert effect:</strong> Model capacity reduction at high discharge rates</li>
                                <li><strong>Degradation modeling:</strong> Account for state-of-health and depth-of-discharge limits</li>
                                <li><strong>Efficiency losses:</strong> Include converter/regulator efficiency in power calculations</li>
                            </ul>

                            <h4>Model Assumptions</h4>
                            <ul>
                                <li>The open-circuit voltage remains constant throughout discharge (nominal voltage approximation)</li>
                                <li>Internal resistance is constant and does not vary with state-of-charge or temperature</li>
                                <li>Temperature effects are linear around the reference temperature</li>
                                <li>Duty cycle averaging accurately represents intermittent loads</li>
                                <li>All cells in the pack are identical and balanced</li>
                            </ul>

                            <h4>When to Use This Tool</h4>
                            <p>
                                This estimator is ideal for <strong>preliminary sizing</strong>, <strong>feasibility studies</strong>,
                                and <strong>comparative analysis</strong> between battery chemistries or configurations.
                                For detailed design validation, always verify results against manufacturer discharge curves
                                and, where possible, empirical testing.
                            </p>
                        </div>
                    </div>

                    <!-- Parameter Glossary Panel -->
                    <div id="bg-glossary" class="background-panel">
                        <div class="background-section">
                            <h3>Parameter Glossary</h3>
                            <p>Complete reference for all input parameters and output values used in the estimator.</p>

                            <div class="glossary-category">
                                <h4>Pack Configuration</h4>
                                <div class="glossary-grid">
                                    <div class="glossary-item">
                                        <div class="term">Chemistry Preset <code>chemistry</code></div>
                                        <div class="definition">Selects default values for cell voltage, capacity, internal resistance, cutoff voltage, Peukert exponent, and temperature coefficient based on common battery chemistries. The calculation itself uses numeric parameters; the chemistry label provides sensible starting points.</div>
                                        <div class="typical">Options: Li-ion (NMC/NCA), LiPo, LiFePO4, NiMH, Lead-acid</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Use Cell Specs <code>use_cell_specs</code></div>
                                        <div class="definition">When enabled, pack-level parameters (voltage, capacity, resistance, cutoff) are computed from cell-level values and series/parallel counts. When disabled, pack values are used directly.</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Pack Nominal Voltage <code>pack_nominal_voltage_v</code></div>
                                        <div class="definition">The average voltage of the battery pack during normal discharge. This is used as the open-circuit voltage (OCV) in calculations. For lithium cells, nominal voltage is typically the midpoint of the discharge curve.</div>
                                        <div class="units">Unit: Volts (V)</div>
                                        <div class="typical">Typical: 3.2-3.7V per Li-ion cell, 2.0V per lead-acid cell</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Pack Capacity <code>pack_capacity_ah</code></div>
                                        <div class="definition">The rated capacity of the pack in amp-hours, typically specified at a standard discharge rate (C/20 for lead-acid, C/5 or 1C for lithium). This is the total charge the battery can deliver from full to empty.</div>
                                        <div class="units">Unit: Amp-hours (Ah)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Pack Internal Resistance <code>pack_internal_resistance_ohm</code></div>
                                        <div class="definition">The lumped DC internal resistance of the pack. This causes voltage sag under load and power loss as heat. For a pack with cells in series and parallel: R_pack = (N_s / N_p) * R_cell.</div>
                                        <div class="units">Unit: Ohms</div>
                                        <div class="typical">Typical: 20-100 mOhm for small Li-ion packs, lower for high-power cells</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Pack Cutoff Voltage <code>pack_cutoff_voltage_v</code></div>
                                        <div class="definition">The minimum safe discharge voltage for the pack. Discharging below this voltage can damage cells and reduce cycle life. The estimator checks that loaded voltage stays above this threshold.</div>
                                        <div class="units">Unit: Volts (V)</div>
                                        <div class="typical">Typical: 2.5-3.0V per Li-ion cell, 1.75V per lead-acid cell</div>
                                    </div>
                                </div>
                            </div>

                            <div class="glossary-category">
                                <h4>Cell Configuration</h4>
                                <div class="glossary-grid">
                                    <div class="glossary-item">
                                        <div class="term">Series Cells <code>series_cells</code></div>
                                        <div class="definition">Number of cells connected in series (Ns). Series cells increase voltage: V_pack = Ns * V_cell. Common configurations: 3S (11.1V nominal Li-ion), 4S (14.8V), 6S (22.2V).</div>
                                        <div class="units">Unit: Count (dimensionless)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Parallel Cells <code>parallel_cells</code></div>
                                        <div class="definition">Number of cells connected in parallel (Np). Parallel cells increase capacity and reduce pack resistance: C_pack = Np * C_cell, R_pack = R_cell / Np (before series scaling).</div>
                                        <div class="units">Unit: Count (dimensionless)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Cell Nominal Voltage <code>cell_nominal_voltage_v</code></div>
                                        <div class="definition">The nominal (average) voltage of a single cell. This is chemistry-dependent: 3.6-3.7V for NMC/NCA, 3.2V for LiFePO4, 1.2V for NiMH, 2.0V for lead-acid.</div>
                                        <div class="units">Unit: Volts (V)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Cell Capacity <code>cell_capacity_ah</code></div>
                                        <div class="definition">The rated capacity of a single cell. Common 18650 cells range from 2.0-3.5 Ah; 21700 cells from 4.0-5.0 Ah. Larger format cells (pouch, prismatic) can be 10-100+ Ah.</div>
                                        <div class="units">Unit: Amp-hours (Ah)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Cell Internal Resistance <code>cell_internal_resistance_ohm</code></div>
                                        <div class="definition">The DC internal resistance of a single cell. Lower resistance means higher power capability and less voltage sag. High-power cells may have 10-20 mOhm; high-energy cells 30-60 mOhm.</div>
                                        <div class="units">Unit: Ohms</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Cell Cutoff Voltage <code>cell_cutoff_voltage_v</code></div>
                                        <div class="definition">The minimum safe voltage per cell. Typically 2.5-3.0V for Li-ion, 2.5V for LiFePO4, 1.0V for NiMH, 1.75V for lead-acid.</div>
                                        <div class="units">Unit: Volts (V)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="glossary-category">
                                <h4>Load Parameters</h4>
                                <div class="glossary-grid">
                                    <div class="glossary-item">
                                        <div class="term">Load Type <code>load_type</code></div>
                                        <div class="definition">Defines how the load draws power. <strong>Constant current:</strong> motors, LED drivers (I = fixed). <strong>Constant power:</strong> DC-DC converters, regulated loads (P = fixed, I varies with V). <strong>Constant resistance:</strong> resistive heaters, simple loads (R = fixed, I = V/R).</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Load Current <code>load_current_a</code></div>
                                        <div class="definition">For constant current mode: the current drawn by the load (after any conversion). The battery current is scaled by converter efficiency: I_battery = I_load / efficiency.</div>
                                        <div class="units">Unit: Amperes (A)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Load Power <code>load_power_w</code></div>
                                        <div class="definition">For constant power mode: the power consumed by the load. The tool solves for battery current considering internal resistance losses and converter efficiency.</div>
                                        <div class="units">Unit: Watts (W)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Load Resistance <code>load_resistance_ohm</code></div>
                                        <div class="definition">For constant resistance mode: the equivalent resistance of the load at the battery terminals. Current is determined by V_pack / (R_load + R_internal).</div>
                                        <div class="units">Unit: Ohms</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Converter Efficiency <code>converter_efficiency</code></div>
                                        <div class="definition">The efficiency of any power conversion between battery and load (DC-DC converter, motor controller, etc.). A value of 0.90 means 10% of battery power is lost in conversion.</div>
                                        <div class="units">Unit: Fraction (0-1)</div>
                                        <div class="typical">Typical: 0.85-0.95 for switching regulators, 0.70-0.85 for linear regulators</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Duty Cycle <code>duty_cycle</code></div>
                                        <div class="definition">The fraction of time the load is active. For continuous loads, use 1.0. For intermittent loads (e.g., a motor running 30% of the time), use 0.30. The average current becomes I_avg = I_load * duty_cycle.</div>
                                        <div class="units">Unit: Fraction (0-1)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="glossary-category">
                                <h4>Environment & Degradation</h4>
                                <div class="glossary-grid">
                                    <div class="glossary-item">
                                        <div class="term">Ambient Temperature <code>ambient_temperature_c</code></div>
                                        <div class="definition">The operating temperature of the battery. Capacity decreases at low temperatures and may increase slightly at moderate high temperatures (though cycle life suffers). Extreme temperatures should be avoided.</div>
                                        <div class="units">Unit: Degrees Celsius</div>
                                        <div class="typical">Optimal: 20-25 C for most chemistries</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Reference Temperature <code>reference_temperature_c</code></div>
                                        <div class="definition">The temperature at which rated capacity was measured (typically 25 C or 20 C per manufacturer specs). The temperature coefficient adjusts capacity relative to this baseline.</div>
                                        <div class="units">Unit: Degrees Celsius</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Capacity Temp Coefficient <code>capacity_temp_coeff_per_c</code></div>
                                        <div class="definition">The fractional change in capacity per degree Celsius deviation from reference. A value of 0.004 means capacity drops by 0.4% for each degree below reference (and increases for temperatures above).</div>
                                        <div class="units">Unit: 1/C</div>
                                        <div class="typical">Typical: 0.003-0.006 for lithium, 0.005-0.01 for lead-acid</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Peukert Exponent <code>peukert_exponent</code></div>
                                        <div class="definition">Captures the reduction in effective capacity at high discharge rates. Named after Wilhelm Peukert (1897). A value of 1.0 means no rate dependence; lead-acid batteries have k = 1.1-1.4. Lithium cells are typically 1.02-1.10.</div>
                                        <div class="units">Unit: Dimensionless (k >= 1)</div>
                                        <div class="typical">Typical: 1.02-1.05 (Li-ion), 1.1-1.3 (lead-acid)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Reference Current <code>reference_current_a</code></div>
                                        <div class="definition">The discharge current at which rated capacity was measured. Peukert's correction compares actual current to this reference. Often specified as C/20 or C/5 rate.</div>
                                        <div class="units">Unit: Amperes (A)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Depth of Discharge <code>depth_of_discharge</code></div>
                                        <div class="definition">The fraction of capacity you intend to use. Using only 80% (DoD = 0.80) extends cycle life significantly. For critical applications, 50% DoD may be appropriate.</div>
                                        <div class="units">Unit: Fraction (0-1)</div>
                                        <div class="typical">Typical: 0.80-1.00 for Li-ion, 0.50-0.80 for lead-acid</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">State of Health <code>state_of_health</code></div>
                                        <div class="definition">The remaining capacity as a fraction of original rated capacity. A new battery has SOH = 1.0; an aged battery with 80% of original capacity has SOH = 0.80. End-of-life is often defined as SOH = 0.70-0.80.</div>
                                        <div class="units">Unit: Fraction (0-1)</div>
                                    </div>
                                </div>
                            </div>

                            <div class="glossary-category">
                                <h4>Output Values</h4>
                                <div class="glossary-grid">
                                    <div class="glossary-item">
                                        <div class="term">Runtime <code>runtime_hours</code>, <code>runtime_minutes</code></div>
                                        <div class="definition">The estimated operating time until the battery reaches cutoff voltage or depletes usable capacity. Calculated as effective capacity divided by average current.</div>
                                        <div class="units">Units: Hours (h) or Minutes (min)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Effective Capacity <code>effective_capacity_ah</code></div>
                                        <div class="definition">The usable capacity after all adjustments: temperature correction, SOH, DoD limits, and Peukert derating. This is the capacity available for the specified operating conditions.</div>
                                        <div class="units">Unit: Amp-hours (Ah)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Average Current <code>average_current_a</code></div>
                                        <div class="definition">The time-averaged current drawn from the battery, including duty cycle effects. For continuous operation at fixed current, this equals the instantaneous current.</div>
                                        <div class="units">Unit: Amperes (A)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Average Power <code>average_power_w</code></div>
                                        <div class="definition">The power delivered by the battery at the loaded terminal voltage: P = V_load * I_avg. This is less than V_nominal * I_avg due to internal resistance losses.</div>
                                        <div class="units">Unit: Watts (W)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Energy Delivered <code>energy_delivered_wh</code></div>
                                        <div class="definition">The total energy the battery can deliver: E = V_load * C_effective. This accounts for voltage sag and capacity derating.</div>
                                        <div class="units">Unit: Watt-hours (Wh)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Loaded Voltage <code>loaded_voltage_v</code></div>
                                        <div class="definition">The terminal voltage under load: V_load = V_nominal - I_load * R_internal. This is the voltage available to the load and is lower than open-circuit voltage.</div>
                                        <div class="units">Unit: Volts (V)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Voltage Sag <code>voltage_sag_v</code></div>
                                        <div class="definition">The voltage drop across internal resistance: V_sag = I_load * R_internal. Large sag indicates high power loss and potential thermal issues.</div>
                                        <div class="units">Unit: Volts (V)</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">C-rate <code>c_rate</code></div>
                                        <div class="definition">The discharge rate relative to capacity: C-rate = I_avg / C_rated. A 1C rate fully discharges the battery in 1 hour; 2C in 30 minutes; 0.5C in 2 hours.</div>
                                        <div class="units">Unit: 1/hour</div>
                                    </div>
                                    <div class="glossary-item">
                                        <div class="term">Heat Dissipation <code>power_loss_w</code></div>
                                        <div class="definition">Power lost as heat in the internal resistance: P_loss = I_load^2 * R_internal. This energy heats the battery and is not delivered to the load. High values indicate thermal management may be required.</div>
                                        <div class="units">Unit: Watts (W)</div>
                                        <div class="typical">Concern threshold: varies, but >5-10% of output power warrants attention</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Theory Panel -->
                    <div id="bg-theory" class="background-panel">
                        <div class="background-section">
                            <h3>Battery Fundamentals</h3>

                            <h4>The Basic Runtime Equation</h4>
                            <p>
                                At its simplest, battery runtime is capacity divided by current:
                                <strong>t = C / I</strong>. A 10 Ah battery discharged at 2 A runs for 5 hours.
                                However, real batteries are more complex due to voltage variations, efficiency losses,
                                temperature effects, and rate-dependent capacity.
                            </p>

                            <h4>Open-Circuit Voltage vs. Loaded Voltage</h4>
                            <p>
                                A battery's <strong>open-circuit voltage (OCV)</strong> is measured with no current flowing.
                                Under load, the terminal voltage drops due to internal resistance:
                            </p>
                            <p style="text-align: center; font-family: var(--font-mono);">
                                V_terminal = V_OCV - I * R_internal
                            </p>
                            <p>
                                This <strong>voltage sag</strong> reduces available power and causes energy to be dissipated
                                as heat inside the battery. High-power applications require low internal resistance cells.
                            </p>

                            <h4>Internal Resistance</h4>
                            <p>
                                Internal resistance has multiple components: ionic resistance in the electrolyte,
                                charge-transfer resistance at electrode surfaces, and ohmic resistance in current collectors.
                                For simplified modeling, these are lumped into a single DC resistance value.
                            </p>
                            <p>
                                Internal resistance <strong>increases with age</strong> and <strong>decreases with temperature</strong>
                                (within safe operating limits). Cold batteries have higher resistance and more voltage sag.
                            </p>

                            <h4>Series and Parallel Cell Combinations</h4>
                            <p>
                                Battery packs combine cells in series (S) and parallel (P) to achieve desired voltage and capacity:
                            </p>
                            <ul>
                                <li><strong>Series (S):</strong> Increases voltage. V_pack = N_s * V_cell. Resistance adds: R_series = N_s * R_cell.</li>
                                <li><strong>Parallel (P):</strong> Increases capacity. C_pack = N_p * C_cell. Resistance divides: R_parallel = R_cell / N_p.</li>
                                <li><strong>Combined:</strong> For a pack with S cells in series and P cells in parallel: R_pack = (N_s / N_p) * R_cell.</li>
                            </ul>
                            <p>
                                Pack notation like "4S2P" means 4 cells in series (voltage x4) with 2 parallel groups (capacity x2).
                            </p>

                            <h4>Peukert's Law</h4>
                            <p>
                                Wilhelm Peukert observed in 1897 that lead-acid batteries deliver less total charge when
                                discharged rapidly. This is expressed as:
                            </p>
                            <p style="text-align: center; font-family: var(--font-mono);">
                                C_effective = C_rated * (I_ref / I_actual)^(k-1)
                            </p>
                            <p>
                                where <strong>k</strong> is the Peukert exponent (k >= 1). Lead-acid batteries have k = 1.1-1.4;
                                lithium batteries are closer to ideal with k = 1.02-1.10. At 2x the reference current,
                                a battery with k = 1.2 delivers only (0.5)^0.2 = 87% of rated capacity.
                            </p>

                            <h4>Temperature Effects</h4>
                            <p>
                                Battery capacity is temperature-dependent. The electrochemical reactions slow at low temperatures,
                                reducing available capacity. A typical Li-ion cell may lose 10-20% capacity at 0 C compared to 25 C.
                            </p>
                            <p>
                                The linear approximation used here is:
                            </p>
                            <p style="text-align: center; font-family: var(--font-mono);">
                                C_temp = C_rated * [1 + alpha * (T - T_ref)]
                            </p>
                            <p>
                                This is accurate for moderate deviations (e.g., 0-40 C) but breaks down at extreme temperatures.
                            </p>

                            <h4>State of Health and Cycle Life</h4>
                            <p>
                                Batteries degrade over time and with use. <strong>State of Health (SOH)</strong> represents
                                the current capacity as a fraction of original capacity. A battery with SOH = 0.80 has
                                lost 20% of its original capacity.
                            </p>
                            <p>
                                Degradation accelerates with:
                            </p>
                            <ul>
                                <li>High temperatures (especially when fully charged)</li>
                                <li>Deep discharge cycles</li>
                                <li>High charge/discharge rates</li>
                                <li>Storage at high or very low state-of-charge</li>
                            </ul>

                            <h4>Depth of Discharge</h4>
                            <p>
                                <strong>Depth of Discharge (DoD)</strong> is the fraction of capacity used per cycle.
                                Using 80% of capacity (DoD = 0.80) leaves a 20% buffer. Limiting DoD significantly
                                extends cycle life - a Li-ion cell cycled to 80% DoD may last 2-3x longer than one
                                cycled to 100% DoD.
                            </p>

                            <h4>C-Rate</h4>
                            <p>
                                The <strong>C-rate</strong> normalizes discharge current to capacity. A 10 Ah battery:
                            </p>
                            <ul>
                                <li>At 1C (10 A): depletes in 1 hour</li>
                                <li>At 2C (20 A): depletes in 30 minutes</li>
                                <li>At 0.5C (5 A): depletes in 2 hours</li>
                                <li>At C/10 (1 A): depletes in 10 hours</li>
                            </ul>
                            <p>
                                Maximum continuous C-rate is a key cell specification. High-power cells may support
                                3-5C continuous; high-energy cells may be limited to 1C.
                            </p>

                            <h4>Constant Power Loads</h4>
                            <p>
                                Many modern devices use DC-DC converters that draw constant power regardless of input voltage.
                                As the battery voltage drops, current must increase to maintain power output:
                            </p>
                            <p style="text-align: center; font-family: var(--font-mono);">
                                I = P / V
                            </p>
                            <p>
                                This creates a feedback loop: lower voltage -> higher current -> more voltage sag -> even lower voltage.
                                If internal resistance is too high, the battery cannot deliver the requested power.
                            </p>
                        </div>
                    </div>

                    <!-- Equations Panel -->
                    <div id="bg-equations" class="background-panel">
                        <div class="background-section">
                            <h3>Mathematical Model</h3>
                            <p>The following equations define the battery runtime estimation model.</p>
                            <div class="equation-container" id="equation-container"></div>
                        </div>
                    </div>

                    <!-- Chemistries Panel -->
                    <div id="bg-chemistries" class="background-panel">
                        <div class="background-section">
                            <h3>Battery Chemistry Comparison</h3>
                            <p>
                                Different battery chemistries have distinct characteristics that affect runtime,
                                power capability, cycle life, and safety. This comparison helps select the appropriate
                                chemistry for your application.
                            </p>

                            <table class="chemistry-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Li-ion NMC/NCA</th>
                                        <th>LiPo</th>
                                        <th>LiFePO4</th>
                                        <th>NiMH</th>
                                        <th>Lead-Acid</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Nominal Voltage</td>
                                        <td>3.6-3.7 V</td>
                                        <td>3.7 V</td>
                                        <td>3.2 V</td>
                                        <td>1.2 V</td>
                                        <td>2.0 V</td>
                                    </tr>
                                    <tr>
                                        <td>Cutoff Voltage</td>
                                        <td>2.5-3.0 V</td>
                                        <td>3.0-3.2 V</td>
                                        <td>2.5 V</td>
                                        <td>1.0 V</td>
                                        <td>1.75 V</td>
                                    </tr>
                                    <tr>
                                        <td>Energy Density</td>
                                        <td>150-250 Wh/kg</td>
                                        <td>150-200 Wh/kg</td>
                                        <td>90-120 Wh/kg</td>
                                        <td>60-120 Wh/kg</td>
                                        <td>30-50 Wh/kg</td>
                                    </tr>
                                    <tr>
                                        <td>Cycle Life</td>
                                        <td>500-1000</td>
                                        <td>300-500</td>
                                        <td>2000-5000</td>
                                        <td>500-1000</td>
                                        <td>200-500</td>
                                    </tr>
                                    <tr>
                                        <td>Peukert Exponent</td>
                                        <td>1.02-1.05</td>
                                        <td>1.02-1.04</td>
                                        <td>1.03-1.06</td>
                                        <td>1.05-1.15</td>
                                        <td>1.10-1.30</td>
                                    </tr>
                                    <tr>
                                        <td>Temp Coefficient</td>
                                        <td>0.3-0.5%/C</td>
                                        <td>0.3-0.4%/C</td>
                                        <td>0.2-0.4%/C</td>
                                        <td>0.4-0.6%/C</td>
                                        <td>0.5-1.0%/C</td>
                                    </tr>
                                    <tr>
                                        <td>Self-Discharge</td>
                                        <td>2-3%/month</td>
                                        <td>3-5%/month</td>
                                        <td>1-3%/month</td>
                                        <td>15-30%/month</td>
                                        <td>3-20%/month</td>
                                    </tr>
                                    <tr>
                                        <td>Max C-Rate</td>
                                        <td>1-3C</td>
                                        <td>3-10C</td>
                                        <td>1-3C</td>
                                        <td>1-2C</td>
                                        <td>0.2-1C</td>
                                    </tr>
                                    <tr>
                                        <td>Best For</td>
                                        <td>EVs, laptops, power tools</td>
                                        <td>Drones, RC, high-power</td>
                                        <td>Solar storage, EVs, safety-critical</td>
                                        <td>Hybrid vehicles, consumer devices</td>
                                        <td>UPS, SLI, low-cost storage</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h4>Representative Discharge Curves</h4>
                            <p>
                                The shape of the discharge curve varies significantly by chemistry. Flat curves
                                provide stable voltage; sloped curves give better state-of-charge indication.
                            </p>
                            <div class="curve-grid">
                                <div class="curve-card">
                                    <h5>Li-ion NMC/NCA</h5>
                                    <div class="curve-plot" id="curve-li-ion">
                                        <svg viewBox="0 0 200 100" style="width: 100%; height: 100%;">
                                            <polyline points="10,20 40,28 80,38 120,52 160,75 190,90" fill="none" stroke="#111827" stroke-width="2"/>
                                            <text x="10" y="15" font-size="8" fill="#6b7280">4.2V</text>
                                            <text x="10" y="95" font-size="8" fill="#6b7280">2.5V</text>
                                            <text x="180" y="95" font-size="8" fill="#6b7280">100%</text>
                                        </svg>
                                    </div>
                                    <div class="curve-notes">
                                        Gradual slope from 4.2V to ~3.5V, then steeper drop to cutoff at 2.5-3.0V.
                                        Most capacity delivered between 3.4-3.9V. Good voltage indication of SOC.
                                    </div>
                                </div>
                                <div class="curve-card">
                                    <h5>LiFePO4</h5>
                                    <div class="curve-plot" id="curve-lifepo4">
                                        <svg viewBox="0 0 200 100" style="width: 100%; height: 100%;">
                                            <polyline points="10,25 40,32 80,35 120,38 160,65 190,90" fill="none" stroke="#111827" stroke-width="2"/>
                                            <text x="10" y="15" font-size="8" fill="#6b7280">3.6V</text>
                                            <text x="10" y="95" font-size="8" fill="#6b7280">2.5V</text>
                                            <text x="180" y="95" font-size="8" fill="#6b7280">100%</text>
                                        </svg>
                                    </div>
                                    <div class="curve-notes">
                                        Very flat plateau at ~3.2-3.3V for 80%+ of capacity. Excellent for
                                        applications needing stable voltage. Poor SOC indication from voltage.
                                    </div>
                                </div>
                                <div class="curve-card">
                                    <h5>Lead-Acid</h5>
                                    <div class="curve-plot" id="curve-lead-acid">
                                        <svg viewBox="0 0 200 100" style="width: 100%; height: 100%;">
                                            <polyline points="10,15 40,25 80,40 120,55 160,72 190,90" fill="none" stroke="#111827" stroke-width="2"/>
                                            <text x="10" y="12" font-size="8" fill="#6b7280">2.15V</text>
                                            <text x="10" y="95" font-size="8" fill="#6b7280">1.75V</text>
                                            <text x="180" y="95" font-size="8" fill="#6b7280">100%</text>
                                        </svg>
                                    </div>
                                    <div class="curve-notes">
                                        Steady linear decline. Strong Peukert effect - capacity drops
                                        significantly at high discharge rates. Must limit DoD for cycle life.
                                    </div>
                                </div>
                                <div class="curve-card">
                                    <h5>NiMH</h5>
                                    <div class="curve-plot" id="curve-nimh">
                                        <svg viewBox="0 0 200 100" style="width: 100%; height: 100%;">
                                            <polyline points="10,18 40,28 80,35 120,42 160,60 190,90" fill="none" stroke="#111827" stroke-width="2"/>
                                            <text x="10" y="12" font-size="8" fill="#6b7280">1.4V</text>
                                            <text x="10" y="95" font-size="8" fill="#6b7280">1.0V</text>
                                            <text x="180" y="95" font-size="8" fill="#6b7280">100%</text>
                                        </svg>
                                    </div>
                                    <div class="curve-notes">
                                        Relatively flat at ~1.2V for most of discharge. Sharp drop at end.
                                        High self-discharge rate. Memory effect largely eliminated in modern cells.
                                    </div>
                                </div>
                            </div>

                            <h4>Chemistry Selection Guidelines</h4>
                            <ul>
                                <li><strong>Maximum energy density:</strong> Li-ion NMC/NCA - best for weight/volume constrained applications</li>
                                <li><strong>High power bursts:</strong> LiPo - drones, RC vehicles, peak power applications</li>
                                <li><strong>Long cycle life:</strong> LiFePO4 - stationary storage, commercial EVs, where longevity matters</li>
                                <li><strong>Safety-critical:</strong> LiFePO4 - thermal stability, no thermal runaway risk</li>
                                <li><strong>Low cost:</strong> Lead-acid - UPS, backup power, automotive starting</li>
                                <li><strong>Extreme cold:</strong> Lithium with heating or lead-acid (tolerates cold better when charged)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- References Panel -->
                    <div id="bg-references" class="background-panel">
                        <div class="background-section">
                            <h3>References & Further Reading</h3>
                            <p>
                                Authoritative sources for battery modeling, characterization, and application design.
                            </p>

                            <h4>Textbooks & Handbooks</h4>
                            <div class="reference-list">
                                <div class="reference-card">
                                    <div class="ref-title">Handbook of Batteries (4th Edition)</div>
                                    <div class="ref-authors">D. Linden, T. B. Reddy (eds.)</div>
                                    <div class="ref-source">McGraw-Hill, 2011. ISBN: 978-0071624213</div>
                                    <div class="ref-link"><a href="https://www.accessengineeringlibrary.com/content/book/9780071624213" target="_blank">Access Engineering Library</a></div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">Battery Technology Handbook (2nd Edition)</div>
                                    <div class="ref-authors">H. A. Kiehne (ed.)</div>
                                    <div class="ref-source">CRC Press, 2003. ISBN: 978-0824742492</div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">Electrochemical Power Sources: Batteries, Fuel Cells, and Supercapacitors</div>
                                    <div class="ref-authors">V. S. Bagotsky, A. M. Skundin, Y. M. Volfkovich</div>
                                    <div class="ref-source">Wiley, 2015. ISBN: 978-1118460238</div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">Lithium-Ion Batteries: Science and Technologies</div>
                                    <div class="ref-authors">M. Yoshio, R. J. Brodd, A. Kozawa (eds.)</div>
                                    <div class="ref-source">Springer, 2009. ISBN: 978-0387344447</div>
                                </div>
                            </div>

                            <h4>Technical Papers</h4>
                            <div class="reference-list">
                                <div class="reference-card">
                                    <div class="ref-title">Peukert's Law and the Prediction of Battery Life</div>
                                    <div class="ref-authors">W. Peukert (original 1897); modern analysis in various sources</div>
                                    <div class="ref-source">Describes rate-dependent capacity in lead-acid batteries</div>
                                    <div class="ref-link"><a href="https://en.wikipedia.org/wiki/Peukert%27s_law" target="_blank">Wikipedia Overview</a></div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">A Review of Lithium-Ion Battery State of Health Estimation</div>
                                    <div class="ref-authors">M. Berecibar et al.</div>
                                    <div class="ref-source">Renewable and Sustainable Energy Reviews, 2016</div>
                                    <div class="ref-link"><a href="https://doi.org/10.1016/j.rser.2015.11.042" target="_blank">DOI: 10.1016/j.rser.2015.11.042</a></div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">Modeling of Lithium-Ion Battery Thermal Behavior</div>
                                    <div class="ref-authors">Various authors - extensive literature</div>
                                    <div class="ref-source">Journal of Power Sources, Electrochimica Acta, etc.</div>
                                </div>
                            </div>

                            <h4>Online Resources</h4>
                            <div class="reference-list">
                                <div class="reference-card">
                                    <div class="ref-title">Battery University</div>
                                    <div class="ref-authors">Cadex Electronics</div>
                                    <div class="ref-source">Comprehensive educational resource on battery technology</div>
                                    <div class="ref-link"><a href="https://batteryuniversity.com/" target="_blank">batteryuniversity.com</a></div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">Battery Design and Safety</div>
                                    <div class="ref-authors">MIT OpenCourseWare</div>
                                    <div class="ref-source">Lecture notes and materials on battery fundamentals</div>
                                    <div class="ref-link"><a href="https://ocw.mit.edu/courses/10-426-electrochemical-energy-systems-spring-2022/" target="_blank">MIT OCW 10.426</a></div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">Cell Database - Battery Archive</div>
                                    <div class="ref-authors">Various Contributors</div>
                                    <div class="ref-source">Real-world test data for many commercial cells</div>
                                    <div class="ref-link"><a href="https://www.batteryarchive.org/" target="_blank">batteryarchive.org</a></div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">NREL Battery Thermal Testing</div>
                                    <div class="ref-authors">National Renewable Energy Laboratory</div>
                                    <div class="ref-source">Research on thermal management and safety</div>
                                    <div class="ref-link"><a href="https://www.nrel.gov/transportation/battery-thermal-testing.html" target="_blank">NREL Battery Thermal Testing</a></div>
                                </div>
                            </div>

                            <h4>Manufacturer Datasheets</h4>
                            <div class="reference-list">
                                <div class="reference-card">
                                    <div class="ref-title">Cell Manufacturer Technical Resources</div>
                                    <div class="ref-source">
                                        For accurate parameters, always consult manufacturer datasheets:
                                    </div>
                                    <div class="ref-link">
                                        <a href="https://www.panasonic.com/global/energy/products.html" target="_blank">Panasonic</a> |
                                        <a href="https://www.lgchem.com/products/it-electronic-materials/rechargeable-batteries" target="_blank">LG Chem</a> |
                                        <a href="https://www.samsung.com/global/business/semiconductor/about-us/business-area/battery/" target="_blank">Samsung SDI</a> |
                                        <a href="https://www.catl.com/en/products/" target="_blank">CATL</a>
                                    </div>
                                </div>
                            </div>

                            <h4>Standards & Safety</h4>
                            <div class="reference-list">
                                <div class="reference-card">
                                    <div class="ref-title">UN 38.3 - Transport Testing</div>
                                    <div class="ref-source">UN Manual of Tests and Criteria for lithium battery transport</div>
                                    <div class="ref-link"><a href="https://unece.org/transport/dangerous-goods/un-manual-tests-and-criteria" target="_blank">UN Manual of Tests</a></div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">IEC 62133 - Safety Requirements</div>
                                    <div class="ref-source">International standard for portable sealed secondary cells</div>
                                </div>
                                <div class="reference-card">
                                    <div class="ref-title">UL 2054 / UL 2271 / UL 1973</div>
                                    <div class="ref-source">UL standards for household batteries, light EV batteries, and stationary storage</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Engineering Tools. All tools are for educational purposes. <a class="support-link" href="https://ko-fi.com/transparent_tools" target="_blank" rel="noopener">Support on Ko-fi</a></p>
    </footer>

    <script>
        // --- 0. Global Store & Config ---
        let toolDocumentation = {};
        let latexExpressions = [];
        let pyUtils, pyToolModule;

        // --- CONFIG: Set these for each tool ---
        const TOOL_MODULE_NAME = 'batteries';
        const TOOL_FUNCTION_NAME = 'estimate_battery_runtime';
        const PARAM_ORDER = [
            'chemistry',
            'use_cell_specs',
            'series_cells',
            'parallel_cells',
            'cell_nominal_voltage_v',
            'cell_capacity_ah',
            'cell_internal_resistance_ohm',
            'cell_cutoff_voltage_v',
            'pack_nominal_voltage_v',
            'pack_capacity_ah',
            'pack_internal_resistance_ohm',
            'pack_cutoff_voltage_v',
            'load_type',
            'load_current_a',
            'load_power_w',
            'load_resistance_ohm',
            'converter_efficiency',
            'duty_cycle',
            'peukert_exponent',
            'reference_current_a',
            'ambient_temperature_c',
            'reference_temperature_c',
            'capacity_temp_coeff_per_c',
            'depth_of_discharge',
            'state_of_health'
        ];
        const STRING_PARAMS = new Set(['chemistry', 'load_type']);
        const RESULT_EQUATION_INDEX = {
            runtime_hours: 11,
            runtime_minutes: 11,
            effective_capacity_ah: 10,
            average_current_a: null,
            average_power_w: 13,
            energy_delivered_wh: 12,
            loaded_voltage_v: 6,
            voltage_sag_v: 7,
            c_rate: 14,
            power_loss_w: 15,
            pack_nominal_voltage_v: 0,
            pack_capacity_ah: 1,
            pack_internal_resistance_ohm: 2,
            pack_cutoff_voltage_v: null
        };
        const EQUATION_DESCRIPTIONS = [
            'Series cells scale nominal voltage.',
            'Parallel cells scale capacity.',
            'Series and parallel combine internal resistance.',
            'Constant-current load adjusted by efficiency.',
            'Constant-resistance load current with internal resistance.',
            'Constant-power load current with internal resistance.',
            'Loaded voltage under current draw.',
            'Voltage sag across internal resistance.',
            'Temperature-adjusted capacity.',
            'Capacity limited by SOH and depth-of-discharge.',
            'Peukert-adjusted effective capacity.',
            'Runtime based on effective capacity and average current.',
            'Delivered energy estimate.',
            'Average power at loaded voltage.',
            'C-rate based on average current.',
            'Power dissipated as heat in internal resistance.'
        ];
        const EQUATION_LEGENDS = [
            [
                { symbol: 'V_{pack}', text: 'Pack nominal voltage (V)' },
                { symbol: 'N_s', text: 'Cells in series (count)' },
                { symbol: 'V_{cell}', text: 'Cell nominal voltage (V)' }
            ],
            [
                { symbol: 'C_{pack}', text: 'Pack capacity (Ah)' },
                { symbol: 'N_p', text: 'Cells in parallel (count)' },
                { symbol: 'C_{cell}', text: 'Cell capacity (Ah)' }
            ],
            [
                { symbol: 'R_{pack}', text: 'Pack internal resistance (Ohm)' },
                { symbol: 'N_s', text: 'Cells in series (count)' },
                { symbol: 'N_p', text: 'Cells in parallel (count)' },
                { symbol: 'R_{cell}', text: 'Cell internal resistance (Ohm)' }
            ],
            [
                { symbol: 'I_{load}', text: 'Battery current (A)' },
                { symbol: 'I_{set}', text: 'Requested constant current (A)' },
                { symbol: '\\eta', text: 'Converter efficiency (0-1)' }
            ],
            [
                { symbol: 'I_{load}', text: 'Battery current (A)' },
                { symbol: 'V_{pack}', text: 'Pack nominal voltage (V)' },
                { symbol: 'R_{load}', text: 'Load resistance (Ohm)' },
                { symbol: 'R_{pack}', text: 'Pack internal resistance (Ohm)' }
            ],
            [
                { symbol: 'I_{load}', text: 'Battery current (A)' },
                { symbol: 'V_{pack}', text: 'Pack nominal voltage (V)' },
                { symbol: 'R_{pack}', text: 'Pack internal resistance (Ohm)' },
                { symbol: 'P_{batt}', text: 'Battery-side power demand (W)' }
            ],
            [
                { symbol: 'V_{load}', text: 'Loaded voltage (V)' },
                { symbol: 'V_{pack}', text: 'Pack nominal voltage (V)' },
                { symbol: 'I_{load}', text: 'Battery current (A)' },
                { symbol: 'R_{pack}', text: 'Pack internal resistance (Ohm)' }
            ],
            [
                { symbol: 'V_{sag}', text: 'Voltage sag (V)' },
                { symbol: 'I_{load}', text: 'Battery current (A)' },
                { symbol: 'R_{pack}', text: 'Pack internal resistance (Ohm)' }
            ],
            [
                { symbol: 'C_{temp}', text: 'Temperature-adjusted capacity (Ah)' },
                { symbol: 'C_{pack}', text: 'Pack rated capacity (Ah)' },
                { symbol: '\\alpha', text: 'Capacity temp coefficient (1/deg C)' },
                { symbol: 'T', text: 'Ambient temperature (deg C)' },
                { symbol: 'T_{ref}', text: 'Reference temperature (deg C)' }
            ],
            [
                { symbol: 'C_{usable}', text: 'Usable capacity (Ah)' },
                { symbol: 'C_{temp}', text: 'Temperature-adjusted capacity (Ah)' },
                { symbol: 'SOH', text: 'State of health (fraction)' },
                { symbol: 'DoD', text: 'Depth of discharge (fraction)' }
            ],
            [
                { symbol: 'C_{eff}', text: 'Effective capacity (Ah)' },
                { symbol: 'C_{usable}', text: 'Usable capacity (Ah)' },
                { symbol: 'I_{ref}', text: 'Reference current (A)' },
                { symbol: 'I_{avg}', text: 'Average current (A)' },
                { symbol: 'k', text: 'Peukert exponent' }
            ],
            [
                { symbol: 't', text: 'Runtime (h)' },
                { symbol: 'C_{eff}', text: 'Effective capacity (Ah)' },
                { symbol: 'I_{avg}', text: 'Average current (A)' }
            ],
            [
                { symbol: 'E', text: 'Delivered energy (Wh)' },
                { symbol: 'V_{load}', text: 'Loaded voltage (V)' },
                { symbol: 'C_{eff}', text: 'Effective capacity (Ah)' }
            ],
            [
                { symbol: 'P_{avg}', text: 'Average power (W)' },
                { symbol: 'V_{load}', text: 'Loaded voltage (V)' },
                { symbol: 'I_{avg}', text: 'Average current (A)' }
            ],
            [
                { symbol: 'C_{rate}', text: 'C-rate (1/h)' },
                { symbol: 'I_{avg}', text: 'Average current (A)' },
                { symbol: 'C_{pack}', text: 'Pack rated capacity (Ah)' }
            ],
            [
                { symbol: 'P_{loss}', text: 'Power loss / heat dissipation (W)' },
                { symbol: 'I_{load}', text: 'Battery current (A)' },
                { symbol: 'R_{pack}', text: 'Pack internal resistance (Ohm)' }
            ]
        ];
        const CHEMISTRY_DEFAULTS = {
            li_ion_nmc: {
                cell_nominal_voltage_v: 3.6,
                cell_capacity_ah: 2.6,
                cell_internal_resistance_ohm: 0.03,
                cell_cutoff_voltage_v: 3.0,
                peukert_exponent: 1.05,
                capacity_temp_coeff_per_c: 0.004,
                reference_c_rate: 0.2
            },
            lipo: {
                cell_nominal_voltage_v: 3.7,
                cell_capacity_ah: 2.2,
                cell_internal_resistance_ohm: 0.02,
                cell_cutoff_voltage_v: 3.2,
                peukert_exponent: 1.03,
                capacity_temp_coeff_per_c: 0.003,
                reference_c_rate: 0.5
            },
            lifepo4: {
                cell_nominal_voltage_v: 3.2,
                cell_capacity_ah: 3.0,
                cell_internal_resistance_ohm: 0.015,
                cell_cutoff_voltage_v: 2.5,
                peukert_exponent: 1.05,
                capacity_temp_coeff_per_c: 0.003,
                reference_c_rate: 0.3
            },
            nimh: {
                cell_nominal_voltage_v: 1.2,
                cell_capacity_ah: 2.0,
                cell_internal_resistance_ohm: 0.02,
                cell_cutoff_voltage_v: 1.0,
                peukert_exponent: 1.1,
                capacity_temp_coeff_per_c: 0.004,
                reference_c_rate: 0.2
            },
            lead_acid: {
                cell_nominal_voltage_v: 2.0,
                cell_capacity_ah: 7.0,
                cell_internal_resistance_ohm: 0.015,
                cell_cutoff_voltage_v: 1.75,
                peukert_exponent: 1.2,
                capacity_temp_coeff_per_c: 0.006,
                reference_c_rate: 0.05
            }
        };

        const inputTabs = document.querySelectorAll('.input-tab');
        const inputSections = document.querySelectorAll('.input-section');
        const outputTabs = document.querySelectorAll('.tab-link');
        const outputSections = document.querySelectorAll('.tab-content');

        function setInputTab(targetId) {
            inputTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.target === targetId));
            inputSections.forEach(section => section.classList.toggle('active', section.id === targetId));
        }

        function setOutputTab(targetId) {
            outputTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.target === targetId));
            outputSections.forEach(section => {
                section.style.display = section.id === targetId ? 'block' : 'none';
            });
        }

        inputTabs.forEach(tab => {
            tab.addEventListener('click', () => setInputTab(tab.dataset.target));
        });
        outputTabs.forEach(tab => {
            tab.addEventListener('click', () => setOutputTab(tab.dataset.target));
        });

        // Background sub-tab navigation
        const bgTabs = document.querySelectorAll('.background-tab');
        const bgPanels = document.querySelectorAll('.background-panel');

        function setBackgroundTab(targetId) {
            bgTabs.forEach(tab => tab.classList.toggle('active', tab.dataset.bgTarget === targetId));
            bgPanels.forEach(panel => panel.classList.toggle('active', panel.id === targetId));
            typesetMath();
        }

        bgTabs.forEach(tab => {
            tab.addEventListener('click', () => setBackgroundTab(tab.dataset.bgTarget));
        });

        function typesetMath() {
            if (window.MathJax) { window.MathJax.typesetPromise(); }
        }

        function formatNumber(value, decimals = 2) {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return 'N/A';
            }
            if (!Number.isFinite(value)) {
                return value > 0 ? '&infin;' : value < 0 ? '-&infin;' : 'N/A';
            }
            const absVal = Math.abs(value);
            if (absVal >= 1e6) return (value / 1e6).toFixed(decimals) + ' M';
            if (absVal >= 1e3) return (value / 1e3).toFixed(decimals) + ' k';
            return value.toFixed(decimals);
        }

        function setNumberValue(id, value) {
            const input = document.getElementById(id);
            const numeric = Number(value);
            if (input && Number.isFinite(numeric)) {
                input.value = numeric;
            }
        }

        function updatePackFromCells() {
            const useCells = Number(document.getElementById('use_cell_specs').value) === 1;
            if (!useCells) {
                return;
            }
            const seriesCells = Number(document.getElementById('series_cells').value);
            const parallelCells = Number(document.getElementById('parallel_cells').value);
            const cellVoltage = Number(document.getElementById('cell_nominal_voltage_v').value);
            const cellCapacity = Number(document.getElementById('cell_capacity_ah').value);
            const cellResistance = Number(document.getElementById('cell_internal_resistance_ohm').value);
            const cellCutoff = Number(document.getElementById('cell_cutoff_voltage_v').value);
            if (![seriesCells, parallelCells, cellVoltage, cellCapacity, cellResistance, cellCutoff].every(Number.isFinite)) {
                return;
            }
            if (seriesCells <= 0 || parallelCells <= 0) {
                return;
            }
            setNumberValue('pack_nominal_voltage_v', seriesCells * cellVoltage);
            setNumberValue('pack_capacity_ah', parallelCells * cellCapacity);
            setNumberValue('pack_internal_resistance_ohm', (seriesCells * cellResistance) / parallelCells);
            setNumberValue('pack_cutoff_voltage_v', seriesCells * cellCutoff);
        }

        function updateReferenceCurrent(defaults) {
            const useCells = Number(document.getElementById('use_cell_specs').value) === 1;
            const capacity = useCells
                ? Number(document.getElementById('parallel_cells').value) * Number(document.getElementById('cell_capacity_ah').value)
                : Number(document.getElementById('pack_capacity_ah').value);
            if (!Number.isFinite(capacity) || capacity <= 0) {
                return;
            }
            const cRate = defaults?.reference_c_rate ?? 0.2;
            setNumberValue('reference_current_a', capacity * cRate);
        }

        function applyChemistryDefaults() {
            const chemistry = document.getElementById('chemistry').value;
            const defaults = CHEMISTRY_DEFAULTS[chemistry];
            if (!defaults) {
                return;
            }
            setNumberValue('cell_nominal_voltage_v', defaults.cell_nominal_voltage_v);
            setNumberValue('cell_capacity_ah', defaults.cell_capacity_ah);
            setNumberValue('cell_internal_resistance_ohm', defaults.cell_internal_resistance_ohm);
            setNumberValue('cell_cutoff_voltage_v', defaults.cell_cutoff_voltage_v);
            setNumberValue('peukert_exponent', defaults.peukert_exponent);
            setNumberValue('capacity_temp_coeff_per_c', defaults.capacity_temp_coeff_per_c);
            updatePackFromCells();
            updateReferenceCurrent(defaults);
        }

        async function loadReadme() {
            const container = document.getElementById('readme-content');
            try {
                const response = await fetch('./README.md');
                if (!response.ok) throw new Error('README not found');
                const markdown = await response.text();
                container.innerHTML = renderMarkdown(markdown);
            } catch (error) {
                container.innerHTML = `<p style="color:#c92a2a;">Unable to load README: ${error.message}</p>`;
            }
        }

        function renderMarkdown(markdown) {
            const lines = markdown.split('\n');
            let html = '';
            let inList = false;
            let paragraphLines = [];

            const flushParagraph = () => {
                if (paragraphLines.length) {
                    html += `<p>${paragraphLines.join(' ').trim()}</p>`;
                    paragraphLines = [];
                }
            };
            const closeList = () => {
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
            };

            lines.forEach((line) => {
                const trimmed = line.trim();
                if (!trimmed) {
                    flushParagraph();
                    closeList();
                    return;
                }

                if (trimmed.startsWith('#')) {
                    flushParagraph();
                    closeList();
                    const match = trimmed.match(/^(#+)\s*(.*)$/);
                    const level = match ? match[1].length : 1;
                    const text = match ? match[2] : trimmed.replace(/^#+\s*/, '');
                    const tag = level === 1 ? 'h3' : 'h4';
                    html += `<${tag}>${text}</${tag}>`;
                    return;
                }

                if (/^[-*+]\s+/.test(trimmed)) {
                    flushParagraph();
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    html += `<li>${trimmed.replace(/^[-*+]\s+/, '')}</li>`;
                    return;
                }

                if (inList) {
                    closeList();
                }
                paragraphLines.push(trimmed);
            });

            flushParagraph();
            closeList();
            return html;
        }

        // --- 2. Pyodide Initialization ---
        async function main() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const button = document.getElementById('calculate-btn');

            try {
                loadingText.textContent = 'Loading Pyodide...';
                let pyodide = await loadPyodide();
                await pyodide.loadPackage('micropip');

                loadingText.textContent = 'Loading Python modules...';
                await pyodide.runPythonAsync(`
                    import micropip
                    from pyodide.http import pyfetch

                    response_utils = await pyfetch('../../pycalcs/utils.py')
                    with open('utils.py', 'w') as f:
                        f.write(await response_utils.string())

                    response_tool = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
                    with open('${TOOL_MODULE_NAME}.py', 'w') as f:
                        f.write(await response_tool.string())

                    import utils
                    import ${TOOL_MODULE_NAME}
                `);

                pyUtils = pyodide.globals.get('utils');
                pyToolModule = pyodide.globals.get(TOOL_MODULE_NAME);

                const docMap = pyUtils.get_documentation(TOOL_MODULE_NAME, TOOL_FUNCTION_NAME).toJs();
                if (docMap.has('error')) {
                    document.getElementById('results-display').innerHTML = `
                        <p style="color: red; font-weight: bold;">Initialization Error:</p>
                        <p style="color: red;">${docMap.get('error')}</p>
                    `;
                    loadingText.textContent = 'Error loading documentation.';
                    return;
                }

                toolDocumentation = Object.fromEntries(docMap);
                if (toolDocumentation.parameters) {
                    toolDocumentation.parameters = Object.fromEntries(toolDocumentation.parameters);
                }
                if (toolDocumentation.returns) {
                    toolDocumentation.returns = Object.fromEntries(toolDocumentation.returns);
                }
                latexExpressions = toolDocumentation.latex
                    ? toolDocumentation.latex.split('\n').map((line) => line.trim()).filter((line) => line.length > 0)
                    : [];

                populateUiFromDocs();
                button.textContent = 'Calculate';
                loadingOverlay.classList.add('hidden');
                loadReadme();
            } catch (error) {
                loadingText.textContent = 'Error loading: ' + error.message;
                console.error('Initialization error:', error);
            }
        }
        main();

        // --- 3. Populate UI from Docstring ---
        function populateUiFromDocs() {
            if (!toolDocumentation.parameters) return;

            document.getElementById('tool-description').textContent = toolDocumentation.description;

            PARAM_ORDER.forEach((param) => {
                const tooltip = document.getElementById(`tooltip-${param}`);
                if (tooltip && toolDocumentation.parameters[param]) {
                    tooltip.setAttribute('data-tooltip', toolDocumentation.parameters[param]);
                }
            });

            const background = document.getElementById('background-description');
            background.innerHTML = `
                ${toolDocumentation.description.replace(/\n/g, '<br>')}
                <br><br>
                The model uses a nominal open-circuit voltage with a lumped internal resistance, plus
                Peukert and temperature corrections for effective capacity. For more precise results,
                validate against manufacturer discharge curves or field data.
            `;

            const equationContainer = document.getElementById('equation-container');
            equationContainer.innerHTML = '';
            latexExpressions.forEach((expression, index) => {
                const legendItems = (EQUATION_LEGENDS[index] || [])
                    .map((item) => `<li><span class="math-inline">\\(${item.symbol}\\)</span>: ${item.text}</li>`)
                    .join('');
                const legendHtml = legendItems || '<li>Variable definitions to be provided.</li>';
                const summaryText = EQUATION_DESCRIPTIONS[index] || '';

                const card = document.createElement('div');
                card.className = 'equation-card';
                card.innerHTML = `
                    <strong>Equation (${index + 1})</strong>
                    <span class="equation-expression">\\[ ${expression} \\]</span>
                    ${summaryText ? `<p class="equation-summary">${summaryText}</p>` : ''}
                    <ul>${legendHtml}</ul>
                `;
                equationContainer.appendChild(card);
            });
            typesetMath();
        }

        function buildEquationBlock(key, results) {
            const eqIndex = RESULT_EQUATION_INDEX[key];
            const equation = typeof eqIndex === 'number' ? latexExpressions[eqIndex] : '';
            const substString = results[`subst_${key}`];
            if (!equation && !substString) {
                return '';
            }
            const equationHtml = equation ? `<p><strong>Equation:</strong> $$${equation}$$</p>` : '';
            const substHtml = substString ? `<p><strong>Substituted:</strong> $$${substString}$$</p>` : '';
            return `
                <details class="inline-details">
                    <summary>Equation</summary>
                    <div class="equation-details">${equationHtml}${substHtml}</div>
                </details>
            `;
        }

        function buildResultCard(key, label, unit, options, results, returnDefs) {
            const value = results[key];
            const decimals = options?.decimals ?? 2;
            const formatted = formatNumber(value, decimals);
            const definition = returnDefs[key];
            const labelHtml = definition ? `<span class="def" data-def="${definition}">${label}</span>` : label;
            const highlight = options?.highlight ? 'highlight' : '';
            const metaText = typeof options?.meta === 'function' ? options.meta(results) : '';
            const equationBlock = buildEquationBlock(key, results);

            return `
                <div class="result-card ${highlight}">
                    <div class="label">${labelHtml}</div>
                    <div class="value">${formatted}${unit ? `<span class="unit">${unit}</span>` : ''}</div>
                    ${metaText ? `<div class="range">${metaText}</div>` : ''}
                    ${equationBlock}
                </div>
            `;
        }

        function classifyHigh(value, warn, danger) {
            if (!Number.isFinite(value)) return 'danger';
            if (value >= danger) return 'danger';
            if (value >= warn) return 'warning';
            return 'success';
        }

        function classifyLow(value, warn, danger) {
            if (!Number.isFinite(value)) return 'danger';
            if (value <= danger) return 'danger';
            if (value <= warn) return 'warning';
            return 'success';
        }

        function buildGauge(label, valueText, value, maxValue, thresholds, statusClass) {
            const width = Math.min(100, Math.max(0, (value / maxValue) * 100));
            const threshold1 = Math.min(100, Math.max(0, (thresholds[0] / maxValue) * 100));
            const threshold2 = Math.min(100, Math.max(0, (thresholds[1] / maxValue) * 100));
            return `
                <div class="safety-gauge">
                    <span class="gauge-label">${label}</span>
                    <div class="gauge-bar-container">
                        <div class="gauge-bar ${statusClass}" style="width: ${width}%"></div>
                        <div class="gauge-threshold" style="left: ${threshold1}%"></div>
                        <div class="gauge-threshold" style="left: ${threshold2}%"></div>
                    </div>
                    <span class="gauge-value ${statusClass}">${valueText}</span>
                </div>
            `;
        }

        function renderResults(results) {
            const resultsDiv = document.getElementById('results-display');
            const returnDefs = toolDocumentation.returns || {};

            const primaryCards = [
                buildResultCard('runtime_hours', 'Runtime', 'h', { highlight: true, decimals: 2, meta: (res) => `Avg current: ${formatNumber(res.average_current_a, 2)} A` }, results, returnDefs),
                buildResultCard('runtime_minutes', 'Runtime', 'min', { highlight: true, decimals: 1 }, results, returnDefs),
                buildResultCard('energy_delivered_wh', 'Energy Delivered', 'Wh', { decimals: 1, meta: (res) => `Eff capacity: ${formatNumber(res.effective_capacity_ah, 2)} Ah` }, results, returnDefs),
                buildResultCard('loaded_voltage_v', 'Loaded Voltage', 'V', { decimals: 2, meta: (res) => `Sag: ${formatNumber(res.voltage_sag_v, 2)} V` }, results, returnDefs)
            ];

            const secondaryCards = [
                buildResultCard('effective_capacity_ah', 'Effective Capacity', 'Ah', { decimals: 2 }, results, returnDefs),
                buildResultCard('average_current_a', 'Average Current', 'A', { decimals: 2 }, results, returnDefs),
                buildResultCard('average_power_w', 'Average Power', 'W', { decimals: 1 }, results, returnDefs),
                buildResultCard('c_rate', 'C-rate', '1/h', { decimals: 2 }, results, returnDefs),
                buildResultCard('voltage_sag_v', 'Voltage Sag', 'V', { decimals: 2 }, results, returnDefs),
                buildResultCard('power_loss_w', 'Heat Dissipation', 'W', { decimals: 2, meta: (res) => {
                    const pct = (res.power_loss_w / res.average_power_w) * 100;
                    return Number.isFinite(pct) ? `${pct.toFixed(1)}% of output power` : '';
                }}, results, returnDefs)
            ];

            const packCards = [
                buildResultCard('pack_nominal_voltage_v', 'Pack Nominal', 'V', { decimals: 2 }, results, returnDefs),
                buildResultCard('pack_capacity_ah', 'Pack Capacity', 'Ah', { decimals: 2 }, results, returnDefs),
                buildResultCard('pack_internal_resistance_ohm', 'Pack Resistance', 'Ohm', { decimals: 4 }, results, returnDefs),
                buildResultCard('pack_cutoff_voltage_v', 'Pack Cutoff', 'V', { decimals: 2 }, results, returnDefs)
            ];

            const cRate = results.c_rate;
            const sagRatio = results.voltage_sag_v / results.pack_nominal_voltage_v;
            const marginRatioRaw = (results.loaded_voltage_v - results.pack_cutoff_voltage_v) / results.pack_nominal_voltage_v;
            const marginRatio = Math.max(0, marginRatioRaw);

            const cRateStatus = classifyHigh(cRate, 0.5, 1.5);
            const sagStatus = classifyHigh(sagRatio, 0.05, 0.1);
            const marginStatus = classifyLow(marginRatio, 0.1, 0.05);

            const statusOrder = { success: 0, warning: 1, danger: 2 };
            const worst = Math.max(statusOrder[cRateStatus], statusOrder[sagStatus], statusOrder[marginStatus]);
            const status = worst === 2 ? 'unacceptable' : worst === 1 ? 'marginal' : 'acceptable';

            const recommendations = [];
            if (cRateStatus !== 'success') {
                recommendations.push('Reduce load current or add parallel cells to lower C-rate.');
            }
            if (sagStatus !== 'success') {
                recommendations.push('Lower internal resistance or reduce load to limit voltage sag.');
            }
            if (marginStatus !== 'success') {
                recommendations.push('Increase pack voltage or reduce load to stay above cutoff voltage.');
            }

            const statusIcons = { acceptable: '&#10004;', marginal: '&#9888;', unacceptable: '&#10006;' };
            const statusTitles = {
                acceptable: 'Discharge Severity Acceptable',
                marginal: 'Moderate Discharge - Review Needed',
                unacceptable: 'High Discharge - Mitigation Recommended'
            };

            const gaugesHtml = `
                <div class="safety-section">
                    <h4>Performance Indicators</h4>
                    ${buildGauge('C-rate severity', `${formatNumber(cRate, 2)} 1/h`, cRate, 3.0, [0.5, 1.5], cRateStatus)}
                    ${buildGauge('Voltage sag ratio', `${(sagRatio * 100).toFixed(1)}%`, sagRatio, 0.2, [0.05, 0.1], sagStatus)}
                    ${buildGauge('Cutoff margin', `${(marginRatio * 100).toFixed(1)}%`, marginRatio, 0.2, [0.05, 0.1], marginStatus)}
                </div>
            `;

            const statusHtml = `
                <div class="status-banner ${status}">
                    <span class="icon">${statusIcons[status]}</span>
                    <div class="content">
                        <h4>${statusTitles[status]}</h4>
                        <p>Indicators are heuristic; validate against the manufacturer discharge curve.</p>
                        ${recommendations.length > 0 ? `
                            <ul class="recommendations">
                                ${recommendations.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = `
                <div class="results-section">
                    <h4>Runtime Summary</h4>
                    <div class="results-grid">
                        ${primaryCards.join('')}
                    </div>
                </div>
                <div class="results-section">
                    <h4>Load + Capacity</h4>
                    <div class="results-grid">
                        ${secondaryCards.join('')}
                    </div>
                </div>
                <div class="results-section">
                    <h4>Pack Summary</h4>
                    <div class="results-grid">
                        ${packCards.join('')}
                    </div>
                </div>
                ${gaugesHtml}
                ${statusHtml}
            `;
            typesetMath();
        }

        // --- 4. Handle Calculation ---
        const form = document.getElementById('calc-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(form);
            const args = PARAM_ORDER.map((param) => {
                const rawValue = formData.get(param);
                if (STRING_PARAMS.has(param)) {
                    return rawValue ? String(rawValue) : '';
                }
                const value = Number(rawValue);
                return Number.isFinite(value) ? value : 0;
            });

            try {
                const resultMap = pyToolModule[TOOL_FUNCTION_NAME](...args).toJs();
                const results = Object.fromEntries(resultMap);

                if (results.error) {
                    throw new Error(results.error);
                }

                renderResults(results);
            } catch (error) {
                console.error('Python calculation error:', error);
                document.getElementById('results-display').innerHTML = `
                    <p style="color: red; font-weight:bold;">Calculation Error:</p>
                    <p style="color: red;">${error.message}</p>
                `;
            }
        });

        document.getElementById('chemistry').addEventListener('change', applyChemistryDefaults);
        ['series_cells', 'parallel_cells', 'cell_nominal_voltage_v', 'cell_capacity_ah', 'cell_internal_resistance_ohm', 'cell_cutoff_voltage_v']
            .forEach((id) => document.getElementById(id).addEventListener('input', updatePackFromCells));
        document.getElementById('use_cell_specs').addEventListener('change', () => {
            updatePackFromCells();
            applyChemistryDefaults();
            if (Number(document.getElementById('use_cell_specs').value) === 1) {
                setInputTab('section-cells');
            }
        });
        applyChemistryDefaults();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YG3SBRRZFZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YG3SBRRZFZ');
    </script>

    <title>Reliability Prediction Tool - Engineering Tools</title>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        /* =================================================================
           1. CSS VARIABLES & RESET
           ================================================================= */
        :root {
            --primary-color: #0b0d12;
            --primary-light: #f4f5f7;
            --secondary-color: #4b5563;
            --accent-color: #111827;
            --success-color: #0f766e;
            --warning-color: #b45309;
            --danger-color: #b91c1c;
            --text-color: #111827;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --bg-color: #f8f9fb;
            --bg-card: #ffffff;
            --shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 12px 28px rgba(15, 23, 42, 0.18);
            --border-radius: 8px;
            --font-sans: 'Helvetica Neue', 'Avenir Next', 'Univers', 'Helvetica', system-ui, sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', monospace;
            --btn-primary-bg: #111827;
            --btn-primary-text: #ffffff;
            --tooltip-bg: #111827;
            --tooltip-text: #ffffff;
        }
        body[data-theme="dark"] {
            --primary-color: #f9fafb;
            --primary-light: #1f2937;
            --secondary-color: #9ca3af;
            --accent-color: #f9fafb;
            --success-color: #34d399;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
            --text-color: #f9fafb;
            --text-light: #9ca3af;
            --border-color: #374151;
            --bg-color: #0b0d12;
            --bg-card: #111827;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
            --shadow-lg: 0 16px 32px rgba(0, 0, 0, 0.55);
            --btn-primary-bg: #3b82f6;
            --btn-primary-text: #ffffff;
            --tooltip-bg: #1f2937;
            --tooltip-text: #f9fafb;
        }
        @media (prefers-color-scheme: dark) {
            body[data-theme="system"] {
                --primary-color: #f9fafb;
                --primary-light: #1f2937;
                --secondary-color: #9ca3af;
                --accent-color: #f9fafb;
                --success-color: #34d399;
                --warning-color: #fbbf24;
                --danger-color: #f87171;
                --text-color: #f9fafb;
                --text-light: #9ca3af;
                --border-color: #374151;
                --bg-color: #0b0d12;
                --bg-card: #111827;
                --shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
                --shadow-lg: 0 16px 32px rgba(0, 0, 0, 0.55);
                --btn-primary-bg: #3b82f6;
                --btn-primary-text: #ffffff;
                --tooltip-bg: #1f2937;
                --tooltip-text: #f9fafb;
            }
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-sans);
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        /* =================================================================
           2. LOADING OVERLAY
           ================================================================= */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            margin-top: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        /* =================================================================
           3. LAYOUT & CONTAINERS
           ================================================================= */
        .container { width: 92%; max-width: 1400px; margin: 0 auto; padding: 24px 0; }
        .navbar { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 0 5%; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; height: 64px; max-width: 1400px; margin: 0 auto; }
        .nav-brand { font-size: 1.35rem; font-weight: 600; color: var(--text-color); text-decoration: none; }
        .nav-actions { display: flex; align-items: center; gap: 12px; }
        .settings-button {
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-color);
            font-weight: 600;
            font-size: 0.85rem;
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
        }
        .settings-button:hover { background: var(--primary-light); }

        main.container { flex-grow: 1; }
        h1 { font-size: 2.25rem; letter-spacing: -0.02em; font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem; }
        h2 { font-size: 1.375rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; margin-bottom: 1rem; }
        h3 { font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); margin-bottom: 0.75rem; }
        h4 { font-size: 0.95rem; font-weight: 600; color: var(--text-color); margin-bottom: 0.5rem; }
        p { margin-bottom: 1em; color: var(--text-light); }
        a { color: var(--accent-color); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .tool-description { font-size: 1.05rem; max-width: 80ch; margin-bottom: 1.5rem; }
        .tool-layout {
            display: grid;
            grid-template-columns: minmax(360px, 0.9fr) minmax(480px, 1.1fr);
            gap: 28px;
            align-items: start;
        }
        @media (max-width: 1000px) {
            .tool-layout { grid-template-columns: 1fr; }
        }
        .card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 24px;
        }

        /* =================================================================
           4. PURPOSE/README SECTION
           ================================================================= */
        .purpose-section { margin-bottom: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--bg-card); }
        .purpose-section summary { padding: 16px 24px; font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); cursor: pointer; }
        .purpose-section summary::after { content: '[Expand]'; float: right; font-size: 0.9rem; font-weight: 500; color: var(--text-light); }
        .purpose-section[open] > summary::after { content: '[Collapse]'; }
        .purpose-content { padding: 0 24px 24px 24px; border-top: 1px solid var(--border-color); }
        .purpose-content h3 { margin-top: 1rem; }
        .purpose-content ul { padding-left: 20px; margin-bottom: 1rem; }
        .purpose-content code { background-color: var(--primary-light); padding: 2px 6px; border-radius: 4px; font-size: 0.9rem; }

        /* =================================================================
           5. INPUTS & CONTROLS
           ================================================================= */
        .input-group { margin-bottom: 1.1rem; position: relative; }
        .input-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.875rem; color: var(--text-color); }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: 100%;
            padding: 11px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-color);
            font-size: 0.95rem;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(17, 24, 39, 0.15);
        }

        .input-hint {
            margin-top: 6px;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .table-group { margin-top: 1rem; }
        .table-actions { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .component-table-wrapper { border: 1px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; }
        .component-table { width: 100%; border-collapse: collapse; }
        .component-table th, .component-table td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.9rem; }
        .component-table th { background: var(--primary-light); font-weight: 600; color: var(--secondary-color); }
        .component-table td { background: var(--bg-card); }
        .component-table input {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .component-table tr:last-child td { border-bottom: none; }
        .component-table .row-actions { width: 80px; text-align: right; }
        .component-table .remove-row {
            border: none;
            background: transparent;
            color: var(--danger-color);
            font-weight: 600;
            cursor: pointer;
        }

        .advanced-column { display: none; }
        body.advanced-visible .advanced-column { display: table-cell; }

        .advanced-toggle {
            margin-top: 8px;
            background: none;
            border: 1px dashed var(--border-color);
            border-radius: 999px;
            padding: 8px 16px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .advanced-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); display: none; }
        .advanced-section.visible { display: block; }
        .advanced-note { font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.75rem; }

        /* =================================================================
           6. BUTTONS
           ================================================================= */
        .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: transform 0.1s ease; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--btn-primary-bg); color: var(--btn-primary-text); padding: 12px 22px; font-size: 1rem; }
        .btn-secondary { background: var(--primary-light); color: var(--text-color); padding: 8px 14px; font-size: 0.9rem; border: 1px solid var(--border-color); }

        /* =================================================================
           7. TOOLTIP
           ================================================================= */
        .tooltip-trigger {
            position: absolute;
            right: 0;
            top: 30px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            color: var(--btn-primary-text);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--tooltip-bg);
            color: var(--tooltip-text);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            width: 220px;
            box-shadow: var(--shadow);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 10;
        }
        .tooltip-trigger:hover::after { opacity: 1; }
        .tooltip-trigger.inline-tooltip { position: relative; top: 0; right: 0; margin-left: 6px; }

        /* =================================================================
           8. RESULTS & DERIVATIONS
           ================================================================= */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }
        .result-item {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            background: var(--primary-light);
            position: relative;
            transition: border-color 0.15s ease;
        }
        .result-item:hover { border-color: var(--accent-color); }
        .result-item .label { font-size: 0.85rem; color: var(--secondary-color); font-weight: 600; margin-bottom: 6px; }
        .result-item .value { font-size: 1.4rem; font-weight: 700; font-family: var(--font-mono); color: var(--text-color); }
        .result-item .unit { font-size: 0.85rem; color: var(--text-light); }
        .result-item .subvalue { margin-top: 6px; font-size: 0.8rem; color: var(--text-light); }
        .result-item .icon { position: absolute; top: 14px; right: 14px; color: var(--text-light); }

        .derivation-panel {
            margin-top: 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            display: none;
            background: var(--bg-card);
        }
        .derivation-panel.visible { display: block; }
        .derivation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .derivation-title { font-weight: 600; color: var(--text-color); }
        .derivation-close {
            border: none;
            background: transparent;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-light);
        }
        .derivation-step { margin-bottom: 14px; }
        .derivation-step:last-child { margin-bottom: 0; }
        .step-title { font-weight: 600; font-size: 0.9rem; color: var(--secondary-color); margin-bottom: 6px; }
        .equation { font-family: var(--font-mono); font-size: 0.95rem; color: var(--text-color); margin-bottom: 6px; }
        .legend { display: flex; flex-wrap: wrap; gap: 10px; font-size: 0.8rem; color: var(--text-light); }
        .legend span { padding: 2px 6px; background: var(--primary-light); border-radius: 6px; }

        .summary-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        .summary-table th, .summary-table td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); font-size: 0.88rem; text-align: left; }
        .summary-table th { background: var(--primary-light); color: var(--secondary-color); font-weight: 600; }

        .allocation-card {
            margin-top: 20px;
            padding: 16px;
            border-radius: 10px;
            border: 1px dashed var(--border-color);
            background: var(--primary-light);
        }
        .allocation-card h4 { margin-bottom: 8px; }

        /* =================================================================
           9. TABS & CHARTS
           ================================================================= */
        .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; }
        .tab-link {
            background: none;
            border: none;
            padding: 10px 12px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-link.active { color: var(--text-color); border-color: var(--accent-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .chart-card { border: 1px solid var(--border-color); border-radius: 10px; padding: 12px; background: var(--bg-card); }
        #reliability-plot { width: 100%; height: 360px; }
        .bg-toc { margin: 16px 0; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--primary-light); }
        .bg-toc ul { margin-left: 18px; }
        .bg-toc li { margin: 6px 0; }
        .bg-toc a { color: var(--text-color); font-weight: 600; }

        /* =================================================================
           10. SETTINGS PANEL
           ================================================================= */
        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1500;
        }
        .settings-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .settings-panel {
            position: fixed;
            top: 0;
            right: -360px;
            width: 360px;
            height: 100%;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            padding: 24px;
            z-index: 1600;
            transition: right 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .settings-panel.open { right: 0; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; }
        .settings-header h3 { margin: 0; }
        .settings-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        .settings-section { display: flex; flex-direction: column; gap: 14px; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .setting-label { font-weight: 600; color: var(--text-color); }
        .setting-help { font-size: 0.75rem; color: var(--text-light); }
        .segmented {
            display: inline-flex;
            border: 1px solid var(--border-color);
            border-radius: 999px;
            overflow: hidden;
        }
        .segmented button {
            border: none;
            background: transparent;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-color);
        }
        .segmented button.active {
            background: var(--accent-color);
            color: var(--btn-primary-text);
        }

        .hidden { display: none; }
        .full-width { width: 100%; }
        .section-spacing { margin-top: 20px; }

        /* =================================================================
           11. DENSITY MODES
           ================================================================= */
        body[data-density="compact"] .container { padding: 16px 0; }
        body[data-density="compact"] .card { padding: 16px; }
        body[data-density="compact"] .tool-layout { gap: 16px; }
        body[data-density="compact"] h1 { font-size: 1.7rem; margin-bottom: 0.25rem; }
        body[data-density="compact"] h2 { font-size: 1.1rem; padding-bottom: 8px; margin-bottom: 10px; }
        body[data-density="compact"] .tool-description { font-size: 0.9rem; margin-bottom: 1rem; }
        body[data-density="compact"] .input-group { margin-bottom: 10px; }
        body[data-density="compact"] .input-group label { font-size: 0.78rem; margin-bottom: 3px; }
        body[data-density="compact"] .input-group input,
        body[data-density="compact"] .input-group select { padding: 8px 10px; font-size: 0.85rem; }
        body[data-density="compact"] .tooltip-trigger { top: 26px; }
        body[data-density="compact"] .btn-primary { padding: 10px 18px; font-size: 0.9rem; }

        /* =================================================================
           12. FOOTER
           ================================================================= */
        .footer {
            padding: 16px;
            text-align: center;
            border-top: 1px solid var(--border-color);
            background: var(--bg-card);
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .support-link { color: inherit; font-weight: 600; text-decoration: none; }
        .support-link:hover { text-decoration: underline; }
    </style>
</head>
<body data-theme="system" data-density="comfortable">
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Loading tool...</div>
    </div>

    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
            <div class="nav-actions">
                <button class="settings-button" id="settings-button" type="button">Settings</button>
            </div>
        </nav>
    </header>

    <aside class="settings-panel" id="settings-panel" aria-hidden="true">
        <div class="settings-header">
            <h3>Tool Settings</h3>
            <button class="settings-close" id="settings-close" type="button">x</button>
        </div>
        <div class="settings-section">
            <div class="setting-row">
                <div>
                    <div class="setting-label">Theme</div>
                    <div class="setting-help">System, light, or dark.</div>
                </div>
                <div class="segmented" role="group" aria-label="Theme">
                    <button type="button" data-theme="system">System</button>
                    <button type="button" data-theme="light">Light</button>
                    <button type="button" data-theme="dark">Dark</button>
                </div>
            </div>
            <div class="setting-row">
                <div>
                    <div class="setting-label">Density</div>
                    <div class="setting-help">Adjust spacing and sizing.</div>
                </div>
                <div class="segmented" role="group" aria-label="Density">
                    <button type="button" data-density="comfortable">Comfort</button>
                    <button type="button" data-density="compact">Compact</button>
                </div>
            </div>
            <div class="setting-row">
                <div>
                    <div class="setting-label">Precision</div>
                    <div class="setting-help">Decimal places in results.</div>
                </div>
                <div class="segmented" role="group" aria-label="Precision">
                    <button type="button" data-precision="2">2 dp</button>
                    <button type="button" data-precision="3">3 dp</button>
                    <button type="button" data-precision="4">4 dp</button>
                </div>
            </div>
        </div>
        <div class="settings-footer">
            <button class="btn btn-secondary full-width" id="settings-reset" type="button">Reset to Defaults</button>
        </div>
    </aside>
    <div class="settings-overlay" id="settings-overlay" aria-hidden="true"></div>

    <main class="container">
        <h1>Reliability Prediction Tool</h1>
        <p class="tool-description" id="tool-description">
            Predict system reliability from component MTBF values using a series model with optional parallel redundancy.
        </p>

        <details class="purpose-section">
            <summary>Tool Purpose and README</summary>
            <div class="purpose-content" id="readme-content">
                <p>Loading README...</p>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <form id="calc-form">
                    <div class="input-group" data-param="mission_time_hours">
                        <label for="mission_time_hours">Mission time (hours)</label>
                        <input type="number" id="mission_time_hours" min="0" step="any" value="100">
                        <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                    </div>

                    <div class="table-group">
                        <div class="table-actions">
                            <h4>Component table</h4>
                            <button type="button" class="btn btn-secondary" id="add-component">Add component</button>
                        </div>
                        <div class="component-table-wrapper">
                            <table class="component-table">
                                <thead>
                                    <tr>
                                        <th>
                                            Component
                                            <span class="tooltip-trigger inline-tooltip" data-param="component_names" data-tooltip="Loading...">?</span>
                                        </th>
                                        <th>
                                            MTBF (hours)
                                            <span class="tooltip-trigger inline-tooltip" data-param="component_mtbf_hours" data-tooltip="Loading...">?</span>
                                        </th>
                                        <th>
                                            Series count
                                            <span class="tooltip-trigger inline-tooltip" data-param="component_series_count" data-tooltip="Loading...">?</span>
                                        </th>
                                        <th class="advanced-column">
                                            Parallel count
                                            <span class="tooltip-trigger inline-tooltip" data-param="component_parallel_count" data-tooltip="Loading...">?</span>
                                        </th>
                                        <th class="row-actions"></th>
                                    </tr>
                                </thead>
                                <tbody id="component-body"></tbody>
                            </table>
                        </div>
                        <div class="input-hint">
                            Use series count for repeated components. Advanced options add parallel redundancy.
                        </div>
                    </div>

                    <button type="button" class="advanced-toggle" id="advanced-toggle">
                        <span class="toggle-icon" id="toggle-icon">+</span> Show advanced options
                    </button>

                    <div class="advanced-section" id="advanced-inputs">
                        <p class="advanced-note">
                            Advanced options include parallel redundancy and a separate reliability allocation scenario.
                        </p>
                        <div class="input-group" data-param="target_system_reliability">
                            <label for="target_system_reliability">Target system reliability (0 to 1)</label>
                            <input type="number" id="target_system_reliability" min="0" max="1" step="0.01" placeholder="0.9">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                        <div class="input-group" data-param="allocation_component_count">
                            <label for="allocation_component_count">Allocation component count</label>
                            <input type="number" id="allocation_component_count" min="1" step="1" placeholder="3">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="calculate-btn" disabled>Loading...</button>
                </form>
            </section>

            <section class="tool-outputs card">
                <div class="tabs">
                    <button class="tab-link active" data-target="results">Results</button>
                    <button class="tab-link" data-target="visualization">Visualization</button>
                    <button class="tab-link" data-target="background">Background and Theory</button>
                </div>

                <div id="results" class="tab-content active">
                    <h3>Key results</h3>
                    <div id="results-display">
                        <p id="results-placeholder" class="input-hint">Provide inputs and click calculate to see results.</p>
                    </div>

                    <div class="results-grid hidden" id="results-grid">
                        <div class="result-item" data-key="system_reliability" onclick="toggleDerivation('system_reliability')">
                            <div class="label">System reliability</div>
                            <div class="value" id="system_reliability_value">--</div>
                            <div class="subvalue" id="system_reliability_percent">--</div>
                            <span class="icon">v</span>
                        </div>
                        <div class="result-item" data-key="equivalent_failure_rate_per_hour" onclick="toggleDerivation('equivalent_failure_rate_per_hour')">
                            <div class="label">Equivalent failure rate</div>
                            <div class="value" id="equivalent_failure_rate_value">--</div>
                            <div class="unit">1/hr</div>
                            <span class="icon">v</span>
                        </div>
                        <div class="result-item" data-key="equivalent_mtbf_hours" onclick="toggleDerivation('equivalent_mtbf_hours')">
                            <div class="label">Equivalent MTBF</div>
                            <div class="value" id="equivalent_mtbf_value">--</div>
                            <div class="unit">hours</div>
                            <span class="icon">v</span>
                        </div>
                    </div>

                    <div class="derivation-panel" id="deriv-system_reliability">
                        <div class="derivation-header">
                            <span class="derivation-title">System Reliability Derivation</span>
                            <button class="derivation-close" onclick="toggleDerivation('system_reliability')">x</button>
                        </div>
                        <div class="derivation-step">
                            <div class="step-title">Equation (1): Component reliability</div>
                            <div class="equation">$$ R = e^{-\lambda t} $$</div>
                            <div class="legend">
                                <span>R: reliability</span>
                                <span>\lambda: failure rate</span>
                                <span>t: mission time</span>
                            </div>
                        </div>
                        <div class="derivation-step">
                            <div class="step-title">Equation (2): Parallel redundancy</div>
                            <div class="equation">$$ R_{parallel} = 1 - (1 - R)^n $$</div>
                            <div class="legend">
                                <span>n: parallel count</span>
                            </div>
                        </div>
                        <div class="derivation-step">
                            <div class="step-title">Equation (3): Series system reliability</div>
                            <div class="equation">$$ R_{sys} = \prod R_i $$</div>
                            <div class="legend">
                                <span>R_i: block reliability</span>
                            </div>
                        </div>
                        <div class="derivation-step">
                            <div class="step-title">Substituted values</div>
                            <div class="equation" id="subst-system_reliability"></div>
                        </div>
                    </div>

                    <div class="derivation-panel" id="deriv-equivalent_failure_rate_per_hour">
                        <div class="derivation-header">
                            <span class="derivation-title">Equivalent Failure Rate Derivation</span>
                            <button class="derivation-close" onclick="toggleDerivation('equivalent_failure_rate_per_hour')">x</button>
                        </div>
                        <div class="derivation-step">
                            <div class="step-title">Equation (4): Effective failure rate</div>
                            <div class="equation">$$ \lambda_{eq} = -\frac{\ln R_{sys}}{t} $$</div>
                            <div class="legend">
                                <span>\lambda_{eq}: equivalent failure rate</span>
                                <span>R_{sys}: system reliability</span>
                                <span>t: mission time</span>
                            </div>
                        </div>
                        <div class="derivation-step">
                            <div class="step-title">Substituted values</div>
                            <div class="equation" id="subst-equivalent_failure_rate_per_hour"></div>
                        </div>
                    </div>

                    <div class="derivation-panel" id="deriv-equivalent_mtbf_hours">
                        <div class="derivation-header">
                            <span class="derivation-title">Equivalent MTBF Derivation</span>
                            <button class="derivation-close" onclick="toggleDerivation('equivalent_mtbf_hours')">x</button>
                        </div>
                        <div class="derivation-step">
                            <div class="step-title">Equation (5): Equivalent MTBF</div>
                            <div class="equation">$$ MTBF_{eq} = \frac{1}{\lambda_{eq}} $$</div>
                            <div class="legend">
                                <span>MTBF_{eq}: equivalent MTBF</span>
                                <span>\lambda_{eq}: equivalent failure rate</span>
                            </div>
                        </div>
                        <div class="derivation-step">
                            <div class="step-title">Substituted values</div>
                            <div class="equation" id="subst-equivalent_mtbf_hours"></div>
                        </div>
                    </div>

                    <div class="allocation-card">
                        <h4>Reliability allocation</h4>
                        <p id="allocation-placeholder" class="input-hint">Provide allocation inputs to compute required component targets.</p>
                        <div id="allocation-results" class="hidden">
                            <div class="results-grid">
                                <div class="result-item" data-key="allocation_required_reliability" onclick="toggleDerivation('allocation_required_reliability')">
                                    <div class="label">Required component reliability</div>
                                    <div class="value" id="allocation_required_reliability_value">--</div>
                                    <span class="icon">v</span>
                                </div>
                                <div class="result-item" data-key="allocation_required_failure_rate_per_hour" onclick="toggleDerivation('allocation_required_failure_rate_per_hour')">
                                    <div class="label">Required failure rate</div>
                                    <div class="value" id="allocation_required_failure_rate_value">--</div>
                                    <div class="unit">1/hr</div>
                                    <span class="icon">v</span>
                                </div>
                                <div class="result-item" data-key="allocation_required_mtbf_hours" onclick="toggleDerivation('allocation_required_mtbf_hours')">
                                    <div class="label">Required MTBF</div>
                                    <div class="value" id="allocation_required_mtbf_value">--</div>
                                    <div class="unit">hours</div>
                                    <span class="icon">v</span>
                                </div>
                            </div>
                        </div>

                        <div class="derivation-panel" id="deriv-allocation_required_reliability">
                            <div class="derivation-header">
                                <span class="derivation-title">Allocation Reliability Derivation</span>
                                <button class="derivation-close" onclick="toggleDerivation('allocation_required_reliability')">x</button>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Equation (6): Equal allocation</div>
                                <div class="equation">$$ R_{comp} = R_{sys}^{1/N} $$</div>
                                <div class="legend">
                                    <span>R_{comp}: component reliability</span>
                                    <span>R_{sys}: system reliability</span>
                                    <span>N: component count</span>
                                </div>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Substituted values</div>
                                <div class="equation" id="subst-allocation_required_reliability"></div>
                            </div>
                        </div>

                        <div class="derivation-panel" id="deriv-allocation_required_failure_rate_per_hour">
                            <div class="derivation-header">
                                <span class="derivation-title">Allocation Failure Rate Derivation</span>
                                <button class="derivation-close" onclick="toggleDerivation('allocation_required_failure_rate_per_hour')">x</button>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Equation (7): Required failure rate</div>
                                <div class="equation">$$ \lambda_{req} = -\frac{\ln R_{comp}}{t} $$</div>
                                <div class="legend">
                                    <span>\lambda_{req}: required failure rate</span>
                                    <span>R_{comp}: component reliability</span>
                                    <span>t: mission time</span>
                                </div>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Substituted values</div>
                                <div class="equation" id="subst-allocation_required_failure_rate_per_hour"></div>
                            </div>
                        </div>

                        <div class="derivation-panel" id="deriv-allocation_required_mtbf_hours">
                            <div class="derivation-header">
                                <span class="derivation-title">Allocation MTBF Derivation</span>
                                <button class="derivation-close" onclick="toggleDerivation('allocation_required_mtbf_hours')">x</button>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Equation (8): Required MTBF</div>
                                <div class="equation">$$ MTBF_{req} = \frac{1}{\lambda_{req}} $$</div>
                                <div class="legend">
                                    <span>MTBF_{req}: required MTBF</span>
                                    <span>\lambda_{req}: required failure rate</span>
                                </div>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Substituted values</div>
                                <div class="equation" id="subst-allocation_required_mtbf_hours"></div>
                            </div>
                        </div>
                    </div>

                    <h3 class="section-spacing">Component summary</h3>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th>MTBF (hours)</th>
                                <th>Series</th>
                                <th>Parallel</th>
                                <th>Failure rate (1/hr)</th>
                                <th>Block reliability</th>
                            </tr>
                        </thead>
                        <tbody id="component-summary-body"></tbody>
                    </table>
                </div>

                <div id="visualization" class="tab-content">
                    <h3>System reliability curve</h3>
                    <div class="chart-card">
                        <div id="reliability-plot"></div>
                    </div>
                </div>

                <div id="background" class="tab-content">
                    <h3>Background and Theory</h3>
                    <div class="bg-toc">
                        <div class="setting-label">Contents</div>
                        <ul>
                            <li><a href="#bg-overview">Overview</a></li>
                            <li><a href="#bg-assumptions">Assumptions</a></li>
                            <li><a href="#bg-references">References</a></li>
                        </ul>
                    </div>
                    <h4 id="bg-overview">Overview</h4>
                    <p>
                        This tool assumes independent component failures and uses an exponential reliability model
                        with constant failure rates. Series blocks multiply reliability, while parallel redundancy
                        assumes independent units with no repair during the mission time.
                    </p>
                    <h4 id="bg-assumptions">Assumptions</h4>
                    <ul>
                        <li>Component failures follow an exponential distribution with constant hazard rate.</li>
                        <li>Redundancy is cold or hot standby without repair during the mission.</li>
                        <li>Components are statistically independent.</li>
                    </ul>
                    <h4 id="bg-references">References</h4>
                    <ul>
                        <li>O'Connor, P.D.T. and Kleyner, A. Practical Reliability Engineering, 5th ed.</li>
                        <li>Ebeling, C.E. An Introduction to Reliability and Maintainability Engineering.</li>
                        <li>IEC 60300-3-1: Dependability management - Application guide.</li>
                    </ul>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Engineering Tools. All tools are for educational purposes. <a class="support-link" href="https://ko-fi.com/transparent_tools" target="_blank" rel="noopener">Support on Ko-fi</a></p>
    </footer>

    <template id="component-row-template">
        <tr>
            <td><input type="text" data-field="name" placeholder="Component"></td>
            <td><input type="number" data-field="mtbf" min="0" step="any" value="500"></td>
            <td><input type="number" data-field="series" min="1" step="1" value="1"></td>
            <td class="advanced-column"><input type="number" data-field="parallel" min="1" step="1" value="1"></td>
            <td class="row-actions"><button type="button" class="remove-row">Remove</button></td>
        </tr>
    </template>

    <script>
        // =================================================================
        // 0. GLOBAL STORE & CONFIG
        // =================================================================
        let toolDocumentation = {};
        let pyUtils, pyToolModule;
        let lastResults = null;
        let openDerivation = null;
        let advancedVisible = false;

        const TOOL_MODULE_NAME = 'reliability';
        const TOOL_FUNCTION_NAME = 'analyze_reliability';
        const PARAM_ORDER = [
            'mission_time_hours',
            'component_names',
            'component_mtbf_hours',
            'component_series_count',
            'component_parallel_count',
            'target_system_reliability',
            'allocation_component_count'
        ];
        const STORAGE_KEY = 'reliability-tool-settings';

        const defaultSettings = {
            theme: 'system',
            density: 'comfortable',
            precision: 3
        };
        let settings = { ...defaultSettings };

        // =================================================================
        // SETTINGS MANAGEMENT
        // =================================================================
        function saveSettings() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSettings() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) {
                settings = { ...defaultSettings };
                return;
            }
            try {
                settings = { ...defaultSettings, ...JSON.parse(stored) };
            } catch (e) {
                settings = { ...defaultSettings };
            }
        }

        function applySettings() {
            document.body.dataset.theme = settings.theme;
            document.body.dataset.density = settings.density;
            setSegmentedActive('[data-theme]', settings.theme, 'theme');
            setSegmentedActive('[data-density]', settings.density, 'density');
            setSegmentedActive('[data-precision]', String(settings.precision), 'precision');

            if (lastResults) {
                displayResults(lastResults);
            }
        }

        function setSegmentedActive(selector, value, dataAttr) {
            document.querySelectorAll(`.settings-panel ${selector}`).forEach(btn => {
                const isActive = btn.dataset[dataAttr] === value;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });
        }

        function handleSettingChange(key, value) {
            settings[key] = value;
            saveSettings();
            applySettings();
        }

        function toggleSettingsPanel(open) {
            const panel = document.getElementById('settings-panel');
            const overlay = document.getElementById('settings-overlay');
            const isOpen = open ?? !panel.classList.contains('open');
            panel.classList.toggle('open', isOpen);
            overlay.classList.toggle('open', isOpen);
            panel.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
            overlay.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        }

        function bindSettingsControls() {
            document.querySelectorAll('.settings-panel [data-theme]').forEach(btn => {
                btn.addEventListener('click', () => handleSettingChange('theme', btn.dataset.theme));
            });
            document.querySelectorAll('.settings-panel [data-density]').forEach(btn => {
                btn.addEventListener('click', () => handleSettingChange('density', btn.dataset.density));
            });
            document.querySelectorAll('.settings-panel [data-precision]').forEach(btn => {
                btn.addEventListener('click', () => handleSettingChange('precision', Number(btn.dataset.precision)));
            });

            document.getElementById('settings-reset').addEventListener('click', () => {
                settings = { ...defaultSettings };
                saveSettings();
                applySettings();
            });

            document.getElementById('settings-button').addEventListener('click', () => toggleSettingsPanel(true));
            document.getElementById('settings-close').addEventListener('click', () => toggleSettingsPanel(false));
            document.getElementById('settings-overlay').addEventListener('click', () => toggleSettingsPanel(false));

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') toggleSettingsPanel(false);
            });
        }

        // =================================================================
        // UI HELPERS
        // =================================================================
        function formatNumber(value, overridePrecision = null) {
            if (value === null || value === undefined || Number.isNaN(value)) {
                return '--';
            }
            if (!Number.isFinite(value)) {
                return 'inf';
            }
            const precision = overridePrecision ?? settings.precision;
            const absValue = Math.abs(value);
            if (absValue > 0 && (absValue >= 1e5 || absValue < 1e-3)) {
                return value.toExponential(precision);
            }
            return value.toFixed(precision);
        }

        function formatPercent(value) {
            if (!Number.isFinite(value)) {
                return '--';
            }
            return `${(value * 100).toFixed(1)}%`;
        }

        function typesetMath() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        function toggleAdvanced() {
            const section = document.getElementById('advanced-inputs');
            const icon = document.getElementById('toggle-icon');
            const btn = document.getElementById('advanced-toggle');
            advancedVisible = !advancedVisible;

            section.classList.toggle('visible', advancedVisible);
            document.body.classList.toggle('advanced-visible', advancedVisible);
            if (advancedVisible) {
                icon.textContent = '-';
                btn.innerHTML = '<span class="toggle-icon" id="toggle-icon">-</span> Hide advanced options';
            } else {
                icon.textContent = '+';
                btn.innerHTML = '<span class="toggle-icon" id="toggle-icon">+</span> Show advanced options';
            }
        }

        function toggleDerivation(key) {
            const panel = document.getElementById('deriv-' + key);
            const item = document.querySelector(`.result-item[data-key="${key}"]`);
            if (!panel) {
                return;
            }

            if (openDerivation && openDerivation !== key) {
                document.getElementById('deriv-' + openDerivation)?.classList.remove('visible');
                document.querySelector(`.result-item[data-key="${openDerivation}"]`)?.classList.remove('expanded');
            }

            if (panel.classList.contains('visible')) {
                panel.classList.remove('visible');
                item?.classList.remove('expanded');
                openDerivation = null;
            } else {
                panel.classList.add('visible');
                item?.classList.add('expanded');
                openDerivation = key;
                typesetMath();
            }
        }

        function openTab(event) {
            const targetId = event.currentTarget.dataset.target;
            document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(section => section.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(targetId).classList.add('active');

            if (targetId === 'visualization') {
                setTimeout(() => {
                    const plotEl = document.getElementById('reliability-plot');
                    if (plotEl && plotEl.data) {
                        Plotly.Plots.resize(plotEl);
                    }
                }, 100);
            }

            if (targetId === 'background') {
                typesetMath();
            }
        }

        // =================================================================
        // COMPONENT TABLE
        // =================================================================
        function addComponentRow(data = {}) {
            const template = document.getElementById('component-row-template');
            const row = template.content.cloneNode(true);
            const tr = row.querySelector('tr');
            tr.querySelector('[data-field="name"]').value = data.name ?? '';
            tr.querySelector('[data-field="mtbf"]').value = data.mtbf ?? 500;
            tr.querySelector('[data-field="series"]').value = data.series ?? 1;
            tr.querySelector('[data-field="parallel"]').value = data.parallel ?? 1;

            tr.querySelector('.remove-row').addEventListener('click', () => {
                tr.remove();
            });

            document.getElementById('component-body').appendChild(row);
        }

        function collectComponents() {
            const rows = Array.from(document.querySelectorAll('#component-body tr'));
            if (rows.length === 0) {
                throw new Error('Add at least one component.');
            }

            const names = [];
            const mtbfs = [];
            const seriesCounts = [];
            const parallelCounts = [];

            rows.forEach((row, index) => {
                const name = row.querySelector('[data-field="name"]').value.trim() || `Component ${index + 1}`;
                const mtbf = parseFloat(row.querySelector('[data-field="mtbf"]').value);
                const series = parseInt(row.querySelector('[data-field="series"]').value, 10);
                const parallel = parseInt(row.querySelector('[data-field="parallel"]').value, 10);

                if (!Number.isFinite(mtbf) || mtbf <= 0) {
                    throw new Error(`Component ${index + 1} MTBF must be greater than zero.`);
                }
                if (!Number.isFinite(series) || series < 1) {
                    throw new Error(`Component ${index + 1} series count must be 1 or greater.`);
                }
                if (!Number.isFinite(parallel) || parallel < 1) {
                    throw new Error(`Component ${index + 1} parallel count must be 1 or greater.`);
                }

                names.push(name);
                mtbfs.push(mtbf);
                seriesCounts.push(series);
                parallelCounts.push(parallel);
            });

            return { names, mtbfs, seriesCounts, parallelCounts };
        }

        // =================================================================
        // PYODIDE INITIALIZATION
        // =================================================================
        async function loadReadme() {
            try {
                const response = await fetch('README.md');
                const text = await response.text();
                const container = document.getElementById('readme-content');
                const sections = text.trim().split(/\n{2,}/).map(block => {
                    const cleaned = block.replace(/\r/g, '');
                    if (cleaned.startsWith('# ')) {
                        return `<h3>${cleaned.substring(2).trim()}</h3>`;
                    }
                    if (cleaned.startsWith('## ')) {
                        return `<h4>${cleaned.substring(3).trim()}</h4>`;
                    }
                    if (cleaned.startsWith('- ')) {
                        const items = cleaned.split('\n').map(item => `<li>${item.replace(/^-\s*/, '')}</li>`).join('');
                        return `<ul>${items}</ul>`;
                    }
                    return `<p>${cleaned.replace(/\n/g, '<br>')}</p>`;
                }).join('');
                container.innerHTML = sections || '<p>README.md is empty.</p>';
            } catch (error) {
                document.getElementById('readme-content').innerHTML = `<p style="color:#c92a2a;">Failed to load README: ${error.message}</p>`;
            }
        }

        async function main() {
            const loadingText = document.getElementById('loading-text');
            const calculateBtn = document.getElementById('calculate-btn');

            loadSettings();
            applySettings();
            bindSettingsControls();
            loadReadme();

            document.getElementById('advanced-toggle').addEventListener('click', toggleAdvanced);
            document.querySelectorAll('.tab-link').forEach(btn => btn.addEventListener('click', openTab));
            document.getElementById('add-component').addEventListener('click', () => addComponentRow());

            const defaultComponents = [
                { name: 'Controller', mtbf: 1200, series: 1, parallel: 1 },
                { name: 'Power supply', mtbf: 800, series: 1, parallel: 1 },
                { name: 'Sensor', mtbf: 600, series: 1, parallel: 1 }
            ];
            defaultComponents.forEach(component => addComponentRow(component));

            try {
                loadingText.textContent = 'Loading Pyodide...';
                const pyodide = await loadPyodide();

                loadingText.textContent = 'Loading Python modules...';
                await pyodide.loadPackage('micropip');

                await pyodide.runPythonAsync(`
                    import micropip
                    from pyodide.http import pyfetch

                    response_utils = await pyfetch('../../pycalcs/utils.py')
                    with open('utils.py', 'w') as f:
                        f.write(await response_utils.string())

                    response_tool = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
                    with open('${TOOL_MODULE_NAME}.py', 'w') as f:
                        f.write(await response_tool.string())

                    import utils
                    import ${TOOL_MODULE_NAME}
                `);

                pyUtils = pyodide.globals.get('utils');
                pyToolModule = pyodide.globals.get(TOOL_MODULE_NAME);

                loadingText.textContent = 'Parsing documentation...';
                const docMap = pyUtils.get_documentation(TOOL_MODULE_NAME, TOOL_FUNCTION_NAME).toJs();
                const hasError = docMap.has ? docMap.has('error') : docMap.error;
                if (!hasError) {
                    toolDocumentation = docMap instanceof Map ? Object.fromEntries(docMap) : docMap;
                    if (toolDocumentation.parameters) {
                        toolDocumentation.parameters = toolDocumentation.parameters instanceof Map
                            ? Object.fromEntries(toolDocumentation.parameters)
                            : toolDocumentation.parameters;
                    }
                    if (toolDocumentation.returns) {
                        toolDocumentation.returns = toolDocumentation.returns instanceof Map
                            ? Object.fromEntries(toolDocumentation.returns)
                            : toolDocumentation.returns;
                    }
                    populateTooltips();
                } else {
                    console.error('Docstring error:', docMap.get ? docMap.get('error') : docMap.error);
                }

                document.getElementById('calc-form').addEventListener('submit', handleCalculate);

                document.getElementById('loading-overlay').classList.add('hidden');
                calculateBtn.textContent = 'Calculate';
                calculateBtn.disabled = false;
            } catch (error) {
                loadingText.textContent = 'Error loading tool: ' + error.message;
                console.error(error);
            }
        }
        main();

        // =================================================================
        // TOOLTIPS
        // =================================================================
        function populateTooltips() {
            if (!toolDocumentation.parameters) return;

            PARAM_ORDER.forEach(param => {
                const tooltipTargets = document.querySelectorAll(
                    `.tooltip-trigger[data-param="${param}"], [data-param="${param}"] .tooltip-trigger`
                );
                tooltipTargets.forEach(target => {
                    if (toolDocumentation.parameters[param]) {
                        target.setAttribute('data-tooltip', toolDocumentation.parameters[param]);
                    }
                });
            });
        }

        // =================================================================
        // CALCULATION HANDLER
        // =================================================================
        function normalizeValue(value) {
            if (value instanceof Map) {
                const obj = {};
                for (const [key, entry] of value.entries()) {
                    obj[key] = normalizeValue(entry);
                }
                return obj;
            }
            if (Array.isArray(value)) {
                return value.map(item => normalizeValue(item));
            }
            if (value && typeof value === 'object' && value.constructor === Object) {
                const obj = {};
                for (const [key, entry] of Object.entries(value)) {
                    obj[key] = normalizeValue(entry);
                }
                return obj;
            }
            return value;
        }

        async function handleCalculate(event) {
            event.preventDefault();
            const btn = document.getElementById('calculate-btn');
            btn.textContent = 'Calculating...';
            btn.disabled = true;

            try {
                const missionTime = parseFloat(document.getElementById('mission_time_hours').value);
                if (!Number.isFinite(missionTime) || missionTime <= 0) {
                    throw new Error('Mission time must be greater than zero.');
                }

                const { names, mtbfs, seriesCounts, parallelCounts } = collectComponents();

                const targetInput = document.getElementById('target_system_reliability').value.trim();
                const allocationInput = document.getElementById('allocation_component_count').value.trim();
                const targetReliability = targetInput ? parseFloat(targetInput) : null;
                const allocationCount = allocationInput ? parseInt(allocationInput, 10) : null;

                if (targetReliability !== null) {
                    if (!Number.isFinite(targetReliability) || targetReliability <= 0 || targetReliability > 1) {
                        throw new Error('Target system reliability must be between 0 and 1.');
                    }
                }
                if (allocationCount !== null) {
                    if (!Number.isFinite(allocationCount) || allocationCount < 1) {
                        throw new Error('Allocation component count must be 1 or greater.');
                    }
                }
                if ((targetReliability === null) !== (allocationCount === null)) {
                    throw new Error('Provide both allocation inputs to run allocation.');
                }

                const resultProxy = pyToolModule.analyze_reliability(
                    names,
                    mtbfs,
                    seriesCounts,
                    parallelCounts,
                    missionTime,
                    targetReliability,
                    allocationCount
                );

                const rawResults = resultProxy.toJs({ dict_converter: Object.fromEntries });
                resultProxy.destroy();
                lastResults = normalizeValue(rawResults);

                displayResults(lastResults);
            } catch (error) {
                console.error('Calculation error:', error);
                const placeholder = document.getElementById('results-placeholder');
                placeholder.textContent = 'Error: ' + error.message;
                placeholder.style.color = 'var(--danger-color)';
                placeholder.style.display = 'block';
                document.getElementById('results-grid').classList.add('hidden');
                document.getElementById('allocation-results').classList.add('hidden');
                document.getElementById('allocation-placeholder').classList.remove('hidden');
            } finally {
                btn.textContent = 'Calculate';
                btn.disabled = false;
            }
        }

        function displayResults(results) {
            if (!results) return;

            const placeholder = document.getElementById('results-placeholder');
            placeholder.style.display = 'none';
            placeholder.style.color = 'var(--text-light)';
            document.getElementById('results-grid').classList.remove('hidden');

            document.getElementById('system_reliability_value').textContent = formatNumber(results.system_reliability);
            document.getElementById('system_reliability_percent').textContent = formatPercent(results.system_reliability);
            document.getElementById('equivalent_failure_rate_value').textContent = formatNumber(results.equivalent_failure_rate_per_hour);
            document.getElementById('equivalent_mtbf_value').textContent = formatNumber(results.equivalent_mtbf_hours);

            setEquation('subst-system_reliability', results.subst_system_reliability);
            setEquation('subst-equivalent_failure_rate_per_hour', results.subst_equivalent_failure_rate_per_hour);
            setEquation('subst-equivalent_mtbf_hours', results.subst_equivalent_mtbf_hours);

            const allocationPerformed = results.allocation_performed;
            if (allocationPerformed) {
                document.getElementById('allocation-placeholder').classList.add('hidden');
                document.getElementById('allocation-results').classList.remove('hidden');
                document.getElementById('allocation_required_reliability_value').textContent = formatNumber(results.allocation_required_reliability);
                document.getElementById('allocation_required_failure_rate_value').textContent = formatNumber(results.allocation_required_failure_rate_per_hour);
                document.getElementById('allocation_required_mtbf_value').textContent = formatNumber(results.allocation_required_mtbf_hours);

                setEquation('subst-allocation_required_reliability', results.subst_allocation_required_reliability);
                setEquation('subst-allocation_required_failure_rate_per_hour', results.subst_allocation_required_failure_rate_per_hour);
                setEquation('subst-allocation_required_mtbf_hours', results.subst_allocation_required_mtbf_hours);
            } else {
                document.getElementById('allocation-results').classList.add('hidden');
                document.getElementById('allocation-placeholder').classList.remove('hidden');
            }

            updateComponentSummary(results.component_blocks || []);
            updateReliabilityPlot(results.reliability_curve);
            typesetMath();
        }

        function setEquation(elementId, latex) {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (!latex) {
                el.textContent = 'No data.';
                return;
            }
            el.innerHTML = `$$${latex}$$`;
        }

        function updateComponentSummary(blocks) {
            const tbody = document.getElementById('component-summary-body');
            tbody.innerHTML = '';

            blocks.forEach(block => {
                const row = document.createElement('tr');
                const cells = [
                    block.name,
                    formatNumber(block.mtbf_hours),
                    block.series_count,
                    block.parallel_count,
                    formatNumber(block.failure_rate_per_hour),
                    formatNumber(block.reliability_block)
                ];
                cells.forEach(text => {
                    const cell = document.createElement('td');
                    cell.textContent = text;
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
        }

        function updateReliabilityPlot(curve) {
            if (!curve || !curve.time_hours || !curve.system_reliability) {
                return;
            }

            const theme = getPlotTheme();
            const trace = {
                x: curve.time_hours,
                y: curve.system_reliability,
                type: 'scatter',
                mode: 'lines',
                line: { color: theme.lineColor, width: 3 },
                name: 'System reliability'
            };

            const layout = {
                margin: { t: 20, l: 50, r: 20, b: 50 },
                xaxis: { title: 'Time (hours)', gridcolor: theme.gridColor, color: theme.textColor },
                yaxis: { title: 'Reliability', range: [0, 1], gridcolor: theme.gridColor, color: theme.textColor },
                paper_bgcolor: theme.backgroundColor,
                plot_bgcolor: theme.backgroundColor,
                font: { color: theme.textColor }
            };

            Plotly.newPlot('reliability-plot', [trace], layout, { responsive: true, displayModeBar: false });
        }

        function getPlotTheme() {
            const styles = getComputedStyle(document.body);
            return {
                backgroundColor: styles.getPropertyValue('--bg-card').trim(),
                textColor: styles.getPropertyValue('--text-color').trim(),
                gridColor: styles.getPropertyValue('--border-color').trim(),
                lineColor: styles.getPropertyValue('--accent-color').trim()
            };
        }
    </script>
</body>
</html>

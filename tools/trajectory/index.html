<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projectile Trajectory Planner - Engineering Tools</title>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: {'[+]': ['ams']}
            },
            chtml: {
                linebreaks: { automatic: true, width: 'container' }
            },
            svg: {
                linebreaks: { automatic: true, width: 'container' }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        :root {
            --primary-color: #1c2530;
            --primary-light: #edf2f7;
            --secondary-color: #2d3748;
            --accent-color: #2563eb;
            --bg-color: #f7fafc;
            --bg-card: #ffffff;
            --border-color: #d7e0ea;
            --shadow: 0 18px 32px -18px rgba(28, 37, 48, 0.25);
            --radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }
        .container { width: 92%; max-width: 1120px; margin: 0 auto; padding: 18px 0 28px; }
        h1, h2, h3, h4 { font-weight: 600; color: var(--primary-color); line-height: 1.2; }
        h1 { font-size: clamp(2.25rem, 4.5vw, 3rem); margin-bottom: 0.35rem; }
        h2 { font-size: 1.75rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 1rem; }
        h3 { font-size: 1.25rem; color: var(--secondary-color); margin-bottom: 0.85rem; }
        h4 { font-size: 1.05rem; margin-top: 1.2rem; color: var(--secondary-color); }
        p { color: var(--secondary-color); margin-bottom: 0.75rem; }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }

        .navbar { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(28, 37, 48, 0.08); padding: 0 5%; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; height: 64px; max-width: 1200px; margin: 0 auto; }
        .nav-brand { font-size: 1.55rem; font-weight: 600; color: var(--primary-color); }

        main.container { flex-grow: 1; }
        .tool-description { font-size: 1.05rem; max-width: 80ch; margin-bottom: 1.4rem; }
        .tool-layout { display: grid; grid-template-columns: minmax(340px, 0.9fr) minmax(400px, 1.1fr); gap: 22px; align-items: start; }
        .card { background-color: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); padding: 20px; }

        details.purpose-section { margin-bottom: 1.75rem; border: 1px solid var(--border-color); border-radius: var(--radius); background-color: var(--bg-card); }
        .purpose-section summary { padding: 18px 24px; font-size: 1.05rem; font-weight: 600; color: var(--secondary-color); cursor: pointer; list-style: none; }
        .purpose-section summary::after { content: '[Expand]'; float: right; font-size: 0.9rem; font-weight: 500; color: var(--secondary-color); }
        .purpose-section[open] summary::after { content: '[Shrink]'; }
        .purpose-content { padding: 0 24px 24px; border-top: 1px solid var(--border-color); font-size: 0.95rem; }
        .purpose-content h3 { margin-top: 1.2rem; }
        .purpose-content ul { margin-left: 1.1rem; margin-bottom: 0.85rem; }

        .tool-inputs form { display: flex; flex-direction: column; gap: 12px; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px 22px; }
        .input-group { position: relative; padding-right: 28px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.88rem; }
        .input-group input[type="number"] {
            width: 100%; padding: 11px 12px; border: 1px solid var(--border-color); border-radius: 9px;
            font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: #fdfdfd;
        }
        .input-group input:focus {
            outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
        }
        .tooltip-trigger {
            display: inline-flex; justify-content: center; align-items: center;
            width: 18px; height: 18px; border-radius: 50%; background: var(--primary-light);
            color: var(--secondary-color); font-size: 11px; font-weight: 700; cursor: help;
            position: absolute; right: 4px; top: 36px;
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip); position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
            background-color: var(--primary-color); color: white; padding: 10px 12px; border-radius: 8px;
            font-size: 12px; line-height: 1.4; white-space: normal; min-width: 160px; max-width: 240px;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
        }
        .tooltip-trigger:hover::after { opacity: 1; }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            border: none; border-radius: 9px; font-weight: 600; cursor: pointer;
            padding: 11px 18px; transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: var(--primary-light); color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #dbe5f1; }

        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab-link {
            border: 1px solid var(--border-color); background: var(--bg-card);
            padding: 8px 16px; border-radius: 999px; font-weight: 600; cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .tab-link.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        .result-item { padding: 14px 0; border-bottom: 1px solid var(--border-color); }
        .result-item:last-child { border-bottom: none; }
        .result-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .result-header strong { font-size: 1.05rem; color: var(--primary-color); }
        .result-angle-block { padding-bottom: 16px; margin-bottom: 18px; border-bottom: 1px solid var(--border-color); }
        .result-angle-block:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .result-angle-block h4 { margin-bottom: 0.75rem; color: var(--secondary-color); }
        .inline-details summary {
            list-style: none; cursor: pointer; width: 24px; height: 24px;
            border-radius: 50%; background-color: var(--primary-light); display: inline-flex;
            align-items: center; justify-content: center; position: relative;
        }
        .inline-details summary::after { content: '∑'; font-size: 0.85rem; color: var(--secondary-color); }
        .inline-details[open] summary::after { content: '×'; }
        .equation-details { margin-top: 6px; background: #f1f5f9; border-radius: 8px; padding: 10px 14px; line-height: 1.5; }
        .def { border-bottom: 1px dotted var(--accent-color); cursor: help; }

        .equation-container { display: flex; flex-direction: column; gap: 16px; margin-top: 1rem; }
        .equation-card {
            background: rgba(237, 242, 247, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 18px;
        }
        .equation-card strong { display: block; margin-bottom: 6px; color: var(--secondary-color); }
        .equation-expression {
            display: block;
            margin-bottom: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        .variable-legend {
            list-style: none;
            padding-left: 0;
            margin: 10px 0 0;
            display: grid;
            gap: 6px 18px;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            font-size: 0.9rem;
            color: var(--secondary-color);
        }
        .variable-legend .math-inline { font-weight: 600; color: var(--accent-color); }

        .viz-wrapper { display: grid; gap: 18px; }
        .viz-canvas {
            width: 100%; border: 1px solid var(--border-color); border-radius: 12px;
            background: linear-gradient(180deg, rgba(237, 242, 247, 0.35), rgba(255, 255, 255, 0.85));
            padding: 12px;
        }
        .viz-summary {
            border: 1px solid var(--border-color);
            border-radius: 12px; padding: 16px;
            background: rgba(237, 242, 247, 0.55);
        }
        .viz-summary ul { list-style: none; padding-left: 0; display: grid; gap: 6px; font-size: 0.95rem; }
        .viz-summary li strong { color: var(--secondary-color); }

        .footer { text-align: center; padding: 20px 0; background-color: var(--bg-card); border-top: 1px solid var(--border-color); color: var(--secondary-color); font-size: 0.92rem; margin-top: 32px; }

        @media (max-width: 980px) {
            .tool-layout { grid-template-columns: 1fr; }
            .tooltip-trigger { right: 4px; top: 40px; }
            .card { padding: 18px; }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
        </nav>
    </header>

    <main class="container">
        <h1>Projectile Trajectory Planner</h1>
        <p id="tool-description" class="tool-description">
            Plan drag-free projectile motion, quantify peak altitude, and estimate impact conditions.
        </p>

        <details class="purpose-section">
            <summary>Tool Purpose & README</summary>
            <div class="purpose-content" id="readme-content">
                <p>Loading README content...</p>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <form id="calc-form">
                    <div class="input-grid">
                        <div class="input-group" data-param="initial_speed_mps">
                            <label for="initial-speed">Initial Speed (m/s)</label>
                            <input type="number" id="initial-speed" name="initial_speed_mps" min="0.1" step="0.1" value="30">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                        <div class="input-group" data-param="launch_angle_deg">
                            <label for="launch-angle">Launch Angle (deg)</label>
                            <input type="text" id="launch-angle" name="launch_angle_deg" placeholder="e.g., 30, 45, 60" value="35, 45, 55">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                        <div class="input-group" data-param="initial_height_m">
                            <label for="initial-height">Launch Height (m)</label>
                            <input type="number" id="initial-height" name="initial_height_m" min="0" step="0.1" value="1.5">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                        <div class="input-group" data-param="gravity_mps2">
                            <label for="gravity">Gravity (m/s²)</label>
                            <input type="number" id="gravity" name="gravity_mps2" min="1" step="0.001" value="9.807">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="calculate-btn">Calculate</button>
                    </div>
                </form>
            </section>

            <section class="tool-outputs card">
                <div class="tabs">
                    <button type="button" class="tab-link active" data-target="results">Results</button>
                    <button type="button" class="tab-link" data-target="visualization">Visualization</button>
                    <button type="button" class="tab-link" data-target="background">Background &amp; Principles</button>
                </div>

                <div id="results" class="tab-content active">
                    <h3>Key Results</h3>
                    <div id="results-display">
                        <p id="results-placeholder">Enter inputs and press Calculate to see trajectory metrics.</p>
                    </div>
                    <button type="button" class="btn btn-secondary" id="export-btn" style="margin-top: 18px;">Export Results</button>
                </div>

                <div id="visualization" class="tab-content">
                    <h3>Trajectory Plot</h3>
                    <div id="plot-container">
                        <p>Run a calculation to render the flight path.</p>
                    </div>
                </div>

                <div id="background" class="tab-content">
                    <h3>Underlying Principles</h3>
                    <div id="background-content">
                        <p>Equations and references will load after the docstring is parsed.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Engineering Tools. Calculations assume idealized, drag-free motion.</p>
    </footer>

    <script>
        const TOOL_MODULE_NAME = 'ballistics';
        const TOOL_FUNCTION_NAME = 'plan_projectile_trajectory';

        let pyodideInstance, pyUtils, pyToolModule;
        let toolDocumentation = { parameters: {}, returns: {}, latex: '', variables: '', references: '' };
        let latestResults = null;
        let equationBlocks = [];

        function normaliseMap(value) {
            if (value instanceof Map) {
                const obj = {};
                for (const [key, entry] of value.entries()) {
                    obj[key] = normaliseMap(entry);
                }
                return obj;
            }
            if (value && typeof value === 'object' && typeof value.toJs === 'function') {
                return normaliseMap(value.toJs());
            }
            if (Array.isArray(value)) {
                return value.map(item => normaliseMap(item));
            }
            if (value && typeof value === 'object') {
                const obj = {};
                for (const [key, entry] of Object.entries(value)) {
                    obj[key] = normaliseMap(entry);
                }
                return obj;
            }
            return value;
        }

        function openTab(event) {
            const targetId = event.currentTarget.dataset.target;
            document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(section => section.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(targetId).classList.add('active');
            if (targetId === 'background') {
                typesetMath();
            }
        }
        document.querySelectorAll('.tab-link').forEach(btn => btn.addEventListener('click', openTab));

        function typesetMath() {
            if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
                window.MathJax.typesetPromise();
            }
        }

        async function loadReadme() {
            try {
                const response = await fetch('README.md');
                const text = await response.text();
                const container = document.getElementById('readme-content');
                const sections = text.trim().split(/\\n{2,}/).map(block => {
                    const cleaned = block.replace(/\\r/g, '');
                    if (cleaned.startsWith('# ')) {
                        return `<h3>${cleaned.substring(2).trim()}</h3>`;
                    }
                    if (cleaned.startsWith('## ')) {
                        return `<h4>${cleaned.substring(3).trim()}</h4>`;
                    }
                    if (cleaned.startsWith('- ')) {
                        const items = cleaned.split('\\n').map(item => `<li>${item.replace(/^-\\s*/, '')}</li>`).join('');
                        return `<ul>${items}</ul>`;
                    }
                    return `<p>${cleaned.replace(/\\n/g, '<br>')}</p>`;
                }).join('');
                container.innerHTML = sections || '<p>README.md is empty.</p>';
            } catch (error) {
                document.getElementById('readme-content').innerHTML = `<p style="color:#c92a2a;">Failed to load README: ${error.message}</p>`;
            }
        }

        async function initialisePyodide() {
            const button = document.getElementById('calculate-btn');
            button.textContent = 'Loading Pyodide...';
            pyodideInstance = await loadPyodide();
            await pyodideInstance.loadPackage('micropip');

            button.textContent = 'Preparing Python...';
            await pyodideInstance.runPythonAsync(`
                import micropip
                from pyodide.http import pyfetch

                response_utils = await pyfetch('../../pycalcs/utils.py')
                with open('utils.py', 'w') as f:
                    f.write(await response_utils.string())

                response_tool = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
                with open('${TOOL_MODULE_NAME}.py', 'w') as f:
                    f.write(await response_tool.string())

                import utils
                import ${TOOL_MODULE_NAME}
            `);

            pyUtils = pyodideInstance.globals.get('utils');
            pyToolModule = pyodideInstance.globals.get(TOOL_MODULE_NAME);

            const docProxy = pyUtils.get_documentation(TOOL_MODULE_NAME, TOOL_FUNCTION_NAME);
            const docMap = docProxy.toJs();
            if (typeof docProxy.destroy === 'function') {
                docProxy.destroy();
            }
            if (docMap.has && docMap.has('error')) {
                throw new Error(docMap.get('error'));
            }
            toolDocumentation = Object.fromEntries(docMap);
            if (toolDocumentation.parameters) {
                toolDocumentation.parameters = Object.fromEntries(toolDocumentation.parameters);
            }
            if (toolDocumentation.returns) {
                toolDocumentation.returns = Object.fromEntries(toolDocumentation.returns);
            }

            populateUiFromDocstring();
            button.textContent = 'Calculate';
        }

        function populateUiFromDocstring() {
            document.getElementById('tool-description').textContent = toolDocumentation.description || '';

            document.querySelectorAll('.input-group[data-param]').forEach(group => {
                const key = group.dataset.param;
                const tooltip = group.querySelector('.tooltip-trigger');
                const definition = toolDocumentation.parameters?.[key];
                if (tooltip) {
                    tooltip.setAttribute('data-tooltip', definition || 'Parameter description unavailable.');
                }
            });
            equationBlocks = [];
            let latexLines = [];
            if (toolDocumentation.latex) {
            const cleanedLatex = toolDocumentation.latex.replace(/\\r/g, '');
            const alignedBlocks = cleanedLatex.match(/\\begin\{aligned\}[\\s\\S]*?\\end\{aligned\}/g);
            if (alignedBlocks && alignedBlocks.length) {
                latexLines = alignedBlocks.map(block => block.trim());
            } else {
                latexLines = cleanedLatex
                    .split(/\\n{2,}/)
                    .map(block => block.trim())
                    .filter(Boolean);
            }
            equationBlocks = latexLines;
            }
            const variableItems = (toolDocumentation.variables || '')
                .split('\\n')
                .map(line => line.trim())
                .filter(line => line.includes(':'))
                .map(line => {
                    const [symbol, detail] = line.split(':', 2);
                    return `<li><span class="math-inline">\\(${symbol.trim()}\\)</span>: ${detail.trim()}</li>`;
                });
            const variablesHtml = variableItems.length
                ? `<ul class="variable-legend">${variableItems.join('')}</ul>`
                : '<p>No variable definitions supplied.</p>';

            const equationCards = latexLines.map((expr, index) => `
                <div class="equation-card">
                    <strong>Equation (${index + 1})</strong>
                    <span class="equation-expression">\\[ ${expr} \\]</span>
                </div>
            `).join('');

            const background = document.getElementById('background-content');
            background.innerHTML = `
                <p>${(toolDocumentation.description || '').replace(/\\n/g, '<br>')}</p>
                <h4>Equations</h4>
                <div class="equation-container">
                    ${equationCards || '<p>No equations supplied.</p>'}
                </div>
                <h4>Variable Legend</h4>
                ${variablesHtml}
                <h4>References</h4>
                <p>${(toolDocumentation.references || 'No references supplied.').replace(/\\n/g, '<br>')}</p>
            `;
            typesetMath();
        }

        function formatValue(value) {
            if (typeof value !== 'number' || !Number.isFinite(value)) {
                return value;
            }
            const absVal = Math.abs(value);
            const options = {
                maximumFractionDigits: absVal < 1 ? 4 : absVal < 10 ? 3 : absVal < 100 ? 2 : 1,
                minimumFractionDigits: 0
            };
            if (Math.abs(value - Math.round(value)) < 1e-6) {
                options.maximumFractionDigits = 0;
            }
            return value.toLocaleString(undefined, options);
        }

        function buildResultRow(key, label, definition, valueText, equation, substitution) {
            const detailsHtml = substitution
                ? `<details class="inline-details">
                        <summary title="Show equation"></summary>
                        <div class="equation-details">
                            ${equation ? `<p><strong>Equation:</strong> $$${equation}$$</p>` : ''}
                            <p><strong>Substituted:</strong> $$${substitution}$$</p>
                        </div>
                   </details>`
                : '';
            return `
                <div class="result-item">
                    <div class="result-header">
                        <p><strong><span class="def" data-def="${definition || 'Definition unavailable.'}">${label}</span>:</strong> ${valueText}</p>
                        ${detailsHtml}
                    </div>
                </div>
            `;
        }

        function renderResults(resultCases) {
            const resultsDiv = document.getElementById('results-display');
            resultsDiv.innerHTML = '';

            if (!Array.isArray(resultCases) || resultCases.length === 0) {
                resultsDiv.innerHTML = '<p>No results available.</p>';
                return;
            }

            const returnsMeta = toolDocumentation.returns || {};

            resultCases.forEach(({ angleDeg, data }) => {
                let equationIndex = 0;

                const rows = Object.entries(returnsMeta).map(([key, definition]) => {
                    const rawValue = data[key];
                    if (rawValue === undefined || rawValue === null || typeof rawValue === 'object') {
                        return '';
                    }
                    const displayName = key.replace(/_/g, ' ')
                        .replace(/\b([a-z])/g, match => match.toUpperCase());
                    const formattedValue = formatValue(rawValue);
                    const substitution = data[`subst_${key}`];
                    let equation = '';
                    if (equationIndex < equationBlocks.length) {
                        equation = equationBlocks[equationIndex];
                    }
                    equationIndex += 1;
                    return buildResultRow(
                        key,
                        displayName,
                        definition,
                        formattedValue,
                        equation,
                        substitution
                    );
                }).join('');

                resultsDiv.innerHTML += `
                    <div class="result-angle-block">
                        <h4>Launch Angle ${formatValue(angleDeg)}°</h4>
                        ${rows || '<p>No scalar results available.</p>'}
                    </div>
                `;
            });

            typesetMath();
        }

        function renderVisualization(resultCases) {
            const plotContainer = document.getElementById('plot-container');
            if (typeof Plotly === 'undefined') {
                plotContainer.innerHTML = '<p>Plotly library failed to load; cannot render trajectory.</p>';
                return;
            }
            if (!Array.isArray(resultCases) || resultCases.length === 0) {
                plotContainer.innerHTML = '<p>Insufficient data to plot the trajectory.</p>';
                return;
            }

            const colours = ['#2563eb', '#16a34a', '#f97316', '#9333ea', '#0ea5e9', '#ec4899', '#0f766e'];
            let maxRange = 0;
            const traces = [];
            const annotations = [];

            resultCases.forEach(({ angleDeg, data }, index) => {
                const points = data.trajectory_points || [];
                if (!Array.isArray(points) || points.length < 2) {
                    return;
                }
                const xValues = points.map(pt => pt.x);
                const yValues = points.map(pt => pt.y);
                const color = colours[index % colours.length];
                const angleLabel = `${formatValue(angleDeg)}°`;
                maxRange = Math.max(maxRange, ...xValues);

                traces.push({
                    x: xValues,
                    y: yValues,
                    mode: 'lines',
                    name: angleLabel,
                    line: { color, width: 3 },
                    hovertemplate: `Angle: ${angleLabel}<br>Range: %{x:.2f} m<br>Height: %{y:.2f} m<br>Time: %{customdata:.2f} s<extra></extra>`,
                    customdata: points.map(pt => pt.t)
                });

                const apex = points.reduce((best, pt) => (pt.y > best.y ? pt : best), points[0]);
                const impact = points[points.length - 1];

                traces.push({
                    x: [apex.x],
                    y: [apex.y],
                    mode: 'markers',
                    name: `${angleLabel} Apex`,
                    showlegend: false,
                    marker: { color, size: 9, symbol: 'circle' },
                    hovertemplate: `Angle: ${angleLabel}<br>Apex<br>Range: %{x:.2f} m<br>Height: %{y:.2f} m<extra></extra>`
                });

                traces.push({
                    x: [impact.x],
                    y: [impact.y],
                    mode: 'markers',
                    name: `${angleLabel} Impact`,
                    showlegend: false,
                    marker: { color, size: 9, symbol: 'diamond' },
                    hovertemplate: `Angle: ${angleLabel}<br>Impact<br>Range: %{x:.2f} m<br>Height: %{y:.2f} m<extra></extra>`
                });

                annotations.push({
                    x: apex.x,
                    y: apex.y,
                    xanchor: 'left',
                    yanchor: 'bottom',
                    text: `${angleLabel} apex: ${formatValue(apex.y)} m`,
                    showarrow: false,
                    font: { color }
                });
            });

            if (!traces.length) {
                plotContainer.innerHTML = '<p>Insufficient data to plot the trajectory.</p>';
                return;
            }

            const summaryList = resultCases.map(({ angleDeg, data }) => {
                const angleLabel = `${formatValue(angleDeg)}°`;
                return `
                    <li>
                        <strong>${angleLabel}</strong> — Range ${formatValue(data.range_m)} m,
                        Peak ${formatValue(data.peak_height_m)} m,
                        ToF ${formatValue(data.time_of_flight_s)} s,
                        Impact ${formatValue(data.impact_speed_mps)} m/s
                    </li>
                `;
            }).join('');

            plotContainer.innerHTML = `
                <div class="viz-wrapper">
                    <div id="trajectory-plot" class="viz-canvas"></div>
                    <div class="viz-summary">
                        <h4>Flight Highlights</h4>
                        <ul>${summaryList}</ul>
                    </div>
                </div>
            `;

            const shapes = [
                {
                    type: 'line',
                    x0: 0,
                    x1: (maxRange > 0 ? maxRange * 1.05 : 1),
                    y0: 0,
                    y1: 0,
                    line: { color: '#64748b', width: 2 }
                }
            ];

            const firstPoint = resultCases[0]?.data?.trajectory_points?.[0];
            if (firstPoint) {
                annotations.push({
                    x: firstPoint.x,
                    y: firstPoint.y,
                    xanchor: 'left',
                    yanchor: 'bottom',
                    text: `Launch height: ${formatValue(firstPoint.y)} m`,
                    showarrow: false,
                    font: { color: '#475569' }
                });
            }

            const layout = {
                margin: { t: 30, r: 20, b: 60, l: 70 },
                height: 420,
                xaxis: {
                    title: 'Horizontal Distance x (m)',
                    zeroline: true,
                    zerolinecolor: '#64748b',
                    gridcolor: '#e2e8f0'
                },
                yaxis: {
                    title: 'Vertical Position y (m)',
                    zeroline: false,
                    gridcolor: '#e2e8f0'
                },
                legend: { orientation: 'h', yanchor: 'bottom', y: 1.02, x: 0 },
                hovermode: 'closest',
                shapes,
                annotations,
                responsive: true
            };

            Plotly.newPlot('trajectory-plot', traces, layout, { displaylogo: false, responsive: true });
        }

        function exportResults() {
            if (!latestResults) {
                alert('Run a calculation before exporting.');
                return;
            }
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const blob = new Blob([JSON.stringify(latestResults, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `projectile-trajectory-${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        document.getElementById('export-btn').addEventListener('click', exportResults);

        document.getElementById('calc-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!pyToolModule) {
                alert('Python runtime still loading. Please wait a moment and try again.');
                return;
            }
            try {
                const initialSpeedValue = document.getElementById('initial-speed').value;
                const launchAnglesValue = document.getElementById('launch-angle').value;
                const initialHeightValue = document.getElementById('initial-height').value;
                const gravityValue = document.getElementById('gravity').value;

                const speed = parseFloat(initialSpeedValue);
                const height = parseFloat(initialHeightValue);
                const gravity = parseFloat(gravityValue);

                if ([speed, height, gravity].some(value => Number.isNaN(value))) {
                    throw new Error('Initial speed, launch height, and gravity must be numeric.');
                }

                const angleTokens = launchAnglesValue.split(',').map(token => token.trim()).filter(token => token.length > 0);
                if (angleTokens.length === 0) {
                    throw new Error('Enter at least one launch angle (comma-separated).');
                }

                const angleValues = angleTokens.map(token => {
                    const angle = Number(token);
                    if (!Number.isFinite(angle)) {
                        throw new Error(`Invalid launch angle: "${token}".`);
                    }
                    if (!(angle > 0 && angle < 90)) {
                        throw new Error(`Launch angle must be between 0 and 90 degrees (received ${token}).`);
                    }
                    return angle;
                });

                const resultsByAngle = [];
                for (const angleDeg of angleValues) {
                    const resultProxy = pyToolModule[TOOL_FUNCTION_NAME](speed, angleDeg, height, gravity);
                    const resultMap = resultProxy.toJs();
                    const result = normaliseMap(resultMap);
                    if (typeof resultProxy.destroy === 'function') {
                        resultProxy.destroy();
                    }
                    if (result.error) {
                        throw new Error(`Angle ${angleDeg}°: ${result.error}`);
                    }
                    resultsByAngle.push({ angleDeg, data: result });
                }

                latestResults = {
                    inputs: {
                        initial_speed_mps: speed,
                        initial_height_m: height,
                        gravity_mps2: gravity
                    },
                    solutions: resultsByAngle
                };

                renderResults(resultsByAngle);
                renderVisualization(resultsByAngle);
            } catch (error) {
                console.error('Calculation error:', error);
                document.getElementById('results-display').innerHTML = `
                    <p style="color:#c92a2a;font-weight:600;">Calculation error: ${error.message}</p>
                `;
                document.getElementById('plot-container').innerHTML = '<p>Unable to render trajectory due to the calculation error.</p>';
            } finally {
                typesetMath();
            }
        });

        (async function bootstrap() {
            await loadReadme();
            try {
                await initialisePyodide();
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('results-display').innerHTML = `
                    <p style="color:#c92a2a;font-weight:600;">Initialization error: ${error.message}</p>
                `;
            }
        })();
    </script>
</body>
</html>

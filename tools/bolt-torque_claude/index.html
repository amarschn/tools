<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolt Torque Calculator (VDI 2230) - Engineering Tools</title>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        /* --- 1. Global Styles & Variables (Polestar-Inspired Minimal UI) --- */
        :root {
            --primary-color: #0b0d12;
            --primary-light: #f4f5f7;
            --secondary-color: #4b5563;
            --accent-color: #111827;
            --success-color: #0f766e;
            --warning-color: #b45309;
            --danger-color: #b91c1c;
            --text-color: #111827;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --bg-color: #f8f9fb;
            --bg-card: #ffffff;
            --shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 6px 18px rgba(15, 23, 42, 0.08);
            --border-radius: 8px;
            --font-sans: 'Helvetica Neue', 'Avenir Next', 'Univers', 'Helvetica', system-ui, sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-sans);
            line-height: 1.6;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container { width: 92%; max-width: 1400px; margin: 0 auto; padding: 24px 0; }
        h1, h2, h3, h4 { color: var(--primary-color); margin-bottom: 0.75em; line-height: 1.2; font-weight: 600; letter-spacing: -0.01em; }
        h1 { font-size: 2.25rem; letter-spacing: -0.02em; }
        h2 { font-size: 1.375rem; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; }
        h3 { font-size: 1.1rem; color: var(--secondary-color); font-weight: 600; }
        p { margin-bottom: 1em; color: var(--text-light); }
        a { color: var(--text-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }

        /* --- 2. Navigation --- */
        .navbar {
            background: var(--primary-color);
            border-bottom: none;
            box-shadow: var(--shadow);
            padding: 0 5%;
        }
        .nav-container { display: flex; justify-content: space-between; align-items: center; height: 56px; max-width: 1400px; margin: 0 auto; }
        .nav-brand { font-size: 1.25rem; font-weight: 600; color: #fff; letter-spacing: -0.01em; }
        .nav-brand:hover { text-decoration: none; opacity: 0.85; }

        /* --- 3. Main Tool Layout --- */
        main.container { flex-grow: 1; }
        .tool-header { text-align: center; margin-bottom: 2rem; }
        .tool-header h1 { margin-bottom: 0.5rem; }
        .tool-description { font-size: 1.15rem; max-width: 70ch; margin: 0 auto 1.5rem; color: var(--text-light); }
        .tool-layout { display: grid; grid-template-columns: minmax(360px, 0.9fr) minmax(480px, 1.1fr); gap: 28px; align-items: start; }
        .card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            padding: 28px;
        }

        /* --- 3b. Purpose/README Section --- */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .purpose-section { margin-bottom: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--bg-card); }
        .purpose-section summary { padding: 16px 24px; font-size: 1.05rem; font-weight: 600; color: var(--secondary-color); display: flex; justify-content: space-between; align-items: center; }
        .purpose-section summary::after { content: 'Expand'; font-size: 0.85rem; font-weight: 500; color: var(--accent-color); background: var(--primary-light); padding: 4px 12px; border-radius: 20px; }
        .purpose-section[open] > summary::after { content: 'Collapse'; }
        .purpose-content { padding: 0 24px 24px 24px; border-top: 1px solid var(--border-color); }
        .purpose-content h3 { margin-top: 1rem; }
        .purpose-content ul { padding-left: 20px; margin-bottom: 1rem; }

        /* --- 4. Input Section --- */
        .tool-inputs h2 { margin-top: 0; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; }
        .tool-inputs h2::before { content: ''; width: 4px; height: 24px; background: var(--accent-color); border-radius: 2px; }

        .input-tabs { display: flex; gap: 6px; margin-bottom: 1.25rem; flex-wrap: wrap; }
        .input-tab {
            flex: 1 1 auto;
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-card);
            color: var(--secondary-color);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: background-color 0.15s ease, border-color 0.15s ease;
            text-align: center;
        }
        .input-tab:hover { border-color: var(--text-color); color: var(--text-color); }
        .input-tab.active {
            background: var(--accent-color);
            color: #fff;
            border-color: var(--accent-color);
        }
        .input-section { display: none; animation: fadeIn 0.3s ease; }
        .input-section.active { display: block; }

        .input-group { margin-bottom: 1.1rem; position: relative; }
        .input-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.875rem;
            color: var(--text-color);
        }
        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-family: var(--font-sans);
            transition: border-color 0.15s ease;
            background: var(--bg-card);
        }
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--text-color);
        }
        .input-group select { cursor: pointer; }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* --- 5. Input Tooltip --- */
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: var(--border-color);
            color: var(--text-light);
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            position: absolute;
            right: 8px;
            top: 42px;
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.5;
            white-space: normal;
            width: 220px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        .tooltip-trigger:hover::after { opacity: 1; visibility: visible; }

        /* --- 6. Button Styles --- */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            transition: background-color 0.15s ease, opacity 0.15s ease;
        }
        .btn-primary {
            background: var(--accent-color);
            color: white;
            width: 100%;
            font-size: 1rem;
            padding: 14px;
            margin-top: 8px;
            box-shadow: var(--shadow);
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-secondary {
            background-color: var(--bg-card);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { background-color: var(--primary-light); }

        /* --- 7. Output Section --- */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; gap: 4px; }
        .tab-link {
            padding: 12px 18px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: color 0.15s ease, border-color 0.15s ease;
        }
        .tab-link:hover { color: var(--text-color); }
        .tab-link.active {
            color: var(--text-color);
            font-weight: 600;
            border-bottom-color: var(--text-color);
        }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 7a. Results Display --- */
        #results-display { min-height: 200px; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 18px;
            text-align: center;
        }
        .result-card.highlight {
            background: var(--primary-light);
            border-left: 3px solid var(--accent-color);
        }
        .result-card .label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 6px; font-weight: 500; }
        .result-card .value { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); font-family: var(--font-mono); }
        .result-card .unit { font-size: 0.85rem; color: var(--text-light); margin-left: 4px; }
        .result-card .range { font-size: 0.8rem; color: var(--text-light); margin-top: 6px; }

        /* --- 7b. Safety Gauges --- */
        .safety-section { margin-top: 24px; }
        .safety-section h4 { margin-bottom: 16px; color: var(--secondary-color); }
        .safety-gauge {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        .gauge-label { min-width: 140px; font-weight: 600; font-size: 0.9rem; }
        .gauge-bar-container { flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; position: relative; overflow: visible; }
        .gauge-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.4s ease;
        }
        .gauge-bar.success { background: var(--success-color); }
        .gauge-bar.warning { background: var(--warning-color); }
        .gauge-bar.danger { background: var(--danger-color); }
        .gauge-value {
            min-width: 60px;
            text-align: right;
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.9rem;
        }
        .gauge-value.success { color: var(--success-color); }
        .gauge-value.warning { color: var(--warning-color); }
        .gauge-value.danger { color: var(--danger-color); }
        .gauge-threshold {
            position: absolute;
            width: 2px;
            height: 16px;
            background: var(--text-color);
            top: -4px;
        }

        /* --- 7c. Status Banner --- */
        .status-banner {
            padding: 18px 24px;
            border-radius: var(--border-radius);
            margin-top: 24px;
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }
        .status-banner .icon { font-size: 1.25rem; }
        .status-banner .content h4 { margin-bottom: 4px; }
        .status-banner .content p { margin-bottom: 0; font-size: 0.9rem; }
        .status-banner.acceptable {
            background: #ecfdf5;
            border: 1px solid var(--success-color);
        }
        .status-banner.acceptable h4 { color: var(--success-color); }
        .status-banner.marginal {
            background: #fffbeb;
            border: 1px solid var(--warning-color);
        }
        .status-banner.marginal h4 { color: var(--warning-color); }
        .status-banner.unacceptable {
            background: #fef2f2;
            border: 1px solid var(--danger-color);
        }
        .status-banner.unacceptable h4 { color: var(--danger-color); }
        .recommendations { margin-top: 8px; padding-left: 20px; }
        .recommendations li { font-size: 0.85rem; margin-bottom: 4px; }

        /* --- 7d. Chart Containers --- */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 18px;
            margin-bottom: 20px;
        }
        .chart-container h4 { margin-bottom: 12px; font-size: 0.95rem; font-weight: 600; }
        .chart-plot { width: 100%; min-height: 320px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* --- 7e. Equation Cards --- */
        .equation-container { display: flex; flex-direction: column; gap: 16px; margin-top: 1rem; }
        .equation-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px 20px;
        }
        .equation-card strong { display: block; margin-bottom: 8px; color: var(--secondary-color); font-size: 0.9rem; }
        .equation-card .equation-expression { display: block; margin-bottom: 10px; font-size: 1.05rem; }
        .equation-card ul { list-style: none; padding-left: 0; display: grid; gap: 6px; font-size: 0.85rem; color: var(--text-light); }

        /* --- 8. Footer --- */
        .footer {
            text-align: center;
            padding: 24px 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: auto;
        }

        /* --- 9. Responsive Layout --- */
        @media (max-width: 1000px) {
            .tool-layout { grid-template-columns: 1fr; }
            .charts-grid { grid-template-columns: 1fr; }
            .input-row { grid-template-columns: 1fr; }
        }
        @media (max-width: 600px) {
            .input-tabs { flex-direction: column; }
            .results-grid { grid-template-columns: 1fr; }
        }

        /* --- 10. Loading State --- */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-weight: 600; color: var(--text-color); }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Loading Pyodide...</div>
    </div>

    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
        </nav>
    </header>

    <main class="container">
        <div class="tool-header">
            <h1>Bolt Torque Calculator</h1>
            <p class="tool-description">
                VDI 2230-style bolted joint analysis with comprehensive safety factor evaluation.
                Supports ISO metric and SAE/ASTM imperial fasteners.
            </p>
        </div>

        <details class="purpose-section">
            <summary>Tool Purpose & References</summary>
            <div class="purpose-content" id="readme-content">
                <h3>About This Calculator</h3>
                <p>This tool implements the systematic approach from VDI 2230:2015 for calculating:</p>
                <ul>
                    <li>Assembly torque with K-factor uncertainty bands</li>
                    <li>Bolt and joint stiffness using multi-zone models</li>
                    <li>Preload with scatter from tightening method</li>
                    <li>Embedding losses per surface finish</li>
                    <li>Safety factors for yield, clamping, fatigue, and shear</li>
                </ul>
                <h3>Key References</h3>
                <ul>
                    <li><strong>VDI 2230:2015</strong> - Systematic calculation of highly stressed bolted joints</li>
                    <li><strong>ISO 898-1:2013</strong> - Mechanical properties of fasteners (metric)</li>
                    <li><strong>SAE J429</strong> - SAE bolt grade specifications</li>
                    <li><strong>Bickford (2007)</strong> - Introduction to the Design and Behavior of Bolted Joints</li>
                    <li><strong>Shigley's MED, 11th ed.</strong> - Chapter 8: Screws, Fasteners, and the Design of Nonpermanent Joints</li>
                </ul>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <div class="input-tabs">
                    <button type="button" class="input-tab active" data-target="section-fastener">Fastener</button>
                    <button type="button" class="input-tab" data-target="section-joint">Joint</button>
                    <button type="button" class="input-tab" data-target="section-loading">Loading</button>
                    <button type="button" class="input-tab" data-target="section-assembly">Assembly</button>
                </div>
                <form id="calc-form">
                    <!-- Fastener Tab -->
                    <div id="section-fastener" class="input-section active">
                        <div class="input-group">
                            <label for="fastener_standard">Fastener Standard</label>
                            <select id="fastener_standard">
                                <option value="ISO">ISO Metric</option>
                                <option value="UTS">SAE / Imperial (UTS)</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Select ISO for metric threads (M6, M10, etc.) or UTS for unified inch threads (1/4-20, 1/2-13, etc.)">?</span>
                        </div>
                        <div class="input-group">
                            <label for="fastener_size">Thread Size</label>
                            <select id="fastener_size">
                                <!-- Populated dynamically -->
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Thread designation including nominal diameter and pitch. Stress area and geometry are looked up from standards tables.">?</span>
                        </div>
                        <div class="input-group">
                            <label for="bolt_grade">Bolt Grade</label>
                            <select id="bolt_grade">
                                <!-- Populated dynamically -->
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Material grade determines proof strength, yield strength, and tensile strength per ISO 898-1 or SAE J429.">?</span>
                        </div>
                    </div>

                    <!-- Joint Tab -->
                    <div id="section-joint" class="input-section">
                        <div class="input-group">
                            <label for="grip_length">Grip Length (mm)</label>
                            <input type="number" id="grip_length" value="25" min="1" step="0.5">
                            <span class="tooltip-trigger" data-tooltip="Total clamped length from bolt head bearing surface to nut bearing surface. Affects stiffness calculations.">?</span>
                        </div>
                        <div class="input-group">
                            <label for="clamped_material">Clamped Material</label>
                            <select id="clamped_material">
                                <option value="210e9">Steel (E = 210 GPa)</option>
                                <option value="70e9">Aluminum (E = 70 GPa)</option>
                                <option value="110e9">Cast Iron (E = 110 GPa)</option>
                                <option value="115e9">Titanium (E = 115 GPa)</option>
                                <option value="custom">Custom...</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Elastic modulus of clamped members. For multi-material joints, use equivalent modulus.">?</span>
                        </div>
                        <div class="input-group" id="custom-modulus-group" style="display: none;">
                            <label for="custom_modulus">Custom Modulus (GPa)</label>
                            <input type="number" id="custom_modulus" value="200" min="1" step="1">
                        </div>
                        <div class="input-group">
                            <label for="joint_type">Joint Type</label>
                            <select id="joint_type">
                                <option value="through_bolt">Through-Bolt (nut on back)</option>
                                <option value="tap_bolt">Tap Bolt (threaded hole)</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Through-bolt uses a nut; tap-bolt threads into the component. Affects stiffness model.">?</span>
                        </div>
                    </div>

                    <!-- Loading Tab -->
                    <div id="section-loading" class="input-section">
                        <div class="input-row">
                            <div class="input-group">
                                <label for="external_axial_load">Axial Load per Bolt (N)</label>
                                <input type="number" id="external_axial_load" value="5000" min="0" step="100">
                                <span class="tooltip-trigger" data-tooltip="Maximum tensile working load applied to each bolt. Used for safety factor calculations.">?</span>
                            </div>
                            <div class="input-group">
                                <label for="external_shear_load">Shear Load per Bolt (N)</label>
                                <input type="number" id="external_shear_load" value="0" min="0" step="100">
                                <span class="tooltip-trigger" data-tooltip="Shear load perpendicular to bolt axis. Resisted by friction grip (preload dependent).">?</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="n_bolts">Number of Bolts</label>
                            <input type="number" id="n_bolts" value="1" min="1" step="1">
                            <span class="tooltip-trigger" data-tooltip="Total bolts in joint pattern. Loads are specified per bolt.">?</span>
                        </div>
                    </div>

                    <!-- Assembly Tab -->
                    <div id="section-assembly" class="input-section">
                        <div class="input-group">
                            <label for="tightening_method">Tightening Method</label>
                            <select id="tightening_method">
                                <option value="torque_wrench">Torque Wrench (standard)</option>
                                <option value="torque_wrench_precision">Torque Wrench (calibrated click)</option>
                                <option value="angle_control">Torque + Angle</option>
                                <option value="yield_control">Yield Point Control</option>
                                <option value="hydraulic">Hydraulic Tensioner</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Tightening method affects preload scatter. Better methods give tighter tolerance on achieved preload.">?</span>
                        </div>
                        <div class="input-group">
                            <label for="surface_condition">Surface Condition</label>
                            <select id="surface_condition">
                                <option value="oiled">Oiled (K ~ 0.15)</option>
                                <option value="dry_steel">Dry Steel (K ~ 0.20)</option>
                                <option value="moly_lube">Moly Lubricant (K ~ 0.11)</option>
                                <option value="zinc_plated_dry">Zinc Plated Dry (K ~ 0.20)</option>
                                <option value="zinc_plated_oiled">Zinc Plated Oiled (K ~ 0.16)</option>
                                <option value="phosphate_oil">Phosphate + Oil (K ~ 0.14)</option>
                                <option value="cadmium_plated">Cadmium Plated (K ~ 0.13)</option>
                                <option value="ptfe_coated">PTFE Coated (K ~ 0.09)</option>
                                <option value="stainless_dry">Stainless Dry (K ~ 0.30)</option>
                                <option value="stainless_lubed">Stainless Lubed (K ~ 0.17)</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Thread and bearing surface condition determines K-factor (nut factor). Lower K means more preload per unit torque.">?</span>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="temperature">Operating Temp (C)</label>
                                <input type="number" id="temperature" value="20" step="5">
                                <span class="tooltip-trigger" data-tooltip="Operating temperature for thermal differential considerations.">?</span>
                            </div>
                            <div class="input-group">
                                <label for="embedding_surface_roughness">Surface Finish</label>
                                <select id="embedding_surface_roughness">
                                    <option value="machined">Machined (Ra 1.6-6.3 um)</option>
                                    <option value="machined_fine">Fine Machined (Ra < 1.6 um)</option>
                                    <option value="as_rolled">As-Rolled</option>
                                    <option value="as_cast">As-Cast</option>
                                </select>
                                <span class="tooltip-trigger" data-tooltip="Surface roughness affects embedding (settling) loss per VDI 2230. Rougher surfaces have more embedding.">?</span>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="calculate-btn">Calculate</button>
                </form>
            </section>

            <section class="tool-outputs card">
                <div class="tabs">
                    <button class="tab-link active" onclick="openTab(event, 'results')">Results</button>
                    <button class="tab-link" onclick="openTab(event, 'diagrams')">Joint Diagram</button>
                    <button class="tab-link" onclick="openTab(event, 'sensitivity')">Sensitivity</button>
                    <button class="tab-link" onclick="openTab(event, 'background')">Background</button>
                </div>

                <div id="results" class="tab-content" style="display: block;">
                    <div id="results-display">
                        <p style="text-align: center; color: var(--text-light); padding: 40px;">
                            Enter parameters and click <strong>Calculate</strong> to analyze the bolted joint.
                        </p>
                    </div>
                </div>

                <div id="diagrams" class="tab-content">
                    <div class="chart-container">
                        <h4>Joint Force-Extension Diagram</h4>
                        <div id="joint-diagram-plot" class="chart-plot"></div>
                    </div>
                </div>

                <div id="sensitivity" class="tab-content">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h4>Torque-Tension Relationship</h4>
                            <div id="torque-tension-plot" class="chart-plot" style="min-height: 280px;"></div>
                        </div>
                        <div class="chart-container">
                            <h4>K-Factor Sensitivity</h4>
                            <div id="k-sensitivity-plot" class="chart-plot" style="min-height: 280px;"></div>
                        </div>
                    </div>
                </div>

                <div id="background" class="tab-content" style="max-height: 70vh; overflow-y: auto;">

                    <!-- Table of Contents -->
                    <div style="background: var(--primary-light); padding: 16px 20px; border-radius: 8px; margin-bottom: 24px;">
                        <strong style="color: var(--primary-color);">Contents</strong>
                        <ol style="margin: 10px 0 0 20px; color: var(--text-light); font-size: 0.9rem;">
                            <li><a href="#bg-overview" style="color: var(--accent-color);">Overview: Why Preload Matters</a></li>
                            <li><a href="#bg-torque-tension" style="color: var(--accent-color);">Torque-Tension Relationship</a></li>
                            <li><a href="#bg-kfactor" style="color: var(--accent-color);">The K-Factor (Nut Factor)</a></li>
                            <li><a href="#bg-stiffness" style="color: var(--accent-color);">Bolt and Joint Stiffness</a></li>
                            <li><a href="#bg-loadfactor" style="color: var(--accent-color);">Load Factor and Force Distribution</a></li>
                            <li><a href="#bg-embedding" style="color: var(--accent-color);">Embedding and Relaxation</a></li>
                            <li><a href="#bg-safety" style="color: var(--accent-color);">Safety Factors Explained</a></li>
                            <li><a href="#bg-graphs" style="color: var(--accent-color);">How to Interpret the Graphs</a></li>
                            <li><a href="#bg-examples" style="color: var(--accent-color);">Worked Examples</a></li>
                            <li><a href="#bg-references" style="color: var(--accent-color);">References and Standards</a></li>
                        </ol>
                    </div>

                    <!-- Section 1: Overview -->
                    <div id="bg-overview" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">1. Overview: Why Preload Matters</h3>
                        <p style="margin-top: 12px;">
                            A bolted joint is not merely a mechanical connection&mdash;it is a <strong>clamping system</strong>.
                            The bolt acts as a very stiff spring that clamps the joint members together. The tension in the bolt
                            after tightening is called the <strong>preload</strong> (F<sub>i</sub>), and it is the single most
                            important factor determining joint reliability.
                        </p>
                        <div style="background: #fef3c7; border-left: 4px solid var(--warning-color); padding: 12px 16px; margin: 16px 0; border-radius: 0 8px 8px 0;">
                            <strong style="color: var(--warning-color);">Key Insight:</strong>
                            <span style="color: var(--text-color);">
                                Approximately 90% of bolted joint failures are due to inadequate preload, not bolt breakage.
                                Insufficient preload leads to fatigue, loosening, and joint separation.
                            </span>
                        </div>
                        <p><strong>What preload does:</strong></p>
                        <ul style="margin-left: 20px; color: var(--text-color);">
                            <li><strong>Prevents joint separation:</strong> The clamping force keeps members in contact even under tensile loads</li>
                            <li><strong>Reduces fatigue:</strong> A properly preloaded bolt sees only a fraction of the external load variation</li>
                            <li><strong>Resists loosening:</strong> Friction from clamping force prevents nut rotation</li>
                            <li><strong>Transfers shear loads:</strong> Friction grip between clamped members carries shear without bolt shear stress</li>
                        </ul>
                    </div>

                    <!-- Section 2: Torque-Tension -->
                    <div id="bg-torque-tension" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">2. Torque-Tension Relationship</h3>
                        <p style="margin-top: 12px;">
                            When you apply torque to a bolt, only a small fraction actually stretches the bolt to create preload.
                            The majority is lost to friction in the threads and under the nut/head bearing surface.
                        </p>
                        <div class="equation-card" style="margin: 16px 0;">
                            <strong>The "Short Form" Torque Equation</strong>
                            <span class="equation-expression">$$ T = K \cdot d \cdot F_i $$</span>
                            <ul>
                                <li><strong>T</strong> = Applied tightening torque (N-m or lb-ft)</li>
                                <li><strong>K</strong> = Nut factor or torque coefficient (dimensionless, typically 0.10&ndash;0.25)</li>
                                <li><strong>d</strong> = Nominal bolt diameter (m or inches)</li>
                                <li><strong>F<sub>i</sub></strong> = Resulting bolt preload/tension (N or lbf)</li>
                            </ul>
                        </div>
                        <p><strong>Where does the torque go?</strong></p>
                        <p>For a typical dry steel bolt, the input torque energy is distributed approximately as:</p>
                        <ul style="margin-left: 20px; color: var(--text-color);">
                            <li><strong>~50%</strong> &rarr; Friction under the nut/bolt head bearing face</li>
                            <li><strong>~40%</strong> &rarr; Friction in the threads</li>
                            <li><strong>~10%</strong> &rarr; Useful work stretching the bolt (creating preload)</li>
                        </ul>
                        <p style="margin-top: 12px;">
                            This explains why lubrication has such a dramatic effect: reducing friction means more of your
                            torque goes into preload. It also explains why torque alone is an imprecise way to control
                            preload&mdash;friction variations of &plusmn;20% cause preload variations of &plusmn;25% or more.
                        </p>
                    </div>

                    <!-- Section 3: K-Factor -->
                    <div id="bg-kfactor" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">3. The K-Factor (Nut Factor)</h3>
                        <p style="margin-top: 12px;">
                            The K-factor (also called nut factor or torque coefficient) captures all the friction and geometry
                            effects in a single empirical constant. It can be calculated from first principles or measured experimentally.
                        </p>
                        <div class="equation-card" style="margin: 16px 0;">
                            <strong>Long-Form K-Factor Equation</strong>
                            <span class="equation-expression">$$ K = \frac{d_2}{2d}\left(\frac{P}{\pi d_2} + \frac{\mu_t}{\cos\alpha}\right) + \frac{\mu_b \cdot D_m}{2d} $$</span>
                            <ul>
                                <li><strong>P</strong> = Thread pitch (distance between threads)</li>
                                <li><strong>d<sub>2</sub></strong> = Pitch diameter of threads</li>
                                <li><strong>d</strong> = Nominal bolt diameter</li>
                                <li><strong>&mu;<sub>t</sub></strong> = Coefficient of friction in threads</li>
                                <li><strong>&mu;<sub>b</sub></strong> = Coefficient of friction at bearing surface</li>
                                <li><strong>&alpha;</strong> = Thread half-angle (30&deg; for standard 60&deg; threads)</li>
                                <li><strong>D<sub>m</sub></strong> = Mean bearing diameter under nut/head</li>
                            </ul>
                        </div>
                        <p><strong>Typical K-Factor Values:</strong></p>
                        <table style="width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--primary-light);">
                                    <th style="padding: 10px; text-align: left; border: 1px solid var(--border-color);">Surface Condition</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color);">K (min)</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color);">K (typical)</th>
                                    <th style="padding: 10px; text-align: center; border: 1px solid var(--border-color);">K (max)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid var(--border-color);">Dry steel (as-received)</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.16</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);"><strong>0.20</strong></td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.25</td></tr>
                                <tr style="background: #fafafa;"><td style="padding: 8px; border: 1px solid var(--border-color);">Machine oil</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.12</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);"><strong>0.15</strong></td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.18</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid var(--border-color);">Moly paste (MoS<sub>2</sub>)</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.08</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);"><strong>0.11</strong></td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.14</td></tr>
                                <tr style="background: #fafafa;"><td style="padding: 8px; border: 1px solid var(--border-color);">PTFE/Teflon coating</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.06</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);"><strong>0.09</strong></td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.12</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid var(--border-color);">Zinc plated, dry</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.17</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);"><strong>0.20</strong></td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.23</td></tr>
                                <tr style="background: #fafafa;"><td style="padding: 8px; border: 1px solid var(--border-color);">Stainless steel, dry</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.25</td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);"><strong>0.30</strong></td><td style="padding: 8px; text-align: center; border: 1px solid var(--border-color);">0.35</td></tr>
                            </tbody>
                        </table>
                        <div style="background: #dbeafe; border-left: 4px solid var(--accent-color); padding: 12px 16px; margin: 16px 0; border-radius: 0 8px 8px 0;">
                            <strong style="color: var(--accent-color);">Practical Note:</strong>
                            <span style="color: var(--text-color);">
                                Stainless steel bolts have high galling tendency and require anti-seize compound.
                                Never use dry stainless fasteners in critical applications&mdash;they can seize during tightening.
                            </span>
                        </div>
                    </div>

                    <!-- Section 4: Stiffness -->
                    <div id="bg-stiffness" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">4. Bolt and Joint Stiffness</h3>
                        <p style="margin-top: 12px;">
                            Understanding stiffness is crucial because it determines how external loads are shared between
                            the bolt and the clamped members. Both the bolt and joint act as springs in parallel.
                        </p>

                        <h4 style="margin-top: 20px; color: var(--secondary-color);">Bolt Stiffness (K<sub>b</sub>)</h4>
                        <p>The bolt stretches under tension like a spring. Its stiffness depends on cross-sectional area, length, and material:</p>
                        <div class="equation-card" style="margin: 12px 0;">
                            <strong>Simplified Bolt Stiffness</strong>
                            <span class="equation-expression">$$ K_b = \frac{A_s \cdot E}{L_{eff}} $$</span>
                            <ul>
                                <li><strong>A<sub>s</sub></strong> = Tensile stress area of the thread (smaller than nominal area due to thread roots)</li>
                                <li><strong>E</strong> = Elastic modulus of bolt material (~205 GPa for steel)</li>
                                <li><strong>L<sub>eff</sub></strong> = Effective grip length (includes contributions from head, shank, and engaged threads)</li>
                            </ul>
                        </div>
                        <p>
                            <strong>Typical values:</strong> For an M10 bolt with 25mm grip, K<sub>b</sub> &asymp; 400&ndash;600 MN/m.
                        </p>

                        <h4 style="margin-top: 20px; color: var(--secondary-color);">Joint Stiffness (K<sub>j</sub>)</h4>
                        <p>
                            The clamped members compress under the bolt preload. The compression zone is not uniform&mdash;it
                            spreads out in a barrel or frustum (cone) shape from the bolt head and nut.
                        </p>
                        <div class="equation-card" style="margin: 12px 0;">
                            <strong>Frustum Cone Model (VDI 2230)</strong>
                            <span class="equation-expression">$$ K_j = \frac{\pi \cdot E_j \cdot d \cdot \tan\alpha}{\ln\left[\frac{(D_w + d)(D_w - d + L\tan\alpha)}{(D_w - d)(D_w + d + L\tan\alpha)}\right]} $$</span>
                            <ul>
                                <li><strong>E<sub>j</sub></strong> = Elastic modulus of clamped material</li>
                                <li><strong>D<sub>w</sub></strong> = Washer or head bearing diameter</li>
                                <li><strong>&alpha;</strong> = Frustum half-angle (typically 30&deg;)</li>
                                <li><strong>L</strong> = Grip length</li>
                            </ul>
                        </div>
                        <p>
                            <strong>Key relationship:</strong> Joint stiffness is typically 3&ndash;10&times; higher than bolt stiffness for steel-on-steel joints.
                            This ratio is critical for determining the load factor.
                        </p>
                    </div>

                    <!-- Section 5: Load Factor -->
                    <div id="bg-loadfactor" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">5. Load Factor and Force Distribution</h3>
                        <p style="margin-top: 12px;">
                            The <strong>load factor</strong> (&phi;<sub>n</sub>) answers a critical question:
                            <em>"When an external tensile load is applied to the joint, how much of it goes into the bolt?"</em>
                        </p>
                        <div class="equation-card" style="margin: 16px 0;">
                            <strong>Load Factor</strong>
                            <span class="equation-expression">$$ \phi_n = \frac{K_b}{K_b + K_j} $$</span>
                            <p style="margin-top: 10px;">
                                Since K<sub>j</sub> >> K<sub>b</sub> typically, &phi;<sub>n</sub> is usually between 0.05 and 0.20.
                                This means <strong>only 5&ndash;20% of the external load adds to bolt tension</strong>.
                            </p>
                        </div>

                        <h4 style="margin-top: 20px; color: var(--secondary-color);">What happens when load is applied?</h4>
                        <p>Consider a preloaded joint with external tensile load F<sub>a</sub>:</p>
                        <div class="equation-card" style="margin: 12px 0;">
                            <strong>Bolt and Joint Forces Under Load</strong>
                            <span class="equation-expression">$$ F_{b} = F_i + \phi_n \cdot F_a $$</span>
                            <span class="equation-expression">$$ F_{j} = F_i - (1 - \phi_n) \cdot F_a $$</span>
                            <ul>
                                <li><strong>F<sub>b</sub></strong> = Bolt force (increases slightly under load)</li>
                                <li><strong>F<sub>j</sub></strong> = Clamping force (decreases under load)</li>
                                <li><strong>F<sub>i</sub></strong> = Initial preload</li>
                            </ul>
                        </div>
                        <div style="background: #d1fae5; border-left: 4px solid var(--success-color); padding: 12px 16px; margin: 16px 0; border-radius: 0 8px 8px 0;">
                            <strong style="color: var(--success-color);">Why This Matters for Fatigue:</strong>
                            <span style="color: var(--text-color);">
                                If &phi;<sub>n</sub> = 0.10, then a cyclic external load of &plusmn;10 kN causes only &plusmn;1 kN
                                variation in bolt force. The preload "absorbs" most of the load variation, dramatically
                                improving fatigue life. This is the primary reason to preload bolts.
                            </span>
                        </div>
                    </div>

                    <!-- Section 6: Embedding -->
                    <div id="bg-embedding" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">6. Embedding and Relaxation</h3>
                        <p style="margin-top: 12px;">
                            <strong>Embedding</strong> (also called settling or bedding-in) is the permanent flattening of
                            surface asperities at contact interfaces under sustained load. This causes preload loss.
                        </p>
                        <p>Embedding occurs at:</p>
                        <ul style="margin-left: 20px; color: var(--text-color);">
                            <li>Thread flanks (bolt-to-nut or bolt-to-tapped-hole)</li>
                            <li>Bolt head bearing surface</li>
                            <li>Nut bearing surface</li>
                            <li>Interfaces between clamped members</li>
                        </ul>
                        <p style="margin-top: 12px;"><strong>Factors affecting embedding:</strong></p>
                        <table style="width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: var(--primary-light);">
                                    <th style="padding: 10px; text-align: left; border: 1px solid var(--border-color);">Factor</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid var(--border-color);">Effect on Embedding</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td style="padding: 8px; border: 1px solid var(--border-color);">Surface roughness</td><td style="padding: 8px; border: 1px solid var(--border-color);">Rougher surfaces = more embedding (2&ndash;10 &mu;m per interface)</td></tr>
                                <tr style="background: #fafafa;"><td style="padding: 8px; border: 1px solid var(--border-color);">Bolt grade</td><td style="padding: 8px; border: 1px solid var(--border-color);">Higher strength = less embedding (harder surfaces)</td></tr>
                                <tr><td style="padding: 8px; border: 1px solid var(--border-color);">Number of interfaces</td><td style="padding: 8px; border: 1px solid var(--border-color);">Each interface adds embedding loss</td></tr>
                                <tr style="background: #fafafa;"><td style="padding: 8px; border: 1px solid var(--border-color);">Time under load</td><td style="padding: 8px; border: 1px solid var(--border-color);">Most embedding occurs in first few hours</td></tr>
                            </tbody>
                        </table>
                        <p style="margin-top: 12px;">
                            <strong>VDI 2230 guidance:</strong> Expect 2&ndash;3 &mu;m embedding per interface for machined surfaces,
                            5&ndash;10 &mu;m for as-rolled or cast surfaces. Re-torquing after initial settling can recover some preload.
                        </p>
                    </div>

                    <!-- Section 7: Safety Factors -->
                    <div id="bg-safety" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">7. Safety Factors Explained</h3>
                        <p style="margin-top: 12px;">
                            This calculator evaluates four distinct failure modes, each with its own safety factor:
                        </p>

                        <div style="background: var(--bg-color); border-radius: 8px; padding: 16px; margin: 16px 0;">
                            <h4 style="color: var(--primary-color); margin-bottom: 8px;">SF<sub>y</sub> &mdash; Yield Safety Factor</h4>
                            <span class="equation-expression">$$ SF_y = \frac{R_{p0.2} \cdot A_s}{F_{b,max}} $$</span>
                            <p style="margin-top: 8px;">
                                Compares the bolt's yield capacity to the maximum bolt force under load.
                                <strong>Target: SF<sub>y</sub> &ge; 1.2</strong> for static loads, &ge; 1.5 for dynamic.
                            </p>
                            <p><em>What it means:</em> If SF<sub>y</sub> &lt; 1.0, the bolt will plastically deform (yield) under maximum load.</p>
                        </div>

                        <div style="background: var(--bg-color); border-radius: 8px; padding: 16px; margin: 16px 0;">
                            <h4 style="color: var(--primary-color); margin-bottom: 8px;">SF<sub>k</sub> &mdash; Clamping Safety Factor</h4>
                            <span class="equation-expression">$$ SF_k = \frac{F_{j,min}}{F_{req}} $$</span>
                            <p style="margin-top: 8px;">
                                Compares minimum residual clamping force to required clamping.
                                <strong>Target: SF<sub>k</sub> &ge; 1.2</strong>.
                            </p>
                            <p><em>What it means:</em> If SF<sub>k</sub> &lt; 1.0, the joint may separate or lose friction grip under load.</p>
                        </div>

                        <div style="background: var(--bg-color); border-radius: 8px; padding: 16px; margin: 16px 0;">
                            <h4 style="color: var(--primary-color); margin-bottom: 8px;">SF<sub>D</sub> &mdash; Fatigue Safety Factor</h4>
                            <span class="equation-expression">$$ SF_D = \frac{\sigma_{A,endurance}}{\sigma_a} $$</span>
                            <p style="margin-top: 8px;">
                                Compares the bolt's fatigue endurance limit to the alternating stress amplitude.
                                <strong>Target: SF<sub>D</sub> &ge; 2.0</strong> for infinite life.
                            </p>
                            <p><em>What it means:</em> Low SF<sub>D</sub> indicates risk of fatigue crack initiation at thread roots.</p>
                        </div>

                        <div style="background: var(--bg-color); border-radius: 8px; padding: 16px; margin: 16px 0;">
                            <h4 style="color: var(--primary-color); margin-bottom: 8px;">SF<sub>G</sub> &mdash; Shear/Slip Safety Factor</h4>
                            <span class="equation-expression">$$ SF_G = \frac{\mu \cdot F_{j,min}}{F_{shear}} $$</span>
                            <p style="margin-top: 8px;">
                                Compares friction grip capacity to applied shear load.
                                <strong>Target: SF<sub>G</sub> &ge; 1.2</strong>.
                            </p>
                            <p><em>What it means:</em> If SF<sub>G</sub> &lt; 1.0, the joint may slip; consider adding dowels or more bolts.</p>
                        </div>
                    </div>

                    <!-- Section 8: Graph Interpretation -->
                    <div id="bg-graphs" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">8. How to Interpret the Graphs</h3>

                        <h4 style="margin-top: 20px; color: var(--secondary-color);">Joint Force-Extension Diagram (Triangular Format)</h4>
                        <p>
                            This classic diagram (also called a joint diagram, bolt diagram, or Bickford diagram) is the most important
                            visualization for understanding bolted joint behavior. It shows how preload is established and how
                            external loads are shared between the bolt and the clamped members.
                        </p>

                        <div style="background: var(--primary-light); padding: 16px; border-radius: 8px; margin: 12px 0;">
                            <p><strong>Understanding the Triangular Shape:</strong></p>
                            <p style="margin: 8px 0; color: var(--text-color);">
                                The diagram forms a characteristic triangle because both the bolt and joint act as springs.
                                When you tighten a bolt, you simultaneously stretch the bolt and compress the joint members.
                                At the preload point, these two "springs" are in equilibrium.
                            </p>
                        </div>

                        <div style="background: var(--bg-card); border: 1px solid var(--border-color); padding: 16px; border-radius: 8px; margin: 12px 0;">
                            <p><strong>Reading the Diagram Elements:</strong></p>
                            <ul style="margin-left: 20px; color: var(--text-color); line-height: 1.8;">
                                <li><strong style="color: #2563eb;">Blue line (Bolt stiffness K<sub>b</sub>):</strong> Starts at origin,
                                rises with slope equal to bolt stiffness. Shows how bolt force increases with extension.
                                A steeper line means a stiffer bolt.</li>
                                <li><strong style="color: #dc2626;">Red line (Joint stiffness K<sub>j</sub>):</strong> Starts at the preload point
                                and slopes downward to the right. This represents the joint "releasing" compression as external load is applied.
                                Where this line reaches zero force is the <em>separation point</em>.</li>
                                <li><strong style="color: #111827;">Black circle (F<sub>i</sub>):</strong> The preload point&mdash;where bolt and joint
                                lines meet. This is the equilibrium state immediately after tightening.</li>
                                <li><strong style="color: #2563eb;">Blue diamond (F<sub>b,max</sub>):</strong> Maximum bolt force under working load.
                                Located on the bolt line above the preload point.</li>
                                <li><strong style="color: #dc2626;">Red diamond (F<sub>j,min</sub>):</strong> Minimum clamping force under working load.
                                Located on the joint line below the preload point. <em>This must stay positive to maintain the clamp!</em></li>
                                <li><strong style="color: #fbbf24;">Yellow shaded triangle:</strong> The "working range" showing how load shifts
                                from preload to working state. The vertical edge shows &phi;&middot;F<sub>a</sub> (bolt pickup),
                                the sloped edge shows (1-&phi;)&middot;F<sub>a</sub> (joint relief).</li>
                                <li><strong style="color: #b91c1c;">X marker (Separation):</strong> The point where joint force reaches zero.
                                If external load exceeds the separation load, the joint opens and the bolt carries 100% of the load&mdash;a
                                dangerous condition that leads to fatigue failure.</li>
                            </ul>
                        </div>

                        <div style="background: var(--primary-light); padding: 16px; border-radius: 8px; margin: 12px 0;">
                            <p><strong>How External Load is Shared:</strong></p>
                            <p style="margin: 8px 0; color: var(--text-color);">
                                When external tensile load F<sub>a</sub> is applied to the joint:
                            </p>
                            <ul style="margin-left: 20px; color: var(--text-color);">
                                <li>The bolt force increases by <strong>&phi;&middot;F<sub>a</sub></strong> (shown as vertical green line)</li>
                                <li>The joint clamping force decreases by <strong>(1-&phi;)&middot;F<sub>a</sub></strong></li>
                                <li>The load factor &phi; = K<sub>b</sub>/(K<sub>b</sub>+K<sub>j</sub>) determines this split</li>
                            </ul>
                            <p style="margin-top: 12px; color: var(--text-color);">
                                <strong>Example:</strong> If &phi; = 0.15 (typical for stiff joints) and F<sub>a</sub> = 10 kN,
                                the bolt only "sees" 1.5 kN additional load while the joint absorbs 8.5 kN.
                                This is why preloaded joints are so effective&mdash;the stiff joint shields the bolt from most of the external load.
                            </p>
                        </div>

                        <div style="background: #fef2f2; border: 1px solid var(--danger-color); padding: 16px; border-radius: 8px; margin: 12px 0;">
                            <p><strong style="color: var(--danger-color);">Warning Signs to Watch For:</strong></p>
                            <ul style="margin-left: 20px; color: var(--text-color);">
                                <li><strong>F<sub>j,min</sub> near zero:</strong> Joint is close to separation. Increase preload or reduce external load.</li>
                                <li><strong>F<sub>b,max</sub> near yield:</strong> Bolt is close to yielding. Use higher strength grade or larger diameter.</li>
                                <li><strong>Large working triangle:</strong> Indicates high load factor &phi;&mdash;consider stiffer joint members.</li>
                                <li><strong>Shallow joint line:</strong> Low joint stiffness&mdash;may need larger clamped area or harder materials.</li>
                            </ul>
                        </div>

                        <div style="background: #ecfdf5; border: 1px solid var(--success-color); padding: 16px; border-radius: 8px; margin: 12px 0;">
                            <p><strong style="color: var(--success-color);">Design Goals for a Good Joint Diagram:</strong></p>
                            <ul style="margin-left: 20px; color: var(--text-color);">
                                <li>Working triangle should be small relative to the total preload</li>
                                <li>F<sub>j,min</sub> should be at least 10-20% of F<sub>i</sub> (adequate clamp margin)</li>
                                <li>F<sub>b,max</sub> should be below 90% of bolt yield capacity</li>
                                <li>Separation point should be far to the right of the working point</li>
                                <li>Joint stiffness line should be steeper than bolt stiffness line (K<sub>j</sub> > K<sub>b</sub>)</li>
                            </ul>
                        </div>

                        <h4 style="margin-top: 20px; color: var(--secondary-color);">Torque-Tension Curve</h4>
                        <p>
                            This graph shows how preload varies with applied torque for different K-factor values.
                        </p>
                        <div style="background: var(--primary-light); padding: 16px; border-radius: 8px; margin: 12px 0;">
                            <p><strong>How to read it:</strong></p>
                            <ul style="margin-left: 20px; color: var(--text-color);">
                                <li><strong>Center line (K<sub>typical</sub>):</strong> Expected preload for nominal K-factor.</li>
                                <li><strong>Upper dashed line (K<sub>min</sub>):</strong> Maximum preload if friction is at its lowest (risk of bolt yield).</li>
                                <li><strong>Lower dashed line (K<sub>max</sub>):</strong> Minimum preload if friction is at its highest (risk of insufficient clamp).</li>
                                <li><strong>Star marker:</strong> Your target operating point.</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Key insight:</strong> The spread between lines shows preload uncertainty.
                            Wider spread = less reliable joint. Controlled lubrication narrows the band.</p>
                        </div>

                        <h4 style="margin-top: 20px; color: var(--secondary-color);">K-Factor Sensitivity</h4>
                        <p>
                            This graph shows how achieved preload varies as K-factor changes, for a fixed torque.
                        </p>
                        <div style="background: var(--primary-light); padding: 16px; border-radius: 8px; margin: 12px 0;">
                            <p><strong>How to read it:</strong></p>
                            <ul style="margin-left: 20px; color: var(--text-color);">
                                <li><strong>Curve:</strong> Preload = T / (K &times; d). Hyperbolic relationship&mdash;preload drops rapidly as K increases.</li>
                                <li><strong>Target line:</strong> Your desired preload level.</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Key insight:</strong> A 20% increase in K-factor (e.g., from 0.15 to 0.18) causes
                            a 17% decrease in preload. This is why K-factor control is critical.</p>
                        </div>
                    </div>

                    <!-- Section 9: Worked Examples -->
                    <div id="bg-examples" style="margin-bottom: 32px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">9. Worked Examples</h3>

                        <div style="background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin: 16px 0;">
                            <h4 style="color: var(--primary-color);">Example 1: M10 Grade 8.8 Flange Connection</h4>
                            <p><strong>Given:</strong></p>
                            <ul style="margin-left: 20px; margin-bottom: 12px;">
                                <li>Bolt: M10&times;1.5, Grade 8.8</li>
                                <li>Grip length: 25 mm</li>
                                <li>Clamped material: Steel (E = 210 GPa)</li>
                                <li>Surface: Oiled (K = 0.15)</li>
                                <li>External tensile load: 5 kN per bolt</li>
                            </ul>
                            <p><strong>Solution:</strong></p>
                            <ol style="margin-left: 20px;">
                                <li>Stress area A<sub>s</sub> = 58 mm&sup2; (from ISO 262)</li>
                                <li>Proof strength R<sub>p0.2</sub> = 640 MPa (Grade 8.8)</li>
                                <li>Target preload F<sub>i</sub> = 0.9 &times; 640 &times; 58 = <strong>33.4 kN</strong></li>
                                <li>Assembly torque T = 0.15 &times; 0.010 &times; 33,400 = <strong>50.1 N-m</strong></li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>Result:</strong> Tighten to 50 N-m with oiled threads. Expected preload 33 kN.</p>
                        </div>

                        <div style="background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin: 16px 0;">
                            <h4 style="color: var(--primary-color);">Example 2: 1/2-13 UNC Grade 5 Structural Joint</h4>
                            <p><strong>Given:</strong></p>
                            <ul style="margin-left: 20px; margin-bottom: 12px;">
                                <li>Bolt: 1/2-13 UNC, SAE Grade 5</li>
                                <li>Grip length: 38 mm (1.5")</li>
                                <li>Clamped material: Steel</li>
                                <li>Surface: Oiled (K = 0.15)</li>
                                <li>External tensile load: 10 kN per bolt</li>
                            </ul>
                            <p><strong>Solution:</strong></p>
                            <ol style="margin-left: 20px;">
                                <li>Stress area A<sub>s</sub> = 84.3 mm&sup2; (from ASME B1.1)</li>
                                <li>Proof strength = 586 MPa (Grade 5 = 85 ksi)</li>
                                <li>Target preload F<sub>i</sub> = 0.9 &times; 586 &times; 84.3 = <strong>44.4 kN</strong></li>
                                <li>Assembly torque T = 0.15 &times; 0.0127 &times; 44,400 = <strong>84.6 N-m</strong> (62 lb-ft)</li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>Result:</strong> Tighten to 85 N-m (63 lb-ft). This matches published torque tables for Grade 5.</p>
                        </div>
                    </div>

                    <!-- Section 10: References -->
                    <div id="bg-references" style="margin-bottom: 16px;">
                        <h3 style="border-bottom: 2px solid var(--accent-color); padding-bottom: 8px;">10. References and Standards</h3>

                        <h4 style="margin-top: 16px; color: var(--secondary-color);">Primary Standards</h4>
                        <table style="width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 0.9rem;">
                            <tbody>
                                <tr style="background: var(--primary-light);">
                                    <td style="padding: 10px; border: 1px solid var(--border-color); font-weight: 600; width: 30%;">VDI 2230:2015</td>
                                    <td style="padding: 10px; border: 1px solid var(--border-color);">Systematic calculation of highly stressed bolted joints. The definitive German engineering guideline for bolted joint analysis.</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid var(--border-color); font-weight: 600;">ISO 898-1:2013</td>
                                    <td style="padding: 10px; border: 1px solid var(--border-color);">Mechanical properties of fasteners made of carbon steel and alloy steel. Defines property classes 4.6, 5.6, 8.8, 10.9, 12.9.</td>
                                </tr>
                                <tr style="background: var(--primary-light);">
                                    <td style="padding: 10px; border: 1px solid var(--border-color); font-weight: 600;">SAE J429</td>
                                    <td style="padding: 10px; border: 1px solid var(--border-color);">Mechanical and material requirements for externally threaded fasteners. Defines SAE Grades 1, 2, 5, 5.2, 8, 8.2.</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid var(--border-color); font-weight: 600;">ISO 262 / ISO 724</td>
                                    <td style="padding: 10px; border: 1px solid var(--border-color);">ISO general purpose metric screw threads. Defines thread geometry, stress areas, and tolerances.</td>
                                </tr>
                                <tr style="background: var(--primary-light);">
                                    <td style="padding: 10px; border: 1px solid var(--border-color); font-weight: 600;">ASME B1.1</td>
                                    <td style="padding: 10px; border: 1px solid var(--border-color);">Unified inch screw threads (UN, UNR, UNJ forms). The American standard for inch-based threads.</td>
                                </tr>
                            </tbody>
                        </table>

                        <h4 style="margin-top: 20px; color: var(--secondary-color);">Recommended Textbooks</h4>
                        <ul style="margin-left: 20px; color: var(--text-color);">
                            <li><strong>Bickford, J.H. (2007)</strong> &mdash; <em>Introduction to the Design and Behavior of Bolted Joints</em>, 4th Edition, CRC Press.
                                The most comprehensive English-language reference on bolted joints. Covers theory, analysis, and practical applications.</li>
                            <li style="margin-top: 8px;"><strong>Budynas &amp; Nisbett</strong> &mdash; <em>Shigley's Mechanical Engineering Design</em>, 11th Edition, Chapter 8.
                                Excellent undergraduate treatment of fastener design with worked examples.</li>
                            <li style="margin-top: 8px;"><strong>Machinery's Handbook</strong>, Industrial Press &mdash;
                                Contains torque tables, thread data, and material properties in a quick-reference format.</li>
                        </ul>

                        <h4 style="margin-top: 20px; color: var(--secondary-color);">ASTM Structural Bolt Standards</h4>
                        <ul style="margin-left: 20px; color: var(--text-color);">
                            <li><strong>ASTM F3125</strong> &mdash; Standard specification for high-strength structural bolts and assemblies (consolidates A325, A490, F1852, F2280)</li>
                            <li><strong>ASTM A354</strong> &mdash; Quenched and tempered alloy steel bolts, studs, and other externally threaded fasteners</li>
                            <li><strong>ASTM A449</strong> &mdash; Hex cap screws, bolts, and studs for general use</li>
                        </ul>

                        <div style="background: #dbeafe; border-left: 4px solid var(--accent-color); padding: 12px 16px; margin: 20px 0; border-radius: 0 8px 8px 0;">
                            <strong style="color: var(--accent-color);">Disclaimer:</strong>
                            <span style="color: var(--text-color);">
                                This calculator is for educational and preliminary design purposes. Critical applications
                                should be verified by qualified engineers using appropriate standards and testing. Always
                                consult the applicable codes and specifications for your industry (e.g., AISC for structural steel,
                                ASME for pressure vessels, SAE for automotive).
                            </span>
                        </div>
                    </div>

                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Engineering Tools. All calculations are for reference only.</p>
    </footer>

    <script>
        // === CONFIGURATION ===
        const TOOL_MODULE_NAME = 'fasteners_claude';
        const TOOL_FUNCTION_NAME = 'analyze_bolted_joint_claude';

        // Fastener databases for dynamic dropdowns
        const ISO_SIZES = [
            "M6x1.0", "M8x1.25", "M8x1.0", "M10x1.5", "M10x1.25", "M10x1.0",
            "M12x1.75", "M12x1.5", "M12x1.25", "M14x2.0", "M16x2.0", "M16x1.5",
            "M18x2.5", "M20x2.5", "M20x1.5", "M22x2.5", "M24x3.0"
        ];
        const UTS_SIZES = [
            "#6-32 UNC", "#8-32 UNC", "#10-24 UNC", "#10-32 UNF",
            "1/4-20 UNC", "1/4-28 UNF", "5/16-18 UNC", "5/16-24 UNF",
            "3/8-16 UNC", "3/8-24 UNF", "7/16-14 UNC", "1/2-13 UNC", "1/2-20 UNF",
            "9/16-12 UNC", "5/8-11 UNC", "5/8-18 UNF", "3/4-10 UNC", "3/4-16 UNF",
            "7/8-9 UNC", "1-8 UNC", "1-12 UNF"
        ];
        const ISO_GRADES = ["4.6", "5.6", "8.8", "10.9", "12.9"];
        const SAE_GRADES = ["SAE Grade 2", "SAE Grade 5", "SAE Grade 8", "ASTM A325", "ASTM A490"];

        let pyToolModule = null;

        // === TAB LOGIC ===
        function openTab(event, tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.style.display = "none");
            document.querySelectorAll(".tab-link").forEach(link => link.classList.remove("active"));
            document.getElementById(tabName).style.display = "block";
            event.currentTarget.classList.add("active");
        }

        function typesetMath() {
            if (window.MathJax) { window.MathJax.typesetPromise(); }
        }

        // === DYNAMIC DROPDOWNS ===
        function updateFastenerOptions() {
            const standard = document.getElementById('fastener_standard').value;
            const sizeSelect = document.getElementById('fastener_size');
            const gradeSelect = document.getElementById('bolt_grade');

            sizeSelect.innerHTML = '';
            gradeSelect.innerHTML = '';

            const sizes = standard === 'ISO' ? ISO_SIZES : UTS_SIZES;
            const grades = standard === 'ISO' ? ISO_GRADES : SAE_GRADES;

            sizes.forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            });

            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });

            // Default selections
            if (standard === 'ISO') {
                sizeSelect.value = 'M10x1.5';
                gradeSelect.value = '8.8';
            } else {
                sizeSelect.value = '1/2-13 UNC';
                gradeSelect.value = 'SAE Grade 5';
            }
        }

        // === INPUT TAB SWITCHING ===
        const inputTabs = document.querySelectorAll('.input-tab');
        const inputSections = document.querySelectorAll('.input-section');

        inputTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.dataset.target;
                inputTabs.forEach(btn => btn.classList.toggle('active', btn === tab));
                inputSections.forEach(section => {
                    section.classList.toggle('active', section.id === targetId);
                });
            });
        });

        // === CUSTOM MODULUS TOGGLE ===
        document.getElementById('clamped_material').addEventListener('change', function() {
            const customGroup = document.getElementById('custom-modulus-group');
            customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // === PYODIDE INITIALIZATION ===
        async function main() {
            const loadingText = document.getElementById('loading-text');

            try {
                loadingText.textContent = 'Loading Pyodide...';
                let pyodide = await loadPyodide();
                await pyodide.loadPackage("micropip");

                loadingText.textContent = 'Loading Python modules...';
                await pyodide.runPythonAsync(`
                    from pyodide.http import pyfetch

                    # Fetch the fasteners module
                    response = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
                    with open('${TOOL_MODULE_NAME}.py', 'w') as f:
                        f.write(await response.string())

                    import ${TOOL_MODULE_NAME}
                `);

                pyToolModule = pyodide.globals.get(TOOL_MODULE_NAME);

                // Initialize dropdowns
                updateFastenerOptions();
                document.getElementById('fastener_standard').addEventListener('change', updateFastenerOptions);

                // Hide loading overlay
                document.getElementById('loading-overlay').classList.add('hidden');

                // Initial math typeset
                typesetMath();

            } catch (error) {
                loadingText.textContent = 'Error loading: ' + error.message;
                console.error('Initialization error:', error);
            }
        }
        main();

        // === RESULTS RENDERING ===
        function renderResults(results) {
            const resultsDiv = document.getElementById('results-display');

            // Format numbers nicely
            const fmt = (val, dec=1) => {
                if (typeof val !== 'number' || !isFinite(val)) return 'N/A';
                if (Math.abs(val) >= 1e6) return (val/1e6).toFixed(dec) + ' M';
                if (Math.abs(val) >= 1e3) return (val/1e3).toFixed(dec) + ' k';
                return val.toFixed(dec);
            };

            // Primary results
            let html = `
                <div class="results-grid">
                    <div class="result-card highlight">
                        <div class="label">Assembly Torque</div>
                        <div class="value">${fmt(results.assembly_torque, 1)}<span class="unit">N-m</span></div>
                        <div class="range">${fmt(results.torque_range_low, 1)} - ${fmt(results.torque_range_high, 1)} N-m</div>
                    </div>
                    <div class="result-card highlight">
                        <div class="label">Target Preload</div>
                        <div class="value">${fmt(results.target_preload/1000, 1)}<span class="unit">kN</span></div>
                        <div class="range">Min: ${fmt(results.minimum_preload/1000, 1)} kN</div>
                    </div>
                    <div class="result-card">
                        <div class="label">K-Factor</div>
                        <div class="value">${results.k_factor.toFixed(3)}</div>
                        <div class="range">${results.k_factor_min.toFixed(2)} - ${results.k_factor_max.toFixed(2)}</div>
                    </div>
                    <div class="result-card">
                        <div class="label">Load Factor (phi)</div>
                        <div class="value">${results.load_factor.toFixed(3)}</div>
                        <div class="range">Bolt takes ${(results.load_factor*100).toFixed(0)}% of load</div>
                    </div>
                </div>

                <div class="results-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="result-card">
                        <div class="label">Bolt Stiffness</div>
                        <div class="value">${fmt(results.bolt_stiffness/1e6, 0)}<span class="unit">MN/m</span></div>
                    </div>
                    <div class="result-card">
                        <div class="label">Joint Stiffness</div>
                        <div class="value">${fmt(results.joint_stiffness/1e6, 0)}<span class="unit">MN/m</span></div>
                    </div>
                    <div class="result-card">
                        <div class="label">Embedding Loss</div>
                        <div class="value">${fmt(results.embedding_loss/1000, 2)}<span class="unit">kN</span></div>
                    </div>
                </div>
            `;

            // Safety gauges
            const gaugeClass = (sf) => sf >= 1.5 ? 'success' : sf >= 1.0 ? 'warning' : 'danger';
            const gaugeWidth = (sf) => Math.min(100, Math.max(0, sf / 3.0 * 100));

            html += `
                <div class="safety-section">
                    <h4>Safety Factors</h4>
                    <div class="safety-gauge">
                        <span class="gauge-label">Yield (SF<sub>y</sub>)</span>
                        <div class="gauge-bar-container">
                            <div class="gauge-bar ${gaugeClass(results.safety_factor_yield)}" style="width: ${gaugeWidth(results.safety_factor_yield)}%"></div>
                            <div class="gauge-threshold" style="left: 33.3%"></div>
                            <div class="gauge-threshold" style="left: 50%"></div>
                        </div>
                        <span class="gauge-value ${gaugeClass(results.safety_factor_yield)}">${results.safety_factor_yield.toFixed(2)}</span>
                    </div>
                    <div class="safety-gauge">
                        <span class="gauge-label">Clamp (SF<sub>k</sub>)</span>
                        <div class="gauge-bar-container">
                            <div class="gauge-bar ${gaugeClass(results.safety_factor_clamp)}" style="width: ${gaugeWidth(results.safety_factor_clamp)}%"></div>
                            <div class="gauge-threshold" style="left: 33.3%"></div>
                            <div class="gauge-threshold" style="left: 50%"></div>
                        </div>
                        <span class="gauge-value ${gaugeClass(results.safety_factor_clamp)}">${results.safety_factor_clamp.toFixed(2)}</span>
                    </div>
                    <div class="safety-gauge">
                        <span class="gauge-label">Fatigue (SF<sub>D</sub>)</span>
                        <div class="gauge-bar-container">
                            <div class="gauge-bar ${gaugeClass(results.safety_factor_fatigue)}" style="width: ${gaugeWidth(results.safety_factor_fatigue)}%"></div>
                            <div class="gauge-threshold" style="left: 33.3%"></div>
                            <div class="gauge-threshold" style="left: 50%"></div>
                        </div>
                        <span class="gauge-value ${gaugeClass(results.safety_factor_fatigue)}">${isFinite(results.safety_factor_fatigue) ? results.safety_factor_fatigue.toFixed(2) : '>10'}</span>
                    </div>
                    <div class="safety-gauge">
                        <span class="gauge-label">Shear Slip (SF<sub>G</sub>)</span>
                        <div class="gauge-bar-container">
                            <div class="gauge-bar ${gaugeClass(results.safety_factor_shear)}" style="width: ${gaugeWidth(results.safety_factor_shear)}%"></div>
                            <div class="gauge-threshold" style="left: 33.3%"></div>
                            <div class="gauge-threshold" style="left: 50%"></div>
                        </div>
                        <span class="gauge-value ${gaugeClass(results.safety_factor_shear)}">${isFinite(results.safety_factor_shear) ? results.safety_factor_shear.toFixed(2) : '>10'}</span>
                    </div>
                </div>
            `;

            // Status banner
            const statusIcons = { acceptable: '&#10004;', marginal: '&#9888;', unacceptable: '&#10006;' };
            const statusTitles = { acceptable: 'Joint Design Acceptable', marginal: 'Marginal - Review Required', unacceptable: 'Unacceptable - Redesign Needed' };

            html += `
                <div class="status-banner ${results.status}">
                    <span class="icon">${statusIcons[results.status]}</span>
                    <div class="content">
                        <h4>${statusTitles[results.status]}</h4>
                        <p>Minimum safety factor: ${Math.min(results.safety_factor_yield, results.safety_factor_clamp, results.safety_factor_fatigue, results.safety_factor_shear).toFixed(2)}</p>
                        ${results.recommendations.length > 0 ? `
                            <ul class="recommendations">
                                ${results.recommendations.map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
            typesetMath();
        }

        // === CHART RENDERING ===
        function renderCharts(results) {
            // Joint Diagram - Classic Triangular Format (VDI 2230 / Bickford)
            const jd = results.joint_diagram_data;
            const jointTraces = [
                // Bolt stiffness line (from origin through preload point)
                {
                    x: jd.bolt_extension.map(x => x * 1000),
                    y: jd.bolt_force.map(f => f / 1000),
                    mode: 'lines',
                    name: 'Bolt stiffness (Kb)',
                    line: { color: '#2563eb', width: 3 },
                    hovertemplate: ' = %{x:.3f} mm<br>F = %{y:.1f} kN<extra></extra>'
                },
                // Joint stiffness line (from preload point toward separation)
                {
                    x: jd.joint_x.map(x => x * 1000),
                    y: jd.joint_force.map(f => f / 1000),
                    mode: 'lines',
                    name: 'Joint stiffness (Kj)',
                    line: { color: '#dc2626', width: 3 },
                    hovertemplate: ' = %{x:.3f} mm<br>F = %{y:.1f} kN<extra></extra>'
                },
                // Working triangle (filled region showing load distribution)
                {
                    x: jd.triangle_x.map(x => x * 1000),
                    y: jd.triangle_f.map(f => f / 1000),
                    mode: 'lines',
                    name: 'Working range',
                    fill: 'toself',
                    fillcolor: 'rgba(251, 191, 36, 0.15)',
                    line: { color: 'rgba(251, 191, 36, 0.6)', width: 2, dash: 'dot' },
                    hoverinfo: 'skip'
                },
                // Vertical delta Fb line
                {
                    x: jd.delta_fb_x.map(x => x * 1000),
                    y: jd.delta_fb_y.map(f => f / 1000),
                    mode: 'lines',
                    name: 'Fb (bolt pickup)',
                    line: { color: '#059669', width: 2 },
                    hoverinfo: 'skip'
                },
                // Horizontal working line
                {
                    x: jd.working_line_x.map(x => x * 1000),
                    y: jd.working_line_y.map(f => f / 1000),
                    mode: 'lines',
                    name: 'Working line',
                    line: { color: '#6b7280', width: 1, dash: 'dash' },
                    showlegend: false,
                    hoverinfo: 'skip'
                },
                // Preload point (Fi)
                {
                    x: [jd.preload_extension * 1000],
                    y: [jd.preload_force / 1000],
                    mode: 'markers+text',
                    name: 'Preload (Fi)',
                    marker: { size: 14, color: '#111827', symbol: 'circle' },
                    text: [`Fi = ${(jd.preload_force/1000).toFixed(1)} kN`],
                    textposition: 'top left',
                    textfont: { size: 11, color: '#111827', family: 'monospace' }
                },
                // Max bolt force point (Fb,max)
                {
                    x: [jd.work_bolt_extension * 1000],
                    y: [jd.work_bolt_force / 1000],
                    mode: 'markers+text',
                    name: 'Max bolt (Fb,max)',
                    marker: { size: 12, color: '#2563eb', symbol: 'diamond' },
                    text: [`Fb,max = ${(jd.work_bolt_force/1000).toFixed(1)} kN`],
                    textposition: 'top right',
                    textfont: { size: 11, color: '#2563eb', family: 'monospace' }
                },
                // Min clamp force point (Fj,min)
                {
                    x: [jd.work_x * 1000],
                    y: [jd.work_joint_force / 1000],
                    mode: 'markers+text',
                    name: 'Min clamp (Fj,min)',
                    marker: { size: 12, color: '#dc2626', symbol: 'diamond' },
                    text: [`Fj,min = ${(jd.work_joint_force/1000).toFixed(1)} kN`],
                    textposition: 'bottom right',
                    textfont: { size: 11, color: '#dc2626', family: 'monospace' }
                },
                // Separation point marker
                {
                    x: [jd.separation_extension * 1000],
                    y: [0],
                    mode: 'markers+text',
                    name: 'Separation',
                    marker: { size: 10, color: '#b91c1c', symbol: 'x' },
                    text: ['Separation'],
                    textposition: 'top center',
                    textfont: { size: 10, color: '#b91c1c' }
                }
            ];

            const jointLayout = {
                title: { text: 'Joint Diagram (VDI 2230)', font: { size: 16, color: '#111827' } },
                xaxis: {
                    title: { text: 'Deformation  (mm)', font: { size: 12 } },
                    zeroline: true,
                    zerolinecolor: '#9ca3af',
                    zerolinewidth: 1,
                    gridcolor: '#e5e7eb',
                    range: [0, jd.separation_extension * 1000 * 1.1]
                },
                yaxis: {
                    title: { text: 'Force F (kN)', font: { size: 12 } },
                    zeroline: true,
                    zerolinecolor: '#9ca3af',
                    zerolinewidth: 1,
                    gridcolor: '#e5e7eb',
                    rangemode: 'tozero'
                },
                legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(255,255,255,0.9)', font: { size: 10 } },
                margin: { t: 50, r: 30, b: 60, l: 60 },
                hovermode: 'closest',
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                annotations: [
                    {
                        x: (jd.preload_extension + jd.work_bolt_extension) / 2 * 1000,
                        y: (jd.preload_force + jd.work_bolt_force) / 2 / 1000,
                        text: `Fa`,
                        showarrow: false,
                        font: { size: 10, color: '#059669' },
                        xanchor: 'right',
                        yanchor: 'middle'
                    },
                    {
                        x: (jd.preload_extension + jd.work_x) / 2 * 1000,
                        y: (jd.preload_force + jd.work_joint_force) / 2 / 1000,
                        text: `(1-)Fa`,
                        showarrow: false,
                        font: { size: 10, color: '#dc2626' },
                        xanchor: 'left',
                        yanchor: 'middle'
                    }
                ]
            };

            Plotly.newPlot('joint-diagram-plot', jointTraces, jointLayout, { responsive: true });

            // Torque-Tension Curve
            const tt = results.torque_tension_data;
            const ttTraces = [
                {
                    x: tt.torque_at_k_min.map(t => t),
                    y: tt.preload.map(f => f / 1000),
                    mode: 'lines',
                    name: `K = ${tt.k_min.toFixed(2)} (max preload)`,
                    line: { color: '#dc2626', width: 2, dash: 'dash' }
                },
                {
                    x: tt.torque_at_k_typ.map(t => t),
                    y: tt.preload.map(f => f / 1000),
                    mode: 'lines',
                    name: `K = ${tt.k_typ.toFixed(2)} (typical)`,
                    line: { color: '#2563eb', width: 3 }
                },
                {
                    x: tt.torque_at_k_max.map(t => t),
                    y: tt.preload.map(f => f / 1000),
                    mode: 'lines',
                    name: `K = ${tt.k_max.toFixed(2)} (min preload)`,
                    line: { color: '#059669', width: 2, dash: 'dash' }
                },
                {
                    x: [results.assembly_torque],
                    y: [results.target_preload / 1000],
                    mode: 'markers',
                    name: 'Target',
                    marker: { size: 14, color: '#f59e0b', symbol: 'star' }
                }
            ];

            const ttLayout = {
                title: { text: 'Torque-Tension Relationship', font: { size: 14 } },
                xaxis: { title: 'Torque (N-m)' },
                yaxis: { title: 'Preload (kN)' },
                legend: { x: 0.02, y: 0.98, font: { size: 10 } },
                margin: { t: 40, r: 20, b: 50, l: 50 },
                plot_bgcolor: '#fafafa'
            };

            Plotly.newPlot('torque-tension-plot', ttTraces, ttLayout, { responsive: true });

            // K-Factor Sensitivity
            const ks = results.k_sensitivity_data;
            const ksTraces = [
                {
                    x: ks.k_values,
                    y: ks.preload_achieved.map(f => f / 1000),
                    mode: 'lines+markers',
                    name: 'Achieved Preload',
                    line: { color: '#2563eb', width: 2 },
                    marker: { size: 6 }
                },
                {
                    x: [ks.k_values[0], ks.k_values[ks.k_values.length - 1]],
                    y: [results.target_preload / 1000, results.target_preload / 1000],
                    mode: 'lines',
                    name: 'Target Preload',
                    line: { color: '#059669', width: 2, dash: 'dot' }
                }
            ];

            const ksLayout = {
                title: { text: 'Preload Sensitivity to K-Factor', font: { size: 14 } },
                xaxis: { title: 'Nut Factor K' },
                yaxis: { title: 'Preload (kN)' },
                legend: { x: 0.6, y: 0.98, font: { size: 10 } },
                margin: { t: 40, r: 20, b: 50, l: 50 },
                plot_bgcolor: '#fafafa',
                annotations: [{
                    x: results.k_factor,
                    y: results.target_preload / 1000,
                    xref: 'x',
                    yref: 'y',
                    text: 'Design Point',
                    showarrow: true,
                    arrowhead: 2,
                    ax: 40,
                    ay: -30
                }]
            };

            Plotly.newPlot('k-sensitivity-plot', ksTraces, ksLayout, { responsive: true });
        }

        // === FORM SUBMISSION ===
        document.getElementById('calc-form').addEventListener('submit', function(event) {
            event.preventDefault();

            // Gather inputs
            const fastenerSize = document.getElementById('fastener_size').value;
            const boltGrade = document.getElementById('bolt_grade').value;
            const gripLength = parseFloat(document.getElementById('grip_length').value) / 1000; // mm to m

            let clampedModulus = document.getElementById('clamped_material').value;
            if (clampedModulus === 'custom') {
                clampedModulus = parseFloat(document.getElementById('custom_modulus').value) * 1e9;
            } else {
                clampedModulus = parseFloat(clampedModulus);
            }

            const externalAxialLoad = parseFloat(document.getElementById('external_axial_load').value);
            const externalShearLoad = parseFloat(document.getElementById('external_shear_load').value);
            const tighteningMethod = document.getElementById('tightening_method').value;
            const surfaceCondition = document.getElementById('surface_condition').value;
            const temperature = parseFloat(document.getElementById('temperature').value);
            const nBolts = parseInt(document.getElementById('n_bolts').value);
            const jointType = document.getElementById('joint_type').value;
            const embeddingRoughness = document.getElementById('embedding_surface_roughness').value;

            try {
                // Call Python function
                const resultProxy = pyToolModule[TOOL_FUNCTION_NAME](
                    fastenerSize,
                    boltGrade,
                    gripLength,
                    clampedModulus,
                    externalAxialLoad,
                    externalShearLoad,
                    tighteningMethod,
                    surfaceCondition,
                    temperature,
                    nBolts,
                    jointType,
                    embeddingRoughness
                );

                // Convert Python dict to JS object
                const resultMap = resultProxy.toJs();
                const results = {};

                for (const [key, value] of resultMap) {
                    if (value instanceof Map) {
                        // Convert nested Maps to objects
                        const nestedObj = {};
                        for (const [k, v] of value) {
                            if (v instanceof Array || Array.isArray(v)) {
                                nestedObj[k] = Array.from(v);
                            } else {
                                nestedObj[k] = v;
                            }
                        }
                        results[key] = nestedObj;
                    } else if (value instanceof Array || Array.isArray(value)) {
                        results[key] = Array.from(value);
                    } else {
                        results[key] = value;
                    }
                }

                // Handle recommendations array
                if (resultMap.has('recommendations')) {
                    results.recommendations = Array.from(resultMap.get('recommendations'));
                }

                // Handle nested data structures
                ['joint_diagram_data', 'torque_tension_data', 'k_sensitivity_data'].forEach(key => {
                    if (resultMap.has(key)) {
                        const dataMap = resultMap.get(key);
                        results[key] = {};
                        for (const [k, v] of dataMap) {
                            results[key][k] = Array.isArray(v) ? Array.from(v) : v;
                        }
                    }
                });

                // Render results and charts
                renderResults(results);
                renderCharts(results);

            } catch (error) {
                console.error('Calculation error:', error);
                document.getElementById('results-display').innerHTML = `
                    <div class="status-banner unacceptable">
                        <span class="icon">&#10006;</span>
                        <div class="content">
                            <h4>Calculation Error</h4>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>

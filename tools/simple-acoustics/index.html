<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sound Level Calculator (SPL/SWL)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
      color: #212529;
      line-height: 1.6;
    }
    
    header, footer {
      background: #343a40;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    
    h1 {
      margin: 0;
      font-size: 1.75rem;
    }
    
    main {
      max-width: 1200px;
      margin: 1rem auto;
      background: #fff;
      border-radius: 5px;
      padding: 1rem 2rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    details {
      margin-bottom: 1rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #dee2e6;
    }
    
    summary {
      cursor: pointer;
      font-size: 1.2rem;
      font-weight: bold;
      color: #495057;
      outline: none;
      margin-bottom: 0.5rem;
    }
    
    label {
      display: inline-block;
      width: 220px;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    
    input, select {
      width: 120px;
      margin-bottom: 0.5rem;
      padding: 0.3rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    
    button {
      display: inline-block;
      margin-top: 1rem;
      margin-right: 0.5rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    .charts-container {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: space-around;
      margin-top: 1rem;
    }
    
    .chart-box {
      flex: 1 1 450px;
      min-width: 300px;
      max-width: 100%;
      margin-bottom: 2rem;
    }
    
    .chart-box canvas {
      width: 100%;
      max-height: 400px;
    }
    
    .chart-title {
      text-align: center;
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    
    .results-panel {
      background: #f1f8ff;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    
    .math-formula {
      font-family: 'Times New Roman', Times, serif;
      background: #f8f9fa;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-left: 3px solid #007bff;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    
    table, th, td {
      border: 1px solid #dee2e6;
    }
    
    th, td {
      padding: 0.5rem;
      text-align: left;
    }
    
    th {
      background-color: #f8f9fa;
    }
    
    @media (max-width: 768px) {
      label {
        width: 100%;
        display: block;
      }
      
      input, select {
        width: 100%;
      }
      
      .chart-box {
        flex: 1 1 100%;
      }
    }
    
    .reference {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 0.5rem;
    }
    
    .tab-container {
      margin: 1rem 0;
    }
    
    .tab-buttons {
      display: flex;
      overflow-x: auto;
    }
    
    .tab-button {
      background: #f1f1f1;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 0.5rem 1rem;
      margin-right: 0.2rem;
      font-size: 0.9rem;
      border-radius: 4px 4px 0 0;
    }
    
    .tab-button:hover {
      background: #ddd;
    }
    
    .tab-button.active {
      background: #007bff;
      color: white;
    }
    
    .tab-content {
      display: none;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 0 4px 4px 4px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1rem;
    }
    
    .grid-item {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <header>
    <h1>Sound Level Calculator (SPL/SWL)</h1>
  </header>

  <main>
    <!-- TABS NAVIGATION -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab(event, 'calculator')">Calculator</button>
        <button class="tab-button" onclick="openTab(event, 'theory')">Theory</button>
        <button class="tab-button" onclick="openTab(event, 'references')">References</button>
      </div>
      
      <!-- CALCULATOR TAB -->
      <div id="calculator" class="tab-content active">
        <details open>
          <summary>1) Source Properties</summary>
          <div class="grid-container">
            <div class="grid-item">
              <label for="sourceType">Source Type:</label>
              <select id="sourceType">
                <option value="point">Point Source</option>
                <option value="line">Line Source</option>
                <option value="plane">Plane Source</option>
              </select>
              
              <div id="sourceInputContainer">
                <label for="sourceLevel">Source Sound Power Level (SWL):</label>
                <input type="number" id="sourceLevel" value="100" step="1"> dB
              </div>
              
              <label for="frequency">Frequency:</label>
              <select id="frequency">
                <option value="broadband">Broadband</option>
                <option value="63">63 Hz</option>
                <option value="125">125 Hz</option>
                <option value="250">250 Hz</option>
                <option value="500">500 Hz</option>
                <option value="1000">1000 Hz</option>
                <option value="2000">2000 Hz</option>
                <option value="4000">4000 Hz</option>
                <option value="8000">8000 Hz</option>
              </select>
            </div>
            
            <div class="grid-item">
              <label for="weighting">Weighting:</label>
              <select id="weighting">
                <option value="Z">Z (None)</option>
                <option value="A" selected>A</option>
                <option value="C">C</option>
              </select>
              
              <div id="sourcePresets">
                <label>Presets:</label>
                <select id="sourcePresetSelect">
                  <option value="custom">Custom</option>
                  <option value="conversation">Normal conversation (65 dB)</option>
                  <option value="vacuum">Vacuum cleaner (75 dB)</option>
                  <option value="lawnmower">Lawn mower (90 dB)</option>
                  <option value="concert">Rock concert (110 dB)</option>
                  <option value="jetEngine">Jet engine (140 dB)</option>
                </select>
                <button id="applyPresetBtn">Apply</button>
              </div>
              
              <div id="directivity">
                <label for="dirFactor">Directivity Factor (Q):</label>
                <select id="dirFactor">
                  <option value="1">Spherical - Free field (Q=1)</option>
                  <option value="2" selected>Hemispherical - On ground/wall (Q=2)</option>
                  <option value="4">Quarter sphere - Wall corner (Q=4)</option>
                  <option value="8">Eighth sphere - Floor-wall corner (Q=8)</option>
                </select>
              </div>
            </div>
          </div>
        </details>
        
        <details open>
          <summary>2) Propagation</summary>
          <div class="grid-container">
            <div class="grid-item">
              <label for="distanceMin">Distance (min):</label>
              <input type="number" id="distanceMin" value="1" min="0.1" step="0.1"> m
              
              <label for="distanceMax">Distance (max):</label>
              <input type="number" id="distanceMax" value="100" min="1" step="1"> m
              
              <label for="tempC">Temperature:</label>
              <input type="number" id="tempC" value="20" min="-50" max="50"> Â°C
              
              <label for="humidity">Relative Humidity:</label>
              <input type="number" id="humidity" value="60" min="0" max="100"> %
            </div>
            
            <div class="grid-item">
              <label for="groundAbsorption">Ground Absorption:</label>
              <select id="groundAbsorption">
                <option value="0">Hard (0)</option>
                <option value="0.5" selected>Mixed (0.5)</option>
                <option value="1">Soft (1)</option>
              </select>
              
              <label for="airAttenuationEnabled">Air Attenuation:</label>
              <input type="checkbox" id="airAttenuationEnabled" checked style="width: auto;">
              
              <label for="barriers">Number of Barriers:</label>
              <input type="number" id="barriers" value="0" min="0" max="5" step="1">
              
              <label for="barrierAttenuation">Barrier Attenuation (each):</label>
              <input type="number" id="barrierAttenuation" value="5" min="0" max="25" step="1"> dB
            </div>
          </div>
          
          <button id="calculateBtn">Calculate</button>
          <button id="resetBtn">Reset to Defaults</button>
        </details>
        
        <details open>
          <summary>3) Results</summary>
          <div class="results-panel" id="resultsContainer">
            <div id="singlePointResult">
              <h3>Sound Level at 1m:</h3>
              <p id="spl1m">-</p>
              <p id="splWeighted1m">-</p>
            </div>
          </div>
          
          <div class="charts-container">
            <div class="chart-box">
              <div class="chart-title">SPL vs. Distance</div>
              <canvas id="distanceChart"></canvas>
            </div>
            
            <div class="chart-box">
              <div class="chart-title">Equal Loudness Contours</div>
              <canvas id="loudnessChart"></canvas>
            </div>
          </div>
        </details>
      </div>
      
      <!-- THEORY TAB -->
      <div id="theory" class="tab-content">
        <h2>Sound Pressure and Power Level Calculations</h2>
        
        <h3>Basic Definitions</h3>
        <p>
          <strong>Sound Pressure Level (SPL)</strong> is the local pressure deviation from ambient atmospheric pressure caused by a sound wave, measured in decibels (dB).
        </p>
        <div class="math-formula">
          SPL = 20 Ã logââ(p/pâ) dB
        </div>
        <p>where p is the sound pressure and pâ is the reference pressure of 20 ÂµPa (the threshold of human hearing).</p>
        
        <p>
          <strong>Sound Power Level (SWL)</strong> is the total acoustic power emitted by a sound source, measured in decibels (dB).
        </p>
        <div class="math-formula">
          SWL = 10 Ã logââ(W/Wâ) dB
        </div>
        <p>where W is the sound power and Wâ is the reference power of 10â»Â¹Â² watts.</p>
        
        <h3>Propagation Models</h3>
        
        <h4>Point Source (Spherical Spreading)</h4>
        <p>For point sources, sound pressure decreases with the inverse of distance:</p>
        <div class="math-formula">
          SPL = SWL - 20 Ã logââ(r) - 11 + 10 Ã logââ(Q) dB
        </div>
        <p>where r is distance in meters and Q is the directivity factor.</p>
        
        <h4>Line Source</h4>
        <p>For line sources, sound pressure decreases with the inverse square root of distance:</p>
        <div class="math-formula">
          SPL = SWL - 10 Ã logââ(r) - 8 dB
        </div>
        
        <h4>Plane Source</h4>
        <p>For plane sources (very close to a large radiating surface), SPL remains nearly constant with distance:</p>
        <div class="math-formula">
          SPL = SWL - 10 Ã logââ(S) + 6 dB
        </div>
        <p>where S is the surface area in mÂ².</p>
        
        <h3>Frequency Weighting</h3>
        <p>
          Frequency weighting adjusts sound measurements to reflect how the human ear perceives different frequencies:
        </p>
        <ul>
          <li><strong>A-weighting (dBA)</strong>: Emphasizes frequencies 500 Hz to 10 kHz, most used for environmental and occupational noise</li>
          <li><strong>C-weighting (dBC)</strong>: Nearly flat response, used for peak measurements and low-frequency noise</li>
          <li><strong>Z-weighting (dBZ)</strong>: No weighting, flat frequency response</li>
        </ul>
        
        <h3>Directivity Factor (Q)</h3>
        <p>
          The directivity factor accounts for reflective surfaces near the source:
        </p>
        <ul>
          <li>Q = 1: Free field (spherical radiation)</li>
          <li>Q = 2: Hemispherical radiation (source on reflective surface)</li>
          <li>Q = 4: Quarter sphere (source at wall corner)</li>
          <li>Q = 8: Eighth sphere (source at floor-wall corner)</li>
        </ul>
        
        <h3>Environmental Factors</h3>
        <p>
          <strong>Air Absorption</strong> increases with:
        </p>
        <ul>
          <li>Higher frequencies</li>
          <li>Lower humidity</li>
          <li>Longer distances</li>
        </ul>
        
        <p>
          <strong>Ground Effect</strong> depends on:
        </p>
        <ul>
          <li>Source and receiver heights</li>
          <li>Ground properties (hard/soft surfaces)</li>
          <li>Frequency (stronger at low frequencies)</li>
        </ul>
        
        <h3>Equal Loudness Contours</h3>
        <p>
          Equal loudness contours (phon curves) show sound pressure levels that are perceived as equally loud across different frequencies. The unit of loudness is the phon, which equals the SPL in dB at 1000 Hz.
        </p>
      </div>
      
      <!-- REFERENCES TAB -->
      <div id="references" class="tab-content">
        <h2>References and Further Reading</h2>
        
        <h3>Standards</h3>
        <ul>
          <li>ISO 9613-2: "Acoustics â Attenuation of sound during propagation outdoors"</li>
          <li>ISO 226:2003: "Acoustics â Normal equal-loudness-level contours"</li>
          <li>IEC 61672-1: "Electroacoustics â Sound level meters â Part 1: Specifications"</li>
        </ul>
        
        <h3>Books</h3>
        <ul>
          <li>Bies, D. A., & Hansen, C. H. (2009). "Engineering Noise Control: Theory and Practice, Fourth Edition." Spon Press.</li>
          <li>Crocker, M. J. (Ed.). (2007). "Handbook of Noise and Vibration Control." John Wiley & Sons.</li>
          <li>Morfey, C. L. (2001). "Dictionary of Acoustics." Academic Press.</li>
        </ul>
        
        <h3>Online Resources</h3>
        <ul>
          <li><a href="https://www.engineeringtoolbox.com/sound-pressure-level-d_711.html" target="_blank">Engineering ToolBox: Sound Pressure</a></li>
          <li><a href="https://www.noisemeters.com/apps/db-calculator/" target="_blank">NoiseMeters: Decibel Calculator</a></li>
          <li><a href="https://www.iacacoustics.com/blog-full/comparative-examples-of-noise-levels.html" target="_blank">IAC Acoustics: Comparative Examples of Noise Levels</a></li>
        </ul>
        
        <h3>Common Sound Levels Table</h3>
        <table>
          <thead>
            <tr>
              <th>Source</th>
              <th>dB(A)</th>
              <th>Perceived Loudness</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Threshold of hearing</td>
              <td>0</td>
              <td>-</td>
            </tr>
            <tr>
              <td>Rustling leaves</td>
              <td>20</td>
              <td>Just audible</td>
            </tr>
            <tr>
              <td>Whisper</td>
              <td>30</td>
              <td>Very quiet</td>
            </tr>
            <tr>
              <td>Library</td>
              <td>40</td>
              <td>Quiet</td>
            </tr>
            <tr>
              <td>Normal conversation</td>
              <td>60-65</td>
              <td>Moderate</td>
            </tr>
            <tr>
              <td>Vacuum cleaner</td>
              <td>75</td>
              <td>Loud</td>
            </tr>
            <tr>
              <td>Heavy traffic</td>
              <td>85</td>
              <td>Very loud</td>
            </tr>
            <tr>
              <td>Lawn mower</td>
              <td>90</td>
              <td>Very loud</td>
            </tr>
            <tr>
              <td>Rock concert</td>
              <td>110</td>
              <td>Extremely loud</td>
            </tr>
            <tr>
              <td>Jet engine (at 30m)</td>
              <td>140</td>
              <td>Pain threshold</td>
            </tr>
          </tbody>
        </table>
        
        <h3>Exposure Limits</h3>
        <p>NIOSH recommended exposure limits:</p>
        <table>
          <thead>
            <tr>
              <th>Exposure Level (dBA)</th>
              <th>Maximum Duration per Day</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>85</td>
              <td>8 hours</td>
            </tr>
            <tr>
              <td>88</td>
              <td>4 hours</td>
            </tr>
            <tr>
              <td>91</td>
              <td>2 hours</td>
            </tr>
            <tr>
              <td>94</td>
              <td>1 hour</td>
            </tr>
            <tr>
              <td>97</td>
              <td>30 minutes</td>
            </tr>
            <tr>
              <td>100</td>
              <td>15 minutes</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 - Sound Level Calculator - Part of Engineering Tools Collection</p>
  </footer>

  <script>
    // =====================================================================
    // MAIN VARIABLES & CONSTANTS
    // =====================================================================
    const REFERENCE_PRESSURE = 2e-5;  // 20 ÂµPa in Pa
    const REFERENCE_POWER = 1e-12;    // 10^-12 watts
    
    // A-weighting coefficients (simplified for common octave bands)
    const A_WEIGHTING = {
      '63': -26.2,
      '125': -16.1,
      '250': -8.6,
      '500': -3.2,
      '1000': 0,
      '2000': 1.2,
      '4000': 1.0,
      '8000': -1.1,
      'broadband': 0  // No adjustment for broadband
    };
    
    // C-weighting coefficients
    const C_WEIGHTING = {
      '63': -0.8,
      '125': -0.2,
      '250': 0,
      '500': 0,
      '1000': 0,
      '2000': -0.2,
      '4000': -0.8,
      '8000': -3.0,
      'broadband': 0  // No adjustment for broadband
    };
    
    // Equal loudness contour data (ISO 226:2003)
    // Format: [frequency, 0 phon, 10 phon, 20 phon, ... 100 phon]
    const PHON_DATA = [
      [20, 74.3, 74.3, 74.3, 74.3, 74.3, 74.3, 76.8, 81.0, 85.5, 90.8, 96.3],
      [25, 65.0, 65.0, 65.4, 66.1, 66.8, 68.1, 71.0, 75.4, 80.2, 85.7, 91.5],
      [31.5, 55.9, 56.3, 57.2, 58.5, 60.3, 62.6, 66.0, 70.7, 75.9, 81.8, 88.0],
      [40, 48.0, 48.5, 50.0, 52.0, 54.6, 57.5, 61.4, 66.3, 71.8, 78.1, 84.8],
      [50, 41.5, 42.3, 44.3, 47.0, 50.0, 53.4, 57.7, 62.8, 68.5, 75.0, 82.0],
      [63, 35.6, 36.8, 39.3, 42.5, 46.0, 49.8, 54.4, 59.8, 65.7, 72.5, 79.8],
      [80, 30.2, 31.8, 34.8, 38.5, 42.5, 46.7, 51.4, 57.0, 63.2, 70.3, 77.8],
      [100, 25.5, 27.5, 31.0, 35.0, 39.5, 44.0, 49.0, 54.8, 61.2, 68.5, 76.3],
      [125, 21.5, 24.0, 27.8, 32.5, 37.3, 42.0, 47.4, 53.4, 60.0, 67.5, 75.4],
      [160, 17.8, 20.8, 25.0, 30.0, 35.0, 40.0, 45.6, 51.8, 58.6, 66.4, 74.5],
      [200, 14.3, 17.5, 22.5, 27.8, 33.0, 38.2, 44.0, 50.4, 57.5, 65.4, 73.7],
      [250, 11.4, 14.8, 20.0, 25.8, 31.3, 36.8, 42.7, 49.3, 56.5, 64.5, 73.0],
      [315, 8.6, 12.1, 17.7, 23.8, 29.5, 35.3, 41.5, 48.3, 55.6, 63.8, 72.3],
      [400, 6.2, 9.8, 15.8, 22.0, 28.0, 34.0, 40.4, 47.3, 54.7, 63.1, 71.8],
      [500, 4.4, 8.0, 14.0, 20.5, 26.8, 33.0, 39.6, 46.5, 54.0, 62.5, 71.3],
      [630, 3.0, 6.6, 12.6, 19.2, 25.6, 32.0, 38.8, 45.8, 53.4, 62.0, 70.8],
      [800, 2.2, 5.5, 11.6, 18.2, 24.8, 31.3, 38.1, 45.1, 52.8, 61.5, 70.4],
      [1000, 2.4, 4.8, 11.0, 17.5, 24.0, 30.6, 37.5, 44.5, 52.2, 61.0, 70.0],
      [1250, 3.5, 5.0, 11.0, 17.5, 24.0, 30.7, 37.5, 44.4, 52.0, 60.5, 69.5],
      [1600, 1.7, 6.0, 12.0, 18.2, 24.5, 31.0, 37.7, 44.3, 51.7, 60.0, 69.0],
      [2000, -1.3, 4.0, 11.0, 17.5, 24.0, 30.5, 37.2, 43.8, 51.3, 59.5, 68.5],
      [2500, -4.2, 2.5, 10.0, 17.0, 23.5, 30.0, 36.8, 43.4, 51.0, 59.0, 68.0],
      [3150, -6.0, 1.0, 9.0, 16.5, 23.0, 29.6, 36.4, 43.0, 50.6, 58.5, 67.5],
      [4000, -5.4, 1.0, 9.0, 16.0, 22.5, 29.2, 36.0, 42.6, 50.2, 58.0, 67.0],
      [5000, -1.5, 4.0, 10.5, 16.5, 22.5, 29.0, 35.8, 42.4, 50.0, 57.5, 66.5],
      [6300, 6.0, 10.0, 15.0, 19.5, 24.5, 30.0, 36.0, 42.5, 49.8, 57.0, 66.0],
      [8000, 15.0, 17.0, 20.5, 24.0, 28.0, 32.5, 37.5, 43.5, 50.0, 57.0, 65.7],
      [10000, 16.5, 20.0, 25.0, 28.0, 32.0, 36.0, 40.0, 45.5, 51.5, 58.0, 66.0]
    ];
    
    // Source presets with SWL values
    const SOURCE_PRESETS = {
      'custom': { swl: 100 },
      'conversation': { swl: 75 },  // SWL for conversation (65 dB SPL at 1m)
      'vacuum': { swl: 85 },       // SWL for vacuum cleaner
      'lawnmower': { swl: 100 },    // SWL for lawn mower
      'concert': { swl: 120 },      // SWL for rock concert
      'jetEngine': { swl: 150 }     // SWL for jet engine
    };
    
    // Chart objects
    let distanceChart = null;
    let loudnessChart = null;
    
    // =====================================================================
    // UTILITY FUNCTIONS
    // =====================================================================
    
    // Calculate SPL from SWL for point source
    function calculatePointSourceSPL(swl, distance, directivityFactor) {
      const Q = parseFloat(directivityFactor);
      return swl - 20 * Math.log10(distance) - 11 + 10 * Math.log10(Q);
    }
    
    // Calculate SPL from SWL for line source
    function calculateLineSourceSPL(swl, distance) {
      return swl - 10 * Math.log10(distance) - 8;
    }
    
    // Calculate SPL from SWL for plane source
    function calculatePlaneSourceSPL(swl, distance) {
      // Simplified model that assumes distance has minimal effect
      return swl - 5;
    }
    
    // Apply frequency weighting
    function applyWeighting(spl, frequency, weightingType) {
      if (weightingType === 'Z') return spl;
      
      const weighting = weightingType === 'A' ? A_WEIGHTING : C_WEIGHTING;
      return spl + (weighting[frequency] || 0);
    }
    
    // Calculate air absorption based on ISO 9613-1
    function calculateAirAbsorption(frequency, distance, tempC, relHumidity) {
      // Simplified calculation for octave bands
      // Values in dB/km, converted to dB/m
      const absorptionCoeffs = {
        '63': 0.1,
        '125': 0.3,
        '250': 1.1,
        '500': 2.8,
        '1000': 5.0,
        '2000': 9.0,
        '4000': 22.9,
        '8000': 76.6,
        'broadband': 4.0  // Average value for broadband
      };
      
      // Adjust for temperature and humidity (simplified model)
      let coeff = absorptionCoeffs[frequency] || absorptionCoeffs['broadband'];
      
      // Temperature adjustment factor (simplified)
      const tempFactor = 1 + 0.01 * Math.abs(tempC - 20);
      
      // Humidity adjustment factor (simplified)
      const humidityFactor = relHumidity < 40 ? 1.2 : 
                            relHumidity > 80 ? 0.8 : 
                            1.0;
      
      coeff = coeff * tempFactor * humidityFactor / 1000; // Convert from dB/km to dB/m
      
      return coeff * distance;
    }
    
    // Calculate ground effect (simplified model)
    function calculateGroundEffect(distance, absorptionCoeff, frequency) {
      if (frequency === 'broadband') {
        // Broadband approximation
        return absorptionCoeff * 1.5 * Math.log10(distance + 1);
      }
      
      const freq = parseInt(frequency);
      
      // Ground effect is stronger at low frequencies
      let freqFactor = 1;
      if (freq <= 250) freqFactor = 2;
      else if (freq <= 500) freqFactor = 1.5;
      else if (freq > 2000) freqFactor = 0.5;
      
      return absorptionCoeff * freqFactor * Math.log10(distance + 1);
    }
    
    // Calculate barrier attenuation
    function calculateBarrierAttenuation(numBarriers, attenuationPerBarrier) {
      return numBarriers * attenuationPerBarrier;
    }
    
    // Calculate total SPL at distance
    function calculateTotalSPL(
      sourceType, swl, distance, directivityFactor,
      frequency, groundAbsorption, airAttenuationEnabled,
      tempC, humidity, numBarriers, barrierAttenuation
    ) {
      // 1. Calculate base SPL based on source type
      let spl;
      if (sourceType === 'point') {
        spl = calculatePointSourceSPL(swl, distance, directivityFactor);
      } else if (sourceType === 'line') {
        spl = calculateLineSourceSPL(swl, distance);
      } else {
        spl = calculatePlaneSourceSPL(swl, distance);
      }
      
      // 2. Apply ground effect
      const groundEffect = calculateGroundEffect(distance, groundAbsorption, frequency);
      spl -= groundEffect;
      
      // 3. Apply air absorption if enabled
      if (airAttenuationEnabled) {
        const airAbsorption = calculateAirAbsorption(frequency, distance, tempC, humidity);
        spl -= airAbsorption;
      }
      
      // 4. Apply barrier attenuation
      const barrierEffect = calculateBarrierAttenuation(numBarriers, barrierAttenuation);
      spl -= barrierEffect;
      
      return Math.max(0, spl); // SPL cannot be negative
    }
    
    // =====================================================================
    // CHART FUNCTIONS
    // =====================================================================
    
    // Create distance vs SPL chart
    function createDistanceChart(
      distances, spls, splsWeighted, sourceType
    ) {
      const ctx = document.getElementById('distanceChart').getContext('2d');
      
      // Destroy previous chart if it exists
      if (distanceChart !== null) {
        distanceChart.destroy();
      }
      
      // Distance chart labels - use log scale for better visualization
      const labels = distances.map(d => d.toFixed(1) + 'm');
      
      distanceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'SPL (dB)',
              data: spls,
              borderColor: 'rgb(75, 192, 192)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              tension: 0.1
            },
            {
              label: document.getElementById('weighting').value + '-weighted SPL (dB)',
              data: splsWeighted,
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Distance'
              },
              type: sourceType === 'point' ? 'logarithmic' : 'linear',
            },
            y: {
              title: {
                display: true,
                text: 'Sound Pressure Level (dB)'
              },
              min: 0,
              max: Math.max(...spls) + 10
            }
          }
        }
      });
    }
    
    // Create equal loudness contours chart
    function createLoudnessChart() {
      const ctx = document.getElementById('loudnessChart').getContext('2d');
      
      // Destroy previous chart if it exists
      if (loudnessChart !== null) {
        loudnessChart.destroy();
      }
      
      // Extract frequencies for x-axis
      const frequencies = PHON_DATA.map(row => row[0]);
      
      // Create datasets for different phon levels (0, 20, 40, 60, 80, 100)
      const datasets = [0, 2, 4, 6, 8, 10].map(i => {
        const phonLevel = (i * 10);
        return {
          label: phonLevel + ' phon',
          data: PHON_DATA.map(row => row[i + 1]),
          borderColor: getColorForPhon(phonLevel),
          backgroundColor: 'transparent',
          tension: 0.2
        };
      });
      
      loudnessChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: frequencies,
          datasets: datasets
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'logarithmic',
              title: {
                display: true,
                text: 'Frequency (Hz)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Sound Pressure Level (dB)'
              },
              min: 0,
              max: 120
            }
          }
        }
      });
    }
    
    // Get a color for phon curve
    function getColorForPhon(phon) {
      // Generate colors from blue (0 phon) to red (100 phon)
      const ratio = phon / 100;
      const r = Math.floor(255 * ratio);
      const b = Math.floor(255 * (1 - ratio));
      return `rgb(${r}, 50, ${b})`;
    }
    
    // =====================================================================
    // UI EVENT HANDLERS
    // =====================================================================
    
    // Calculate button click handler
    document.getElementById('calculateBtn').addEventListener('click', () => {
      // Get input values
      const sourceType = document.getElementById('sourceType').value;
      const swl = parseFloat(document.getElementById('sourceLevel').value);
      const distanceMin = parseFloat(document.getElementById('distanceMin').value);
      const distanceMax = parseFloat(document.getElementById('distanceMax').value);
      const directivityFactor = document.getElementById('dirFactor').value;
      const frequency = document.getElementById('frequency').value;
      const weightingType = document.getElementById('weighting').value;
      const groundAbsorption = parseFloat(document.getElementById('groundAbsorption').value);
      const airAttenuationEnabled = document.getElementById('airAttenuationEnabled').checked;
      const tempC = parseFloat(document.getElementById('tempC').value);
      const humidity = parseFloat(document.getElementById('humidity').value);
      const numBarriers = parseInt(document.getElementById('barriers').value);
      const barrierAttenuation = parseFloat(document.getElementById('barrierAttenuation').value);
      
      // Generate distance array (logarithmic for point sources, linear for others)
      const numPoints = 100;
      let distances = [];
      
      if (sourceType === 'point') {
        // Logarithmic spacing for point sources
        const minLog = Math.log10(distanceMin);
        const maxLog = Math.log10(distanceMax);
        const step = (maxLog - minLog) / (numPoints - 1);
        
        for (let i = 0; i < numPoints; i++) {
          const logDist = minLog + (step * i);
          distances.push(Math.pow(10, logDist));
        }
      } else {
        // Linear spacing for line and plane sources
        const step = (distanceMax - distanceMin) / (numPoints - 1);
        for (let i = 0; i < numPoints; i++) {
          distances.push(distanceMin + (step * i));
        }
      }
      
      // Calculate SPL at each distance
      const spls = distances.map(dist => 
        calculateTotalSPL(
          sourceType, swl, dist, directivityFactor, 
          frequency, groundAbsorption, airAttenuationEnabled,
          tempC, humidity, numBarriers, barrierAttenuation
        )
      );
      
      // Apply weighting
      const splsWeighted = spls.map(spl => 
        applyWeighting(spl, frequency, weightingType)
      );
      
      // Create distance chart
      createDistanceChart(distances, spls, splsWeighted, sourceType);
      
      // Create loudness chart
      createLoudnessChart();
      
      // Single point result at 1m
      const spl1m = calculateTotalSPL(
        sourceType, swl, 1, directivityFactor,
        frequency, groundAbsorption, airAttenuationEnabled,
        tempC, humidity, numBarriers, barrierAttenuation
      );
      
      const splWeighted1m = applyWeighting(spl1m, frequency, weightingType);
      
      document.getElementById('spl1m').textContent = `SPL at 1m: ${spl1m.toFixed(1)} dB`;
      document.getElementById('splWeighted1m').textContent = 
        `${weightingType}-weighted SPL at 1m: ${splWeighted1m.toFixed(1)} dB(${weightingType})`;
    });
    
    // Reset button click handler
    document.getElementById('resetBtn').addEventListener('click', () => {
      // Reset form to defaults
      document.getElementById('sourceType').value = 'point';
      document.getElementById('sourceLevel').value = '100';
      document.getElementById('distanceMin').value = '1';
      document.getElementById('distanceMax').value = '100';
      document.getElementById('dirFactor').value = '2';
      document.getElementById('frequency').value = 'broadband';
      document.getElementById('weighting').value = 'A';
      document.getElementById('groundAbsorption').value = '0.5';
      document.getElementById('airAttenuationEnabled').checked = true;
      document.getElementById('tempC').value = '20';
      document.getElementById('humidity').value = '60';
      document.getElementById('barriers').value = '0';
      document.getElementById('barrierAttenuation').value = '5';
      document.getElementById('sourcePresetSelect').value = 'custom';
      
      // Clear charts
      if (distanceChart) distanceChart.destroy();
      if (loudnessChart) loudnessChart.destroy();
      
      // Clear results
      document.getElementById('spl1m').textContent = '-';
      document.getElementById('splWeighted1m').textContent = '-';
    });
    
    // Apply preset button click handler
    document.getElementById('applyPresetBtn').addEventListener('click', () => {
      const preset = document.getElementById('sourcePresetSelect').value;
      if (preset in SOURCE_PRESETS) {
        document.getElementById('sourceLevel').value = SOURCE_PRESETS[preset].swl;
      }
    });
    
    // Tab switching function
    function openTab(evt, tabName) {
      // Declare variables
      let i, tabcontent, tabbuttons;
      
      // Get all tab content elements and hide them
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      
      // Get all tab buttons and remove "active" class
      tabbuttons = document.getElementsByClassName("tab-button");
      for (i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
      }
      
      // Show the current tab and add "active" class to the button
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }
    
    // Initialize the app
    window.onload = function() {
      // Initialize charts
      createLoudnessChart();
      
      // Set initial data
      document.getElementById('calculateBtn').click();
    };
  </script>
</body>
</html>
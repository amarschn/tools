<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YG3SBRRZFZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YG3SBRRZFZ');
    </script>

    <title>Energy Density & Storage Calculator - Engineering Tools</title>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        /* =================================================================
           1. CSS VARIABLES & RESET
           ================================================================= */
        :root {
            --primary-color: #0b0d12;
            --primary-light: #f4f5f7;
            --secondary-color: #4b5563;
            --accent-color: #111827;
            --success-color: #0f766e;
            --warning-color: #b45309;
            --danger-color: #b91c1c;
            --text-color: #111827;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --bg-color: #f8f9fb;
            --bg-card: #ffffff;
            --shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 12px 28px rgba(15, 23, 42, 0.18);
            --border-radius: 8px;
            --font-sans: 'Helvetica Neue', 'Avenir Next', 'Univers', 'Helvetica', system-ui, sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', monospace;
            --btn-primary-bg: #111827;
            --btn-primary-text: #ffffff;
            --tooltip-bg: #111827;
            --tooltip-text: #ffffff;
            --callout-info-bg: #dbeafe;
            --callout-info-border: #3b82f6;
        }
        body[data-theme="dark"] {
            --primary-color: #f9fafb;
            --primary-light: #1f2937;
            --secondary-color: #9ca3af;
            --accent-color: #f9fafb;
            --success-color: #34d399;
            --text-color: #f9fafb;
            --text-light: #9ca3af;
            --border-color: #374151;
            --bg-color: #0b0d12;
            --bg-card: #111827;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
            --shadow-lg: 0 16px 32px rgba(0, 0, 0, 0.55);
            --btn-primary-bg: #3b82f6;
            --btn-primary-text: #ffffff;
            --tooltip-bg: #1f2937;
            --tooltip-text: #f9fafb;
            --callout-info-bg: #1e3a5f;
            --callout-info-border: #3b82f6;
        }
        @media (prefers-color-scheme: dark) {
            body[data-theme="system"] {
                --primary-color: #f9fafb;
                --primary-light: #1f2937;
                --secondary-color: #9ca3af;
                --accent-color: #f9fafb;
                --success-color: #34d399;
                --text-color: #f9fafb;
                --text-light: #9ca3af;
                --border-color: #374151;
                --bg-color: #0b0d12;
                --bg-card: #111827;
                --shadow: 0 1px 2px rgba(0, 0, 0, 0.45);
                --shadow-lg: 0 16px 32px rgba(0, 0, 0, 0.55);
                --btn-primary-bg: #3b82f6;
                --btn-primary-text: #ffffff;
                --tooltip-bg: #1f2937;
                --tooltip-text: #f9fafb;
                --callout-info-bg: #1e3a5f;
                --callout-info-border: #3b82f6;
            }
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body { font-family: var(--font-sans); line-height: 1.6; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; transition: background-color 0.2s ease, color 0.2s ease; }

        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; transition: background-color 0.2s ease; }
        .loading-overlay.hidden { display: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; font-weight: 600; color: var(--text-color); }

        .container { width: 92%; max-width: 1400px; margin: 0 auto; padding: 24px 0; }
        .navbar { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 0 5%; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; height: 64px; max-width: 1400px; margin: 0 auto; }
        .nav-brand { font-size: 1.35rem; font-weight: 600; color: var(--text-color); text-decoration: none; }
        main.container { flex-grow: 1; }
        h1 { font-size: 2.25rem; font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem; }
        h2 { font-size: 1.375rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 12px; margin-bottom: 1rem; }
        h3 { font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); margin-bottom: 0.75rem; }
        p { margin-bottom: 1em; color: var(--text-light); }
        a { color: var(--accent-color); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .tool-description { font-size: 1.05rem; max-width: 80ch; margin-bottom: 1.5rem; }
        .tool-layout { display: grid; grid-template-columns: minmax(360px, 0.9fr) minmax(480px, 1.1fr); gap: 28px; align-items: start; }
        .card { background-color: var(--bg-card); border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); padding: 24px; }

        .input-group { margin-bottom: 1.1rem; position: relative; }
        .input-group label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.875rem; color: var(--text-color); }
        .input-group input, .input-group select { width: 100%; padding: 11px 14px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem; font-family: var(--font-sans); background: var(--bg-card); color: var(--text-color); }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--text-color); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .tooltip-trigger { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background-color: var(--primary-light); border: 1px solid var(--border-color); color: var(--text-light); border-radius: 50%; font-size: 11px; font-weight: bold; cursor: help; position: absolute; right: 10px; top: 36px; }
        .tooltip-trigger::after { content: attr(data-tooltip); position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%); background-color: var(--tooltip-bg); color: var(--tooltip-text); padding: 10px 14px; border-radius: 8px; font-size: 12px; font-weight: 400; line-height: 1.5; white-space: normal; width: 240px; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 10; box-shadow: var(--shadow-lg); }
        .tooltip-trigger:hover::after { opacity: 1; visibility: visible; }

        .btn { display: inline-block; padding: 12px 16px; font-size: 1rem; font-weight: 600; border: none; border-radius: var(--border-radius); cursor: pointer; text-align: center; transition: background-color 0.15s, opacity 0.15s; }
        .btn-primary { background-color: var(--btn-primary-bg); color: var(--btn-primary-text); width: 100%; }
        .btn-primary:hover { opacity: 0.9; }

        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; gap: 4px; flex-wrap: wrap; }
        .tab-link { padding: 12px 16px; cursor: pointer; background-color: transparent; border: none; font-size: 0.85rem; font-weight: 600; letter-spacing: 0.03em; text-transform: uppercase; color: var(--text-light); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: color 0.2s ease; }
        .tab-link:hover { color: var(--text-color); }
        .tab-link.active { color: var(--text-color); border-bottom-color: var(--accent-color); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-bottom: 20px; }
        .result-item { background: var(--bg-color); padding: 16px; border-radius: var(--border-radius); text-align: center; cursor: pointer; border: 2px solid transparent; }
        .result-item:hover { border-color: var(--border-color); }
        .result-item.expanded { border-color: var(--accent-color); background: var(--primary-light); }
        .result-item .label { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
        .result-item .value { font-size: 1.3rem; font-weight: 600; font-family: var(--font-mono); }
        .result-item .unit { font-size: 0.85rem; color: var(--text-light); margin-left: 2px; }
        .result-item .icon { font-size: 0.65rem; margin-left: 4px; opacity: 0.4; }

        .derivation-panel { display: none; background: var(--primary-light); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; }
        .derivation-panel.visible { display: block; animation: fadeIn 0.3s ease; }
        .derivation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .derivation-title { font-weight: 600; font-size: 1rem; }
        .derivation-close { background: none; border: none; font-size: 1.25rem; cursor: pointer; color: var(--text-light); }
        .derivation-step { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .derivation-step:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .derivation-step .step-title { font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; }
        .derivation-step .equation { background: var(--bg-card); padding: 12px; border-radius: 6px; font-size: 0.95rem; overflow-x: auto; }

        .chart-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 18px; margin-bottom: 20px; }
        .chart-plot { width: 100%; min-height: 350px; height: 350px; }

        .footer { text-align: center; padding: 20px 0; background-color: var(--bg-card); border-top: 1px solid var(--border-color); color: var(--text-light); font-size: 0.9rem; margin-top: 30px; }
        
        .purpose-section { margin-bottom: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--bg-card); }
        .purpose-section summary { padding: 16px 24px; font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); list-style: none; cursor: pointer; }
        .purpose-section summary::-webkit-details-marker { display: none; }
        .purpose-section summary::after { content: '[Expand]'; float: right; font-size: 0.9rem; font-weight: 500; color: var(--text-light); }
        .purpose-section[open] > summary::after { content: '[Collapse]'; }
        .purpose-content { padding: 0 24px 24px 24px; border-top: 1px solid var(--border-color); }
        .purpose-content ul { padding-left: 20px; }

        @media (max-width: 1000px) { .tool-layout { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .input-row { grid-template-columns: 1fr; } }
    </style>
</head>

<body data-theme="system">
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Loading Pyodide...</div>
    </div>

    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
        </nav>
    </header>

    <main class="container">
        <h1>Energy Density & Storage Calculator</h1>
        <p class="tool-description">
            Compare mass and volume requirements for different energy storage systems (batteries vs. fuels) to achieve a target range for various vehicle types.
        </p>

        <details class="purpose-section">
            <summary>Tool Purpose & Background</summary>
            <div class="purpose-content">
                <h3>About This Tool</h3>
                <p>This tool evaluates the system-level tradeoffs between different energy storage media. It accounts for:</p>
                <ul>
                    <li>Conversion efficiency (e.g., ICE vs Fuel Cell vs Battery Electric)</li>
                    <li>Container mass and volume overhead (e.g., heavy high-pressure tanks for hydrogen, or battery pack structures)</li>
                    <li>Vehicle energy consumption (Wh/km at the wheels)</li>
                </ul>
                <p>Understanding these tradeoffs is critical when comparing future mobility platforms.</p>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <form id="calc-form">
                    <div class="input-group">
                        <label for="vehicle_type">Vehicle Type</label>
                        <select id="vehicle_type" name="vehicle_type" onchange="toggleCustomConsumption()">
                            <option value="commuter_car">Compact Commuter Car</option>
                            <option value="suv">Large SUV</option>
                            <option value="semi_truck">Class 8 Semi Truck</option>
                            <option value="bicycle">E-Bike</option>
                            <option value="small_aircraft">4-Seat Aircraft</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                    </div>

                    <div class="input-group" id="custom_consumption_group" style="display: none;">
                        <label for="custom_consumption_wh_km">Custom Energy Consumption (Wh/km)</label>
                        <input type="number" id="custom_consumption_wh_km" name="custom_consumption_wh_km" value="150" step="1" min="1">
                        <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                    </div>

                    <div class="input-group">
                        <label for="target_range_km">Target Range (km)</label>
                        <input type="number" id="target_range_km" name="target_range_km" value="400" step="10" min="1">
                        <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                    </div>

                    <h3 style="margin-top: 20px; font-size: 1rem;">Compare Energy Sources</h3>
                    
                    <div class="input-row">
                        <div class="input-group">
                            <label for="energy_source_1">Option 1</label>
                            <select id="energy_source_1" name="energy_source_1">
                                <option value="li_ion_nmc">Li-Ion NMC Battery</option>
                                <option value="lfp_battery">LFP Battery</option>
                                <option value="solid_state">Solid State Battery</option>
                                <option value="gasoline">Gasoline (ICE)</option>
                                <option value="diesel">Diesel (ICE)</option>
                                <option value="hydrogen_700bar">Hydrogen (700 bar)</option>
                                <option value="jet_a">Jet A Fuel</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                        <div class="input-group">
                            <label for="energy_source_2">Option 2</label>
                            <select id="energy_source_2" name="energy_source_2">
                                <option value="gasoline">Gasoline (ICE)</option>
                                <option value="li_ion_nmc">Li-Ion NMC Battery</option>
                                <option value="lfp_battery">LFP Battery</option>
                                <option value="solid_state">Solid State Battery</option>
                                <option value="diesel">Diesel (ICE)</option>
                                <option value="hydrogen_700bar">Hydrogen (700 bar)</option>
                                <option value="jet_a">Jet A Fuel</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="calculate-btn" style="margin-top: 16px;">Calculate</button>
                </form>
            </section>

            <section class="tool-outputs card">
                <div class="tabs">
                    <button class="tab-link active" onclick="openTab(event, 'results')">Results</button>
                    <button class="tab-link" onclick="openTab(event, 'visualization')">Visual Comparison</button>
                </div>

                <div id="results" class="tab-content" style="display: block;">
                    <h3>System Requirements</h3>
                    <p id="results-placeholder" style="color: var(--text-light);">Enter inputs and press Calculate to see results.</p>

                    <div id="results-container" style="display: none;">
                        <p style="margin-bottom: 12px;"><strong>Useful Energy Required:</strong> <span id="val-useful_energy">--</span> kWh</p>
                        
                        <h4 style="margin-top: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;" id="name-source1">Option 1</h4>
                        <div class="results-grid">
                            <div class="result-item" data-key="mass1" onclick="toggleDerivation('mass1')">
                                <div class="label">Total Mass</div>
                                <div class="value" id="val-mass1">--<span class="unit">kg</span></div>
                                <span class="icon">&#9660;</span>
                            </div>
                            <div class="result-item" data-key="vol1" onclick="toggleDerivation('vol1')">
                                <div class="label">Total Volume</div>
                                <div class="value" id="val-vol1">--<span class="unit">L</span></div>
                                <span class="icon">&#9660;</span>
                            </div>
                        </div>

                        <div class="derivation-panel" id="deriv-mass1">
                            <div class="derivation-header">
                                <span class="derivation-title">Mass Derivation (Option 1)</span>
                                <button class="derivation-close" onclick="toggleDerivation('mass1')">&times;</button>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Stored Energy Needed (accounting for efficiency)</div>
                                <div class="equation" id="subst-stored1"></div>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Total Mass (accounting for container overhead)</div>
                                <div class="equation" id="subst-mass1"></div>
                            </div>
                        </div>

                        <div class="derivation-panel" id="deriv-vol1">
                            <div class="derivation-header">
                                <span class="derivation-title">Volume Derivation (Option 1)</span>
                                <button class="derivation-close" onclick="toggleDerivation('vol1')">&times;</button>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Total Volume (accounting for container overhead)</div>
                                <div class="equation" id="subst-vol1"></div>
                            </div>
                        </div>

                        <h4 style="margin-top: 16px; border-bottom: 1px solid var(--border-color); padding-bottom: 4px;" id="name-source2">Option 2</h4>
                        <div class="results-grid">
                            <div class="result-item" data-key="mass2" onclick="toggleDerivation('mass2')">
                                <div class="label">Total Mass</div>
                                <div class="value" id="val-mass2">--<span class="unit">kg</span></div>
                                <span class="icon">&#9660;</span>
                            </div>
                            <div class="result-item" data-key="vol2" onclick="toggleDerivation('vol2')">
                                <div class="label">Total Volume</div>
                                <div class="value" id="val-vol2">--<span class="unit">L</span></div>
                                <span class="icon">&#9660;</span>
                            </div>
                        </div>
                        
                        <div class="derivation-panel" id="deriv-mass2">
                            <div class="derivation-header">
                                <span class="derivation-title">Mass Derivation (Option 2)</span>
                                <button class="derivation-close" onclick="toggleDerivation('mass2')">&times;</button>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Stored Energy Needed (accounting for efficiency)</div>
                                <div class="equation" id="subst-stored2"></div>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Total Mass (accounting for container overhead)</div>
                                <div class="equation" id="subst-mass2"></div>
                            </div>
                        </div>

                        <div class="derivation-panel" id="deriv-vol2">
                            <div class="derivation-header">
                                <span class="derivation-title">Volume Derivation (Option 2)</span>
                                <button class="derivation-close" onclick="toggleDerivation('vol2')">&times;</button>
                            </div>
                            <div class="derivation-step">
                                <div class="step-title">Total Volume (accounting for container overhead)</div>
                                <div class="equation" id="subst-vol2"></div>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="visualization" class="tab-content">
                    <div class="chart-container">
                        <div id="mass-plot" class="chart-plot" style="min-height: 250px; height: 250px;"></div>
                    </div>
                    <div class="chart-container">
                        <div id="volume-plot" class="chart-plot" style="min-height: 250px; height: 250px;"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        let pyUtils, pyToolModule;
        const TOOL_MODULE_NAME = 'energy_density';
        const TOOL_FUNCTION_NAME = 'analyze_energy_storage';
        const PARAM_ORDER = ['vehicle_type', 'custom_consumption_wh_km', 'target_range_km', 'energy_source_1', 'energy_source_2'];
        let openDerivation = null;

        function toggleCustomConsumption() {
            const select = document.getElementById('vehicle_type');
            const customGroup = document.getElementById('custom_consumption_group');
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        }

        function openTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.currentTarget.classList.add('active');
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise();
            }

            if (tabName === 'visualization') {
                setTimeout(() => {
                    Plotly.Plots.resize('mass-plot');
                    Plotly.Plots.resize('volume-plot');
                }, 100);
            }
        }

        function toggleDerivation(key) {
            const panel = document.getElementById('deriv-' + key);
            const item = document.querySelector(`.result-item[data-key="${key}"]`);

            if (openDerivation && openDerivation !== key) {
                document.getElementById('deriv-' + openDerivation).classList.remove('visible');
                document.querySelector(`.result-item[data-key="${openDerivation}"]`)?.classList.remove('expanded');
            }

            if (panel.classList.contains('visible')) {
                panel.classList.remove('visible');
                item?.classList.remove('expanded');
                openDerivation = null;
            } else {
                panel.classList.add('visible');
                item?.classList.add('expanded');
                openDerivation = key;
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise();
                }
            }
        }

        async function main() {
            const loadingText = document.getElementById('loading-text');

            try {
                let pyodide = await loadPyodide();
                await pyodide.loadPackage('micropip');

                await pyodide.runPythonAsync(`
                    import micropip
                    from pyodide.http import pyfetch

                    response_utils = await pyfetch('../../pycalcs/utils.py')
                    with open('utils.py', 'w') as f:
                        f.write(await response_utils.string())

                    response_tool = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
                    with open('${TOOL_MODULE_NAME}.py', 'w') as f:
                        f.write(await response_tool.string())

                    import utils
                    import ${TOOL_MODULE_NAME}
                `);

                pyUtils = pyodide.globals.get('utils');
                pyToolModule = pyodide.globals.get(TOOL_MODULE_NAME);

                const docMap = pyUtils.get_documentation(TOOL_MODULE_NAME, TOOL_FUNCTION_NAME).toJs();
                let params = {};
                if (!docMap.has('error') && docMap.has('parameters')) {
                    params = Object.fromEntries(docMap.get('parameters'));
                    PARAM_ORDER.forEach(paramId => {
                        const tooltip = document.querySelector(`#\${paramId} + .tooltip-trigger, .input-group:has(#\${paramId}) .tooltip-trigger`);
                        if (tooltip && params[paramId]) {
                            tooltip.setAttribute('data-tooltip', params[paramId]);
                        }
                    });
                }

                document.getElementById('calc-form').addEventListener('submit', handleCalculate);
                document.getElementById('loading-overlay').classList.add('hidden');

            } catch (error) {
                loadingText.textContent = 'Error loading: ' + error.message;
                console.error(error);
            }
            toggleCustomConsumption();
        }

        async function handleCalculate(event) {
            event.preventDefault();

            const btn = document.getElementById('calculate-btn');
            btn.textContent = 'Calculating...';
            btn.disabled = true;

            try {
                const vehicle_type = document.getElementById('vehicle_type').value;
                const custom_consumption_wh_km = parseFloat(document.getElementById('custom_consumption_wh_km').value);
                const target_range_km = parseFloat(document.getElementById('target_range_km').value);
                const energy_source_1 = document.getElementById('energy_source_1').value;
                const energy_source_2 = document.getElementById('energy_source_2').value;

                const resultProxy = pyToolModule.analyze_energy_storage(
                    vehicle_type,
                    custom_consumption_wh_km,
                    target_range_km,
                    energy_source_1,
                    energy_source_2
                );

                const results = resultProxy.toJs({ dict_converter: Object.fromEntries });
                resultProxy.destroy();

                displayResults(results, energy_source_1, energy_source_2);

            } catch (error) {
                console.error(error);
                document.getElementById('results-placeholder').textContent = 'Error: ' + error.message;
                document.getElementById('results-placeholder').style.color = 'var(--danger-color)';
                document.getElementById('results-placeholder').style.display = 'block';
                document.getElementById('results-container').style.display = 'none';
            }

            btn.textContent = 'Calculate';
            btn.disabled = false;
        }

        function displayResults(results, src1, src2) {
            document.getElementById('results-placeholder').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';

            document.getElementById('val-useful_energy').textContent = results.useful_energy_kwh.toFixed(1);
            
            const sel1 = document.getElementById('energy_source_1');
            const sel2 = document.getElementById('energy_source_2');
            document.getElementById('name-source1').textContent = sel1.options[sel1.selectedIndex].text;
            document.getElementById('name-source2').textContent = sel2.options[sel2.selectedIndex].text;

            document.getElementById('val-mass1').innerHTML = results.source1_total_mass_kg.toFixed(1) + '<span class="unit">kg</span>';
            document.getElementById('val-vol1').innerHTML = results.source1_total_volume_l.toFixed(1) + '<span class="unit">L</span>';
            
            document.getElementById('val-mass2').innerHTML = results.source2_total_mass_kg.toFixed(1) + '<span class="unit">kg</span>';
            document.getElementById('val-vol2').innerHTML = results.source2_total_volume_l.toFixed(1) + '<span class="unit">L</span>';

            document.getElementById('subst-stored1').innerHTML = '$$' + results.subst_source1_stored + '$$';
            document.getElementById('subst-mass1').innerHTML = '$$' + results.subst_source1_mass + '$$';
            document.getElementById('subst-vol1').innerHTML = '$$' + results.subst_source1_volume + '$$';
            
            document.getElementById('subst-stored2').innerHTML = '$$' + results.subst_source2_stored + '$$';
            document.getElementById('subst-mass2').innerHTML = '$$' + results.subst_source2_mass + '$$';
            document.getElementById('subst-vol2').innerHTML = '$$' + results.subst_source2_volume + '$$';

            plotCharts(results);

            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise();
            }
        }

        function plotCharts(data) {
            const categories = data.viz_categories;
            const massData = data.viz_mass_data;
            const volData = data.viz_vol_data;

            const computedStyle = getComputedStyle(document.body);
            const bgColor = computedStyle.getPropertyValue('--bg-card').trim() || '#ffffff';
            const textColor = computedStyle.getPropertyValue('--text-color').trim() || '#111827';
            const accentColor = computedStyle.getPropertyValue('--accent-color').trim() || '#111827';
            const gridColor = computedStyle.getPropertyValue('--border-color').trim() || '#e5e7eb';

            const massTrace = {
                x: categories,
                y: massData,
                type: 'bar',
                marker: { color: accentColor }
            };

            const massLayout = {
                title: { text: 'Total System Mass (kg)', font: { color: textColor } },
                xaxis: { color: textColor, gridcolor: gridColor },
                yaxis: { title: 'Mass (kg)', color: textColor, gridcolor: gridColor },
                paper_bgcolor: bgColor,
                plot_bgcolor: bgColor,
                margin: { t: 40, b: 30, l: 50, r: 20 },
                font: { family: 'Helvetica Neue, sans-serif' }
            };

            Plotly.newPlot('mass-plot', [massTrace], massLayout, { responsive: true });

            const volTrace = {
                x: categories,
                y: volData,
                type: 'bar',
                marker: { color: '#3b82f6' }
            };

            const volLayout = {
                title: { text: 'Total System Volume (L)', font: { color: textColor } },
                xaxis: { color: textColor, gridcolor: gridColor },
                yaxis: { title: 'Volume (L)', color: textColor, gridcolor: gridColor },
                paper_bgcolor: bgColor,
                plot_bgcolor: bgColor,
                margin: { t: 40, b: 30, l: 50, r: 20 },
                font: { family: 'Helvetica Neue, sans-serif' }
            };

            Plotly.newPlot('volume-plot', [volTrace], volLayout, { responsive: true });
        }

        main();
    </script>
</body>
</html>

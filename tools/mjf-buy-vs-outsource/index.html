<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YG3SBRRZFZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YG3SBRRZFZ');
    </script>

    <title>MJF Buy vs. Outsource Simulator - Engineering Tools</title>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <style>
        :root {
            --primary-color: #1f2933;
            --primary-light: #f0f4f8;
            --secondary-color: #52606d;
            --accent-color: #2563eb;
            --bg-color: #f8fafc;
            --bg-card: #ffffff;
            --border-color: #d8dee4;
            --shadow: 0 10px 28px -18px rgba(15, 23, 42, 0.35);
            --radius: 10px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
        }
        .container { width: 92%; max-width: 1180px; margin: 0 auto; padding: 22px 0 36px; }
        h1, h2, h3, h4 { font-weight: 600; color: var(--primary-color); }
        h1 { font-size: clamp(2.1rem, 3.8vw, 2.8rem); margin-bottom: 0.35rem; }
        h2 { font-size: 1.55rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 1rem; }
        h3 { font-size: 1.2rem; color: var(--secondary-color); margin-bottom: 0.85rem; }
        h4 { font-size: 1rem; margin-top: 1.1rem; color: var(--secondary-color); }
        p { color: var(--secondary-color); margin-bottom: 0.65rem; }
        ul { padding-left: 1.25rem; margin-bottom: 0.75rem; }
        a { color: var(--accent-color); }

        .navbar { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 6px rgba(15, 23, 42, 0.05); }
        .nav-container { max-width: 1180px; margin: 0 auto; padding: 0 4%; height: 60px; display: flex; align-items: center; }
        .nav-brand { font-size: 1.4rem; font-weight: 600; color: var(--primary-color); text-decoration: none; }

        main.container { flex-grow: 1; }
        .tool-description { max-width: 80ch; font-size: 1.05rem; color: var(--secondary-color); margin-bottom: 1.2rem; }
        .tool-layout { display: grid; grid-template-columns: minmax(320px, 1.15fr) minmax(360px, 1.4fr); gap: 20px; align-items: start; }
        .card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); padding: 20px 22px; }

        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .purpose-section { margin-bottom: 1.8rem; border: 1px solid var(--border-color); border-radius: var(--radius); background-color: var(--bg-card); box-shadow: var(--shadow); }
        .purpose-section summary { padding: 16px 24px; font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); }
        .purpose-section summary::after { content: '[Expand]'; float: right; font-size: 0.9rem; color: var(--secondary-color); letter-spacing: 0.02em; }
        .purpose-section[open] > summary::after { content: '[Shrink]'; }
        .purpose-content { padding: 0 24px 24px; border-top: 1px solid var(--border-color); }
        .purpose-content code { background-color: var(--primary-light); padding: 2px 4px; border-radius: 4px; }

        .form-section { margin-bottom: 1.6rem; }
        .form-section:last-of-type { margin-bottom: 1.1rem; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px 16px; }
        .input-group { position: relative; }
        .input-group label { display: block; font-weight: 600; font-size: 0.88rem; margin-bottom: 4px; color: var(--secondary-color); }
        .input-group input[type="number"], .input-group input[type="text"] {
            width: 100%;
            padding: 9px 12px;
            border-radius: 7px;
            border: 1px solid var(--border-color);
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-group input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18); }
        .tooltip-trigger {
            display: inline-flex; justify-content: center; align-items: center;
            width: 18px; height: 18px;
            background-color: var(--border-color);
            color: var(--secondary-color);
            border-radius: 50%;
            font-size: 12px; font-weight: bold;
            position: absolute; right: -22px; top: 30px;
            cursor: help;
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            background: var(--primary-color); color: #fff;
            padding: 8px 10px; border-radius: 6px;
            font-size: 0.78rem; line-height: 1.35; width: 240px;
            opacity: 0; visibility: hidden; transition: opacity 0.2s ease;
            box-shadow: 0 10px 28px rgba(15, 23, 42, 0.25); z-index: 10;
        }
        .tooltip-trigger:hover::after { opacity: 1; visibility: visible; }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 18px;
            border-radius: 7px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.18s ease, box-shadow 0.18s ease;
        }
        .btn-primary { background-color: var(--accent-color); color: #fff; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: var(--secondary-color); color: #fff; }
        .btn-secondary:hover { background-color: #3d4852; }

        .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; flex-wrap: wrap; }
        .tab-link { padding: 9px 16px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--secondary-color); border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .tab-content { display: none; }

        .result-item { border-bottom: 1px solid var(--border-color); padding: 14px 0; }
        .result-item:last-of-type { border-bottom: none; }
        .result-header { display: flex; justify-content: space-between; gap: 12px; align-items: center; }
        .result-header p { margin: 0; color: var(--primary-color); font-weight: 600; }
        .equation-details { font-size: 0.88rem; color: var(--secondary-color); margin-top: 0.5rem; }
        .inline-details summary { width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); cursor: pointer; }
        .inline-details[open] summary { background-color: var(--primary-light); }

        .analysis-details { margin-top: 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: #f8fafc; }
        .analysis-details summary { padding: 12px 14px; font-weight: 600; color: var(--secondary-color); cursor: pointer; }
        .analysis-details > div { padding: 0 14px 14px 14px; }

        .chart-wrapper { background: #f1f5fb; border-radius: 10px; border: 1px solid var(--border-color); padding: 16px; }
        #cost-comparison-chart { width: 100%; height: 360px; }
        .chart-summary { margin-top: 0.8rem; font-size: 0.92rem; color: var(--secondary-color); }

        table { width: 100%; border-collapse: collapse; margin-top: 0.4rem; }
        th, td { border: 1px solid var(--border-color); padding: 8px 10px; text-align: left; font-size: 0.9rem; }
        th { background: var(--primary-light); font-weight: 600; color: var(--secondary-color); }
        tbody tr:nth-child(even) { background: #f9fbfd; }

        .definition-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px 14px; margin-top: 0.75rem; }
        .definition-card { background-color: #f8fafc; border-radius: 8px; border: 1px solid var(--border-color); padding: 10px 12px; font-size: 0.85rem; color: var(--secondary-color); }
        .empty-hint { color: var(--secondary-color); font-style: italic; margin-top: 0.5rem; }
        .footer { text-align: center; padding: 22px 0 26px; color: var(--secondary-color); font-size: 0.88rem; }

        @media (max-width: 1040px) {
            .tool-layout { grid-template-columns: 1fr; }
            .tooltip-trigger { right: 0; top: 6px; }
        }
        @media (max-width: 640px) {
            .tabs { gap: 0; }
            .tab-link { flex: 1 1 45%; text-align: center; }
            .input-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
    
    .support-link {
      color: inherit;
      font-weight: 600;
      text-decoration: none;
    }

    .support-link:hover {
      text-decoration: underline;
    }
    </style>
</head>
<body>

    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
        </nav>
    </header>

    <main class="container">

        <h1>MJF Buy vs. Outsource Simulator</h1>
        <p class="tool-description" id="tool-description">
            Evaluate capital purchases for HP Multi Jet Fusion printers versus outsourcing. The tool samples demand,
            uptime events, labour limits, and supporting infrastructure costs to reveal savings distributions,
            turnaround gains, and break-even confidence.
        </p>

        <details class="purpose-section">
            <summary>Tool Purpose & README</summary>
            <div class="purpose-content" id="readme-content">
                <h3>Purpose</h3>
                <p>This simulator estimates the economic and schedule impact of bringing MJF production in-house. It blends capital
                expenses, Monte Carlo demand modelling, downtime risks, labour availability, and supporting infrastructure costs to
                highlight when internal builds outperform outsourcing.</p>
                <h3>How It Works</h3>
                <ul>
                    <li>Leverages <code>simulate_mjf_breakeven</code> in <code>pycalcs/manufacturing.py</code> to run Monte Carlo trials.</li>
                    <li>Captures print/cooldown cycle time, operator bandwidth, and annual supporting OPEX.</li>
                    <li>Produces cumulative cost envelopes for outsourced, in-house, and hybrid demand mixes plus a representative event log.</li>
                    <li>Summarises each machine-count scenario with percentile savings, break-even likelihood, and cost breakdowns.</li>
                </ul>
                <h3>Usage Tips</h3>
                <p>Populate demand statistics, uptime expectations, and labour availability using your programme data. Group supporting capital
                (depowdering, ventilation, electrical) into the capital field and recurring utilities into the OPEX field. Adjust the hybrid
                outsourcing slider to explore mixed sourcing strategies.</p>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <form id="calc-form" autocomplete="off">
                    <div class="form-section">
                        <h3>Capital & Horizon</h3>
                        <div class="input-grid">
                            <div class="input-group" data-param="purchase_price">
                                <label for="purchase_price">Printer purchase price (USD)</label>
                                <input type="number" id="purchase_price" min="0" step="1000" placeholder="350000">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="support_capital_cost">
                                <label for="support_capital_cost">Support capital (post-process, infrastructure) (USD)</label>
                                <input type="number" id="support_capital_cost" min="0" step="1000" placeholder="85000">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="machine_counts">
                                <label for="machine_counts">Machine counts to evaluate</label>
                                <input type="text" id="machine_counts" placeholder="1,2,3">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="analysis_years">
                                <label for="analysis_years">Analysis horizon (years)</label>
                                <input type="number" id="analysis_years" min="1" step="1" placeholder="5">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="simulations">
                                <label for="simulations">Monte Carlo trials</label>
                                <input type="number" id="simulations" min="10" step="10" placeholder="750">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Demand & Cycle Time</h3>
                        <div class="input-grid">
                            <div class="input-group" data-param="annual_demand_mean">
                                <label for="annual_demand_mean">Mean annual demand (builds)</label>
                                <input type="number" id="annual_demand_mean" min="0" step="1" placeholder="650">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="annual_demand_std">
                                <label for="annual_demand_std">Demand standard deviation</label>
                                <input type="number" id="annual_demand_std" min="0" step="1" placeholder="120">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="max_builds_per_machine">
                                <label for="max_builds_per_machine">Nominal builds/machine/year</label>
                                <input type="number" id="max_builds_per_machine" min="1" step="1" placeholder="480">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="print_time_hours">
                                <label for="print_time_hours">Print time per build (h)</label>
                                <input type="number" id="print_time_hours" min="0" step="0.25" placeholder="12">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="cooldown_time_hours">
                                <label for="cooldown_time_hours">Cooldown / depowder (h)</label>
                                <input type="number" id="cooldown_time_hours" min="0" step="0.25" placeholder="18">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="external_turnaround_days">
                                <label for="external_turnaround_days">External turnaround (days)</label>
                                <input type="number" id="external_turnaround_days" min="0" step="0.5" placeholder="10">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Availability & Labour</h3>
                        <div class="input-grid">
                            <div class="input-group" data-param="uptime_mean">
                                <label for="uptime_mean">Mean uptime fraction</label>
                                <input type="number" id="uptime_mean" min="0" max="1" step="0.01" placeholder="0.88">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="uptime_std">
                                <label for="uptime_std">Uptime standard deviation</label>
                                <input type="number" id="uptime_std" min="0" max="1" step="0.01" placeholder="0.05">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="downtime_event_probability">
                                <label for="downtime_event_probability">Major downtime probability</label>
                                <input type="number" id="downtime_event_probability" min="0" max="1" step="0.01" placeholder="0.2">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="downtime_event_duration_fraction">
                                <label for="downtime_event_duration_fraction">Downtime impact (fraction)</label>
                                <input type="number" id="downtime_event_duration_fraction" min="0" max="1" step="0.01" placeholder="0.15">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="operator_issue_probability">
                                <label for="operator_issue_probability">Operator issue probability</label>
                                <input type="number" id="operator_issue_probability" min="0" max="1" step="0.01" placeholder="0.1">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="operator_issue_duration_fraction">
                                <label for="operator_issue_duration_fraction">Operator impact (fraction)</label>
                                <input type="number" id="operator_issue_duration_fraction" min="0" max="1" step="0.01" placeholder="0.1">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="operator_hours_per_build">
                                <label for="operator_hours_per_build">Operator hours per build</label>
                                <input type="number" id="operator_hours_per_build" min="0" step="0.25" placeholder="3.5">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="operator_hours_available_per_year">
                                <label for="operator_hours_available_per_year">Operator hours / machine / year</label>
                                <input type="number" id="operator_hours_available_per_year" min="0" step="10" placeholder="2080">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Cost Structure & OPEX</h3>
                        <div class="input-grid">
                            <div class="input-group" data-param="variable_internal_cost">
                                <label for="variable_internal_cost">Internal variable cost (USD/build)</label>
                                <input type="number" id="variable_internal_cost" min="0" step="1" placeholder="140">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="external_cost_per_build">
                                <label for="external_cost_per_build">External cost (USD/build)</label>
                                <input type="number" id="external_cost_per_build" min="0" step="1" placeholder="240">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="fixed_annual_cost_per_machine">
                                <label for="fixed_annual_cost_per_machine">Fixed cost per machine (USD/yr)</label>
                                <input type="number" id="fixed_annual_cost_per_machine" min="0" step="1000" placeholder="60000">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                            <div class="input-group" data-param="support_annual_operating_cost">
                                <label for="support_annual_operating_cost">Support annual OPEX (USD/yr)</label>
                                <input type="number" id="support_annual_operating_cost" min="0" step="1000" placeholder="22000">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Sourcing Strategy</h3>
                        <div class="input-grid">
                            <div class="input-group" data-param="hybrid_outsource_fraction">
                                <label for="hybrid_outsource_fraction">Target outsourced share for hybrid scenario (%)</label>
                                <input type="number" id="hybrid_outsource_fraction" min="0" max="100" step="5" placeholder="30">
                                <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                            </div>
                        </div>
                        <small style="display:block;color:var(--secondary-color);margin-top:6px;">The hybrid line in the plot forces this share of demand to stay external even when internal capacity exists.</small>
                    </div>

                    <button type="submit" class="btn btn-primary" id="calculate-btn">Calculate</button>
                </form>
            </section>

            <section class="tool-outputs card">
                <div class="tabs">
                    <button class="tab-link active" data-target="results">Results</button>
                    <button class="tab-link" data-target="costs">Cost Comparison</button>
                    <button class="tab-link" data-target="log">Year in Review</button>
                    <button class="tab-link" data-target="background">Background & Principles</button>
                </div>

                <div id="results" class="tab-content" style="display: block;">
                    <h3>Key Results</h3>
                    <div id="results-display">
                        <p id="results-placeholder">Enter inputs and run the simulation to populate metrics.</p>
                    </div>
                    <details class="analysis-details" id="cost-breakdown-details" style="display:none;">
                        <summary>Cost Breakdown (Best Machine Count)</summary>
                        <div id="cost-breakdown-container"></div>
                    </details>
                    <button class="btn btn-secondary" id="export-btn" style="margin-top: 18px;">Export Results</button>
                </div>

                <div id="costs" class="tab-content">
                    <h3>Cost Comparison</h3>
                    <div class="chart-wrapper">
                        <div id="cost-comparison-chart" role="img" aria-label="Cumulative cost comparison"></div>
                        <div class="chart-summary" id="cost-chart-summary"></div>
                    </div>
                    <h4 style="margin-top: 1.2rem;">Scenario Snapshot</h4>
                    <ul id="scenario-summary" class="definition-list"></ul>
                </div>

                <div id="log" class="tab-content">
                    <h3>Representative Year Log</h3>
                    <p class="empty-hint" id="event-log-empty">Run the simulation to view a representative Monte Carlo year.</p>
                    <table style="display:none;" id="event-log-table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Demand (builds)</th>
                                <th>Internal builds</th>
                                <th>Outsourced (internal)</th>
                                <th>Hybrid internal</th>
                                <th>Hybrid outsourced</th>
                                <th>Uptime</th>
                                <th>Downtime?</th>
                                <th>Operator issue?</th>
                                <th>Annual savings</th>
                                <th>Outsourced cost</th>
                                <th>In-house cost</th>
                                <th>Hybrid cost</th>
                            </tr>
                        </thead>
                        <tbody id="event-log-body"></tbody>
                    </table>
                </div>

                <div id="background" class="tab-content">
                    <h3>Underlying Principles</h3>
                    <p id="background-description">General principles and theory will load here from the docstring.</p>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        &copy; 2025 Engineering Tools. All tools are for educational and trade-study purposes. <a class="support-link" href="https://ko-fi.com/transparent_tools" target="_blank" rel="noopener">Support on Ko-fi</a>
</footer>

    <script>
        const TOOL_MODULE_NAME = 'manufacturing';
        const TOOL_FUNCTION_NAME = 'simulate_mjf_breakeven';
        let toolDocumentation = {};
        let pyUtils, pyToolModule;
        let latestResults = null;

        document.querySelectorAll('.tab-link').forEach(button => {
            button.addEventListener('click', () => {
                const target = button.dataset.target;
                document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
                document.getElementById(target).style.display = 'block';
                button.classList.add('active');
            });
        });

        function typesetMath() {
            if (window.MathJax) { window.MathJax.typesetPromise(); }
        }

        async function main() {
            document.getElementById('calculate-btn').textContent = 'Loading Pyodide...';
            const pyodide = await loadPyodide();
            await pyodide.loadPackage('micropip');

            document.getElementById('calculate-btn').textContent = 'Loading Python...';
            await pyodide.runPythonAsync(`
                import micropip
                from pyodide.http import pyfetch

                response_utils = await pyfetch('../../pycalcs/utils.py')
                with open('utils.py', 'w') as f:
                    f.write(await response_utils.string())

                response_tool = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
                with open('${TOOL_MODULE_NAME}.py', 'w') as f:
                    f.write(await response_tool.string())

                import utils
                import ${TOOL_MODULE_NAME}
            `);

            pyUtils = pyodide.globals.get('utils');
            pyToolModule = pyodide.globals.get(TOOL_MODULE_NAME);

            const docMap = pyUtils.get_documentation(TOOL_MODULE_NAME, TOOL_FUNCTION_NAME).toJs();
            if (docMap.has('error')) {
                const errorText = docMap.get('error');
                document.getElementById('results-placeholder').innerHTML = `
                    <p style="color: #b91c1c; font-weight: 600;">Initialization Error</p>
                    <p style="color: #b91c1c;">Docstring parsing failed for ${TOOL_MODULE_NAME}.py</p>
                    <p style="color: #b91c1c; font-size: 0.9em;">${errorText}</p>
                `;
                throw new Error(errorText);
            }

            toolDocumentation = Object.fromEntries(docMap);
            if (toolDocumentation.parameters) {
                toolDocumentation.parameters = Object.fromEntries(toolDocumentation.parameters);
            }
            if (toolDocumentation.returns) {
                toolDocumentation.returns = Object.fromEntries(toolDocumentation.returns);
            }

            populateUiFromDocs();
            document.getElementById('calculate-btn').textContent = 'Calculate';
        }
        main();

        function populateUiFromDocs() {
            if (!toolDocumentation.parameters) return;
            document.getElementById('tool-description').textContent = toolDocumentation.description;

            document.querySelectorAll('.input-group').forEach(group => {
                const param = group.dataset.param;
                const tooltip = group.querySelector('.tooltip-trigger');
                if (param && tooltip && toolDocumentation.parameters[param]) {
                    tooltip.setAttribute('data-tooltip', toolDocumentation.parameters[param]);
                }
            });

            const latexLines = toolDocumentation.latex
                ? toolDocumentation.latex.split('\n').filter(line => line.trim().length > 0)
                : [];
            const legendByEquation = [
                [
                    { symbol: 'C_{\\text{cap}}', description: 'Total capital expenditure (USD)' },
                    { symbol: 'N_m', description: 'Number of installed machines (–)' },
                    { symbol: 'P_0', description: 'Purchase cost per machine (USD)' }
                ],
                [
                    { symbol: 'B_{\\text{int},y}', description: 'Internalised builds in year y (builds)' },
                    { symbol: 'D_y', description: 'Demand in year y (builds)' },
                    { symbol: 'B_{\\max}', description: 'Nominal builds per machine (builds/year)' },
                    { symbol: 'U_y', description: 'Sampled uptime fraction in year y (–)' }
                ],
                [
                    { symbol: 'S_y', description: 'Savings in year y (USD)' },
                    { symbol: 'C_{\\text{ext}}', description: 'External cost per build (USD)' },
                    { symbol: 'C_{\\text{int}}', description: 'Internal variable cost per build (USD)' },
                    { symbol: 'C_{\\text{fix}}', description: 'Fixed annual cost per machine (USD/year)' }
                ],
                [
                    { symbol: 'C_{\\text{cum},y}', description: 'Cumulative cash flow through year y (USD)' },
                    { symbol: 'S_k', description: 'Savings in year k (USD)' },
                    { symbol: 'C_{\\text{cap}}', description: 'Total capital expenditure (USD)' }
                ]
            ];
            const equationCards = latexLines.map((expression, index) => `
                <div class="definition-card">
                    <strong>Equation (${index + 1})</strong>
                    <div class="equation-expression">\\[ ${expression} \\]</div>
                    <ul style="margin-top: 0.45rem; padding-left: 1rem;">
                        ${(legendByEquation[index] || []).map(item => `
                            <li><span class="math-inline">\\(${item.symbol}\\)</span>: ${item.description}</li>
                        `).join('')}
                    </ul>
                </div>
            `).join('');
            document.getElementById('background').innerHTML = `
                <h3>Underlying Principles</h3>
                <p>${toolDocumentation.description.replace(/\n/g, '<br>')}</p>
                <h4>Equations</h4>
                <div class="definition-list">
                    ${equationCards || '<p>No equations provided.</p>'}
                </div>
            `;
            typesetMath();
        }

        const form = document.getElementById('calc-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const purchasePrice = parseFloat(document.getElementById('purchase_price').value);
            const supportCapitalCost = parseFloat(document.getElementById('support_capital_cost').value);
            const machineCounts = (document.getElementById('machine_counts').value || '').trim();
            const analysisYears = parseInt(document.getElementById('analysis_years').value, 10);
            const simulations = parseInt(document.getElementById('simulations').value, 10);
            const annualDemandMean = parseFloat(document.getElementById('annual_demand_mean').value);
            const annualDemandStd = parseFloat(document.getElementById('annual_demand_std').value);
            const maxBuildsPerMachine = parseFloat(document.getElementById('max_builds_per_machine').value);
            const printTimeHours = parseFloat(document.getElementById('print_time_hours').value);
            const cooldownTimeHours = parseFloat(document.getElementById('cooldown_time_hours').value);
            const externalTurnaroundDays = parseFloat(document.getElementById('external_turnaround_days').value);
            const uptimeMean = parseFloat(document.getElementById('uptime_mean').value);
            const uptimeStd = parseFloat(document.getElementById('uptime_std').value);
            const downtimeProb = parseFloat(document.getElementById('downtime_event_probability').value);
            const downtimeImpact = parseFloat(document.getElementById('downtime_event_duration_fraction').value);
            const operatorProb = parseFloat(document.getElementById('operator_issue_probability').value);
            const operatorImpact = parseFloat(document.getElementById('operator_issue_duration_fraction').value);
            const operatorHoursPerBuild = parseFloat(document.getElementById('operator_hours_per_build').value);
            const operatorHoursPerYear = parseFloat(document.getElementById('operator_hours_available_per_year').value);
            const variableInternalCost = parseFloat(document.getElementById('variable_internal_cost').value);
            const externalCost = parseFloat(document.getElementById('external_cost_per_build').value);
            const fixedAnnualCost = parseFloat(document.getElementById('fixed_annual_cost_per_machine').value);
            const supportAnnualOpex = parseFloat(document.getElementById('support_annual_operating_cost').value);
            const hybridOutsourcePercent = parseFloat(document.getElementById('hybrid_outsource_fraction').value);

            const numericInputs = [
                { label: 'printer purchase price', value: purchasePrice },
                { label: 'support capital cost', value: supportCapitalCost },
                { label: 'analysis horizon', value: analysisYears },
                { label: 'Monte Carlo trials', value: simulations },
                { label: 'mean annual demand', value: annualDemandMean },
                { label: 'demand standard deviation', value: annualDemandStd },
                { label: 'nominal builds per machine', value: maxBuildsPerMachine },
                { label: 'print time per build', value: printTimeHours },
                { label: 'cooldown time', value: cooldownTimeHours },
                { label: 'external turnaround', value: externalTurnaroundDays },
                { label: 'mean uptime', value: uptimeMean },
                { label: 'uptime standard deviation', value: uptimeStd },
                { label: 'major downtime probability', value: downtimeProb },
                { label: 'major downtime impact', value: downtimeImpact },
                { label: 'operator issue probability', value: operatorProb },
                { label: 'operator issue impact', value: operatorImpact },
                { label: 'operator hours per build', value: operatorHoursPerBuild },
                { label: 'operator hours per year', value: operatorHoursPerYear },
                { label: 'internal variable cost', value: variableInternalCost },
                { label: 'external cost per build', value: externalCost },
                { label: 'fixed annual cost', value: fixedAnnualCost },
                { label: 'support annual OPEX', value: supportAnnualOpex },
                { label: 'hybrid outsourced share', value: hybridOutsourcePercent }
            ];
            const missingNumeric = numericInputs.find(item => Number.isNaN(item.value));
            if (missingNumeric) {
                alert(`Please enter a value for ${missingNumeric.label}.`);
                return;
            }
            if (!machineCounts) {
                alert('Please provide at least one machine count (e.g., 1,2,3).');
                return;
            }
            if (hybridOutsourcePercent < 0 || hybridOutsourcePercent > 100) {
                alert('Hybrid outsourced share must be between 0 and 100%.');
                return;
            }

            const hybridOutsourceFraction = hybridOutsourcePercent / 100;

            try {
                const resultMap = pyToolModule[TOOL_FUNCTION_NAME](
                    purchasePrice,
                    machineCounts,
                    analysisYears,
                    simulations,
                    annualDemandMean,
                    annualDemandStd,
                    maxBuildsPerMachine,
                    uptimeMean,
                    uptimeStd,
                    variableInternalCost,
                    externalCost,
                    fixedAnnualCost,
                    downtimeProb,
                    downtimeImpact,
                    operatorProb,
                    operatorImpact,
                    printTimeHours,
                    cooldownTimeHours,
                    operatorHoursPerBuild,
                    operatorHoursPerYear,
                    externalTurnaroundDays,
                    supportCapitalCost,
                    supportAnnualOpex,
                    hybridOutsourceFraction
                ).toJs();
                const results = Object.fromEntries(resultMap);

                if (results.error) {
                    throw new Error(results.error);
                }

                latestResults = results;
                const resultsDiv = document.getElementById('results-display');
                resultsDiv.innerHTML = '';
                document.getElementById('results-placeholder')?.remove();

                const returnDefs = toolDocumentation.returns || {};
                const equations = toolDocumentation.latex ? toolDocumentation.latex.split('\n') : [];
                let eqIndex = 0;
                const skipKeys = new Set(['per_machine_summary_json', 'cash_flow_curve_json', 'cost_curve_json', 'representative_event_log_json', 'cost_component_summary_json']);

                for (const key in returnDefs) {
                    if (skipKeys.has(key)) { eqIndex++; continue; }

                    const definition = returnDefs[key];
                    const value = results[key];
                    const substString = results[`subst_${key}`];
                    const equation = equations[eqIndex] || '';
                    const displayName = key.charAt(0).toUpperCase() + key.slice(1).replaceAll('_', ' ');

                    let formattedValue = value;
                    if (typeof value === 'number') {
                        formattedValue = formatNumericValue(key, value);
                    }

                    resultsDiv.innerHTML += `
                        <div class="result-item">
                            <div class="result-header">
                                <p><span class="def" data-def="${definition}">${displayName}</span>: ${formattedValue}</p>
                                <details class="inline-details">
                                    <summary></summary>
                                    <div class="equation-details">
                                        <p><strong>Equation:</strong> $$${equation}$$</p>
                                        ${substString ? `<p><strong>Substituted:</strong> $$${substString}$$</p>` : ''}
                                    </div>
                                </details>
                            </div>
                        </div>
                    `;
                    eqIndex++;
                }
                typesetMath();

                renderMachineSummary(results.per_machine_summary_json, results.hybrid_outsource_fraction);
                renderCostComparison(results.cost_curve_json, results.hybrid_outsource_fraction);
                renderCostBreakdown(results.cost_component_summary_json, results.hybrid_outsource_fraction);
                renderEventLog(results.representative_event_log_json);
            } catch (error) {
                console.error('Python calculation error:', error);
                document.getElementById('results-display').innerHTML = `<p style="color: #b91c1c; font-weight:bold;">Calculation Error</p><p style="color: #b91c1c;">${error.message}</p>`;
            }
        });

        function formatNumericValue(key, value) {
            if (value === null || value === undefined) return '—';
            if (!Number.isFinite(value)) {
                return 'Not achieved within horizon';
            }
            if (key.includes('fraction')) {
                return formatPercent(value);
            }
            if (key.includes('probability')) {
                return formatPercent(value);
            }
            if (key.includes('savings')) {
                return formatCurrency(value);
            }
            if (key.includes('builds')) {
                return formatBuilds(value);
            }
            if (key.includes('years')) {
                return `${value.toLocaleString(undefined, { maximumFractionDigits: 2 })} years`;
            }
            if (key.includes('turnaround')) {
                return `${value.toLocaleString(undefined, { maximumFractionDigits: 2 })} days`;
            }
            if (key.includes('cycle_time')) {
                return `${value.toLocaleString(undefined, { maximumFractionDigits: 2 })} hours`;
            }
            return value.toLocaleString(undefined, { maximumFractionDigits: 2 });
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || !Number.isFinite(Number(value))) return '—';
            return `$${Number(value).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
        }

        function formatPercent(value) {
            if (value === null || value === undefined || !Number.isFinite(Number(value))) return '—';
            return `${(Number(value) * 100).toFixed(1)}%`;
        }

        function formatYears(value) {
            if (value === null || value === undefined || !Number.isFinite(Number(value))) return 'Not achieved';
            return `${Number(value).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
        }

        function formatBuilds(value) {
            if (value === null || value === undefined || !Number.isFinite(Number(value))) return '—';
            return `${Number(value).toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
        }

        function renderMachineSummary(summaryJson, hybridFraction) {
            const container = document.getElementById('scenario-summary');
            container.innerHTML = '';
            if (!summaryJson) {
                container.innerHTML = '<p class="empty-hint">Summary data unavailable.</p>';
                return;
            }
            try {
                const data = JSON.parse(summaryJson);
                if (!data.length) {
                    container.innerHTML = '<p class="empty-hint">Summary data unavailable.</p>';
                    return;
                }
                container.innerHTML = data.map(item => `
                    <li class="definition-card">
                        <strong>${item.machine_count} machine${item.machine_count > 1 ? 's' : ''}</strong><br>
                        Mean savings: ${formatCurrency(item.mean_annual_savings)}<br>
                        P10–P90: ${formatCurrency(item.savings_p10)} to ${formatCurrency(item.savings_p90)}<br>
                        Break-even: ${formatPercent(item.probability_break_even)} · Mean year: ${formatYears(item.mean_break_even_years)}
                    </li>
                `).join('');
                if (hybridFraction !== undefined) {
                    container.innerHTML += `
                        <li class="definition-card">
                            <strong>Hybrid target</strong><br>
                            ${formatPercent(hybridFraction)} of annual demand forced to remain outsourced.
                        </li>`;
                }
            } catch (error) {
                console.error('Summary parse error', error);
                container.innerHTML = '<p class="empty-hint">Unable to parse scenario summary.</p>';
            }
        }

        function renderCostComparison(curveJson, hybridFraction) {
            const chart = document.getElementById('cost-comparison-chart');
            const summary = document.getElementById('cost-chart-summary');
            summary.innerHTML = '';
            if (!curveJson) {
                chart.innerHTML = '';
                summary.innerHTML = '<p class="empty-hint">Run the simulation to view cost trajectories.</p>';
                return;
            }
            let data;
            try {
                data = JSON.parse(curveJson);
            } catch (error) {
                console.error('Cost curve parse error', error);
                summary.innerHTML = '<p class="empty-hint">Unable to parse cost curve data.</p>';
                return;
            }
            const years = data.years || [];
            if (!years.length) {
                summary.innerHTML = '<p class="empty-hint">Cost data not available.</p>';
                return;
            }
            const outsourced = (data.outsourced || []).map(val => val === null ? null : Number(val));
            const inHouse = (data.in_house || []).map(val => val === null ? null : Number(val));
            const hybrid = (data.hybrid || []).map(val => val === null ? null : Number(val));

            const traces = [
                {
                    x: years,
                    y: outsourced,
                    name: 'Outsourced only',
                    mode: 'lines+markers',
                    line: { color: '#9ca3af', width: 3 }
                },
                {
                    x: years,
                    y: inHouse,
                    name: 'In-house (best machine count)',
                    mode: 'lines+markers',
                    line: { color: '#2563eb', width: 3 }
                },
                {
                    x: years,
                    y: hybrid,
                    name: `Hybrid mix (${formatPercent(hybridFraction)})`,
                    mode: 'lines+markers',
                    line: { color: '#059669', width: 3, dash: 'dash' }
                }
            ];

            const layout = {
                margin: { l: 60, r: 20, t: 20, b: 50 },
                paper_bgcolor: '#f1f5fb',
                plot_bgcolor: '#f1f5fb',
                xaxis: { title: 'Analysis year', dtick: 1 },
                yaxis: { title: 'Cumulative cost (USD)', tickprefix: '$', separatethousands: true },
                legend: { orientation: 'h', x: 0, y: 1.15 },
            };

            Plotly.newPlot(chart, traces, layout, { displayModeBar: false, responsive: true });

            const lastIndex = years.length - 1;
            const outsourcedFinal = outsourced[lastIndex];
            const inHouseFinal = inHouse[lastIndex];
            const hybridFinal = hybrid[lastIndex];
            if (Number.isFinite(outsourcedFinal) && Number.isFinite(inHouseFinal)) {
                const deltaInternal = outsourcedFinal - inHouseFinal;
                summary.innerHTML += `<p><strong>Final year delta (outsourced – in-house):</strong> ${formatCurrency(deltaInternal)}</p>`;
            }
            if (Number.isFinite(outsourcedFinal) && Number.isFinite(hybridFinal)) {
                const deltaHybrid = outsourcedFinal - hybridFinal;
                summary.innerHTML += `<p><strong>Final year delta (outsourced – hybrid):</strong> ${formatCurrency(deltaHybrid)}</p>`;
            }
        }

        function renderCostBreakdown(summaryJson, hybridFraction) {
            const details = document.getElementById('cost-breakdown-details');
            const container = document.getElementById('cost-breakdown-container');
            if (!summaryJson) {
                details.style.display = 'none';
                container.innerHTML = '';
                return;
            }
            try {
                const data = JSON.parse(summaryJson);
                if (!Object.keys(data).length) {
                    details.style.display = 'none';
                    container.innerHTML = '';
                    return;
                }
                const rows = [
                    ['Capital (one-time)', formatCurrency(data.capital)],
                    ['Variable (internal builds)', formatCurrency(data.internal_variable)],
                    ['Fixed + support OPEX', formatCurrency(data.internal_fixed)],
                    ['Residual outsourcing', formatCurrency(data.internal_outsourced)],
                    ['Baseline outsourced cost', formatCurrency(data.baseline_total)],
                    ['Hybrid variable', formatCurrency(data.hybrid_variable)],
                    ['Hybrid fixed + OPEX', formatCurrency(data.hybrid_fixed)],
                    ['Hybrid outsourcing', formatCurrency(data.hybrid_outsourced)]
                ];
                const internalShare = data.internal_outsource_share ?? 0;
                const hybridShare = data.hybrid_outsource_share ?? hybridFraction;

                container.innerHTML = `
                    <table>
                        <tbody>
                            ${rows.map(([label, value]) => `
                                <tr>
                                    <th>${label}</th>
                                    <td>${value}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top:0.8rem;">Internal strategy outsources ${formatPercent(internalShare)} of demand on average. Hybrid strategy outsources ${formatPercent(hybridShare)} on average.</p>
                `;
                details.style.display = 'block';
            } catch (error) {
                console.error('Cost breakdown parse error', error);
                details.style.display = 'none';
                container.innerHTML = '';
            }
        }

        function renderEventLog(logJson) {
            const table = document.getElementById('event-log-table');
            const emptyHint = document.getElementById('event-log-empty');
            const tbody = document.getElementById('event-log-body');
            tbody.innerHTML = '';
            if (!logJson) {
                table.style.display = 'none';
                emptyHint.style.display = 'block';
                return;
            }
            let log;
            try {
                log = JSON.parse(logJson) || [];
            } catch (error) {
                console.error('Event log parse error', error);
                table.style.display = 'none';
                emptyHint.style.display = 'block';
                emptyHint.textContent = 'Unable to parse event log.';
                return;
            }
            if (!log.length) {
                table.style.display = 'none';
                emptyHint.style.display = 'block';
                emptyHint.textContent = 'Event log not available.';
                return;
            }

            emptyHint.style.display = 'none';
            table.style.display = 'table';
            tbody.innerHTML = log.map(entry => `
                <tr>
                    <td>${entry.year}</td>
                    <td>${formatBuilds(entry.demand_builds)}</td>
                    <td>${formatBuilds(entry.internal_builds)}</td>
                    <td>${formatBuilds(entry.outsourced_builds)}</td>
                    <td>${formatBuilds(entry.hybrid_internal_builds)}</td>
                    <td>${formatBuilds(entry.hybrid_outsourced_builds)}</td>
                    <td>${formatPercent(entry.uptime_fraction)}</td>
                    <td>${entry.downtime_event ? 'Yes' : 'No'}</td>
                    <td>${entry.operator_issue ? 'Yes' : 'No'}</td>
                    <td>${formatCurrency(entry.annual_savings)}</td>
                    <td>${formatCurrency(entry.baseline_cumulative_cost)}</td>
                    <td>${formatCurrency(entry.internal_cumulative_cost)}</td>
                    <td>${formatCurrency(entry.hybrid_cumulative_cost)}</td>
                </tr>
            `).join('');
        }

        document.getElementById('export-btn').addEventListener('click', () => {
            if (!latestResults) {
                alert('Run the simulation before exporting results.');
                return;
            }
            const payload = {
                generated_at: new Date().toISOString(),
                tool: 'MJF Buy vs. Outsource Simulator',
                docstring_description: toolDocumentation.description,
                results: latestResults
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'mjf-buy-vs-outsource-results.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>

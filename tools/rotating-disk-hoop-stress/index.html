<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YG3SBRRZFZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-YG3SBRRZFZ');
    </script>

    <title>Rotating Disk Hoop Stress - Engineering Tools</title>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <style>
        :root {
            --primary-color: #0b0d12;
            --primary-light: #f4f5f7;
            --secondary-color: #4b5563;
            --accent-color: #111827;
            --success-color: #0f766e;
            --warning-color: #b45309;
            --danger-color: #b91c1c;
            --text-color: #111827;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
            --bg-color: #f8f9fb;
            --bg-card: #ffffff;
            --shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 6px 18px rgba(15, 23, 42, 0.08);
            --border-radius: 8px;
            --font-sans: 'Helvetica Neue', 'Avenir Next', 'Univers', 'Helvetica', sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: var(--font-sans);
            line-height: 1.6;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }
        .container { width: 92%; max-width: 1400px; margin: 0 auto; padding: 24px 0; }
        h1, h2, h3, h4 { color: var(--primary-color); margin-bottom: 0.75em; line-height: 1.2; font-weight: 600; }
        h1 { font-size: 2.25rem; letter-spacing: -0.01em; }
        h2 { font-size: 1.35rem; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 1rem; }
        h3 { font-size: 1.05rem; color: var(--secondary-color); }
        h4 { font-size: 0.95rem; color: var(--text-color); }
        p { margin-bottom: 1em; color: var(--text-light); }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }

        .navbar { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); box-shadow: none; padding: 0 5%; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; height: 64px; max-width: 1400px; margin: 0 auto; }
        .nav-brand { font-size: 1.35rem; font-weight: 600; color: var(--text-color); }
        .nav-brand:hover { text-decoration: none; }

        main.container { flex-grow: 1; }
        .tool-description { font-size: 1.05rem; max-width: 75ch; margin-bottom: 0.75rem; }
        .tool-layout { display: grid; grid-template-columns: minmax(280px, 1fr) minmax(320px, 1.25fr); gap: 18px; align-items: start; }
        .card { background-color: var(--bg-card); border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); padding: 18px; }

        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .purpose-section { margin-bottom: 2rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--bg-card); }
        .purpose-section summary { padding: 16px 24px; font-size: 1.1rem; font-weight: 600; color: var(--secondary-color); }
        .purpose-section summary::after { content: '[Expand]'; float: right; font-size: 0.9rem; font-weight: 500; color: var(--text-light); }
        .purpose-section[open] > summary::after { content: '[Shrink]'; }
        .purpose-content { padding: 0 24px 24px 24px; border-top: 1px solid var(--border-color); }
        .purpose-content h3 { margin-top: 1rem; }
        .purpose-content code { background-color: var(--bg-color); padding: 2px 4px; border-radius: 4px; }
        .purpose-content ul { padding-left: 20px; }

        .tool-inputs h2 { margin-top: 0; margin-bottom: 0.5rem; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px 16px; }
        .input-group { position: relative; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 0.85rem; color: var(--secondary-color); }
        .input-group input[type="number"], .input-group input[type="text"], .input-group select {
            width: 100%;
            padding: 10px 12px;
            padding-right: 34px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fff;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--text-color);
            box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.08);
        }
        .input-group select {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: none;
        }
        .input-group input[type="number"]::-webkit-inner-spin-button,
        .input-group input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .input-group input[type="number"] { -moz-appearance: textfield; }

        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: #f1f5f9;
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 50%;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            line-height: 18px;
            cursor: help;
            position: absolute;
            right: 6px;
            top: 34px;
        }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.5;
            white-space: normal;
            width: 220px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
            box-shadow: var(--shadow-lg);
        }
        .tooltip-trigger:hover::after { opacity: 1; visibility: visible; }

        .btn { display: inline-block; padding: 10px 16px; font-size: 1rem; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; text-align: center; transition: background-color 0.2s, box-shadow 0.2s; }
        .btn-primary { background-color: var(--text-color); color: white; width: 100%; font-size: 1.05rem; padding: 10px; margin-top: 8px; }
        .btn-primary:hover { background-color: #050608; }

        .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px; padding-bottom: 4px; }
        .tab-link {
            padding: 10px 12px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab-link:hover { color: var(--text-color); }
        .tab-link.active { color: var(--text-color); border-bottom-color: var(--text-color); }
        .tab-content { display: none; animation: fadeIn 0.35s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #results-display { background-color: var(--primary-light); border-radius: 6px; padding: 14px; margin-bottom: 1rem; }
        .status-banner {
            border-left: 4px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 10px;
            background: #fff;
        }
        .status-banner.acceptable { border-left-color: var(--success-color); }
        .status-banner.marginal { border-left-color: var(--warning-color); }
        .status-banner.unacceptable { border-left-color: var(--danger-color); }
        .status-banner strong { color: var(--text-color); }

        .result-item { padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .result-item:last-child { border-bottom: none; padding-bottom: 0; }
        .result-item:first-child { padding-top: 0; }
        .result-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .result-header p { margin: 0; font-size: 1rem; }
        .result-header p strong { color: var(--text-color); }
        details.inline-details > summary { color: var(--secondary-color); font-weight: 500; font-size: 0.85rem; }
        details.inline-details > summary::after { content: '[Show Equation]'; }
        details.inline-details[open] > summary::after { content: '[Hide Equation]'; }
        .equation-details { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; margin-top: 10px; }
        .equation-details p { margin-bottom: 0.4rem; }

        #plot-container {
            width: 100%;
            min-height: 380px;
            background-color: var(--primary-light);
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            padding: 10px;
        }
        #cross-section-container {
            width: 100%;
            background-color: var(--primary-light);
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 12px;
        }
        #cross-section-svg {
            width: 100%;
            height: 260px;
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        #stress-plot-svg {
            width: 100%;
            height: 360px;
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .equation-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 0.75rem;
        }
        .equation-card {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px 14px;
        }
        .equation-card strong {
            display: block;
            margin-bottom: 6px;
            color: var(--secondary-color);
            font-size: 0.95rem;
        }
        .equation-meta {
            display: inline-block;
            margin-bottom: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.74rem;
            color: #1f2937;
            background: #e9edf4;
        }
        .equation-card .equation-expression {
            display: block;
            margin-bottom: 6px;
        }
        .equation-card ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
            display: grid;
            gap: 6px 16px;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            font-size: 0.82rem;
            color: var(--text-light);
        }
        .equation-card .math-inline {
            font-weight: 600;
            color: var(--secondary-color);
        }
        .references-section {
            margin-top: 12px;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: #fff;
        }
        .references-section h4 {
            margin-bottom: 6px;
        }
        .references-section ol {
            margin: 0;
            padding-left: 20px;
        }
        .references-section li {
            margin-bottom: 6px;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .recommendations { margin-top: 6px; padding-left: 20px; }
        .recommendations li { margin-bottom: 4px; color: var(--text-color); }

        .footer { text-align: center; padding: 20px 0; background-color: var(--bg-card); border-top: 1px solid var(--border-color); color: var(--text-light); font-size: 0.9rem; margin-top: 30px; }

        @media (max-width: 900px) {
            .tool-layout { grid-template-columns: 1fr; }
            .input-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            .card { padding: 16px; }
        }
        @media (max-width: 600px) {
            .tabs { flex-wrap: wrap; }
            .tab-link { flex: 1 1 45%; text-align: center; }
        }

        .support-link {
            color: inherit;
            font-weight: 600;
            text-decoration: none;
        }

        .support-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <header class="navbar">
        <nav class="nav-container">
            <a href="../../index.html" class="nav-brand">Engineering Tools</a>
        </nav>
    </header>

    <main class="container">

        <h1>Rotating Disk Hoop Stress</h1>
        <p class="tool-description" id="tool-description">
            Prototype calculator for hoop/radial stress in solid disks, annular disks, and thin rings using Shigley-style closed-form relations.
        </p>

        <details class="purpose-section">
            <summary>Tool Purpose & README</summary>
            <div class="purpose-content" id="readme-content">
                <h3>Prototype Scope</h3>
                <p>
                    This tool estimates stress and speed margin for high-speed rotors. It is intended for
                    first-pass sizing and sanity checks before detailed FEA.
                </p>
                <ul>
                    <li>Geometry options: solid disk, annular disk, thin ring.</li>
                    <li>Outputs include stress maxima, safety factor, allowable speed, and stress profile.</li>
                    <li>Assumes isotropic material, constant thickness, and elastic behavior.</li>
                </ul>
                <h3>Primary References</h3>
                <ul>
                    <li>Budynas and Nisbett, <em>Shigley's Mechanical Engineering Design</em> (rotating disk/ring stress).</li>
                    <li>Timoshenko and Goodier, <em>Theory of Elasticity</em> (axisymmetric rotating disk solutions).</li>
                </ul>
            </div>
        </details>

        <div class="tool-layout">
            <section class="tool-inputs card">
                <h2>Inputs</h2>
                <form id="calc-form">
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="geometry_type">Geometry</label>
                            <select id="geometry_type" name="geometry_type">
                                <option value="solid_disk">Solid Disk</option>
                                <option value="annular_disk">Annular Disk</option>
                                <option value="thin_ring">Thin Ring (Approx.)</option>
                            </select>
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="inner_radius_mm">Inner Radius (mm)</label>
                            <input type="number" id="inner_radius_mm" name="inner_radius_mm" value="0" step="any" min="0">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="outer_radius_mm">Outer Radius (mm)</label>
                            <input type="number" id="outer_radius_mm" name="outer_radius_mm" value="120" step="any" min="0.1">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="thickness_mm">Thickness (mm)</label>
                            <input type="number" id="thickness_mm" name="thickness_mm" value="10" step="any" min="0.1">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="density_kg_m3">Density (kg/m^3)</label>
                            <input type="number" id="density_kg_m3" name="density_kg_m3" value="7800" step="any" min="1">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="poisson_ratio">Poisson Ratio</label>
                            <input type="number" id="poisson_ratio" name="poisson_ratio" value="0.30" step="any" min="0" max="0.49">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="speed_rpm">Speed (rpm)</label>
                            <input type="number" id="speed_rpm" name="speed_rpm" value="12000" step="any" min="1">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="yield_strength_mpa">Yield Strength (MPa)</label>
                            <input type="number" id="yield_strength_mpa" name="yield_strength_mpa" value="350" step="any" min="1">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="required_safety_factor">Required Safety Factor</label>
                            <input type="number" id="required_safety_factor" name="required_safety_factor" value="1.50" step="any" min="1.0">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>

                        <div class="input-group">
                            <label for="profile_points">Profile Points</label>
                            <input type="number" id="profile_points" name="profile_points" value="81" step="1" min="21" max="401">
                            <span class="tooltip-trigger" data-tooltip="Loading...">?</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="calculate-btn">Calculate</button>
                </form>
            </section>

            <section class="tool-outputs card">
                <div class="tabs">
                    <button class="tab-link active" onclick="openTab(event, 'results')">Results</button>
                    <button class="tab-link" onclick="openTab(event, 'plot')">Visualization</button>
                    <button class="tab-link" onclick="openTab(event, 'background')">Background</button>
                </div>

                <div id="results" class="tab-content" style="display: block;">
                    <h3>Key Results</h3>
                    <div id="results-display">
                        <p id="results-placeholder">Please enter inputs and press Calculate.</p>
                    </div>
                </div>

                <div id="plot" class="tab-content">
                    <h3>Cross-Section Preview</h3>
                    <div id="cross-section-container">
                        <svg id="cross-section-svg" viewBox="0 0 760 260" role="img" aria-label="Rotor cross-section preview"></svg>
                    </div>
                    <h3>Stress Distribution</h3>
                    <div id="plot-container">
                        <svg id="stress-plot-svg" viewBox="0 0 760 360" role="img" aria-label="Stress profile plot"></svg>
                    </div>
                </div>

                <div id="background" class="tab-content">
                    <h3>Theory</h3>
                    <p>Loading equations...</p>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Engineering Tools. All tools are for educational purposes. <a class="support-link" href="https://ko-fi.com/transparent_tools" target="_blank" rel="noopener">Support on Ko-fi</a></p>
    </footer>

    <script>
        let toolDocumentation = {};
        let pyUtils, pyToolModule;

        const TOOL_MODULE_NAME = 'rotor_stress';
        const TOOL_FUNCTION_NAME = 'calculate_rotor_hoop_stress';
        const PARAM_IDS = [
            'geometry_type',
            'inner_radius_mm',
            'outer_radius_mm',
            'thickness_mm',
            'density_kg_m3',
            'poisson_ratio',
            'speed_rpm',
            'yield_strength_mpa',
            'required_safety_factor',
            'profile_points'
        ];
        const PREVIEW_PARAM_IDS = [
            'geometry_type',
            'inner_radius_mm',
            'outer_radius_mm',
            'thickness_mm'
        ];

        function openTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.currentTarget.classList.add('active');
            typesetMath();
        }

        function typesetMath() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise();
            }
        }

        function toPlainObject(value) {
            if (value instanceof Map) {
                const obj = {};
                value.forEach((v, k) => {
                    obj[k] = toPlainObject(v);
                });
                return obj;
            }
            if (Array.isArray(value)) {
                return value.map(item => toPlainObject(item));
            }
            return value;
        }

        function format(value, decimals = 3) {
            if (!Number.isFinite(value)) return 'N/A';
            return Number(value).toFixed(decimals);
        }

        function formatScientific(value, decimals = 3) {
            if (!Number.isFinite(value)) return 'N/A';
            if (Math.abs(value) >= 1e4 || (Math.abs(value) > 0 && Math.abs(value) < 1e-2)) {
                return Number(value).toExponential(decimals);
            }
            return Number(value).toFixed(decimals);
        }

        function clamp(value, minValue, maxValue) {
            return Math.min(maxValue, Math.max(minValue, value));
        }

        function getNumber(id, fallback) {
            const value = parseFloat(document.getElementById(id).value);
            return Number.isFinite(value) ? value : fallback;
        }

        function getCrossSectionConfig() {
            const geometryType = document.getElementById('geometry_type').value;
            const outerRadiusMm = Math.max(0.1, getNumber('outer_radius_mm', 120));
            const innerInput = getNumber('inner_radius_mm', 0);
            const innerRadiusMm = geometryType === 'solid_disk'
                ? 0
                : clamp(innerInput, 0, outerRadiusMm - 0.1);
            const thicknessMm = Math.max(0.1, getNumber('thickness_mm', 10));

            return {
                geometryType,
                innerRadiusMm,
                outerRadiusMm,
                thicknessMm
            };
        }

        function buildSectionPolygon(sideSign, rStartMm, rEndMm, thicknessMm, centerX, centerY, scalePxPerMm) {
            if (rEndMm <= rStartMm) return '';

            const yTop = centerY - 0.5 * thicknessMm * scalePxPerMm;
            const yBottom = centerY + 0.5 * thicknessMm * scalePxPerMm;
            const xInner = centerX + sideSign * rStartMm * scalePxPerMm;
            const xOuter = centerX + sideSign * rEndMm * scalePxPerMm;

            return [
                `${xInner.toFixed(2)},${yTop.toFixed(2)}`,
                `${xOuter.toFixed(2)},${yTop.toFixed(2)}`,
                `${xOuter.toFixed(2)},${yBottom.toFixed(2)}`,
                `${xInner.toFixed(2)},${yBottom.toFixed(2)}`
            ].join(' ');
        }

        function renderCrossSectionPreview() {
            const svg = document.getElementById('cross-section-svg');
            if (!svg) return;

            const config = getCrossSectionConfig();
            const w = 760;
            const h = 260;
            const marginX = 40;
            const centerX = w / 2;
            const centerY = h / 2;
            const scalePxPerMm = (0.5 * w - marginX) / Math.max(config.outerRadiusMm, 1);

            const radialMarkerY = h - 24;
            const thicknessMarkerY = centerY + 0.5 * config.thicknessMm * scalePxPerMm + 22;

            const sidePolygons = [];
            for (const side of [1, -1]) {
                const points = buildSectionPolygon(
                    side,
                    config.innerRadiusMm,
                    config.outerRadiusMm,
                    config.thicknessMm,
                    centerX,
                    centerY,
                    scalePxPerMm
                );
                if (points) {
                    sidePolygons.push(
                        `<polygon points="${points}" fill="#d7dde8" stroke="#111827" stroke-width="1.3" />`
                    );
                }
            }

            const innerPx = config.innerRadiusMm * scalePxPerMm;
            const outerPx = config.outerRadiusMm * scalePxPerMm;

            const boreHighlight = config.innerRadiusMm > 0
                ? `<rect x="${(centerX - innerPx).toFixed(2)}" y="16" width="${(2 * innerPx).toFixed(2)}" height="${(h - 32).toFixed(2)}" fill="rgba(255,255,255,0.92)" stroke="#cbd5e1" stroke-dasharray="4 3"/>`
                : '';

            const geometryLabel = config.geometryType === 'solid_disk'
                ? 'solid disk'
                : config.geometryType === 'annular_disk'
                    ? 'annular disk'
                    : 'thin ring';

            svg.innerHTML = `
                <rect x="0" y="0" width="${w}" height="${h}" fill="#ffffff" />
                <line x1="0" y1="${centerY}" x2="${w}" y2="${centerY}" stroke="#64748b" stroke-width="1.1" stroke-dasharray="6 4" />
                <text x="${w - 170}" y="${centerY - 6}" font-size="11" fill="#475569">Rotation axis</text>

                ${boreHighlight}
                ${sidePolygons.join('')}

                <line x1="${centerX}" y1="${radialMarkerY}" x2="${(centerX + outerPx).toFixed(2)}" y2="${radialMarkerY}" stroke="#0f766e" stroke-width="1.2" />
                <text x="${(centerX + outerPx / 2).toFixed(2)}" y="${radialMarkerY - 4}" font-size="11" fill="#0f766e" text-anchor="middle">r_o = ${format(config.outerRadiusMm, 1)} mm</text>

                ${config.innerRadiusMm > 0
                    ? `<line x1="${centerX}" y1="${radialMarkerY + 14}" x2="${(centerX + innerPx).toFixed(2)}" y2="${radialMarkerY + 14}" stroke="#b45309" stroke-width="1.2" />
                       <text x="${(centerX + innerPx / 2).toFixed(2)}" y="${radialMarkerY + 10}" font-size="11" fill="#b45309" text-anchor="middle">r_i = ${format(config.innerRadiusMm, 1)} mm</text>`
                    : ''
                }

                <line x1="${(centerX + outerPx + 12).toFixed(2)}" y1="${(centerY - 0.5 * config.thicknessMm * scalePxPerMm).toFixed(2)}" x2="${(centerX + outerPx + 12).toFixed(2)}" y2="${(centerY + 0.5 * config.thicknessMm * scalePxPerMm).toFixed(2)}" stroke="#111827" stroke-width="1.1" />
                <text x="${(centerX + outerPx + 18).toFixed(2)}" y="${thicknessMarkerY.toFixed(2)}" font-size="11" fill="#111827">t = ${format(config.thicknessMm, 1)} mm</text>

                <text x="14" y="20" font-size="11" fill="#475569">Model geometry: ${geometryLabel} (closed-form)</text>
            `;
        }

        function updateGeometryControls() {
            const geometry = document.getElementById('geometry_type').value;
            const innerInput = document.getElementById('inner_radius_mm');
            const outerRadius = Math.max(0.1, getNumber('outer_radius_mm', 120));

            if (geometry === 'solid_disk') {
                innerInput.value = '0';
                innerInput.disabled = true;
            } else {
                innerInput.disabled = false;
                if (Number(innerInput.value) <= 0) {
                    innerInput.value = (0.3 * outerRadius).toFixed(1);
                }
            }

            renderCrossSectionPreview();
        }

        async function main() {
            const calcBtn = document.getElementById('calculate-btn');
            calcBtn.textContent = 'Loading Pyodide...';
            calcBtn.disabled = true;

            try {
                const pyodide = await loadPyodide();
                await pyodide.loadPackage('micropip');

                calcBtn.textContent = 'Loading Python...';
                await pyodide.runPythonAsync(`
                    from pyodide.http import pyfetch

                    response_utils = await pyfetch('../../pycalcs/utils.py')
                    with open('utils.py', 'w') as f:
                        f.write(await response_utils.string())

                    response_tool = await pyfetch('../../pycalcs/${TOOL_MODULE_NAME}.py')
                    with open('${TOOL_MODULE_NAME}.py', 'w') as f:
                        f.write(await response_tool.string())

                    import utils
                    import ${TOOL_MODULE_NAME}
                `);

                pyUtils = pyodide.globals.get('utils');
                pyToolModule = pyodide.globals.get(TOOL_MODULE_NAME);

                const docMap = pyUtils.get_documentation(TOOL_MODULE_NAME, TOOL_FUNCTION_NAME).toJs();
                if (docMap.has('error')) {
                    throw new Error(docMap.get('error'));
                }

                toolDocumentation = Object.fromEntries(docMap);
                if (toolDocumentation.parameters) {
                    toolDocumentation.parameters = Object.fromEntries(toolDocumentation.parameters);
                }

                populateUiFromDocs();
                updateGeometryControls();

                calcBtn.textContent = 'Calculate';
                calcBtn.disabled = false;
            } catch (error) {
                document.getElementById('results-display').innerHTML = `<p style="color: red; font-weight: bold;">Initialization Error: ${error.message}</p>`;
                console.error(error);
            }
        }

        function populateUiFromDocs() {
            if (!toolDocumentation.parameters) return;

            for (const paramId of PARAM_IDS) {
                const tooltip = document.querySelector(`#${paramId} + .tooltip-trigger`);
                if (tooltip && toolDocumentation.parameters[paramId]) {
                    tooltip.setAttribute('data-tooltip', toolDocumentation.parameters[paramId]);
                }
            }

            const equationLines = (toolDocumentation.latex || '')
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0 && line.includes('='));

            const equationScope = [
                'All geometries',
                'Solid disk model',
                'Solid disk model',
                'Annular disk model',
                'Annular disk model',
                'Thin ring model',
                'All geometries',
                'All geometries',
                'All geometries'
            ];

            const legends = [
                [
                    { symbol: 'n', desc: 'rotational speed (rpm)' },
                    { symbol: '\\omega', desc: 'angular speed (rad/s)' }
                ],
                [
                    { symbol: '\\sigma_{r,\\text{solid}}', desc: 'radial stress in solid disk' },
                    { symbol: 'r_o', desc: 'outer radius' },
                    { symbol: 'r', desc: 'local radius' },
                    { symbol: '\\rho', desc: 'density' },
                    { symbol: '\\nu', desc: 'Poisson ratio' }
                ],
                [
                    { symbol: '\\sigma_{\\theta,\\text{solid}}', desc: 'hoop stress in solid disk' },
                    { symbol: 'r_o', desc: 'outer radius' },
                    { symbol: 'r', desc: 'local radius' },
                    { symbol: '\\rho', desc: 'density' },
                    { symbol: '\\nu', desc: 'Poisson ratio' }
                ],
                [
                    { symbol: '\\sigma_{r,\\text{ann}}', desc: 'radial stress in annular disk' },
                    { symbol: 'r_i', desc: 'inner radius' },
                    { symbol: 'r_o', desc: 'outer radius' },
                    { symbol: 'r', desc: 'local radius' }
                ],
                [
                    { symbol: '\\sigma_{\\theta,\\text{ann}}', desc: 'hoop stress in annular disk' },
                    { symbol: 'r_i', desc: 'inner radius' },
                    { symbol: 'r_o', desc: 'outer radius' },
                    { symbol: 'r', desc: 'local radius' }
                ],
                [
                    { symbol: '\\sigma_{\\theta,\\text{ring}}', desc: 'thin-ring hoop stress' },
                    { symbol: 'r_m', desc: 'mean ring radius' },
                    { symbol: '\\rho', desc: 'density' },
                    { symbol: '\\omega', desc: 'angular speed' }
                ],
                [
                    { symbol: '\\sigma_{vm}', desc: 'von Mises equivalent stress' },
                    { symbol: '\\sigma_r', desc: 'radial stress' },
                    { symbol: '\\sigma_{\\theta}', desc: 'hoop stress' }
                ],
                [
                    { symbol: 'SF_y', desc: 'yield safety factor' },
                    { symbol: 'S_y', desc: 'yield strength' },
                    { symbol: '\\sigma_{vm,max}', desc: 'maximum von Mises stress' }
                ],
                [
                    { symbol: 'n_{allow}', desc: 'allowable speed for selected safety factor' },
                    { symbol: 'SF_{req}', desc: 'required safety factor' },
                    { symbol: 'n', desc: 'current speed' }
                ]
            ];

            const cards = equationLines.map((eq, idx) => {
                const legendItems = legends[idx] || [];
                const legendHtml = legendItems.length
                    ? legendItems
                        .map(item => `<li><span class="math-inline">\\(${item.symbol}\\)</span>: ${item.desc}</li>`)
                        .join('')
                    : '<li><span class="math-inline">\\(\\cdot\\)</span>: see equation terms</li>';
                return `
                    <div class="equation-card">
                        <strong>Equation (${idx + 1})</strong>
                        <span class="equation-meta">${equationScope[idx] || 'Model relation'}</span>
                        <span class="equation-expression">\\[ ${eq} \\]</span>
                        <ul>${legendHtml}</ul>
                    </div>
                `;
            }).join('');

            const references = [
                "Budynas, R. G., and Nisbett, J. K. <em>Shigley's Mechanical Engineering Design</em>. Rotating rings and disks.",
                'Timoshenko, S. P., and Goodier, J. N. <em>Theory of Elasticity</em>. Axisymmetric rotating disk solutions.',
                'Boresi, A. P., and Schmidt, R. J. <em>Advanced Mechanics of Materials</em>. Plane-stress von Mises relations.'
            ];
            const referenceList = references.map(item => `<li>${item}</li>`).join('');

            document.getElementById('background').innerHTML = `
                <h3>Background & Equations</h3>
                <p>
                    Equations are classical closed-form axisymmetric elasticity relations for isotropic,
                    constant-thickness rotors at steady speed.
                </p>
                <div class="equation-container">${cards}</div>
                <div class="references-section">
                    <h4>References</h4>
                    <ol>${referenceList}</ol>
                </div>
            `;
            typesetMath();
        }

        function buildResultRow(label, value, unit, subst) {
            const safeSub = subst ? `<details class="inline-details"><summary></summary><div class="equation-details"><p>$$${subst}$$</p></div></details>` : '';
            return `
                <div class="result-item">
                    <div class="result-header">
                        <p><strong>${label}:</strong> ${value}${unit ? ` ${unit}` : ''}</p>
                        ${safeSub}
                    </div>
                </div>
            `;
        }

        function renderResults(results) {
            const banner = `
                <div class="status-banner ${results.status}">
                    <p><strong>Status:</strong> ${results.status}</p>
                </div>
            `;

            const rows = [
                buildResultRow('Geometry', results.geometry_label, '', ''),
                buildResultRow('Max Hoop Stress', format(results.max_hoop_stress_mpa, 3), 'MPa', results.subst_max_hoop_stress_mpa),
                buildResultRow('Max Radial Stress', format(results.max_radial_stress_mpa, 3), 'MPa', ''),
                buildResultRow('Max von Mises Stress', format(results.max_von_mises_stress_mpa, 3), 'MPa', results.subst_max_von_mises_stress_mpa),
                buildResultRow('Yield Safety Factor', format(results.yield_safety_factor, 3), '', results.subst_yield_safety_factor),
                buildResultRow('Allowable Speed', format(results.allowable_speed_rpm, 1), 'rpm', results.subst_allowable_speed_rpm),
                buildResultRow('Critical Radius', format(results.critical_radius_mm, 2), 'mm', ''),
                buildResultRow('Tip Speed', format(results.tip_speed_m_s, 2), 'm/s', ''),
                buildResultRow('Rotor Mass', format(results.mass_kg, 3), 'kg', ''),
                buildResultRow('Kinetic Energy', formatScientific(results.kinetic_energy_j, 3), 'J', ''),
                buildResultRow('Utilization', format(results.utilization_percent, 1), '%', '')
            ].join('');

            const recList = (results.recommendations || [])
                .map(item => `<li>${item}</li>`)
                .join('');

            document.getElementById('results-display').innerHTML = `
                ${banner}
                ${rows}
                <h4 style="margin-top: 10px;">Recommendations</h4>
                <ul class="recommendations">${recList}</ul>
            `;

            typesetMath();
        }

        function renderPlot(profile) {
            const svg = document.getElementById('stress-plot-svg');
            if (!profile || !profile.radius_mm || profile.radius_mm.length < 2) {
                svg.innerHTML = '<text x="20" y="30" fill="#6b7280">No profile data available.</text>';
                return;
            }

            const x = profile.radius_mm;
            const y1 = profile.sigma_theta_mpa;
            const y2 = profile.sigma_r_mpa;
            const y3 = profile.sigma_vm_mpa;

            const w = 760;
            const h = 360;
            const m = { left: 68, right: 26, top: 26, bottom: 50 };
            const plotW = w - m.left - m.right;
            const plotH = h - m.top - m.bottom;

            const xMin = Math.min(...x);
            const xMax = Math.max(...x);
            const yMinRaw = Math.min(...y1, ...y2, ...y3);
            const yMaxRaw = Math.max(...y1, ...y2, ...y3);
            const yPad = Math.max(0.8, 0.08 * Math.max(yMaxRaw - yMinRaw, 1e-9));
            const yMin = yMinRaw - yPad;
            const yMax = yMaxRaw + yPad;
            const ySpan = Math.max(1e-9, yMax - yMin);

            const sx = value => m.left + ((value - xMin) / (xMax - xMin || 1)) * plotW;
            const sy = value => m.top + plotH - ((value - yMin) / ySpan) * plotH;

            const linePath = arr => arr
                .map((v, i) => `${i === 0 ? 'M' : 'L'} ${sx(x[i]).toFixed(2)} ${sy(v).toFixed(2)}`)
                .join(' ');

            const xTicks = 6;
            const yTicks = 6;
            const xGrid = [];
            const yGrid = [];
            const yTickDecimals = ySpan >= 100 ? 0 : ySpan >= 20 ? 1 : 2;
            const xTickDecimals = (xMax - xMin) >= 20 ? 0 : 1;

            for (let i = 0; i <= xTicks; i++) {
                const xv = xMin + (i / xTicks) * (xMax - xMin);
                const xp = sx(xv);
                xGrid.push(`<line x1="${xp}" y1="${m.top}" x2="${xp}" y2="${m.top + plotH}" stroke="#e7ecf3"/>`);
                xGrid.push(`<text x="${xp}" y="${h - 19}" text-anchor="middle" font-size="11" fill="#64748b">${xv.toFixed(xTickDecimals)}</text>`);
            }
            for (let i = 0; i <= yTicks; i++) {
                const yv = yMin + (i / yTicks) * (yMax - yMin);
                const yp = sy(yv);
                yGrid.push(`<line x1="${m.left}" y1="${yp}" x2="${m.left + plotW}" y2="${yp}" stroke="#e7ecf3"/>`);
                yGrid.push(`<text x="${m.left - 9}" y="${yp + 4}" text-anchor="end" font-size="11" fill="#64748b">${yv.toFixed(yTickDecimals)}</text>`);
            }

            const zeroInPlot = yMin <= 0 && yMax >= 0;
            const zeroLine = zeroInPlot
                ? `<line x1="${m.left}" y1="${sy(0)}" x2="${m.left + plotW}" y2="${sy(0)}" stroke="#94a3b8" stroke-dasharray="6 4" />`
                : '';

            const idxVmPeak = y3.indexOf(Math.max(...y3));
            const vmPeakX = sx(x[idxVmPeak]);
            const vmPeakY = sy(y3[idxVmPeak]);
            const peakLabelX = Math.min(m.left + plotW - 8, vmPeakX + 8);
            const peakLabelY = Math.max(m.top + 12, vmPeakY - 10);

            const maxHoop = Math.max(...y1);
            const maxRadialAbs = Math.max(...y2.map(v => Math.abs(v)));
            const maxVm = Math.max(...y3);

            svg.innerHTML = `
                <rect x="0" y="0" width="${w}" height="${h}" fill="#ffffff"/>
                <rect x="${m.left}" y="${m.top}" width="${plotW}" height="${plotH}" fill="#fbfdff"/>
                ${xGrid.join('')}
                ${yGrid.join('')}
                ${zeroLine}
                <line x1="${m.left}" y1="${m.top + plotH}" x2="${m.left + plotW}" y2="${m.top + plotH}" stroke="#0f172a" stroke-width="1.2"/>
                <line x1="${m.left}" y1="${m.top}" x2="${m.left}" y2="${m.top + plotH}" stroke="#0f172a" stroke-width="1.2"/>

                <path d="${linePath(y1)}" fill="none" stroke="#1f2937" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="${linePath(y2)}" fill="none" stroke="#0f766e" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="${linePath(y3)}" fill="none" stroke="#c2410c" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>

                <circle cx="${vmPeakX}" cy="${vmPeakY}" r="3.8" fill="#c2410c"/>
                <text x="${peakLabelX}" y="${peakLabelY}" font-size="11" fill="#9a3412">Peak von Mises: ${maxVm.toFixed(2)} MPa</text>

                <text x="${m.left + plotW / 2}" y="${h - 7}" text-anchor="middle" font-size="12" fill="#0f172a">Radius (mm)</text>
                <text x="18" y="${m.top + plotH / 2}" text-anchor="middle" font-size="12" fill="#0f172a" transform="rotate(-90 18 ${m.top + plotH / 2})">Stress (MPa)</text>

                <rect x="${m.left + plotW - 200}" y="${m.top + 10}" width="190" height="64" rx="6" ry="6" fill="rgba(255,255,255,0.92)" stroke="#d7dce5"/>
                <line x1="${m.left + plotW - 188}" y1="${m.top + 24}" x2="${m.left + plotW - 172}" y2="${m.top + 24}" stroke="#1f2937" stroke-width="2.4"/>
                <text x="${m.left + plotW - 166}" y="${m.top + 28}" font-size="11" fill="#111827">Hoop max: ${maxHoop.toFixed(2)} MPa</text>
                <line x1="${m.left + plotW - 188}" y1="${m.top + 41}" x2="${m.left + plotW - 172}" y2="${m.top + 41}" stroke="#0f766e" stroke-width="2.2"/>
                <text x="${m.left + plotW - 166}" y="${m.top + 45}" font-size="11" fill="#111827">Radial peak |Ïƒ|: ${maxRadialAbs.toFixed(2)} MPa</text>
                <line x1="${m.left + plotW - 188}" y1="${m.top + 58}" x2="${m.left + plotW - 172}" y2="${m.top + 58}" stroke="#c2410c" stroke-width="2.4"/>
                <text x="${m.left + plotW - 166}" y="${m.top + 62}" font-size="11" fill="#111827">von Mises max: ${maxVm.toFixed(2)} MPa</text>
            `;

            typesetMath();
        }

        function bindLivePreviewHandlers() {
            PREVIEW_PARAM_IDS.forEach(id => {
                const element = document.getElementById(id);
                if (!element) return;

                if (id === 'geometry_type') {
                    element.addEventListener('change', updateGeometryControls);
                    return;
                }
                if (id === 'inner_radius_mm' || id === 'outer_radius_mm') {
                    element.addEventListener('input', renderCrossSectionPreview);
                    element.addEventListener('change', updateGeometryControls);
                    return;
                }

                element.addEventListener('input', renderCrossSectionPreview);
                element.addEventListener('change', renderCrossSectionPreview);
            });
        }

        document.getElementById('calc-form').addEventListener('submit', event => {
            event.preventDefault();

            try {
                const args = [
                    document.getElementById('geometry_type').value,
                    parseFloat(document.getElementById('inner_radius_mm').value),
                    parseFloat(document.getElementById('outer_radius_mm').value),
                    parseFloat(document.getElementById('thickness_mm').value),
                    parseFloat(document.getElementById('density_kg_m3').value),
                    parseFloat(document.getElementById('poisson_ratio').value),
                    parseFloat(document.getElementById('speed_rpm').value),
                    parseFloat(document.getElementById('yield_strength_mpa').value),
                    parseFloat(document.getElementById('required_safety_factor').value),
                    parseInt(document.getElementById('profile_points').value, 10)
                ];

                const resultProxy = pyToolModule[TOOL_FUNCTION_NAME](...args);
                const results = toPlainObject(resultProxy.toJs({ dict_converter: Object.fromEntries }));
                resultProxy.destroy();

                renderResults(results);
                renderPlot(results.stress_profile);
            } catch (error) {
                document.getElementById('results-display').innerHTML = `<p style="color: red; font-weight: bold;">Calculation Error: ${error.message}</p>`;
                console.error(error);
            }
        });

        bindLivePreviewHandlers();
        updateGeometryControls();

        main();
    </script>
</body>
</html>
